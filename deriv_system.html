<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DERIV ¬∑ Sistema de Rob√¥s</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<script>if(sessionStorage.getItem('alpha_session'))document.documentElement.classList.add('restoring-session');</script>
<style>
.restoring-session #screenLogin{visibility:hidden!important;}

:root {
  --bg:#020b14; --surface:#041020; --surface2:#071828;
  --border:#0d3a5c; --accent:#00d4ff; --accent2:#00ff9f;
  --red:#ff3b6b; --green:#00ff9f; --gold:#ffb800;
  --text:#c8e6f5; --dim:#4a7a99;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;min-height:100vh;}
.screen{display:none;min-height:100vh;}
.screen.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ INPUTS & BUTTONS ‚îÄ‚îÄ */
input,select,textarea{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:14px;outline:none;width:100%;transition:border-color .2s;}
input:focus,select:focus{border-color:var(--accent);}
label{font-size:10px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;text-transform:uppercase;display:block;margin-bottom:5px;}
.field{display:flex;flex-direction:column;gap:4px;}
.btn{padding:10px 20px;border-radius:8px;border:none;cursor:pointer;font-weight:700;font-size:13px;letter-spacing:1px;transition:all .2s;font-family:'Exo 2',sans-serif;}
.btn-primary{background:linear-gradient(135deg,var(--accent),#0099cc);color:#000;}
.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,212,255,.4);}
.btn-danger{background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.4);}
.btn-danger:hover{background:rgba(255,59,107,.25);}
.btn-success{background:rgba(0,255,159,.15);color:var(--green);border:1px solid rgba(0,255,159,.4);}
.btn-gold{background:rgba(255,184,0,.15);color:var(--gold);border:1px solid rgba(255,184,0,.4);}
.btn-sm{padding:6px 14px;font-size:11px;}
.card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;position:relative;overflow:hidden;}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.mono{font-family:'Share Tech Mono',monospace;}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#screenLogin{align-items:center;justify-content:center;background:radial-gradient(ellipse at center,#041830 0%,var(--bg) 70%);}
.login-box{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;width:100%;max-width:420px;position:relative;overflow:hidden;}
.login-box::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent2));}
.login-logo{text-align:center;margin-bottom:28px;}
.login-logo h1{font-size:22px;font-weight:900;letter-spacing:3px;color:var(--accent);}
.login-logo p{font-size:11px;color:var(--dim);letter-spacing:2px;margin-top:4px;}
/* Brand logo image */
.brand-logo-img{width:72px;height:72px;object-fit:contain;border-radius:12px;margin-bottom:10px;}
/* OAuth popup overlay */
#oauthOverlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);}
#oauthOverlay.show{display:flex;}
.oauth-modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px;text-align:center;max-width:360px;width:90%;}
.oauth-spinner{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite;margin:16px auto;}
@keyframes spin{to{transform:rotate(360deg);}}
/* Profile dropdown */
.profile-btn{position:relative;background:none;border:1px solid var(--border);border-radius:50%;width:36px;height:36px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;color:var(--text);transition:border-color .2s;}
.profile-btn:hover{border-color:var(--accent);}
.profile-btn.deriv-connected{border-color:var(--green);box-shadow:0 0 8px rgba(0,255,159,.3);}
.profile-dropdown{display:none;position:absolute;top:calc(100% + 8px);right:0;width:300px;background:var(--surface);border:1px solid var(--border);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,.5);z-index:999;overflow:hidden;}
.profile-dropdown.open{display:block;}
.profile-dropdown-header{padding:16px;border-bottom:1px solid var(--border);background:var(--surface2);}
.profile-dropdown-section{padding:12px 16px;}
.pd-label{font-size:9px;letter-spacing:2px;color:var(--dim);margin-bottom:8px;}
.deriv-status-badge{display:flex;align-items:center;gap:8px;padding:10px 12px;border-radius:8px;background:var(--surface2);border:1px solid var(--border);margin-bottom:8px;}
.deriv-status-dot{width:8px;height:8px;border-radius:50%;background:var(--dim);}
.deriv-status-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green);}
#profileDropdownWrap{position:relative;}
.color-preview{width:28px;height:28px;border-radius:6px;border:2px solid var(--border);display:inline-block;vertical-align:middle;margin-left:8px;cursor:pointer;}
.login-tabs{display:flex;gap:8px;margin-bottom:24px;}
.login-tab{flex:1;padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--dim);cursor:pointer;font-size:12px;font-weight:700;letter-spacing:1px;transition:all .2s;}
.login-tab.active{background:rgba(0,212,255,.1);color:var(--accent);border-color:var(--accent);}

/* ‚îÄ‚îÄ TOP NAV ‚îÄ‚îÄ */
.topnav{background:var(--surface);border-bottom:1px solid var(--border);padding:12px 24px;display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;}
/* ‚îÄ‚îÄ PING ‚îÄ‚îÄ */
.ping-box{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:5px 12px;font-family:'Share Tech Mono',monospace;transition:border-color .3s;}
.ping-box.good{border-color:rgba(0,255,159,.5);}
.ping-box.warn{border-color:rgba(255,184,0,.5);}
.ping-box.bad{border-color:rgba(255,59,107,.6);animation:ping-danger .8s infinite;}
@keyframes ping-danger{0%,100%{box-shadow:0 0 0 rgba(255,59,107,0);}50%{box-shadow:0 0 10px rgba(255,59,107,.5);}}
.ping-dot{width:9px;height:9px;border-radius:50%;background:var(--dim);flex-shrink:0;transition:background .3s;}
.ping-dot.good{background:var(--green);box-shadow:0 0 6px var(--green);}
.ping-dot.warn{background:var(--gold);box-shadow:0 0 6px var(--gold);}
.ping-dot.bad{background:var(--red);box-shadow:0 0 6px var(--red);}
.ping-val{font-size:13px;font-weight:700;color:var(--text);min-width:48px;}
.ping-label{font-size:9px;color:var(--dim);letter-spacing:1px;}
/* Ping alert overlay */
#pingAlert{display:none;position:fixed;top:70px;left:50%;transform:translateX(-50%);z-index:9999;background:rgba(255,59,107,.15);border:2px solid var(--red);border-radius:12px;padding:14px 24px;text-align:center;backdrop-filter:blur(8px);box-shadow:0 0 40px rgba(255,59,107,.3);min-width:320px;}
#pingAlert.show{display:block;animation:slideDown .3s ease;}
@keyframes slideDown{from{opacity:0;transform:translateX(-50%) translateY(-10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
.topnav-brand{font-size:16px;font-weight:900;letter-spacing:2px;color:var(--accent);}
.topnav-user{display:flex;align-items:center;gap:12px;}
.nav-pill{padding:5px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--dim);cursor:pointer;font-size:11px;font-weight:700;letter-spacing:1px;transition:all .2s;}
.nav-pill.active{background:rgba(0,212,255,.1);color:var(--accent);border-color:var(--accent);}
.nav-pill:hover{border-color:var(--accent);color:var(--accent);}

/* ‚îÄ‚îÄ ADMIN SCREEN ‚îÄ‚îÄ */
#screenAdmin .content{padding:24px;max-width:1400px;margin:0 auto;width:100%;}
.admin-grid{display:grid;grid-template-columns:1fr 380px;gap:20px;align-items:start;}
@media(max-width:900px){.admin-grid{grid-template-columns:1fr;}}
.robot-list{display:flex;flex-direction:column;gap:12px;}
.robot-card-item{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;transition:border-color .2s;}
.robot-card-item:hover{border-color:var(--accent);}
.robot-card-item.running{border-color:var(--green);box-shadow:0 0 12px rgba(0,255,159,.1);}
.robot-status-dot{width:10px;height:10px;border-radius:50%;background:var(--dim);flex-shrink:0;}
.robot-status-dot.running{background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.robot-name{font-weight:700;font-size:15px;color:var(--text);}
.robot-meta{font-size:11px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;}
.robot-actions{display:flex;gap:8px;}

/* ‚îÄ‚îÄ ROBOT FORM ‚îÄ‚îÄ */
.form-section{font-size:10px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin:16px 0 10px;border-bottom:1px solid var(--border);padding-bottom:6px;}
.form-grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.form-grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;}

/* ‚îÄ‚îÄ DASHBOARD SCREEN ‚îÄ‚îÄ */
#screenDashboard{flex-direction:column;}
#screenDashboard .dash-wrapper{
  display:grid;
  grid-template-columns:300px 1fr 280px;
  gap:0;
  flex:1;
  overflow:hidden;
  height:calc(100vh - 50px);
}
/* LEFT panel */
.dash-left{
  background:var(--surface);
  border-right:1px solid var(--border);
  overflow-y:auto;
  padding:14px;
  display:flex;
  flex-direction:column;
  gap:12px;
  scrollbar-width:thin;
  scrollbar-color:var(--border) transparent;
}
/* CENTER panel */
.dash-center{
  overflow-y:auto;
  padding:14px 16px;
  display:flex;
  flex-direction:column;
  gap:12px;
  scrollbar-width:thin;
  scrollbar-color:var(--border) transparent;
}
/* RIGHT panel ‚Äî log column */
.dash-right{
  background:var(--surface);
  border-left:1px solid var(--border);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  align-self:start;
}
.dash-right-header{
  padding:12px 14px 8px;
  font-size:10px;
  letter-spacing:2px;
  color:var(--accent);
  font-family:'Share Tech Mono',monospace;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.dash-right-log{
  height:520px;
  overflow-y:auto;
  padding:10px 12px;
  font-family:'Share Tech Mono',monospace;
  font-size:10.5px;
  scrollbar-width:thin;
  scrollbar-color:var(--border) transparent;
  background:var(--bg);
}
@media(max-width:1200px){
  #screenDashboard .dash-wrapper{grid-template-columns:280px 1fr 240px;}
}
@media(max-width:900px){
  #screenDashboard .dash-wrapper{grid-template-columns:1fr;height:auto;}
  .dash-right{height:200px;}
}

/* Robot selector */
.robot-selector{display:flex;flex-direction:column;gap:8px;}
.robot-sel-item{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;cursor:pointer;transition:all .2s;}
.robot-sel-item:hover,.robot-sel-item.active{border-color:var(--accent);background:rgba(0,212,255,.06);}
.robot-sel-item .rs-name{font-weight:700;font-size:13px;}
.robot-sel-item .rs-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
/* Robot dropdown */
.robot-dropdown{position:relative;width:100%;}
.robot-dropdown-btn{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px 14px;color:var(--text);font-family:'Exo 2',sans-serif;font-size:13px;font-weight:700;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;transition:border-color .2s;}
.robot-dropdown-btn:hover,.robot-dropdown-btn.open{border-color:var(--accent);background:rgba(0,212,255,.05);}
.robot-dropdown-btn .rdb-name{flex:1;text-align:left;}
.robot-dropdown-btn .rdb-arrow{font-size:10px;color:var(--dim);transition:transform .2s;}
.robot-dropdown-btn.open .rdb-arrow{transform:rotate(180deg);}
.robot-dropdown-menu{display:none;position:absolute;top:calc(100% + 4px);left:0;right:0;background:var(--surface);border:1px solid var(--accent);border-radius:8px;z-index:100;overflow:hidden;box-shadow:0 8px 32px rgba(0,0,0,.6);}
.robot-dropdown-menu.open{display:block;}
.robot-dropdown-item{padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--border);transition:background .15s;}
.robot-dropdown-item:last-child{border-bottom:none;}
.robot-dropdown-item:hover{background:rgba(0,212,255,.08);}
.robot-dropdown-item.active{background:rgba(0,212,255,.12);border-left:2px solid var(--accent);}
.robot-dropdown-item.manual-mode{border-top:1px solid var(--border);background:rgba(255,184,0,.04);}
.robot-dropdown-item.manual-mode:hover{background:rgba(255,184,0,.1);}
.rdi-name{font-weight:700;font-size:12px;}
.rdi-meta{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
/* Manual mode fields */
.manual-fields{display:none;flex-direction:column;gap:10px;margin-top:10px;padding-top:10px;border-top:1px solid var(--border);}
.manual-fields.active{display:flex;}

/* Account bar */
.acc-bar{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:14px;}
.acc-info{display:flex;gap:20px;flex-wrap:wrap;align-items:center;}
.acc-field{display:flex;flex-direction:column;gap:2px;}
.acc-field-label{font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;}
.acc-field-val{font-size:15px;font-weight:700;}

/* Boleta */
.boleta{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;margin-bottom:14px;}
.boleta-row{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;}
.boleta-mini{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px;}
.boleta-stat{background:var(--surface2);border-radius:8px;padding:10px 12px;}
.boleta-stat-label{font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;}
.boleta-stat-val{font-size:17px;font-weight:900;font-family:'Share Tech Mono',monospace;margin-top:3px;}
.pnl-bar{height:6px;background:var(--surface2);border-radius:3px;margin-top:5px;overflow:hidden;}
.pnl-fill{height:100%;border-radius:3px;transition:width .4s;}

/* Robot signal */
.signal-box{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px 18px;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
.signal-main{display:flex;flex-direction:column;gap:4px;}
.signal-val{font-size:26px;font-weight:900;letter-spacing:2px;font-family:'Share Tech Mono',monospace;}
.signal-val.aguardando{color:var(--dim);}
.signal-val.virtual{color:var(--gold);}
.signal-val.entrar{color:var(--green);animation:glow 1s infinite alternate;}
.signal-val.perigo{color:var(--red);}
.signal-val.enviando{color:var(--accent);}
@keyframes glow{from{text-shadow:0 0 10px rgba(0,255,159,.3);}to{text-shadow:0 0 30px rgba(0,255,159,.7);}}

/* Vdots */
.vdots{display:flex;gap:6px;flex-wrap:wrap;}
.vdot{width:14px;height:14px;border-radius:3px;border:2px solid var(--border);transition:all .2s;}
.vdot.active{background:var(--red);border-color:var(--red);box-shadow:0 0 8px rgba(255,59,107,.5);}

/* Digit stream */
.digit-stream{display:flex;flex-wrap:wrap;gap:3px;padding:10px;background:var(--bg);border-radius:8px;max-height:120px;overflow-y:auto;}
.digit-chip{width:26px;height:26px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;font-family:'Share Tech Mono',monospace;}
.digit-chip.win{background:rgba(0,255,159,.15);color:var(--green);}
.digit-chip.loss{background:rgba(255,59,107,.15);color:var(--red);}
.digit-chip.neutral{background:var(--surface2);color:var(--dim);}
/* Virtual cycle chip colors */
.digit-chip.virt-loss{background:rgba(255,59,107,.25);color:var(--red);border:1px solid rgba(255,59,107,.5);}
.digit-chip.trigger-win{background:rgba(0,212,255,.25);color:var(--accent);border:2px solid var(--accent);box-shadow:0 0 8px rgba(0,212,255,.4);}
.digit-chip.trigger-loss{background:rgba(255,59,107,.35);color:var(--red);border:2px solid var(--red);box-shadow:0 0 8px rgba(255,59,107,.4);}

/* Stats grid */
.stats-grid{display:grid;grid-template-columns:repeat(10,1fr);gap:6px;margin-bottom:14px;}
@media(max-width:900px){.stats-grid{grid-template-columns:repeat(5,1fr);}}
.freq-card{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px 8px;text-align:center;}
.freq-digit{font-size:18px;font-weight:900;font-family:'Share Tech Mono',monospace;}
.freq-count{font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:2px;}
.freq-bar-wrap{height:4px;background:var(--surface2);border-radius:2px;margin-top:4px;overflow:hidden;}
.freq-bar{height:100%;border-radius:2px;background:var(--accent);transition:width .5s;}

/* Diag grid */
.diag-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;}
@media(max-width:900px){.diag-grid{grid-template-columns:repeat(3,1fr);}}
.diag-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;}
.diag-name{font-size:11px;font-weight:700;font-family:'Share Tech Mono',monospace;}
.diag-pct{font-size:18px;font-weight:900;font-family:'Share Tech Mono',monospace;margin-top:4px;}
.diag-trend{font-size:9px;margin-top:3px;}
.diag-exp{font-size:9px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:1px;}

/* Log */
.log-area{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px;height:140px;overflow-y:auto;font-family:'Share Tech Mono',monospace;font-size:11px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
/* log inside right panel ‚Äî no border/radius needed */
.dash-right-log .log-line{margin-bottom:4px;line-height:1.5;word-break:break-word;}
.log-line{margin-bottom:3px;line-height:1.4;}
.log-line.info{color:var(--dim);}
.log-line.success{color:var(--green);}
.log-line.warning{color:var(--gold);}
.log-line.error{color:var(--red);}

/* Progress */
.progress-bar{height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;margin:8px 0;}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));border-radius:3px;transition:width .3s;}

/* OU Table */
.ou-table{width:100%;border-collapse:collapse;}
/* Martingale reference table */
.mart-ref-table{width:100%;border-collapse:collapse;font-family:'Share Tech Mono',monospace;}
.mart-ref-table th{font-size:9px;letter-spacing:1.5px;color:var(--dim);padding:6px 8px;text-align:center;border-bottom:1px solid var(--border);background:var(--surface2);position:sticky;top:0;}
.mart-ref-table th.strat-col{text-align:left;min-width:70px;}
.mart-ref-table td{font-size:11px;padding:5px 8px;border-bottom:1px solid rgba(13,58,92,.2);text-align:center;transition:background .15s;}
.mart-ref-table td.strat-cell{text-align:left;font-weight:700;}
.mart-ref-table tr:hover td{background:rgba(0,212,255,.04);}
.mart-ref-table tr.active-strat td{background:rgba(0,212,255,.08);}
.mart-ref-table tr.active-strat td.strat-cell{color:var(--accent);}
.mart-ref-table .profit{color:var(--green);}
.mart-ref-table .net{color:var(--gold);font-size:10px;}
.mart-ref-table .net.neg{color:var(--red);}
.mart-ref-section{max-height:340px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.ou-table th{font-size:10px;letter-spacing:2px;color:var(--dim);padding:7px 10px;text-align:left;border-bottom:1px solid var(--border);font-family:'Share Tech Mono',monospace;}
.ou-table td{font-size:12px;padding:7px 10px;border-bottom:1px solid rgba(13,58,92,.3);font-family:'Share Tech Mono',monospace;}
.ou-table tr:last-child td{border-bottom:none;}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700;}
.badge-green{background:rgba(0,255,159,.15);color:var(--green);}
.badge-red{background:rgba(255,59,107,.15);color:var(--red);}
.badge-gold{background:rgba(255,184,0,.15);color:var(--gold);}

/* Stop alert overlay */
.overlay{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(2,11,20,.96);z-index:9999;display:flex;align-items:center;justify-content:center;}
.overlay-box{background:#041020;border-radius:16px;padding:40px;max-width:480px;width:90%;text-align:center;}
</style>
<!-- Supabase SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ‚îÄ‚îÄ Supabase config ‚îÄ‚îÄ
  const SUPABASE_URL  = 'https://okxaphtpaveuxbykqdfh.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reGFwaHRwYXZldXhieWtxZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODgwODksImV4cCI6MjA4NzI2NDA4OX0.jzZaaXK200WQCqev9bZMG7nSlMot2eHD8TKjChDNNG0';

  function initSupabase(){
    if(typeof supabase === 'undefined'){
      setTimeout(initSupabase, 100);
      return;
    }
    const _supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
      auth: { persistSession: false, detectSessionInUrl: false }
    });
    window._sb  = _supa;

    _supa.auth.onAuthStateChange(async (event, session) => {
      if(session?.user){
        const user = session.user;
        try {
          const { data: profile } = await _supa
            .from('profiles')
            .select('name, plan')
            .eq('id', user.id)
            .single();

          window._alphaUser = {
            uid:   user.id,
            email: user.email,
            name:  profile?.name || user.email.split('@')[0],
            plan:  profile?.plan || 'free',
          };
        } catch(e) {
          window._alphaUser = {
            uid:   user.id,
            email: user.email,
            name:  user.email.split('@')[0],
            plan:  'free',
          };
        }
        window._onAlphaLogin && window._onAlphaLogin(window._alphaUser);
      } else {
        window._alphaUser = null;
        window._onAlphaLogout && window._onAlphaLogout();
      }
    });
    // Restore session via getUser (HTTP direto, sem Web Lock)
    const _saved = sessionStorage.getItem('alpha_session');
    if(_saved){
      try {
        const { access_token } = JSON.parse(_saved);
        _supa.auth.getUser(access_token).then(({ data, error }) => {
          document.documentElement.classList.remove('restoring-session');
          if(data?.user && !error){
            window._alphaUser = {
              uid:   data.user.id,
              email: data.user.email,
              name:  data.user.email.split('@')[0],
              plan:  'free',
            };
            window._onAlphaLogin && window._onAlphaLogin(window._alphaUser);
          } else {
            sessionStorage.removeItem('alpha_session');
          }
        });
      } catch(e) {
        sessionStorage.removeItem('alpha_session');
        document.documentElement.classList.remove('restoring-session');
      }
    }

    console.log('‚úÖ Supabase inicializado');
  }

  // Start init after DOM ready
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initSupabase);
  } else {
    initSupabase();
  }
</script>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 1: LOGIN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screenLogin" class="screen active">
  <div class="login-box" style="max-width:420px;">

    <!-- LOGO -->
    <div class="login-logo">
      <div id="loginLogoWrap" style="margin-bottom:8px;">
        <img id="loginLogoImg" style="display:none;" class="brand-logo-img">
        <div id="loginLogoEmoji" style="font-size:48px;">‚ö°</div>
      </div>
      <h1 id="loginBrandName">DERIV ROBO SYSTEM</h1>
      <p id="loginBrandSlogan">PAINEL DE OPERA√á√ïES AUTOMATIZADAS</p>
      <div id="loginBrandWelcome" style="font-size:11px;color:var(--gold);margin-top:6px;display:none;"></div>
    </div>

    <!-- ‚îÄ‚îÄ STEP 1: ALPHA LOGIN / REGISTER ‚îÄ‚îÄ -->
    <div id="panelAlphaAuth">

      <!-- Tabs: Login / Cadastro -->
      <div class="login-tabs" style="margin-bottom:16px;">
        <button class="login-tab active" id="tabAlphaLogin"  onclick="switchAlphaTab('login')">ENTRAR</button>
        <button class="login-tab"        id="tabAlphaSignup" onclick="switchAlphaTab('signup')">CADASTRAR</button>
        <button class="login-tab"        id="tabAlphaAdmin"  onclick="switchAlphaTab('admin')" style="font-size:10px;padding:6px 10px;">üõ†Ô∏è ADMIN</button>
      </div>

      <!-- LOGIN -->
      <div id="panelAlphaLogin">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="field"><label>E-mail</label>
            <input type="email" id="alphaLoginEmail" placeholder="seu@email.com" autocomplete="email"
              onkeydown="if(event.key==='Enter')alphaLogin()">
          </div>
          <div class="field"><label>Senha</label>
            <input type="password" id="alphaLoginPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              onkeydown="if(event.key==='Enter')alphaLogin()">
          </div>
          <button class="btn btn-primary" onclick="alphaLogin()" style="margin-top:4px;">‚ñ∂ ENTRAR</button>
          <div id="alphaLoginErr" style="color:var(--red);font-size:12px;text-align:center;display:none;"></div>
        </div>
      </div>

      <!-- CADASTRO -->
      <div id="panelAlphaSignup" style="display:none;">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="field"><label>Nome</label>
            <input type="text" id="alphaSignupName" placeholder="Seu nome">
          </div>
          <div class="field"><label>E-mail</label>
            <input type="email" id="alphaSignupEmail" placeholder="seu@email.com" autocomplete="email">
          </div>
          <div class="field"><label>Senha</label>
            <input type="password" id="alphaSignupPass" placeholder="M√≠nimo 6 caracteres">
          </div>
          <button class="btn btn-primary" onclick="alphaSignup()" style="margin-top:4px;">‚úÖ CRIAR CONTA</button>
          <div id="alphaSignupErr" style="color:var(--red);font-size:12px;text-align:center;display:none;"></div>
        </div>
      </div>

      <!-- ADMIN (local) -->
      <div id="panelAdminLogin" style="display:none;">
        <div style="display:flex;flex-direction:column;gap:12px;">
          <div class="field"><label>Usu√°rio</label>
            <input type="text" id="adminUser" placeholder="admin" autocomplete="username">
          </div>
          <div class="field"><label>Senha</label>
            <input type="password" id="adminPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
              onkeydown="if(event.key==='Enter')loginAdmin()">
          </div>
          <button class="btn btn-primary" onclick="loginAdmin()">üîê ENTRAR COMO ADMIN</button>
          <div id="adminLoginErr" style="color:var(--red);font-size:12px;text-align:center;display:none;"></div>
        </div>
      </div>
    </div>


  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 2: ADMIN PANEL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screenAdmin" class="screen">
  <!-- TOP NAV -->
  <div class="topnav">
    <div class="topnav-brand" id="adminTopnavBrand">‚ö° DERIV ROBO SYSTEM ¬∑ ADMIN</div>
    <div class="topnav-user" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <button class="nav-pill active" id="adminTabBtnRobots" onclick="showAdminTab('robots')">ü§ñ Rob√¥s</button>
      <button class="nav-pill" id="adminTabBtnAdmins" onclick="showAdminTab('admins')">üë• Admins</button>
      <button class="nav-pill" id="adminTabBtnBrand" onclick="showAdminTab('brand')">üé® Marca</button>
      <span style="font-size:12px;color:var(--dim);" id="adminNavUser"></span>
      <button class="btn btn-gold btn-sm" onclick="goToDashboard()">üìä Trocar Conta</button>
      <button class="btn btn-danger btn-sm" onclick="logoutAll()">‚èè Sair</button>
    </div>
  </div>

  <div class="content">

    <!-- ROBOTS TAB -->
    <div id="adminTabRobots">
      <div class="admin-grid">

        <!-- LEFT: Robot List -->
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 style="font-size:16px;font-weight:900;letter-spacing:1px;">ü§ñ Rob√¥s Criados</h2>
            <button class="btn btn-success btn-sm" onclick="openRobotForm()">+ Novo Rob√¥</button>
          </div>
          <div class="robot-list" id="robotList">
            <div style="color:var(--dim);font-size:13px;text-align:center;padding:40px;">
              Nenhum rob√¥ criado ainda. Clique em "+ Novo Rob√¥".
            </div>
          </div>
        </div>

        <!-- RIGHT: Robot Form -->
        <div class="card" id="robotFormCard">
          <div style="font-size:13px;font-weight:900;letter-spacing:1px;margin-bottom:16px;" id="robotFormTitle">‚ûï NOVO ROB√î</div>

          <div class="form-section">IDENTIFICA√á√ÉO</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="field">
              <label>Nome do Rob√¥</label>
              <input type="text" id="rfName" placeholder="Ex: Over 3 Conservador">
            </div>
            <div class="field">
              <label>Descri√ß√£o (opcional)</label>
              <input type="text" id="rfDesc" placeholder="Ex: Estrat√©gia para baixo risco">
            </div>
          </div>

          <div class="form-section">ESTRAT√âGIA</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="field">
                <label>Estrat√©gia</label>
                <select id="rfStrategy">
                  <option value="over0">Over 0 (1‚Äì9) ¬∑ 90%</option>
                  <option value="over1">Over 1 (2‚Äì9) ¬∑ 80%</option>
                  <option value="over2">Over 2 (3‚Äì9) ¬∑ 70%</option>
                  <option value="over3" selected>Over 3 (4‚Äì9) ¬∑ 60%</option>
                  <option value="over4">Over 4 (5‚Äì9) ¬∑ 50%</option>
                  <option value="over5">Over 5 (6‚Äì9) ¬∑ 40%</option>
                  <option value="over6">Over 6 (7‚Äì9) ¬∑ 30%</option>
                  <option value="over7">Over 7 (8‚Äì9) ¬∑ 20%</option>
                  <option value="over8">Over 8 (s√≥ 9) ¬∑ 10%</option>
                  <option value="under1">Under 1 (s√≥ 0) ¬∑ 10%</option>
                  <option value="under2">Under 2 (0‚Äì1) ¬∑ 20%</option>
                  <option value="under3">Under 3 (0‚Äì2) ¬∑ 30%</option>
                  <option value="under4">Under 4 (0‚Äì3) ¬∑ 40%</option>
                  <option value="under5">Under 5 (0‚Äì4) ¬∑ 50%</option>
                  <option value="under6">Under 6 (0‚Äì5) ¬∑ 60%</option>
                  <option value="under7">Under 7 (0‚Äì6) ¬∑ 70%</option>
                  <option value="under8">Under 8 (0‚Äì7) ¬∑ 80%</option>
                  <option value="under9">Under 9 (0‚Äì8) ¬∑ 90%</option>
                </select>
            </div>
            <div class="field">
              <label>Losses Virtuais para Ativar</label>
              <select id="rfVirtual">
                <option value="2">2 losses</option>
                <option value="3">3 losses</option>
                <option value="4">4 losses</option>
                <option value="5" selected>5 losses</option>
                <option value="6">6 losses</option>
              </select>
            </div>
          </div>

          <div class="form-section">MARTINGALE</div>
          <div class="form-grid-3" style="gap:12px;">
            <div class="field">
              <label>Entrada Base ($)</label>
              <input type="number" id="rfEntry" value="0.35" min="0.35" step="0.05">
            </div>
            <div class="field">
              <label>Fator Martingale</label>
              <input type="number" id="rfFactor" value="2.8" min="1.1" max="5" step="0.1">
            </div>
            <div class="field">
              <label>N√≠veis M√°x.</label>
              <input type="number" id="rfLevels" value="5" min="1" max="8" step="1">
            </div>
          </div>

          <!-- Martingale preview -->
          <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-top:14px;" id="martPreview"></div>

          <div style="display:flex;gap:10px;margin-top:16px;">
            <button class="btn btn-primary" style="flex:1;" onclick="saveRobot()">üíæ SALVAR ROB√î</button>
            <button class="btn btn-danger btn-sm" onclick="cancelRobotForm()">Cancelar</button>
          </div>
          <div id="robotFormErr" style="color:var(--red);font-size:12px;margin-top:8px;display:none;"></div>
        </div>

      </div>
    </div>

    <!-- ADMINS TAB -->
    <div id="adminTabAdmins" style="display:none;">
      <div style="max-width:600px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <h2 style="font-size:16px;font-weight:900;">üë• Administradores</h2>
          <button class="btn btn-success btn-sm" onclick="openAdminForm()">+ Novo Admin</button>
        </div>
        <div id="adminList" style="display:flex;flex-direction:column;gap:10px;"></div>

        <div class="card" id="adminFormCard" style="display:none;margin-top:16px;">
          <div style="font-size:13px;font-weight:900;margin-bottom:14px;">‚ûï NOVO ADMINISTRADOR</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="field"><label>Usu√°rio</label><input type="text" id="afUser" placeholder="nome_usuario"></div>
            <div class="field"><label>Senha</label><input type="password" id="afPass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div class="field"><label>Confirmar Senha</label><input type="password" id="afPass2" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
            <div style="display:flex;gap:10px;">
              <button class="btn btn-primary btn-sm" onclick="saveAdmin()">Salvar</button>
              <button class="btn btn-danger btn-sm" onclick="document.getElementById('adminFormCard').style.display='none'">Cancelar</button>
            </div>
            <div id="adminFormErr" style="color:var(--red);font-size:12px;display:none;"></div>
          </div>
        </div>
      </div>
    </div>


    <!-- BRAND TAB -->
    <div id="adminTabBrand" style="display:none;">
      <div style="max-width:700px;">
        <h2 style="font-size:16px;font-weight:900;margin-bottom:20px;">üé® Personaliza√ß√£o da Marca</h2>

        <div class="card" style="margin-bottom:16px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">üè∑Ô∏è IDENTIDADE</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div class="field" style="grid-column:1/-1;">
              <label>Nome do Sistema</label>
              <input type="text" id="brandName" placeholder="Ex: ALPHA TRADER SYSTEM" maxlength="40">
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Slogan / Subt√≠tulo</label>
              <input type="text" id="brandSlogan" placeholder="Ex: OPERA√á√ïES AUTOMATIZADAS DE ALTA PERFORMANCE" maxlength="60">
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>√çcone / Emoji da Marca</label>
              <input type="text" id="brandIcon" placeholder="Ex: üöÄ ou ‚ö° ou üíé" maxlength="4"
                style="font-size:24px;width:80px;text-align:center;">
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:16px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">üñºÔ∏è LOGOTIPO</div>
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
            <div id="brandLogoPreview" style="width:80px;height:80px;border-radius:12px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:32px;background:var(--surface2);">
              <span id="brandLogoEmoji">‚ö°</span>
              <img id="brandLogoImg" style="display:none;width:100%;height:100%;object-fit:contain;border-radius:10px;">
            </div>
            <div style="flex:1;">
              <div class="field" style="margin-bottom:8px;">
                <label>URL da imagem (PNG/JPG/SVG)</label>
                <input type="text" id="brandLogoUrl" placeholder="https://..." oninput="previewLogo()">
              </div>
              <div style="font-size:10px;color:var(--dim);">Cole a URL de uma imagem hospedada (Imgur, Google Drive p√∫blico, etc)</div>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:16px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">üé® CORES</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div class="field">
              <label>Cor de Destaque (Accent)</label>
              <div style="display:flex;align-items:center;gap:8px;">
                <input type="color" id="brandAccent" value="#00d4ff" style="width:48px;height:36px;border:none;background:none;cursor:pointer;padding:0;">
                <input type="text" id="brandAccentHex" value="#00d4ff" maxlength="7" style="width:90px;font-family:'Share Tech Mono',monospace;"
                  oninput="syncColor('brandAccent','brandAccentHex')">
                <div id="brandAccentPreview" class="color-preview" style="background:#00d4ff;"></div>
              </div>
            </div>
            <div class="field">
              <label>Cor Secund√°ria (Gold)</label>
              <div style="display:flex;align-items:center;gap:8px;">
                <input type="color" id="brandGold" value="#ffb800" style="width:48px;height:36px;border:none;background:none;cursor:pointer;padding:0;">
                <input type="text" id="brandGoldHex" value="#ffb800" maxlength="7" style="width:90px;font-family:'Share Tech Mono',monospace;"
                  oninput="syncColor('brandGold','brandGoldHex')">
                <div id="brandGoldPreview" class="color-preview" style="background:#ffb800;"></div>
              </div>
            </div>
          </div>
          <div style="margin-top:12px;">
            <div style="font-size:10px;color:var(--dim);margin-bottom:8px;">Presets r√°pidos:</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <button class="btn btn-sm" style="background:#00d4ff22;border:1px solid #00d4ff;color:#00d4ff;" onclick="applyPreset('#00d4ff','#ffb800')">‚ö° Padr√£o</button>
              <button class="btn btn-sm" style="background:#7c3aed22;border:1px solid #7c3aed;color:#a78bfa;" onclick="applyPreset('#a78bfa','#f59e0b')">üíú Roxo</button>
              <button class="btn btn-sm" style="background:#059669;border:1px solid #10b981;color:#10b981;" onclick="applyPreset('#10b981','#f59e0b')">üíö Verde</button>
              <button class="btn btn-sm" style="background:#dc262622;border:1px solid #ef4444;color:#ef4444;" onclick="applyPreset('#ef4444','#f97316')">üî¥ Vermelho</button>
              <button class="btn btn-sm" style="background:#0ea5e922;border:1px solid #0ea5e9;color:#0ea5e9;" onclick="applyPreset('#0ea5e9','#06b6d4')">üîµ Azul</button>
              <button class="btn btn-sm" style="background:#f59e0b22;border:1px solid #f59e0b;color:#f59e0b;" onclick="applyPreset('#f59e0b','#ef4444')">üü° Ouro</button>
            </div>
          </div>
        </div>

        <div class="card" style="margin-bottom:16px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">üìû CONTATO & SUPORTE</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
            <div class="field">
              <label>WhatsApp de Suporte</label>
              <input type="text" id="brandWhatsapp" placeholder="Ex: +55 11 99999-9999">
            </div>
            <div class="field">
              <label>Telegram</label>
              <input type="text" id="brandTelegram" placeholder="Ex: @suaempresa">
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Site / Link de Vendas</label>
              <input type="text" id="brandWebsite" placeholder="https://seusite.com">
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label>Mensagem de boas-vindas (exibida no login)</label>
              <textarea id="brandWelcome" rows="2" placeholder="Ex: Bem-vindo ao sistema mais avan√ßado de trading automatizado!"
                style="resize:vertical;font-family:'Share Tech Mono',monospace;font-size:12px;"></textarea>
            </div>
          </div>
        </div>

        <div style="display:flex;gap:12px;">
          <button class="btn btn-primary" onclick="saveBrand()" style="flex:1;">üíæ SALVAR E APLICAR MARCA</button>
          <button class="btn btn-sm" onclick="resetBrand()" style="color:var(--dim);border:1px solid var(--border);">‚Ü∫ Restaurar Padr√£o</button>
        </div>
        <div id="brandSaveMsg" style="display:none;text-align:center;padding:10px;color:var(--green);font-size:12px;margin-top:8px;"></div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /screenAdmin -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     SCREEN 3: DASHBOARD (TRADER)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="screenDashboard" class="screen">
  <!-- Ping alert banner -->
  <div id="pingAlert">
    <div style="font-size:18px;margin-bottom:4px;">‚ö†Ô∏è PING ALTO ‚Äî INSTABILIDADE</div>
    <div id="pingAlertMsg" style="font-size:12px;color:#c8e6f5;"></div>
    <div style="font-size:10px;color:var(--dim);margin-top:6px;">Opera√ß√£o pode ser pulada para evitar entrada em momento ruim</div>
  </div>

  <div class="topnav">
    <div class="topnav-brand" id="dashTopnavBrand">‚ö° DERIV ROBO SYSTEM</div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
      <!-- Ping indicator -->
      <div class="ping-box" id="pingBox">
        <div class="ping-dot" id="pingDot"></div>
        <div>
          <div class="ping-val" id="pingVal">‚Äî</div>
          <div class="ping-label">PING (ms)</div>
        </div>
      </div>
      <button class="nav-pill" onclick="showScreen('screenAdmin')" id="btnAdminNav" style="display:none;">üõ†Ô∏è Admin</button>

      <!-- Profile icon with dropdown -->
      <div id="profileDropdownWrap">
        <button class="profile-btn" id="profileBtn" onclick="toggleProfileDropdown()" title="Perfil e conta Deriv">
          üë§
        </button>
        <div class="profile-dropdown" id="profileDropdown">

          <!-- User info -->
          <div class="profile-dropdown-header">
            <div style="font-size:13px;font-weight:700;" id="pdUserName">‚Äî</div>
            <div style="font-size:11px;color:var(--dim);margin-top:2px;" id="pdUserEmail">‚Äî</div>
            <div style="font-size:10px;color:var(--gold);margin-top:4px;" id="pdUserPlan">Plano Free</div>
          </div>

          <!-- Deriv connection -->
          <div class="profile-dropdown-section">
            <div class="pd-label">CONTA DERIV</div>
            <div class="deriv-status-badge" id="pdDerivBadge">
              <div class="deriv-status-dot" id="pdDerivDot"></div>
              <div style="flex:1;">
                <div style="font-size:12px;font-weight:700;" id="pdDerivId">N√£o conectada</div>
                <div style="font-size:10px;color:var(--dim);" id="pdDerivType"></div>
              </div>
            </div>

            <!-- Connect / Disconnect buttons -->
            <div id="pdDerivConnect">
              <button class="btn btn-primary" onclick="openDerivConnectModal()"
                style="width:100%;padding:10px;font-size:12px;display:flex;align-items:center;justify-content:center;gap:8px;">
                üîó CONECTAR COM DERIV
              </button>
            </div>
            <div id="pdDerivDisconnect" style="display:none;">
              <button onclick="disconnectDeriv()"
                style="width:100%;background:none;border:1px solid var(--border);border-radius:6px;color:var(--dim);font-size:11px;padding:8px;cursor:pointer;">
                ‚úï Desconectar conta Deriv
              </button>
            </div>
          </div>

          <!-- Logout -->
          <div style="padding:0 16px 16px;">
            <button onclick="alphaLogout()"
              style="width:100%;background:rgba(255,59,107,.1);border:1px solid rgba(255,59,107,.3);border-radius:8px;color:var(--red);font-size:12px;padding:9px;cursor:pointer;letter-spacing:1px;">
              ‚èè SAIR DO SISTEMA
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ACCOUNT BAR (top strip) -->
  <div class="acc-bar" id="accBar" style="display:none;border-radius:0;border-left:none;border-right:none;border-top:none;">
    <div class="acc-info">
      <div class="acc-field">
        <span class="acc-field-label">CONTA</span>
        <span class="acc-field-val mono" id="accLoginIdD" style="color:var(--accent);">‚Äî</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">TIPO</span>
        <span class="acc-field-val" id="accTypeD">‚Äî</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">SALDO</span>
        <span class="acc-field-val mono" id="accBalanceD" style="color:var(--green);">‚Äî</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">MERCADO</span>
        <span class="acc-field-val mono" id="accMarketD" style="color:var(--text);">‚Äî</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">ESTRAT√âGIA</span>
        <span class="acc-field-val mono" id="accStratD" style="color:var(--gold);">‚Äî</span>
      </div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <div id="autoTradeIndicator" style="width:10px;height:10px;border-radius:50%;background:var(--dim);"></div>
      <span id="autoTradeLabel" style="font-size:11px;font-family:'Share Tech Mono',monospace;color:var(--dim);">ROB√î PARADO</span>
    </div>
  </div>

  <div class="dash-wrapper">
    <!-- ‚ïê‚ïê‚ïê LEFT PANEL ‚ïê‚ïê‚ïê -->
    <div class="dash-left">

        <!-- ‚îÄ‚îÄ BOLETA DE OPERA√á√ÉO ‚îÄ‚îÄ -->
        <div class="card">
          <div style="font-size:11px;letter-spacing:2px;color:var(--gold);font-family:'Share Tech Mono',monospace;margin-bottom:14px;">üíº BOLETA DE OPERA√á√ÉO</div>

          <!-- Robot dropdown selector -->
          <div class="field" style="margin-bottom:12px;">
            <label>Rob√¥ / Modo</label>
            <div class="robot-dropdown" id="robotDropdown">
              <button class="robot-dropdown-btn" id="robotDropdownBtn" onclick="toggleRobotDropdown()">
                <span class="rdb-name" id="robotDropdownLabel">‚ö° Selecione um rob√¥...</span>
                <span class="rdb-arrow">‚ñº</span>
              </button>
              <div class="robot-dropdown-menu" id="robotDropdownMenu">
                <!-- populated by renderRobotSelectorList() -->
              </div>
            </div>
          </div>

          <!-- Manual mode fields (shown only when manual selected) -->
          <div class="manual-fields" id="manualFields">
            <div class="form-grid-2" style="gap:10px;">
              <div class="field">
                <label>Estrat√©gia</label>
                <select id="manualStrategy" onchange="applyBoleta()">
                  <option value="over0">Over 0 ¬∑ 90%</option>
                  <option value="over1">Over 1 ¬∑ 80%</option>
                  <option value="over2">Over 2 ¬∑ 70%</option>
                  <option value="over3" selected>Over 3 ¬∑ 60%</option>
                  <option value="over4">Over 4 ¬∑ 50%</option>
                  <option value="over5">Over 5 ¬∑ 40%</option>
                  <option value="over6">Over 6 ¬∑ 30%</option>
                  <option value="over7">Over 7 ¬∑ 20%</option>
                  <option value="over8">Over 8 ¬∑ 10%</option>
                  <option value="under1">Under 1 ¬∑ 10%</option>
                  <option value="under2">Under 2 ¬∑ 20%</option>
                  <option value="under3">Under 3 ¬∑ 30%</option>
                  <option value="under4">Under 4 ¬∑ 40%</option>
                  <option value="under5">Under 5 ¬∑ 50%</option>
                  <option value="under6">Under 6 ¬∑ 60%</option>
                  <option value="under7">Under 7 ¬∑ 70%</option>
                  <option value="under8">Under 8 ¬∑ 80%</option>
                  <option value="under9">Under 9 ¬∑ 90%</option>
                </select>
              </div>
              <div class="field">
                <label>Losses Virtuais</label>
                <select id="manualVirtual" onchange="applyBoleta();updateVdots();">
                  <option value="2">2 losses</option>
                  <option value="3">3 losses</option>
                  <option value="4">4 losses</option>
                  <option value="5" selected>5 losses</option>
                  <option value="6">6 losses</option>
                </select>
              </div>
              <div class="field">
                <label>Fator Martingale</label>
                <input type="number" id="manualFactor" value="2.8" min="1.1" max="5" step="0.1" oninput="applyBoleta()">
              </div>
              <div class="field">
                <label>N√≠veis M√°x.</label>
                <input type="number" id="manualLevels" value="5" min="1" max="8" step="1" oninput="applyBoleta()">
              </div>
            </div>
          </div>

          <!-- Common boleta fields -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;margin-top:4px;">
            <div class="field">
              <label>Mercado</label>
              <select id="boletaMarket" onchange="applyBoleta()">
                <option value="R_100">Volatility 100</option>
                <option value="R_10">Volatility 10</option>
                <option value="R_25">Volatility 25</option>
                <option value="R_50">Volatility 50</option>
                <option value="R_75">Volatility 75</option>
                <option value="1HZ100V">Vol 100 (1s)</option>
              </select>
            </div>
            <div class="field">
              <label>Entrada Base ($)</label>
              <input type="number" id="boletaEntry" value="0.35" min="0.35" step="0.05" oninput="applyBoleta()">
            </div>
            <div class="field">
              <label>Stop Gain ($)</label>
              <input type="number" id="boletaSG" value="20" min="0.50" step="0.50" oninput="applyBoleta()">
            </div>
            <div class="field">
              <label>Stop Loss ($)</label>
              <input type="number" id="boletaSL" value="30" min="0.50" step="0.50" oninput="applyBoleta()">
            </div>
          </div>

          <!-- Martingale table -->
          <div id="boletaMartTable" style="background:var(--surface2);border-radius:8px;padding:10px;margin-bottom:12px;min-height:40px;">
            <div style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:Share Tech Mono,monospace;margin-bottom:6px;">TABELA MARTINGALE</div>
            <div id="martTableCells" style="display:flex;gap:5px;flex-wrap:wrap;"></div>
            <div id="martExposure" style="font-size:10px;color:var(--red);font-family:Share Tech Mono,monospace;margin-top:6px;"></div>
          </div>

          <!-- Controls inside boleta -->
          <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
            <button class="btn btn-primary" id="connectBtn" onclick="connectDash()">‚ñ∂ CONECTAR</button>
            <button class="btn" id="tradeToggleBtn" onclick="toggleAutoTrade()" style="background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;">ü§ñ INICIAR ROB√î</button>
          </div>

          <!-- Progress -->
          <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:4px;">
              <span>HIST√ìRICO COLETADO</span>
              <span id="progressText">0 d√≠gitos</span>
            </div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:100%;"></div></div>
          </div>

          <!-- PnL stats -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
            <div class="boleta-stat">
              <div class="boleta-stat-label">N√çVEL MART.</div>
              <div class="boleta-stat-val" id="bLevel" style="color:var(--gold);">‚Äî</div>
            </div>
            <div class="boleta-stat">
              <div class="boleta-stat-label">STATUS SESS√ÉO</div>
              <div class="boleta-stat-val" id="bStatus" style="font-size:13px;color:var(--dim);">AGUARDANDO</div>
            </div>
          </div>
          <div class="boleta-stat">
            <div class="boleta-stat-label">SESS√ÉO P&L</div>
            <div class="boleta-stat-val" id="bPnl" style="color:var(--green);">$0.00</div>
            <div class="pnl-bar"><div class="pnl-fill" id="pnlFill" style="width:0%;background:var(--green);"></div></div>
          </div>
        </div>
    </div><!-- /dash-left -->

    <!-- ‚ïê‚ïê‚ïê CENTER PANEL ‚ïê‚ïê‚ïê -->
    <div class="dash-center">
        <!-- Signal box -->
        <div class="signal-box">
          <div class="signal-main">
            <span style="font-size:10px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">ü§ñ SINAL DO ROB√î</span>
            <span class="signal-val aguardando" id="robotSignal">AGUARDANDO CONEX√ÉO</span>
            <span style="font-size:11px;color:var(--dim);" id="signalDesc">Conecte para iniciar</span>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
            <span style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">LOSSES VIRTUAIS</span>
            <div class="vdots" id="vdots"></div>
            <span class="mono" style="font-size:10px;color:var(--dim);" id="vdotCount">0 / 5</span>
          </div>
          <div style="text-align:right;">
            <div style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">MARTINGALE</div>
            <div style="font-size:26px;font-weight:900;font-family:'Share Tech Mono',monospace;color:var(--gold);" id="mLevel">‚Äî</div>
            <div style="font-size:13px;font-family:'Share Tech Mono',monospace;color:var(--accent);" id="mEntry">$‚Äî</div>
            <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;" id="mAccum">Acum: $‚Äî</div>
          </div>
        </div>

        <!-- Last digit + stream -->
        <div class="card" style="margin-bottom:14px;">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:10px;">
            <div style="width:64px;height:64px;border-radius:12px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;font-family:'Share Tech Mono',monospace;" id="lastDigitDisplay">‚Äî</div>
            <div>
              <div style="font-size:14px;font-weight:700;" id="lastDigitResult">‚Äî</div>
              <div style="font-size:11px;color:var(--dim);" id="lastDigitStrat">‚Äî</div>
              <div style="font-size:11px;color:var(--dim);margin-top:4px;" id="totalDigits">0 d√≠gitos</div>
            </div>
          </div>
          <div class="digit-stream" id="digitStream"></div>
        </div>

        <!-- Stats by digit -->
        <div class="stats-grid" id="freqGrid"></div>

        <!-- Over/Under Table -->
        <div class="card" style="margin-bottom:14px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:12px;">üìä TABELA OVER/UNDER</div>
          <table class="ou-table" id="ouTable"><thead><tr><th>OPERA√á√ÉO</th><th>D√çGITOS</th><th>WIN RATE</th><th>STATUS</th></tr></thead><tbody></tbody></table>
        </div>

        <!-- Martingale Reference Table -->
        <div class="card" style="margin-bottom:14px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:10px;">üìà POTENCIAL MARTINGALE ‚Äî OVER 0 a 8 ¬∑ 5 N√çVEIS</div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>Entrada ($)</label>
              <input type="number" id="martRefEntry" value="0.35" min="0.01" step="0.05"
                oninput="updateMartRefTable()"
                style="padding:6px 8px;font-size:13px;">
            </div>
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>Fator Mart.</label>
              <input type="number" id="martRefFactor" value="2.8" min="1.1" max="10" step="0.1"
                oninput="updateMartRefTable()"
                style="padding:6px 8px;font-size:13px;">
            </div>
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>N√≠veis</label>
              <select id="martRefLevels" onchange="updateMartRefTable()" style="padding:6px 8px;font-size:13px;">
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </div>
            <button onclick="syncMartRefFromBoleta()" title="Sincronizar com boleta"
              style="background:rgba(0,212,255,.1);border:1px solid rgba(0,212,255,.3);border-radius:6px;color:var(--accent);font-size:11px;padding:6px 10px;cursor:pointer;font-family:'Share Tech Mono',monospace;letter-spacing:1px;white-space:nowrap;margin-top:14px;">
              ‚ü≥ BOLETA
            </button>
          </div>
          <div class="mart-ref-section">
            <table class="mart-ref-table" id="martRefTable">
              <thead>
                <tr>
                  <th class="strat-col">ESTRAT√âGIA</th>
                  <th>PAYOUT</th>
                  <th>N1</th>
                  <th>N2</th>
                  <th>N3</th>
                  <th>N4</th>
                  <th>N5</th>
                </tr>
              </thead>
              <tbody id="martRefBody"></tbody>
            </table>
          </div>
          <div style="font-size:9px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:8px;line-height:1.6;">
            üü¢ Lucro bruto por n√≠vel &nbsp;¬∑&nbsp; üü° Lucro l√≠quido (descontando acumulado) &nbsp;¬∑&nbsp; üî¥ Preju√≠zo l√≠quido
          </div>
        </div>

        <!-- Diagnostics -->
        <div class="card" style="margin-bottom:14px;">
          <div style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:12px;">üî¨ DIAGN√ìSTICO PREDITIVO</div>
          <div class="diag-grid" id="diagGrid"></div>
        </div>

    </div><!-- /dash-center -->

    <!-- ‚ïê‚ïê‚ïê RIGHT PANEL ‚Äî LOG ‚ïê‚ïê‚ïê -->
    <div class="dash-right">
      <div class="dash-right-header">
        <span>üìã LOG DO SISTEMA</span>
        <button onclick="document.getElementById('logArea').innerHTML=''" style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--dim);font-size:9px;padding:2px 7px;cursor:pointer;letter-spacing:1px;">LIMPAR</button>
      </div>
      <div class="dash-right-log" id="logArea"></div>
    </div><!-- /dash-right -->

  </div><!-- /dash-wrapper -->
</div><!-- /screenDashboard -->

<!-- Deriv Connect Modal -->
<div id="derivConnectModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9998;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
  <div style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:360px;width:90%;position:relative;">
    <button onclick="closeDerivConnectModal()" style="position:absolute;top:12px;right:14px;background:none;border:none;color:var(--dim);font-size:18px;cursor:pointer;">‚úï</button>
    <div style="text-align:center;margin-bottom:20px;">
      <div style="font-size:28px;margin-bottom:8px;">üîó</div>
      <div style="font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent);">CONECTAR DERIV</div>
      <div style="font-size:11px;color:var(--dim);margin-top:4px;">Autorize o acesso para operar com os rob√¥s</div>
    </div>

    <!-- Token manual ‚Äî padr√£o enquanto OAuth App ID n√£o est√° registrado -->
    <div style="display:flex;flex-direction:column;gap:10px;">
      <div class="field" style="margin:0;"><label>Login ID Deriv</label>
        <input type="text" id="derivLoginId" placeholder="Ex: VRTC1659209 ou CR123456">
      </div>
      <div class="field" style="margin:0;"><label>API Token</label>
        <input type="password" id="derivToken" placeholder="Cole seu token aqui" oninput="showTokenHint(this)">
        <span id="tokenHint" style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:3px;display:block;"></span>
        <div style="font-size:10px;color:var(--dim);margin-top:4px;">
          Gere em <a href="https://app.deriv.com/account/api-token" target="_blank"
          style="color:var(--accent);">app.deriv.com ‚Üí API Token</a> com permiss√µes Read + Trade
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
        <div class="field" style="margin:0;"><label>Tipo de Conta</label>
          <select id="derivAccType">
            <option value="demo">üìä Demo</option>
            <option value="real">üí∞ Real</option>
          </select>
        </div>
        <div class="field" style="margin:0;"><label>App ID</label>
          <input type="text" id="derivAppId" value="128505">
        </div>
      </div>
      <button class="btn btn-primary" onclick="loginTrader()" style="padding:12px;font-size:13px;">
        üîó CONECTAR CONTA DERIV
      </button>
    </div>
    <div id="traderLoginErr" style="color:var(--red);font-size:12px;text-align:center;display:none;margin-top:8px;"></div>

    <!-- OAuth ‚Äî dispon√≠vel quando App ID registrado -->
    <details style="margin-top:12px;">
      <summary style="font-size:10px;color:var(--dim);cursor:pointer;list-style:none;text-align:center;letter-spacing:1px;">
        üîê Usar OAuth (requer App ID registrado na Deriv)
      </summary>
      <div style="margin-top:10px;">
        <button class="btn btn-sm" onclick="loginWithDeriv()"
          style="width:100%;padding:10px;font-size:12px;background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.3);color:var(--accent);">
          Entrar com Deriv (OAuth)
        </button>
        <div id="oauthStatus" style="display:none;text-align:center;padding:8px;border-radius:8px;margin-top:8px;
          background:rgba(0,212,255,.08);border:1px solid rgba(0,212,255,.2);">
          <div style="font-size:12px;color:var(--accent);" id="oauthStatusMsg">Aguardando...</div>
        </div>
      </div>
    </details>
  </div>
</div>

<!-- OAuth waiting overlay -->
<div id="oauthOverlay">
  <div class="oauth-modal">
    <div style="font-size:32px;margin-bottom:12px;">‚ö°</div>
    <div style="font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent);margin-bottom:8px;" id="oauthModalTitle">AUTORIZANDO...</div>
    <div class="oauth-spinner"></div>
    <div style="font-size:12px;color:var(--dim);margin-top:12px;" id="oauthModalMsg">Aguardando autoriza√ß√£o na janela da Deriv</div>
    <button onclick="cancelOAuth()" style="margin-top:20px;background:none;border:1px solid var(--border);color:var(--dim);border-radius:8px;padding:8px 20px;cursor:pointer;font-size:12px;">Cancelar</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STORAGE ‚Äî persistent robots & admins
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function store(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); } catch(e){} }
function load(k, def){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch(e){ return def; } }

// Default admin
let admins = load('drv_admins', [{ user: 'admin', pass: btoa('admin123') }]);
const DEFAULT_ROBOTS = [
  {
    "id": "robot_gladiador",
    "name": "GLADIADOR",
    "desc": "Over 3 equilibrado. 60% win rate. Fator 2.8 calculado ‚Äî lucro garantido em todos os 4 n√≠veis. Entrada ap√≥s 3 losses virtuais. Ideal para opera√ß√£o di√°ria.",
    "strategy": "over3",
    "virtualLosses": 3,
    "entry": 0.35,
    "factor": 2.8,
    "levels": 4,
    "running": true,
    "createdAt": 1700000001000
  },
  {
    "id": "robot_sniper",
    "name": "SNIPER",
    "desc": "Over 5 seletivo. Payout ~123%. Fator 1.8 ‚Äî cada n√≠vel garante ~$0.40 l√≠quido. Aguarda 5 losses virtuais. Menor exposi√ß√£o, alta seletividade.",
    "strategy": "over5",
    "virtualLosses": 5,
    "entry": 0.35,
    "factor": 1.8,
    "levels": 5,
    "running": true,
    "createdAt": 1700000002000
  },
  {
    "id": "robot_titan",
    "name": "TITAN",
    "desc": "Over 4 ativo. 50% win rate. Fator 2.2 garante lucro crescente por n√≠vel. 2 losses virtuais = alta frequ√™ncia de entradas.",
    "strategy": "over4",
    "virtualLosses": 2,
    "entry": 0.35,
    "factor": 2.2,
    "levels": 5,
    "running": true,
    "createdAt": 1700000003000
  },
  {
    "id": "robot_conservador",
    "name": "CONSERVADOR",
    "desc": "Over 2 ‚Äî 70% win rate mas payout 22%. Fator 5.5 necess√°rio para cobrir perdas em 3 n√≠veis. Exposi√ß√£o sobe rapidamente ‚Äî use com cautela.",
    "strategy": "over2",
    "virtualLosses": 4,
    "entry": 0.35,
    "factor": 5.5,
    "levels": 3,
    "running": true,
    "createdAt": 1700000004000
  },
  {
    "id": "robot_cacador",
    "name": "CA√áADOR",
    "desc": "Under 4 contrarian. Payout ~150%. Fator 1.6 ‚Äî lucro l√≠quido positivo em todos os 5 n√≠veis. Complementa estrat√©gias Over.",
    "strategy": "under4",
    "virtualLosses": 4,
    "entry": 0.35,
    "factor": 1.6,
    "levels": 5,
    "running": true,
    "createdAt": 1700000005000
  },
  {
    "id": "robot_equilibrio",
    "name": "EQUIL√çBRIO",
    "desc": "Over 3 seguro. Apenas 3 n√≠veis. Fator 2.7 garante lucro m√≠nimo em cada n√≠vel. Para iniciantes ou preserva√ß√£o de capital.",
    "strategy": "over3",
    "virtualLosses": 4,
    "entry": 0.35,
    "factor": 2.7,
    "levels": 3,
    "running": true,
    "createdAt": 1700000006000
  },
  {
    "id": "robot_agressor",
    "name": "AGRESSOR",
    "desc": "Over 6 alto retorno. Payout 240%. Fator 1.3 ‚Äî lucro l√≠quido $0.84 no N1 at√© $0.23 no N5. Aguarda 6 losses virtuais.",
    "strategy": "over6",
    "virtualLosses": 6,
    "entry": 0.35,
    "factor": 1.3,
    "levels": 5,
    "running": true,
    "createdAt": 1700000007000
  },
  {
    "id": "robot_surfista",
    "name": "SURFISTA",
    "desc": "Under 5 sim√©trico. Fator 2.2 igual ao TITAN. Alternativa Under para diversificar dire√ß√£o de entrada.",
    "strategy": "under5",
    "virtualLosses": 3,
    "entry": 0.35,
    "factor": 2.2,
    "levels": 5,
    "running": true,
    "createdAt": 1700000008000
  }
];
let robots = load('drv_robots', null);
// Always sync default robots ‚Äî update factor/levels on existing pre-built ones, preserve user-created
{
  const stored = robots || [];
  const prebuiltIds = DEFAULT_ROBOTS.map(function(r){ return r.id; });
  const userRobots = stored.filter(function(r){ return !prebuiltIds.includes(r.id); });
  const merged = DEFAULT_ROBOTS.map(function(def){
    const existing = stored.find(function(r){ return r.id === def.id; });
    if(existing){ const copy = Object.assign({}, def); copy.running = existing.running; return copy; }
    return Object.assign({}, def);
  });
  robots = merged.concat(userRobots);
  store('drv_robots', robots);
}
let currentUser = null; // { user, isAdmin }
let editingRobotId = null;
let selectedRobot = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ALPHA AUTH (Supabase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE DROPDOWN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleProfileDropdown(){
  const dd = document.getElementById('profileDropdown');
  if(dd) dd.classList.toggle('open');
}
function closeProfileDropdown(){
  const dd = document.getElementById('profileDropdown');
  if(dd) dd.classList.remove('open');
}
// Close on outside click
document.addEventListener('click', function(e){
  const wrap = document.getElementById('profileDropdownWrap');
  if(wrap && !wrap.contains(e.target)) closeProfileDropdown();
});

function updateProfileDropdown(){
  const user = window._alphaUser;
  if(!user) return;
  // Header
  const nameEl  = document.getElementById('pdUserName');
  const emailEl = document.getElementById('pdUserEmail');
  const planEl  = document.getElementById('pdUserPlan');
  if(nameEl)  nameEl.textContent  = user.name || user.email;
  if(emailEl) emailEl.textContent = user.email;
  if(planEl)  planEl.textContent  = 'Plano ' + (user.plan === 'free' ? 'Free' : user.plan === 'pro' ? '‚≠ê Pro' : user.plan);

  // Deriv status
  const dot        = document.getElementById('pdDerivDot');
  const derivIdEl  = document.getElementById('pdDerivId');
  const derivType  = document.getElementById('pdDerivType');
  const btnConnect = document.getElementById('pdDerivConnect');
  const btnDisc    = document.getElementById('pdDerivDisconnect');
  const profileBtn = document.getElementById('profileBtn');

  if(derivAccount){
    if(dot)        { dot.classList.add('connected'); }
    if(derivIdEl)  derivIdEl.textContent = derivAccount.loginid;
    if(derivType)  derivType.textContent = derivAccount.isVirtual ? 'üìä Conta Demo' : 'üí∞ Conta Real';
    if(btnConnect) btnConnect.style.display='none';
    if(btnDisc)    btnDisc.style.display='block';
    if(profileBtn) profileBtn.classList.add('deriv-connected');
    profileBtn.title = 'Deriv: ' + derivAccount.loginid;
  } else {
    if(dot)        { dot.classList.remove('connected'); }
    if(derivIdEl)  derivIdEl.textContent = 'N√£o conectada';
    if(derivType)  derivType.textContent = '';
    if(btnConnect) btnConnect.style.display='block';
    if(btnDisc)    btnDisc.style.display='none';
    if(profileBtn) profileBtn.classList.remove('deriv-connected');
    profileBtn.title = 'Conectar Deriv';
  }
}

function openDerivConnectModal(){
  closeProfileDropdown();
  const m = document.getElementById('derivConnectModal');
  if(m) m.style.display='flex';
}
function closeDerivConnectModal(){
  const m = document.getElementById('derivConnectModal');
  if(m) m.style.display='none';
}

function disconnectDeriv(){
  if(!confirm('Desconectar conta Deriv? O rob√¥ ser√° parado.')) return;
  if(ws) disconnectDash();
  derivAccount = null;
  updateProfileDropdown();
  closeProfileDropdown();
  log('üîå Conta Deriv desconectada.', 'warning');
}

function switchAlphaTab(tab){
  ['login','signup','admin'].forEach(t=>{
    const panel = document.getElementById('panelAlpha' + t.charAt(0).toUpperCase() + t.slice(1))
               || document.getElementById('panelAdminLogin');
    const btn   = document.getElementById('tabAlpha' + t.charAt(0).toUpperCase() + t.slice(1));
    if(t==='admin'){
      const p = document.getElementById('panelAdminLogin');
      if(p) p.style.display = tab===t ? 'block' : 'none';
    } else {
      if(panel) panel.style.display = tab===t ? 'block' : 'none';
    }
    if(btn) btn.classList.toggle('active', tab===t);
  });
}

async function alphaLogin(){
  const email = document.getElementById('alphaLoginEmail')?.value.trim();
  const pass  = document.getElementById('alphaLoginPass')?.value;
  const err   = document.getElementById('alphaLoginErr');
  if(!email||!pass){ err.textContent='Preencha e-mail e senha.'; err.style.display='block'; return; }
  err.style.display='none';

  // Wait for Supabase to initialize (max 3s)
  let attempts = 0;
  while(!window._sb && attempts < 30){
    await new Promise(r => setTimeout(r, 100));
    attempts++;
  }
  if(!window._sb){
    err.textContent='Erro de conex√£o. Recarregue a p√°gina e tente novamente.';
    err.style.display='block';
    return;
  }

  // Show loading
  const btn = document.querySelector('#panelAlphaLogin .btn-primary');
  if(btn){ btn.textContent='Aguarde...'; btn.disabled=true; }

  let loginResult;
  try {
    loginResult = await window._sb.auth.signInWithPassword({ email, password: pass });
  } catch(e) {
    if(btn){ btn.textContent='‚ñ∂ ENTRAR'; btn.disabled=false; }
    err.textContent = 'Erro inesperado: ' + e.message;
    err.style.display='block';
    console.error('Login error:', e);
    return;
  }

  if(btn){ btn.textContent='‚ñ∂ ENTRAR'; btn.disabled=false; }

  const { data, error } = loginResult;
  if(error){
    const msgs = {
      'Invalid login credentials':      'E-mail ou senha incorretos.',
      'Email not confirmed':            'Confirme seu e-mail antes de entrar.',
      'Too many requests':              'Muitas tentativas. Aguarde alguns minutos.',
      'User not found':                 'E-mail n√£o cadastrado.',
    };
    err.textContent = msgs[error.message] || ('Erro: ' + error.message);
    err.style.display='block';
    console.error('Supabase error:', error);
    return;
  }

  // Login OK ‚Äî manually navigate (don't rely solely on onAuthStateChange)
  if(data?.user){
    console.log('‚úÖ Login OK:', data.user.email);
    if(data.session){
      sessionStorage.setItem('alpha_session', JSON.stringify({
        access_token:  data.session.access_token,
        refresh_token: data.session.refresh_token
      }));
    }
    try {
      const { data: profile } = await window._sb
        .from('profiles')
        .select('name, plan')
        .eq('id', data.user.id)
        .single();

      window._alphaUser = {
        uid:   data.user.id,
        email: data.user.email,
        name:  profile?.name || data.user.email.split('@')[0],
        plan:  profile?.plan || 'free',
      };
    } catch(e) {
      window._alphaUser = {
        uid:   data.user.id,
        email: data.user.email,
        name:  data.user.email.split('@')[0],
        plan:  'free',
      };
    }
    window._onAlphaLogin && window._onAlphaLogin(window._alphaUser);
  }
}

async function alphaSignup(){
  const name  = document.getElementById('alphaSignupName')?.value.trim();
  const email = document.getElementById('alphaSignupEmail')?.value.trim();
  const pass  = document.getElementById('alphaSignupPass')?.value;
  const err   = document.getElementById('alphaSignupErr');
  if(!name){  err.textContent='Informe seu nome.'; err.style.display='block'; return; }
  if(!email){ err.textContent='Informe o e-mail.'; err.style.display='block'; return; }
  if(!pass || pass.length < 6){ err.textContent='Senha deve ter m√≠nimo 6 caracteres.'; err.style.display='block'; return; }
  err.style.display='none';

  if(!window._sb){ err.textContent='Supabase n√£o inicializado ‚Äî configure as credenciais.'; err.style.display='block'; return; }

  // 1. Create auth user
  const { data, error } = await window._sb.auth.signUp({ email, password: pass });
  if(error){
    const msgs = {
      'User already registered': 'E-mail j√° cadastrado. Fa√ßa login.',
      'Password should be at least 6 characters': 'Senha deve ter m√≠nimo 6 caracteres.',
    };
    err.textContent = msgs[error.message] || error.message;
    err.style.display='block';
    return;
  }

  // 2. Insert profile into public.profiles table
  if(data?.user){
    await window._sb.from('profiles').upsert({
      id:         data.user.id,
      name:       name,
      email:      email,
      plan:       'free',
      created_at: new Date().toISOString()
    });
  }

  err.style.display='none';
  // Show confirmation message if email confirmation required
  const confirmMsg = document.getElementById('alphaSignupErr');
  confirmMsg.style.color='var(--green)';
  confirmMsg.textContent='‚úÖ Conta criada! Verifique seu e-mail para confirmar o cadastro.';
  confirmMsg.style.display='block';
  // onAuthStateChange handles navigation if email confirmation is disabled
}

async function alphaLogout(){
  if(ws) disconnectDash();
  derivAccount = null; currentUser = null;
  if(window._sb) await window._sb.auth.signOut();
  sessionStorage.removeItem('alpha_session');
  window._alphaUser = null;
  closeProfileDropdown();
  document.getElementById('panelAlphaAuth').style.display='block';
  showScreen('screenLogin');
}

// Called by Supabase onAuthStateChange when user logs in
window._onAlphaLogin = function(user){
  // Go straight to dashboard
  updateProfileDropdown();
  // If Deriv already connected keep it, otherwise show disconnected state
  if(!derivAccount){
    document.getElementById('pdDerivConnect').style.display='block';
    document.getElementById('pdDerivDisconnect').style.display='none';
  }
  showScreen('screenDashboard');
};

window._onAlphaLogout = function(){
  document.getElementById('panelAlphaAuth').style.display='block';
  showScreen('screenLogin');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LEGACY ‚Äî keep for admin tab
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchLoginTab(tab){
  // Kept for compatibility ‚Äî Alpha system uses switchAlphaTab()
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DERIV OAUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// How it works:
// 1. Open Deriv OAuth URL in popup window
// 2. Deriv redirects back to this page with ?token1=...&acct1=...
// 3. We detect the redirect via popup URL polling OR via URL params on load
// 4. Extract tokens and auto-login

const DERIV_APP_ID = '128505'; // Replace with your registered App ID for production
const DERIV_OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${DERIV_APP_ID}&l=pt&brand=deriv`;

let oauthPopup = null;
let oauthPollTimer = null;

function loginWithDeriv(){
  // Check if we already have tokens in URL (redirect flow)
  const params = new URLSearchParams(window.location.search);
  if(params.get('token1')){
    handleOAuthCallback(params);
    return;
  }

  // Open popup
  const w=600, h=700;
  const left=(screen.width-w)/2, top=(screen.height-h)/2;
  oauthPopup = window.open(
    DERIV_OAUTH_URL,
    'DerivAuth',
    `width=${w},height=${h},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes`
  );

  if(!oauthPopup || oauthPopup.closed){
    // Popup blocked ‚Äî fallback to redirect
    showOAuthStatus('‚ö†Ô∏è Popup bloqueado. Redirecionando...');
    setTimeout(()=>{ window.location.href = DERIV_OAUTH_URL + '&redirect_uri=' + encodeURIComponent(window.location.href); }, 1000);
    return;
  }

  // Show overlay
  document.getElementById('oauthOverlay').classList.add('show');
  document.getElementById('oauthModalMsg').textContent = 'Complete o login na janela da Deriv que abriu';

  // Recebe tokens via localStorage (funciona mesmo sem window.opener)
  function onStorageOAuth(e){
    if(e.key !== 'deriv_oauth_callback' || !e.newValue) return;
    window.removeEventListener('storage', onStorageOAuth);
    clearInterval(oauthPollTimer);
    const search = e.newValue;
    localStorage.removeItem('deriv_oauth_callback');
    if(oauthPopup && !oauthPopup.closed) oauthPopup.close();
    oauthPopup = null;
    handleOAuthCallback(new URLSearchParams(search));
  }
  window.addEventListener('storage', onStorageOAuth);

  // Poll popup URL for callback (fallback)
  oauthPollTimer = setInterval(()=>{
    try{
      if(!oauthPopup || oauthPopup.closed){
        clearInterval(oauthPollTimer);
        document.getElementById('oauthOverlay').classList.remove('show');
        return;
      }
      const popupUrl = oauthPopup.location.href;
      if(popupUrl && popupUrl.includes('token1=')){
        clearInterval(oauthPollTimer);
        const popupParams = new URLSearchParams(new URL(popupUrl).search);
        oauthPopup.close();
        oauthPopup = null;
        handleOAuthCallback(popupParams);
      }
    }catch(e){
      // Cross-origin ‚Äî popup is on deriv.com, can't read URL yet (normal)
    }
  }, 500);
}

function handleOAuthCallback(params){
  document.getElementById('oauthOverlay').classList.remove('show');
  clearInterval(oauthPollTimer);

  // Deriv returns: acct1=VRTC..., token1=..., cur1=USD, acct2=CR..., token2=..., cur2=USD
  const accounts = [];
  let i = 1;
  while(params.get('acct'+i)){
    accounts.push({
      loginid:  params.get('acct'+i),
      token:    params.get('token'+i),
      currency: params.get('cur'+i) || 'USD',
      isVirtual: params.get('acct'+i).startsWith('VR') || params.get('acct'+i).startsWith('VRTC')
    });
    i++;
  }

  if(!accounts.length){
    showOAuthError('Nenhuma conta encontrada na resposta da Deriv.');
    return;
  }

  // Clean URL (remove tokens from address bar)
  window.history.replaceState({}, document.title, window.location.pathname);

  // If multiple accounts ‚Äî let user pick
  if(accounts.length > 1){
    showAccountPicker(accounts);
  } else {
    finishOAuthLogin(accounts[0]);
  }
}

function showAccountPicker(accounts){
  const overlay = document.getElementById('oauthOverlay');
  overlay.classList.add('show');
  document.getElementById('oauthModalTitle').textContent = 'SELECIONE A CONTA';
  document.getElementById('oauthModalMsg').textContent = '';
  document.querySelector('.oauth-spinner').style.display='none';

  const modal = document.querySelector('.oauth-modal');
  // Remove existing picker if any
  const old = modal.querySelector('.account-picker');
  if(old) old.remove();

  const picker = document.createElement('div');
  picker.className = 'account-picker';
  picker.style.cssText='display:flex;flex-direction:column;gap:8px;margin-top:12px;';
  accounts.forEach(acc=>{
    const badge = acc.isVirtual ? 'üìä DEMO' : 'üí∞ REAL';
    const color = acc.isVirtual ? 'var(--accent)' : 'var(--gold)';
    const btn = document.createElement('button');
    btn.style.cssText=`background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;color:var(--text);font-family:'Share Tech Mono',monospace;`;
    btn.innerHTML=`<span style="font-weight:700;">${acc.loginid}</span><span style="color:${color};font-size:11px;">${badge} ¬∑ ${acc.currency}</span>`;
    btn.onmouseover=()=>btn.style.borderColor='var(--accent)';
    btn.onmouseout=()=>btn.style.borderColor='var(--border)';
    btn.onclick=()=>{ overlay.classList.remove('show'); document.querySelector('.oauth-spinner').style.display='block'; finishOAuthLogin(acc); };
    picker.appendChild(btn);
  });

  modal.appendChild(picker);
}

async function finishOAuthLogin(acc){
  document.getElementById('oauthOverlay').classList.remove('show');

  const appId = document.getElementById('derivAppId')?.value.trim() || DERIV_APP_ID;
  const alphaUser = window._alphaUser;

  currentUser = { user: alphaUser?.name || acc.loginid, isAdmin: false };
  derivAccount = {
    loginid:   acc.loginid,
    token:     acc.token,
    appId:     appId,
    accType:   acc.isVirtual ? 'demo' : 'real',
    isVirtual: acc.isVirtual,
    currency:  acc.currency
  };

  // Save Deriv connection info to Supabase (token stays local only)
  if(window._sb && alphaUser?.uid){
    try{
      await window._sb.from('profiles').update({
        deriv_login_id:      acc.loginid,
        deriv_acc_type:      acc.isVirtual ? 'demo' : 'real',
        deriv_currency:      acc.currency,
        deriv_connected_at:  new Date().toISOString()
      }).eq('id', alphaUser.uid);
    }catch(e){ console.warn('Supabase update failed', e); }
  }

  const displayName = alphaUser?.name || acc.loginid;
  closeDerivConnectModal();
  closeProfileDropdown();
  updateProfileDropdown();
  renderRobotSelectorList();
  showScreen('screenDashboard');
  log('‚úÖ Deriv conectada: ' + acc.loginid + ' (' + (acc.isVirtual?'DEMO':'REAL') + ') | ' + acc.currency, 'success');
}

function cancelOAuth(){
  clearInterval(oauthPollTimer);
  if(oauthPopup && !oauthPopup.closed) oauthPopup.close();
  oauthPopup = null;
  document.getElementById('oauthOverlay').classList.remove('show');
}

function showOAuthStatus(msg){
  const el = document.getElementById('oauthStatus');
  const msgEl = document.getElementById('oauthStatusMsg');
  if(el) el.style.display='block';
  if(msgEl) msgEl.textContent = msg;
}

function showOAuthError(msg){
  const err = document.getElementById('traderLoginErr');
  if(err){ err.textContent=msg; err.style.display='block'; }
}

// On page load ‚Äî check if this is an OAuth redirect (redirect flow fallback)
(function checkOAuthOnLoad(){
  const params = new URLSearchParams(window.location.search);
  if(params.get('token1') && params.get('acct1')){
    // Grava no localStorage para sinalizar a janela principal e fecha o popup
    localStorage.setItem('deriv_oauth_callback', window.location.search);
    window.close();
    // Fallback: se n√£o fechou (n√£o √© popup), processa como redirect na pr√≥pria janela
    setTimeout(()=>{
      localStorage.removeItem('deriv_oauth_callback');
      switchLoginTab('trader');
      handleOAuthCallback(params);
    }, 500);
  }
})();

function showTokenHint(input){
  const val = input.value.replace(/[^a-zA-Z0-9\-_]/g,'');
  const hint = document.getElementById('tokenHint');
  if(!val.length){ hint.textContent=''; return; }
  if(val.length < 15){ hint.textContent=`‚ö†Ô∏è ${val.length} chars ‚Äî parece incompleto`; hint.style.color='var(--red)'; }
  else { hint.textContent=`‚úÖ ${val.length} chars ‚Äî OK`; hint.style.color='var(--green)'; }
}

function loginAdmin(){
  const u = document.getElementById('adminUser').value.trim();
  const p = document.getElementById('adminPass').value;
  const err = document.getElementById('adminLoginErr');
  if(!err){ return; }
  const found = admins.find(a => a.user === u && a.pass === btoa(p));
  if(!found){ err.textContent='Usu√°rio ou senha incorretos.'; err.style.display='block'; return; }
  err.style.display='none';
  currentUser = { user: u, isAdmin: true };
  window._alphaUser = { uid: null, email: u, name: u, plan: 'admin' };
  safeSet('adminNavUser','textContent','üë§ ' + u);
  safeSet('btnAdminNav','style.display','inline-block');
  const btnAdmin = document.getElementById('btnAdminNav');
  if(btnAdmin) btnAdmin.style.display = 'inline-block';
  updateProfileDropdown();
  renderRobotList();
  renderAdminList();
  showScreen('screenAdmin');
}

function loginTrader(){
  const loginId = document.getElementById('derivLoginId').value.trim().toUpperCase();
  const token   = document.getElementById('derivToken').value.replace(/[^a-zA-Z0-9\-_]/g,'').trim();
  const accType = document.getElementById('derivAccType').value;
  const appId   = document.getElementById('derivAppId').value.trim() || '128505';
  const err     = document.getElementById('traderLoginErr');

  if(!loginId){ err.textContent='Informe o Login ID.'; err.style.display='block'; return; }
  if(token.length < 10){ err.textContent='Token inv√°lido ou incompleto.'; err.style.display='block'; return; }
  err.style.display='none';

  const alphaUser = window._alphaUser;
  currentUser = { user: alphaUser?.name || loginId, isAdmin: false };
  derivAccount  = { loginid: loginId, token, appId, accType, isVirtual: accType === 'demo' };

  closeDerivConnectModal();
  closeProfileDropdown();
  updateProfileDropdown();
  renderRobotSelectorList();
  showScreen('screenDashboard');
  log('‚úÖ Deriv conectada: ' + loginId + ' (' + accType.toUpperCase() + ')', 'success');
}

function safeEl(id){ return document.getElementById(id); }
function safeSet(id, prop, val){ const el=safeEl(id); if(el) el[prop]=val; }
function safeCss(id, css){ const el=safeEl(id); if(el) el.style.cssText=css; }

function logoutAll(){
  // Hard close WebSocket
  stopPing();
  if(ws){
    ws.onclose=null; ws.onerror=null; ws.onmessage=null; ws.onopen=null;
    ws.close(); ws=null;
  }
  currentUser = null; derivAccount = null; selectedRobot = null;
  digits=[]; freqMap={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
  try{ resetSessionState(); }catch(e){}
  // Reset dashboard UI safely (may not exist if coming from admin screen)
  safeSet('accBar','style','display:none');
  safeSet('digitStream','innerHTML','');
  safeSet('logArea','innerHTML','');
  safeSet('robotDropdownLabel','textContent','‚ö° Selecione um rob√¥...');
  const lblEl=safeEl('robotDropdownLabel'); if(lblEl) lblEl.style.color='';
  try{ setSignal('aguardando','AGUARDANDO CONEX√ÉO','Conecte para iniciar'); }catch(e){}
  try{ resetConnectBtn(); }catch(e){}
  safeSet('tradeToggleBtn','textContent','ü§ñ INICIAR ROB√î');
  safeCss('tradeToggleBtn','background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;');
  safeCss('autoTradeIndicator','width:10px;height:10px;border-radius:50%;background:var(--dim);');
  safeSet('autoTradeLabel','textContent','ROB√î PARADO');
  safeCss('autoTradeLabel','color:var(--dim)');
  safeSet('adminNavUser','textContent','');
  safeCss('btnAdminNav','display:none');
  // Clear login inputs
  safeSet('adminUser','value',''); safeSet('adminPass','value','');
  safeSet('derivLoginId','value',''); safeSet('derivToken','value','');
  safeSet('adminLoginErr','style','display:none');
  safeSet('traderLoginErr','style','display:none');
  showScreen('screenLogin');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî ROBOTS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goToDashboard(){
  // Go to dashboard screen keeping the admin session active
  renderRobotSelectorList();
  showScreen('screenDashboard');
  document.getElementById('btnAdminNav').style.display='inline-block';
  log('üîÑ Trocado para tela de opera√ß√£o.','info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BRAND SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BRAND_DEFAULTS = {
  name: 'DERIV ROBO SYSTEM',
  slogan: 'PAINEL DE OPERA√á√ïES AUTOMATIZADAS',
  icon: '‚ö°',
  logoUrl: '',
  accent: '#00d4ff',
  gold: '#ffb800',
  whatsapp: '',
  telegram: '',
  website: '',
  welcome: ''
};

let brandConfig = Object.assign({}, BRAND_DEFAULTS, load('drv_brand', {}));

function applyBrand(){
  const b = brandConfig;
  // CSS variables
  document.documentElement.style.setProperty('--accent', b.accent);
  document.documentElement.style.setProperty('--gold', b.gold);
  // Login screen
  const nameEl = document.getElementById('loginBrandName');
  const sloganEl = document.getElementById('loginBrandSlogan');
  const emojiEl = document.getElementById('loginLogoEmoji');
  const imgEl = document.getElementById('loginLogoImg');
  const welcomeEl = document.getElementById('loginBrandWelcome');
  if(nameEl) nameEl.textContent = b.name;
  if(sloganEl) sloganEl.textContent = b.slogan;
  if(emojiEl){ emojiEl.textContent = b.icon; emojiEl.style.display = b.logoUrl ? 'none' : 'block'; }
  if(imgEl){ imgEl.src = b.logoUrl || ''; imgEl.style.display = b.logoUrl ? 'block' : 'none'; }
  if(welcomeEl){ welcomeEl.textContent = b.welcome; welcomeEl.style.display = b.welcome ? 'block' : 'none'; }
  // Topnav
  const adminBrand = document.getElementById('adminTopnavBrand');
  const dashBrand = document.getElementById('dashTopnavBrand');
  if(adminBrand) adminBrand.textContent = b.icon + ' ' + b.name + ' ¬∑ ADMIN';
  if(dashBrand) dashBrand.textContent = b.icon + ' ' + b.name;
  // Page title
  document.title = b.name;
}

function loadBrandForm(){
  const b = brandConfig;
  const set = (id, val) => { const el=document.getElementById(id); if(el) el.value=val||''; };
  set('brandName', b.name);
  set('brandSlogan', b.slogan);
  set('brandIcon', b.icon);
  set('brandLogoUrl', b.logoUrl);
  set('brandAccent', b.accent);
  set('brandAccentHex', b.accent);
  set('brandGold', b.gold);
  set('brandGoldHex', b.gold);
  set('brandWhatsapp', b.whatsapp);
  set('brandTelegram', b.telegram);
  set('brandWebsite', b.website);
  set('brandWelcome', b.welcome);
  // Previews
  const ap = document.getElementById('brandAccentPreview');
  const gp = document.getElementById('brandGoldPreview');
  if(ap) ap.style.background = b.accent;
  if(gp) gp.style.background = b.gold;
  const emojiEl = document.getElementById('brandLogoEmoji');
  if(emojiEl) emojiEl.textContent = b.icon || '‚ö°';
  previewLogo();
}

function saveBrand(){
  brandConfig = {
    name:     (document.getElementById('brandName')?.value.trim()   || BRAND_DEFAULTS.name).toUpperCase(),
    slogan:   (document.getElementById('brandSlogan')?.value.trim() || BRAND_DEFAULTS.slogan).toUpperCase(),
    icon:     document.getElementById('brandIcon')?.value.trim()    || BRAND_DEFAULTS.icon,
    logoUrl:  document.getElementById('brandLogoUrl')?.value.trim() || '',
    accent:   document.getElementById('brandAccentHex')?.value.trim() || BRAND_DEFAULTS.accent,
    gold:     document.getElementById('brandGoldHex')?.value.trim()   || BRAND_DEFAULTS.gold,
    whatsapp: document.getElementById('brandWhatsapp')?.value.trim()  || '',
    telegram: document.getElementById('brandTelegram')?.value.trim()  || '',
    website:  document.getElementById('brandWebsite')?.value.trim()   || '',
    welcome:  document.getElementById('brandWelcome')?.value.trim()   || '',
  };
  store('drv_brand', brandConfig);
  applyBrand();
  const msg = document.getElementById('brandSaveMsg');
  if(msg){ msg.textContent='‚úÖ Marca aplicada com sucesso!'; msg.style.display='block'; setTimeout(()=>msg.style.display='none', 3000); }
}

function resetBrand(){
  if(!confirm('Restaurar configura√ß√µes padr√£o da marca?')) return;
  brandConfig = Object.assign({}, BRAND_DEFAULTS);
  store('drv_brand', brandConfig);
  loadBrandForm();
  applyBrand();
}

function previewLogo(){
  const url = document.getElementById('brandLogoUrl')?.value.trim();
  const imgEl = document.getElementById('brandLogoImg');
  const emojiEl = document.getElementById('brandLogoEmoji');
  if(!imgEl || !emojiEl) return;
  if(url){ imgEl.src=url; imgEl.style.display='block'; emojiEl.style.display='none'; }
  else { imgEl.style.display='none'; emojiEl.style.display='block'; }
}

function syncColor(pickerIdOrHex, hexId){
  // called from hex input
  const hex = document.getElementById(hexId)?.value;
  if(!hex || hex.length < 4) return;
  const picker = document.getElementById(pickerIdOrHex);
  if(picker && /^#[0-9a-fA-F]{6}$/.test(hex)) picker.value = hex;
  // update preview
  const previewId = pickerIdOrHex + 'Preview';
  const preview = document.getElementById(previewId);
  if(preview) preview.style.background = hex;
  // live CSS update
  if(pickerIdOrHex === 'brandAccent') document.documentElement.style.setProperty('--accent', hex);
  if(pickerIdOrHex === 'brandGold') document.documentElement.style.setProperty('--gold', hex);
}

function applyPreset(accent, gold){
  const aEl = document.getElementById('brandAccent');
  const aHex = document.getElementById('brandAccentHex');
  const gEl = document.getElementById('brandGold');
  const gHex = document.getElementById('brandGoldHex');
  if(aEl) aEl.value = accent;
  if(aHex) aHex.value = accent;
  if(gEl) gEl.value = gold;
  if(gHex) gHex.value = gold;
  const ap = document.getElementById('brandAccentPreview');
  const gp = document.getElementById('brandGoldPreview');
  if(ap) ap.style.background = accent;
  if(gp) gp.style.background = gold;
  document.documentElement.style.setProperty('--accent', accent);
  document.documentElement.style.setProperty('--gold', gold);
}

// Sync color picker ‚Üí hex input
document.addEventListener('input', function(e){
  if(e.target.id === 'brandAccent'){
    const hex = e.target.value;
    const hEl = document.getElementById('brandAccentHex');
    if(hEl) hEl.value = hex;
    const p = document.getElementById('brandAccentPreview');
    if(p) p.style.background = hex;
    document.documentElement.style.setProperty('--accent', hex);
  }
  if(e.target.id === 'brandGold'){
    const hex = e.target.value;
    const hEl = document.getElementById('brandGoldHex');
    if(hEl) hEl.value = hex;
    const p = document.getElementById('brandGoldPreview');
    if(p) p.style.background = hex;
    document.documentElement.style.setProperty('--gold', hex);
  }
  if(e.target.id === 'brandIcon'){
    const emojiEl = document.getElementById('brandLogoEmoji');
    if(emojiEl) emojiEl.textContent = e.target.value || '‚ö°';
  }
});

function showAdminTab(tab){
  document.getElementById('adminTabRobots').style.display = tab==='robots'?'block':'none';
  document.getElementById('adminTabAdmins').style.display = tab==='admins'?'block':'none';
  document.getElementById('adminTabBtnRobots')?.classList.toggle('active', tab==='robots');
  document.getElementById('adminTabBtnAdmins')?.classList.toggle('active', tab==='admins');
}

['rfEntry','rfFactor','rfLevels'].forEach(id=>{
  // will attach after DOM ready
});

function updateMartPreview(){
  const entry = parseFloat(document.getElementById('rfEntry').value)||0.35;
  const factor = parseFloat(document.getElementById('rfFactor').value)||2.8;
  const levels = parseInt(document.getElementById('rfLevels').value)||5;
  let e=entry, acc=0, html='<div style="font-size:10px;letter-spacing:1px;color:var(--dim);font-family:Share Tech Mono,monospace;margin-bottom:6px;">TABELA MARTINGALE</div><div style="display:flex;gap:6px;flex-wrap:wrap;">';
  for(let i=1;i<=levels;i++){
    acc+=e;
    html+=`<div style="background:var(--bg);border-radius:6px;padding:5px 8px;text-align:center;">
      <div style="font-size:9px;color:var(--dim);">N${i}</div>
      <div style="font-size:12px;font-weight:700;color:var(--gold);font-family:Share Tech Mono,monospace;">$${e.toFixed(2)}</div>
    </div>`;
    e=e*factor;
  }
  html+=`</div><div style="font-size:11px;color:var(--red);font-family:Share Tech Mono,monospace;margin-top:8px;">Exposi√ß√£o m√°xima: $${acc.toFixed(2)}</div>`;
  document.getElementById('martPreview').innerHTML=html;
}

function openRobotForm(id=null){
  editingRobotId=id;
  const title=document.getElementById('robotFormTitle');
  if(id){
    const r=robots.find(x=>x.id===id);
    if(!r) return;
    title.textContent='‚úèÔ∏è EDITAR ROB√î';
    document.getElementById('rfName').value=r.name;
    document.getElementById('rfDesc').value=r.desc||'';
    document.getElementById('rfStrategy').value=r.strategy;
    document.getElementById('rfVirtual').value=r.virtualLosses;
    document.getElementById('rfEntry').value=r.entry;
    document.getElementById('rfFactor').value=r.factor;
    document.getElementById('rfLevels').value=r.levels;
  } else {
    title.textContent='‚ûï NOVO ROB√î';
    ['rfName','rfDesc'].forEach(i=>document.getElementById(i).value='');
    document.getElementById('rfStrategy').value='over3';
  }
  updateMartPreview();
  document.getElementById('robotFormErr').style.display='none';
}

function cancelRobotForm(){ editingRobotId=null; openRobotForm(); }

function saveRobot(){
  const err=document.getElementById('robotFormErr');
  const name=document.getElementById('rfName').value.trim();

  if(!name){ err.textContent='Nome √© obrigat√≥rio.'; err.style.display='block'; return; }

  const robot = {
    id: editingRobotId || ('r_'+Date.now()),
    name,
    desc: document.getElementById('rfDesc').value.trim(),
    strategy: document.getElementById('rfStrategy').value,
    virtualLosses: parseInt(document.getElementById('rfVirtual').value),
    entry: parseFloat(document.getElementById('rfEntry').value),
    factor: parseFloat(document.getElementById('rfFactor').value),
    levels: parseInt(document.getElementById('rfLevels').value),
    running: false,
    createdAt: editingRobotId ? (robots.find(r=>r.id===editingRobotId)?.createdAt||Date.now()) : Date.now()
  };

  if(editingRobotId){
    robots=robots.map(r=>r.id===editingRobotId?robot:r);
  } else {
    robots.push(robot);
  }
  store('drv_robots', robots);
  err.style.display='none';
  editingRobotId=null;
  renderRobotList();
  openRobotForm(); // reset form
}

function deleteRobot(id){
  if(!confirm('Deletar este rob√¥?')) return;
  robots=robots.filter(r=>r.id!==id);
  store('drv_robots', robots);
  renderRobotList();
}

function toggleRobotRunning(id){
  robots=robots.map(r=>r.id===id?{...r,running:!r.running}:r);
  store('drv_robots', robots);
  renderRobotList();
}

function renderRobotList(){
  const list=document.getElementById('robotList');
  if(!robots.length){ list.innerHTML='<div style="color:var(--dim);font-size:13px;text-align:center;padding:40px;">Nenhum rob√¥ criado ainda.</div>'; return; }
  list.innerHTML=robots.map(r=>{
    const stratLabel=r.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2');
    const accBadge=r.accType==='demo'?'<span class="badge badge-gold">DEMO</span>':'<span class="badge badge-red">REAL</span>';
    return `<div class="robot-card-item ${r.running?'running':''}">
      <div class="robot-status-dot ${r.running?'running':''}"></div>
      <div style="flex:1;min-width:150px;">
        <div class="robot-name">${r.name}</div>
        <div class="robot-meta">${stratLabel} ¬∑ ${r.market} ¬∑ ${r.loginId} ${accBadge}</div>
        <div class="robot-meta">Entrada: $${r.entry} ¬∑ x${r.factor} ¬∑ ${r.levels} n√≠veis ¬∑ Virtual: ${r.virtualLosses} losses</div>
      </div>
      <div class="robot-actions">
        <button class="btn btn-sm ${r.running?'btn-danger':'btn-success'}" onclick="toggleRobotRunning('${r.id}')">${r.running?'‚èπ Parar':'‚ñ∂ Ativar'}</button>
        <button class="btn btn-sm btn-gold" onclick="openRobotForm('${r.id}')">‚úèÔ∏è</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRobot('${r.id}')">üóëÔ∏è</button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ADMIN ‚Äî ADMINS CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openAdminForm(){ document.getElementById('adminFormCard').style.display='block'; }

function saveAdmin(){
  const u=document.getElementById('afUser').value.trim();
  const p=document.getElementById('afPass').value;
  const p2=document.getElementById('afPass2').value;
  const err=document.getElementById('adminFormErr');
  if(!u){ err.textContent='Usu√°rio obrigat√≥rio.'; err.style.display='block'; return; }
  if(p.length<4){ err.textContent='Senha m√≠nima: 4 caracteres.'; err.style.display='block'; return; }
  if(p!==p2){ err.textContent='Senhas n√£o conferem.'; err.style.display='block'; return; }
  if(admins.find(a=>a.user===u)){ err.textContent='Usu√°rio j√° existe.'; err.style.display='block'; return; }
  admins.push({ user: u, pass: btoa(p) });
  store('drv_admins', admins);
  err.style.display='none';
  document.getElementById('adminFormCard').style.display='none';
  renderAdminList();
}

function deleteAdmin(u){
  if(u===currentUser?.user){ alert('Voc√™ n√£o pode deletar seu pr√≥prio usu√°rio.'); return; }
  if(!confirm('Deletar admin "'+u+'"?')) return;
  admins=admins.filter(a=>a.user!==u);
  store('drv_admins', admins);
  renderAdminList();
}

function renderAdminList(){
  const list=document.getElementById('adminList');
  list.innerHTML=admins.map(a=>`
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <span style="font-weight:700;">üë§ ${a.user}</span>
        ${a.user===currentUser?.user?'<span class="badge badge-gold" style="margin-left:8px;">VOC√ä</span>':''}
      </div>
      <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${a.user}')" ${a.user===currentUser?.user?'disabled':''}>üóëÔ∏è Remover</button>
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DASHBOARD STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let ws = null;
let derivAccount = null; // from trader login or selected robot
let digits = [];
let freqMap = {0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
let wins=0, losses=0, currentLossStreak=0, maxLossStreak=0;
let virtualLossStreak=0, robotActive=false, pendingMartingaleLevel=0;
let martingaleLevel=0, martingaleEntry=0;
let robotActivationCount=0;
let autoTradeEnabled=false, tradeInProgress=false, currentContractId=null, pendingBuyReqId=null;
let processedContracts=new Set(); // prevent double-processing
let sessionPnl=0, sessionOps=0, sessionStopped=false;
let accountBalance=0, accountCurrency='USD';
let dynamicMartTable=[];
let connectTimeout=null;

function resetSessionState(){
  digits=[]; freqMap={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
  wins=0; losses=0; currentLossStreak=0; maxLossStreak=0;
  virtualLossStreak=0; robotActive=false; pendingMartingaleLevel=0;
  martingaleLevel=0; martingaleEntry=0; robotActivationCount=0;
  autoTradeEnabled=false; tradeInProgress=false; currentContractId=null; cycleState='IDLE'; processedContracts=new Set();
  sessionPnl=0; sessionOps=0; sessionStopped=false;
  dynamicMartTable=[];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROBOT SELECTOR (dashboard)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRobotSelectorList(){
  const menu=document.getElementById('robotDropdownMenu');
  if(!menu) return;
  const toShow = robots; // all robots visible; admin marks active/inactive
  let html='';
  toShow.forEach(r=>{
    const stratLabel=r.strategy.toUpperCase().replace(/([A-Za-z]+)(\d+)/,'$1 $2');
    const statusBadge=r.running
      ?'<span style="color:var(--green);font-size:9px;margin-left:4px;">‚óè ATIVO</span>'
      :'<span style="color:var(--dim);font-size:9px;margin-left:4px;">‚óã inativo</span>';
    html+=`<div class="robot-dropdown-item" id="rsel_${r.id}" onclick="selectRobot('${r.id}')"
      style="${r.running?'':'opacity:0.7'}">
      <div class="rdi-name">ü§ñ ${r.name} ${statusBadge}</div>
      <div class="rdi-meta">${stratLabel} ¬∑ x${r.factor} ¬∑ ${r.levels} n√≠veis ¬∑ ${r.virtualLosses} losses</div>
    </div>`;
  });
  html+=`<div class="robot-dropdown-item manual-mode" onclick="selectManualMode()">
    <div class="rdi-name" style="color:var(--gold);">‚úã MODO MANUAL</div>
    <div class="rdi-meta" style="color:var(--gold);">Configure a estrat√©gia manualmente</div>
  </div>`;
  menu.innerHTML=html||'<div style="padding:12px;color:var(--dim);font-size:12px;text-align:center;">Nenhum rob√¥ dispon√≠vel.</div>';
}

function toggleRobotDropdown(){
  const btn=document.getElementById('robotDropdownBtn');
  const menu=document.getElementById('robotDropdownMenu');
  if(!menu) return;
  renderRobotSelectorList();
  const isOpen=menu.classList.contains('open');
  if(!isOpen){
    menu.classList.add('open'); btn.classList.add('open');
    setTimeout(()=>document.addEventListener('click',closeDropdownOutside,{once:true}),10);
  } else {
    menu.classList.remove('open'); btn.classList.remove('open');
  }
}

function closeDropdownOutside(e){
  const dd=document.getElementById('robotDropdown');
  if(dd&&!dd.contains(e.target)){
    document.getElementById('robotDropdownMenu')?.classList.remove('open');
    document.getElementById('robotDropdownBtn')?.classList.remove('open');
  }
}

function selectManualMode(){
  selectedRobot=null;
  document.getElementById('robotDropdownMenu')?.classList.remove('open');
  document.getElementById('robotDropdownBtn')?.classList.remove('open');
  const lbl=document.getElementById('robotDropdownLabel');
  if(lbl){ lbl.textContent='‚úã MODO MANUAL'; lbl.style.color='var(--gold)'; }
  document.getElementById('manualFields')?.classList.add('active');
  document.querySelectorAll('.robot-dropdown-item').forEach(el=>el.classList.remove('active'));
  applyBoleta();
  log('‚úã Modo manual ativado.','info');
}

function selectRobot(id){
  selectedRobot=robots.find(r=>r.id===id);
  if(!selectedRobot) return;
  // Close dropdown
  document.getElementById('robotDropdownMenu')?.classList.remove('open');
  document.getElementById('robotDropdownBtn')?.classList.remove('open');
  // Update label
  const lbl=document.getElementById('robotDropdownLabel');
  if(lbl){ lbl.textContent='ü§ñ '+selectedRobot.name; lbl.style.color='var(--accent)'; }
  // Mark active in menu
  document.querySelectorAll('.robot-dropdown-item').forEach(el=>el.classList.remove('active'));
  document.getElementById('rsel_'+id)?.classList.add('active');
  // Hide manual fields
  document.getElementById('manualFields')?.classList.remove('active');
  // Sync entry from robot config
  const entryEl=document.getElementById('boletaEntry');
  if(entryEl){ entryEl.value=selectedRobot.entry; delete entryEl.dataset.manuallyChanged; }
  buildMartTable();
  renderMartTable();
  updateBoletaDisplay();
  updateVdots();
  const stratLabel=selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2');
  log(`ü§ñ Rob√¥ selecionado: ${selectedRobot.name} | ${stratLabel} | ${selectedRobot.virtualLosses} losses virtuais`, 'info');
}

function buildMartTable(){
  dynamicMartTable=[];
  const baseEntry=parseFloat(document.getElementById('boletaEntry')?.value||selectedRobot?.entry||0.35)||0.35;
  const levels=getMartLevels();
  const factor=getMartFactor();
  let e=baseEntry, acc=0;
  for(let i=1;i<=levels;i++){
    acc+=e;
    dynamicMartTable.push({level:i, entry:parseFloat(e.toFixed(2)), accum:parseFloat(acc.toFixed(2))});
    e=e*factor;
  }
}

function applyBoleta(){
  buildMartTable();
  renderMartTable();
  updateVdots();
  updateMartRefTable();
  schedulePayout();
  const market=document.getElementById('boletaMarket')?.value||'R_100';
  document.getElementById('accMarketD').textContent=market;
  if(selectedRobot){
    document.getElementById('accStratD').textContent=selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2');
  } else {
    const ms=document.getElementById('manualStrategy')?.value||'over3';
    document.getElementById('accStratD').textContent=ms.toUpperCase().replace(/([a-z]+)(\d+)/i,'$1 $2');
  }
}

function renderMartTable(){
  const cells=document.getElementById('martTableCells');
  const exp=document.getElementById('martExposure');
  if(!cells) return;
  // Use live payout if available, fallback to static table
  const stratKey=selectedRobot?.strategy||document.getElementById('manualStrategy')?.value||'over3';
  const payout=getEffectivePayout(stratKey);
  const isLivePayout=payoutCache[stratKey]!=null;
  cells.innerHTML=dynamicMartTable.map(row=>{
    const grossProfit=row.entry*payout;
    const profitStr='+$'+grossProfit.toFixed(2);
    return `
    <div style="background:var(--bg);border-radius:6px;padding:6px 10px;text-align:center;border:1px solid var(--border);min-width:64px;">
      <div style="font-size:9px;color:var(--dim);font-family:Share Tech Mono,monospace;">N${row.level}</div>
      <div style="font-size:12px;font-weight:700;color:var(--gold);font-family:Share Tech Mono,monospace;">$${row.entry.toFixed(2)}</div>
      <div style="font-size:11px;font-weight:700;color:#00ff9f;font-family:Share Tech Mono,monospace;">${profitStr}</div>
      <div style="font-size:9px;color:var(--dim);font-family:Share Tech Mono,monospace;">acum $${row.accum.toFixed(2)}</div>
    </div>`;
  }).join('');
  const maxExposure=dynamicMartTable[dynamicMartTable.length-1]?.accum||0;
  const entryLast=dynamicMartTable[dynamicMartTable.length-1]?.entry||0;
  const lastProfit='+$'+(entryLast*payout).toFixed(2);
  const liveTag=isLivePayout?' ‚óèlive':' ~est.';
  exp.textContent=maxExposure>0?`Exposi√ß√£o m√°xima: $${maxExposure.toFixed(2)} ¬∑ Lucro N${dynamicMartTable.length}: ${lastProfit}${liveTag}`:'';
}

function updateBoletaDisplay(){
  if(!selectedRobot) return;
  document.getElementById('bLevel').textContent=martingaleLevel||'‚Äî';
  document.getElementById('accMarketD').textContent=document.getElementById('boletaMarket')?.value||'R_100';
  document.getElementById('accStratD').textContent=selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2');
  // Sync boleta entry with robot entry if not manually changed
  const entryEl=document.getElementById('boletaEntry');
  if(entryEl&&!entryEl.dataset.manuallyChanged) entryEl.value=selectedRobot.entry;
  renderMartTable();
}

function updateVdots(){
  const target=getVirtualLossTarget();
  const container=document.getElementById('vdots');
  container.innerHTML='';
  for(let i=0;i<target;i++){
    const d=document.createElement('div');
    d.className='vdot'+(i<virtualLossStreak?' active':'');
    container.appendChild(d);
  }
  document.getElementById('vdotCount').textContent=virtualLossStreak+' / '+target;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SOUND EFFECTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const audioCtx=new(window.AudioContext||window.webkitAudioContext)();
function playWin(){
  [0,0.18].forEach((d,i)=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='sine';o.frequency.setValueAtTime(i?1500:1200,audioCtx.currentTime+d);
    g.gain.setValueAtTime(0,audioCtx.currentTime+d);
    g.gain.linearRampToValueAtTime(0.4,audioCtx.currentTime+d+0.01);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d+0.15);
    o.start(audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d+0.15);
  });
}
function playLoss(){
  const o=audioCtx.createOscillator(),g=audioCtx.createGain();
  o.connect(g);g.connect(audioCtx.destination);
  o.type='sawtooth';o.frequency.setValueAtTime(400,audioCtx.currentTime);
  o.frequency.exponentialRampToValueAtTime(150,audioCtx.currentTime+0.4);
  g.gain.setValueAtTime(0.3,audioCtx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.4);
  o.start(audioCtx.currentTime);o.stop(audioCtx.currentTime+0.4);
}
function playStopGain(){
  [0,0.12,0.24,0.36].forEach((d,i)=>{
    const f=[800,1000,1200,1600][i];
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='sine';o.frequency.setValueAtTime(f,audioCtx.currentTime+d);
    g.gain.setValueAtTime(0.35,audioCtx.currentTime+d);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d+0.2);
    o.start(audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d+0.2);
  });
}
function playStopLoss(){
  [0,0.2,0.4].forEach(d=>{
    const o=audioCtx.createOscillator(),g=audioCtx.createGain();
    o.connect(g);g.connect(audioCtx.destination);
    o.type='square';o.frequency.setValueAtTime(300,audioCtx.currentTime+d);
    g.gain.setValueAtTime(0.2,audioCtx.currentTime+d);
    g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d+0.15);
    o.start(audioCtx.currentTime+d);o.stop(audioCtx.currentTime+d+0.15);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STRATEGY CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Live payout cache ‚Äî fetched from Deriv proposal API
// key: strategyKey, value: multiplier (profit/stake ratio)
let payoutCache = {};
let payoutFetchTimer = null;
let payoutReqMap = {}; // reqId ‚Üí stratKey mapping

function getStrategyPayout(key){
  if(!key){
    if(selectedRobot) key=selectedRobot.strategy;
    else key=document.getElementById('manualStrategy')?.value||'over3';
  }
  return payoutCache[key] || null; // null = not yet fetched, use getEffectivePayout for fallback
}

// Fetch real payout from Deriv proposal API
function fetchPayoutFromDeriv(stratKey, stake, market){
  if(!ws || ws.readyState !== 1) return;
  const contract = getContractTypeForStrategy(stratKey);
  const reqId = 'p_' + stratKey + '_' + Date.now(); // string req_id, encodes stratKey
  payoutReqMap[reqId] = stratKey; // track which strat this request is for
  const msg = {
    proposal: 1,
    amount: parseFloat(stake).toFixed(2),
    basis: 'stake',
    contract_type: contract.type,
    currency: accountCurrency || 'USD',
    duration: 1,
    duration_unit: 't',
    symbol: market || 'R_100',
    barrier: contract.barrier,
    req_id: reqId
  };
  ws.send(JSON.stringify(msg));
}

function getContractTypeForStrategy(key){
  if(!key) key = (selectedRobot?.strategy) || document.getElementById('manualStrategy')?.value || 'over3';
  const n = parseInt(key.replace(/[^0-9]/g,''));
  const isOver = key.startsWith('over');
  return { type: isOver ? 'DIGITOVER' : 'DIGITUNDER', barrier: String(n) };
}

// Schedule a payout fetch (debounced 600ms) ‚Äî current strategy only
function schedulePayout(){
  clearTimeout(payoutFetchTimer);
  payoutFetchTimer = setTimeout(()=>{
    if(!ws || ws.readyState !== 1) return;
    const stratKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
    const stake = parseFloat(document.getElementById('boletaEntry')?.value || 0.35);
    const market = document.getElementById('boletaMarket')?.value || 'R_100';
    fetchPayoutFromDeriv(stratKey, stake, market);
  }, 600);
}

// Fetch payout for ALL 9 Over strategies sequentially (with small delay between each)
function scheduleAllPayouts(){
  if(!ws || ws.readyState !== 1) return;
  const stake = parseFloat(document.getElementById('boletaEntry')?.value || 0.35);
  const market = document.getElementById('boletaMarket')?.value || 'R_100';
  const keys = ['over0','over1','over2','over3','over4','over5','over6','over7','over8'];
  keys.forEach((key, i) => {
    setTimeout(() => {
      if(ws && ws.readyState === 1) fetchPayoutFromDeriv(key, stake, market);
    }, i * 400); // 400ms between each to avoid rate limit
  });
}

function getStrategyConfig(key){
  if(!key){
    if(selectedRobot) key=selectedRobot.strategy;
    else key=document.getElementById('manualStrategy')?.value||'over3';
  }
  const n=parseInt(key.replace(/[^0-9]/g,''));
  const isOver=key.startsWith('over');
  const winDigits=[], lossDigits=[];
  for(let d=0;d<=9;d++){
    if(isOver){ (d>n?winDigits:lossDigits).push(d); }
    else { (d<n?winDigits:lossDigits).push(d); }
  }
  const payout=getStrategyPayout(key);
  return { name:(isOver?'OVER ':'UNDER ')+n, winDigits, lossDigits, payout };
}

function getVirtualLossTarget(){
  if(selectedRobot) return selectedRobot.virtualLosses||2;
  return parseInt(document.getElementById('manualVirtual')?.value||5);
}

function getMartLevels(){
  if(selectedRobot) return selectedRobot.levels||5;
  return parseInt(document.getElementById('manualLevels')?.value||5);
}

function getMartFactor(){
  if(selectedRobot) return selectedRobot.factor||2.8;
  return parseFloat(document.getElementById('manualFactor')?.value||2.8);
}

function getContractType(){
  return getContractTypeForStrategy(); // uses selectedRobot or manualStrategy correctly
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WEBSOCKET & CONNECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function connectDash(){
  if(!derivAccount){ log('‚ùå Fa√ßa login com suas credenciais Deriv primeiro.','error'); return; }
  if(ws&&(ws.readyState===0||ws.readyState===1)){ log('‚ö†Ô∏è J√° conectado.','warning'); return; }
  if(location.protocol==='file:'){ log('‚ö†Ô∏è Aberto via file:// ‚Äî use o INICIAR_WINDOWS.bat para funcionar corretamente.','warning'); }

  // Credentials ALWAYS come from derivAccount (robots are strategy-only configs)
  const creds = derivAccount;
  const appId = creds?.appId || '128505';
  const token = creds?.token || null;
  const market = document.getElementById('boletaMarket')?.value || 'R_100';

  if(!token && !creds){ log('‚ùå Fa√ßa login com suas credenciais Deriv primeiro.','error'); return; }

  // Reset digit state
  digits=[]; freqMap={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0};
  wins=0; losses=0; currentLossStreak=0;
  document.getElementById('digitStream').innerHTML='';
  buildMartTable(); updateBoletaDisplay(); updateVdots();

  // Connection state ‚Äî prevents double auth/subscription
  let connState = 'CONNECTING'; // CONNECTING ‚Üí AUTHING ‚Üí LOADING ‚Üí LIVE

  document.getElementById('connectBtn').textContent='‚èπ ENCERRAR CONEX√ÉO';
  document.getElementById('connectBtn').style.cssText='background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.4);font-weight:700;';
  document.getElementById('connectBtn').setAttribute('onclick','disconnectDash()');
  const modeLabel = selectedRobot ? `Rob√¥: ${selectedRobot.name}` : 'Modo Manual';
  log(`üîå Conectando: ${creds?.loginid||creds?.loginId||'‚Äî'} | ${market} | ${modeLabel}`,'info');

  connectTimeout=setTimeout(()=>{
    log('‚è±Ô∏è Timeout 10s ‚Äî sem resposta da Deriv. Verifique App ID, internet e tente novamente.','error');
    resetConnectBtn(); if(ws) ws.close();
  },15000);

  try{
    ws=new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${appId}`);
  }catch(e){
    clearTimeout(connectTimeout);
    log('‚ùå Erro WebSocket: '+e.message,'error');
    resetConnectBtn(); return;
  }

  ws.onopen=()=>{
    clearTimeout(connectTimeout);
    log('‚úÖ WebSocket conectado!','success');
    document.getElementById('connectBtn').textContent='‚èπ ENCERRAR CONEX√ÉO';
    document.getElementById('connectBtn').style.cssText='background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.4);font-weight:700;';
    document.getElementById('connectBtn').setAttribute('onclick','disconnectDash()');
    // Step 1: authorize if we have a token, else go straight to history
    if(token){
      connState='AUTHING';
      log('üîê Autenticando...','info');
      ws.send(JSON.stringify({authorize:token}));
    } else {
      connState='LOADING';
      loadHistory(market);
    }
    // Start ping AFTER connection (ping is independent, handled separately)
    startPing();
  };

  ws.onmessage=(e)=>{
    let data; try{data=JSON.parse(e.data);}catch{return;}

    // ‚îÄ‚îÄ Ping/pong (independent of auth flow) ‚îÄ‚îÄ
    if(data.msg_type==='ping') handlePong();

    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
    if(data.msg_type==='authorize' && data.authorize && connState==='AUTHING'){
      connState='LOADING';
      const auth=data.authorize;
      accountCurrency=auth.currency||'USD';
      const isVirt=auth.is_virtual===1;
      document.getElementById('accLoginIdD').textContent=auth.loginid;
      document.getElementById('accTypeD').textContent=isVirt?'üìä DEMO':'üí∞ REAL';
      document.getElementById('accTypeD').style.color=isVirt?'var(--accent)':'var(--gold)';
      document.getElementById('accBar').style.display='flex';
      log(`‚úÖ Autenticado: ${auth.loginid} (${isVirt?'DEMO':'REAL'}) | ${auth.currency}`,'success');
      if(!isVirt) log('üö® CONTA REAL ATIVA ‚Äî opere com cuidado!','error');
      // Subscribe balance ONCE
      ws.send(JSON.stringify({balance:1,subscribe:1}));
      // Load history ONCE
      loadHistory(market);
    }

    // ‚îÄ‚îÄ Balance updates ‚îÄ‚îÄ
    if(data.msg_type==='balance' && data.balance){
      accountBalance=parseFloat(data.balance.balance);
      updateBalanceUI(accountBalance);
    }

    // ‚îÄ‚îÄ History loaded ‚Üí subscribe ticks ONCE ‚îÄ‚îÄ
    if(data.msg_type==='history' && data.history && connState==='LOADING'){
      connState='LIVE';
      const prices=data.history.prices||[];
      log(`üì¶ Carregando ${prices.length} d√≠gitos hist√≥ricos...`,'info');
      prices.forEach(p=>{
        const s=p.toString(), parts=s.split('.');
        const d=parts.length>1?parseInt(parts[1].slice(-1)):parseInt(s.slice(-1));
        processDigitSilent(d);
      });
      log(`‚úÖ Hist√≥rico carregado! ${digits.length} d√≠gitos. Iniciando stream ao vivo...`,'success');
      updateDiagnostics(); updateOUTable();
updateMartRefTable(); updateFreqGrid(); updateMartRefTable();
      updateLastDigit(digits[digits.length-1]??0);
      // Subscribe ticks ONCE
      ws.send(JSON.stringify({ticks:market,subscribe:1}));
      schedulePayout();
    }

    // ‚îÄ‚îÄ Live ticks ‚îÄ‚îÄ
    if(data.msg_type==='tick' && data.tick && connState==='LIVE'){
      const s=data.tick.quote.toString(), parts=s.split('.');
      const d=parts.length>1?parseInt(parts[1].slice(-1)):parseInt(s.slice(-1));
      processDigit(d);
    }

    // ‚îÄ‚îÄ Trade responses ‚îÄ‚îÄ
    if(data.msg_type==='buy') handleBuy(data);
    if(data.msg_type==='proposal') handleProposalResponse(data);
    if(data.msg_type==='proposal_open_contract') handleContract(data);

    // ‚îÄ‚îÄ Errors ‚îÄ‚îÄ
    if(data.error){
      const code = data.error.code || '';
      const msg  = data.error.message || '';

      // 1. Trade buy error ‚Äî don't kill connection
      if(data.req_id===pendingBuyReqId){
        tradeInProgress=false; cycleState='IDLE';
        log('‚ùå Erro trade: '+msg,'error'); return;
      }
      // 2. Payout proposal error ‚Äî ignore silently
      if(data.msg_type==='proposal') return;
      // 3. AlreadySubscribed ‚Äî ignore silently
      if(code==='AlreadySubscribed') return;
      // 4. MarketIsClosed ‚Äî warn only
      if(code==='MarketIsClosed'){
        log('‚ö†Ô∏è Mercado fechado no momento.','warning'); return;
      }
      // 5. All other errors ‚Äî log with guidance and reset connection
      clearTimeout(connectTimeout);
      log(`‚ùå Erro API: ${msg} (${code})`,'error');
      if(code==='InvalidAppID')
        log('üí° App ID inv√°lido. Crie um em: developers.deriv.com ‚Üí Dashboard ‚Üí Register App','warning');
      else if(code==='InvalidToken')
        log('üí° Token inv√°lido ou expirado. Gere novo em: app.deriv.com/account/api-token (permiss√µes: Read + Trade)','warning');
      else if(code==='WrongResponse')
        log('üí° WrongResponse: verifique se o App ID e Token correspondem √† mesma conta Deriv.','warning');
      else if(code==='AuthorizationRequired')
        log('üí° Autoriza√ß√£o necess√°ria. Verifique o token.','warning');
      else if(code==='RateLimit')
        log('üí° Muitas requisi√ß√µes. Aguarde alguns segundos e tente novamente.','warning');
      // Reset and close for fatal errors
      disconnectDash();
      resetConnectBtn();
    }
  };

  ws.onerror=()=>{
    clearTimeout(connectTimeout);
    stopPing();
    if(location.protocol==='file:') log('üö® WebSocket bloqueado via file://. Use o INICIAR_WINDOWS.bat (servidor local).','error');
    else { cycleState='IDLE'; log('‚ùå Erro de conex√£o WebSocket.','error'); }
    resetConnectBtn();
  };

  ws.onclose=(e)=>{
    clearTimeout(connectTimeout);
    stopPing();
    if(ws){ ws.onmessage=null; ws.onerror=null; }
    if(cycleState==='TRIGGERED'){ cycleState='IDLE'; tradeInProgress=false; }
    log(`üîå Conex√£o encerrada (${e.code}). Reconecte para operar.`,'warning');
    resetConnectBtn();
    if(autoTradeEnabled) disableAutoTrade();
  };
}

function resetConnectBtn(){
  const btn=document.getElementById('connectBtn');
  btn.textContent='‚ñ∂ CONECTAR';
  btn.style.cssText='';
  btn.className='btn btn-primary';
  btn.setAttribute('onclick','connectDash()');
}

function disconnectDash(){
  if(ws){ ws.onclose=null; ws.onerror=null; ws.onmessage=null; ws.onopen=null; ws.close(); ws=null; }
  cycleState='IDLE';
  if(autoTradeEnabled) disableAutoTrade();
  resetConnectBtn();
  log('‚èπ Conex√£o encerrada pelo usu√°rio.','warning');
}

function loadHistory(market){
  log(`üì° Buscando √∫ltimos 5000 d√≠gitos hist√≥ricos (${market})...`,'info');
  ws.send(JSON.stringify({ticks_history:market,count:5000,end:'latest',style:'ticks',adjust_start_time:1}));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTO-TRADE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAutoTrade(){
  autoTradeEnabled=!autoTradeEnabled;
  const btn=document.getElementById('tradeToggleBtn');
  const ind=document.getElementById('autoTradeIndicator');
  const lbl=document.getElementById('autoTradeLabel');
  if(autoTradeEnabled){
    btn.textContent='‚èπ PARAR ROB√î';
    btn.style.cssText='background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.5);font-weight:700;';
    ind.style.cssText='width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 1.5s infinite;';
    lbl.style.color='var(--green)'; lbl.textContent='ROB√î ATIVO';
    // Reset cycle and show active monitoring signal
    cycleState='IDLE'; virtualLossStreak=0; pendingMartingaleLevel=0;
  window._nextChipIsTrigger=false; window._triggerChip=null;
    updateVdots();
    setSignal('virtual','üëÅÔ∏è MONITORANDO','Aguardando '+getVirtualLossTarget()+' losses virtuais para entrar');
    document.getElementById('bStatus').textContent='OPERANDO';
    document.getElementById('bStatus').style.color='var(--green)';
    log('ü§ñ ROB√î INICIADO ‚Äî Operando automaticamente!','success');
  } else {
    btn.textContent='ü§ñ INICIAR ROB√î';
    btn.style.cssText='background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;';
    ind.style.cssText='width:10px;height:10px;border-radius:50%;background:var(--dim);';
    lbl.style.color='var(--dim)'; lbl.textContent='ROB√î PARADO';
    // Reset robot cycle completely when manually disabled
    cycleState = 'IDLE';
    virtualLossStreak = 0;
    pendingMartingaleLevel = 0;
    robotActive = false;
    setSignal('aguardando', '‚è∏ ROB√î PARADO', 'Clique em INICIAR ROB√î para operar');
    log('‚è∏ Rob√¥ parado. Ciclo e streak resetados.','warning');
  }
}

function disableAutoTrade(){
  if(!autoTradeEnabled) return;
  autoTradeEnabled=false;
  robotActive=false;
  cycleState='IDLE';
  virtualLossStreak=0;
  const btn=document.getElementById('tradeToggleBtn');
  btn.textContent='ü§ñ INICIAR ROB√î';
  btn.style.cssText='background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;';
  document.getElementById('autoTradeIndicator').style.cssText='width:10px;height:10px;border-radius:50%;background:var(--dim);';
  document.getElementById('autoTradeLabel').style.color='var(--dim)';
  document.getElementById('autoTradeLabel').textContent='ROB√î PARADO';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TRADING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function placeTrade(amount){
  if(!ws||ws.readyState!==1){
    log('‚ùå Sem conex√£o ‚Äî ciclo liberado.','error');
    cycleState='IDLE'; return;
  }
  if(tradeInProgress){log('‚è≥ Trade j√° em andamento ‚Äî bloqueado.','warning');return;}
  if(!isPingOkToTrade()){
    log(`üî¥ OPERA√á√ÉO PULADA ‚Äî Ping cr√≠tico: ${currentPing}ms. Aguarde conex√£o est√°vel.`,'error');
    cycleState='IDLE'; virtualLossStreak=0;
    setSignal('perigo','‚ö†Ô∏è PING CR√çTICO','Opera√ß√£o pulada ‚Äî aguardando conex√£o est√°vel');
    return;
  }
  if(cycleState !== 'TRIGGERED'){log('‚ö†Ô∏è Ciclo n√£o ativo ‚Äî trade cancelado.','warning');return;}
  if(sessionStopped){
    cycleState='IDLE';
    log('üõë Sess√£o parada ‚Äî ciclo liberado.','warning'); return;
  }
  const contract=getContractType();
  const market=selectedRobot?.market||derivAccount?.market||'R_100';
  pendingBuyReqId=Date.now();
  tradeInProgress=true;
  ws.send(JSON.stringify({buy:1,price:parseFloat(amount).toFixed(2),parameters:{
    contract_type:contract.type,symbol:market,duration:1,duration_unit:'t',
    basis:'stake',amount:parseFloat(amount).toFixed(2),currency:accountCurrency||'USD',barrier:contract.barrier
  },req_id:pendingBuyReqId}));
  log(`üì§ Ordem: ${contract.type} barrier ${contract.barrier} ‚Äî $${parseFloat(amount).toFixed(2)}`,'info');
  setSignal('enviando','üì§ ENVIANDO ORDEM...','Aguardando confirma√ß√£o da Deriv');
}

function handleBuy(data){
  if(data.error){ tradeInProgress=false; cycleState='IDLE'; log('‚ùå Erro ao comprar: '+data.error.message+' ‚Äî ciclo liberado.','error'); return; }
  currentContractId=data.buy.contract_id;
  log(`‚úÖ Contrato aberto! ID: ${currentContractId} | Pago: $${data.buy.buy_price}`,'success');
  ws.send(JSON.stringify({proposal_open_contract:1,contract_id:currentContractId,subscribe:1}));
  setSignal('enviando','‚è≥ CONTRATO ABERTO','Aguardando resultado...');
}

function handleProposalResponse(data){
  if(data.error) return; // ignore proposal errors silently
  const p = data.proposal;
  if(!p) return;
  // Identify which strategy this proposal was for via req_id map
  const reqId = String(data.req_id || '');
  // Try map first, then parse from req_id string (format: p_over5_timestamp)
  let stratKey = payoutReqMap[reqId];
  if(!stratKey && reqId.startsWith('p_')){
    const parts = reqId.split('_');
    if(parts.length >= 3) stratKey = parts[1] + parts[2]; // e.g. 'over' + '5'
    // actually format is p_{stratKey}_{timestamp} where stratKey has no underscore
    stratKey = reqId.replace(/^p_/, '').replace(/_\d+$/, '');
  }
  if(!stratKey) stratKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
  delete payoutReqMap[reqId]; // cleanup
  // Calculate real payout multiplier from API response
  const stake = parseFloat(p.ask_price || 0);
  const payout = parseFloat(p.payout || 0);
  if(stake <= 0 || payout <= 0) return;
  const multiplier = (payout - stake) / stake;
  if(multiplier <= 0) return; // sanity check
  payoutCache[stratKey] = multiplier;
  // Update payout cell in martRefTable for this specific strategy (no full rebuild)
  updatePayoutCell(stratKey, multiplier);
  // Only full-rebuild martingale boleta table if this is the active strategy
  const activeKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
  if(stratKey === activeKey) renderMartTable();
  const label=stratKey.replace(/([a-zA-Z]+)(\d+)/,'$1 $2').toUpperCase();
  log(`üí∞ Payout REAL ${label}: ${(multiplier*100).toFixed(1)}% (entrada $${stake.toFixed(2)} ‚Üí lucro $${(stake*multiplier).toFixed(2)})`, 'success');
}

function handleContract(data){
  const c=data.proposal_open_contract; if(!c) return;
  // Ignore updates from old/stale contracts ‚Äî only process current one
  if(currentContractId && c.contract_id !== currentContractId){
    log(`‚ö†Ô∏è Ignorando contrato antigo: ${c.contract_id}`, 'info');
    return;
  }
  if(c.balance_after) updateBalanceUI(parseFloat(c.balance_after));
  if(c.is_expired||c.is_sold){
    // Prevent double-processing same contract result
    if(processedContracts.has(c.contract_id)){
      log(`‚ö†Ô∏è Resultado duplicado ignorado: ${c.contract_id}`, 'info');
      return;
    }
    processedContracts.add(c.contract_id);
    // Keep set small
    if(processedContracts.size > 20) processedContracts.clear();
    tradeInProgress=false;
    const profit=parseFloat(c.profit||0);
    const isWin=profit>0;
    const bal=parseFloat(c.balance_after||0);
    if(isWin){
      try{playWin();}catch(e){}
      addPnl(profit);
      const pnlSign=sessionPnl>=0?'+':'';
      log(`üèÜ GANHOU! +$${profit.toFixed(2)} | Sess√£o: ${pnlSign}$${sessionPnl.toFixed(2)} | Saldo: $${bal.toFixed(2)}`,'success');
      // Recolor trigger chip to BLUE (win)
      if(window._triggerChip){ window._triggerChip.className='digit-chip trigger-win'; window._triggerChip=null; }
      // WIN ‚Üí reset everything, back to IDLE for fresh new cycle
      cycleState = 'IDLE';
      robotActive = false; virtualLossStreak = 0;
      // WIN em qualquer n√≠vel ‚Üí volta SEMPRE ao n√≠vel 1
      const wasLevel = martingaleLevel;
      martingaleLevel = 0; pendingMartingaleLevel = 0;
      currentContractId = null;
      if(wasLevel > 1){
        log(`‚Ü©Ô∏è Martingale resetado ao n√≠vel 1 (ganhou no n√≠vel ${wasLevel})`, 'success');
      }
      setSignal('aguardando', '‚úÖ GANHOU! Monitorando...', 'Aguardando pr√≥ximo ciclo de ' + (getVirtualLossTarget()) + ' losses virtuais');
    } else {
      try{playLoss();}catch(e){}
      const lost=Math.abs(profit);
      addPnl(-lost);
      martingaleLevel++;
      const pnlSign=sessionPnl>=0?'+':'';
      const balMsg=bal<0?` | ‚ö†Ô∏è SALDO NEGATIVO: $${bal.toFixed(2)}`:`| Saldo: $${bal.toFixed(2)}`;
      log(`üí∏ PERDEU! -$${lost.toFixed(2)} | Sess√£o: ${pnlSign}$${sessionPnl.toFixed(2)} ${balMsg}`,'error');
      // Recolor trigger chip to BRIGHT RED (loss)
      if(window._triggerChip){ window._triggerChip.className='digit-chip trigger-loss'; window._triggerChip=null; }
      if(bal<0) log(`üö® SALDO NEGATIVO: $${bal.toFixed(2)}`,'error');
      const maxLvl=getMartLevels();
      if(martingaleLevel>maxLvl){
        log(`üö® STOP MARTINGALE! Perdeu no n√≠vel m√°ximo (${maxLvl}). Rob√¥ encerrado automaticamente.`,'error');
        cycleState = 'IDLE';
        robotActive = false; martingaleLevel = 0; virtualLossStreak = 0; pendingMartingaleLevel = 0;
        // Encerra rob√¥ automaticamente ‚Äî independente do stop loss
        sessionStopped = true;
        disableAutoTrade();
        document.getElementById('bStatus').textContent='STOP MARTINGALE ‚ùå';
        document.getElementById('bStatus').style.color='var(--red)';
        setSignal('perigo','üö® STOP MARTINGALE','N√≠vel m√°ximo atingido ‚Äî Rob√¥ encerrado');
        try{playStopLoss();}catch(e){}
        showStopAlert('martingale');
      } else {
        // LOSS ‚Üí store martingale level, go back to IDLE to wait for next virtual cycle
        pendingMartingaleLevel = martingaleLevel;
        cycleState = 'IDLE';
        robotActive = false; virtualLossStreak = 0;
        const next = dynamicMartTable[martingaleLevel - 1]?.entry || (selectedRobot?.entry || 1);
        log(`üîÑ Voltando ao virtual... Pr√≥ximo ciclo entrar√° no n√≠vel ${martingaleLevel} ($${parseFloat(next).toFixed(2)})`, 'warning');
        setSignal('virtual', 'üîÑ AGUARDANDO CICLO VIRTUAL', 'Esperando ' + (selectedRobot?.virtualLosses||2) + ' losses virtuais ‚Üí N√≠vel ' + martingaleLevel);
      }
    }
    currentContractId=null;
    updateBoletaDisplay();
    updateVdots();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PNL & STOPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addPnl(amount){
  sessionPnl+=amount; sessionOps++;
  updatePnlUI();
  checkStops();
}

function updatePnlUI(){
  const el=document.getElementById('bPnl');
  const bar=document.getElementById('pnlFill');
  const sign=sessionPnl>=0?'+':'';
  el.textContent=sign+'$'+sessionPnl.toFixed(2);
  el.style.color=sessionPnl>=0?'var(--green)':'var(--red)';
  const sg=parseFloat(document.getElementById('boletaSG')?.value||20);
  const sl=parseFloat(document.getElementById('boletaSL')?.value||30);
  const maxV=Math.max(sg,sl,Math.abs(sessionPnl));
  bar.style.width=Math.min(Math.abs(sessionPnl)/maxV*100,100)+'%';
  bar.style.background=sessionPnl>=0?'var(--green)':'var(--red)';
  const statusEl=document.getElementById('bStatus');
  if(!sessionStopped){
    statusEl.textContent=sessionOps>0?'OPERANDO':'AGUARDANDO';
    statusEl.style.color=sessionOps>0?'var(--accent)':'var(--dim)';
  }
}

function updateBalanceUI(bal){
  accountBalance=bal;
  const el=document.getElementById('accBalanceD');
  el.textContent=(bal<0?'-$'+Math.abs(bal).toFixed(2):'$'+bal.toFixed(2));
  el.style.color=bal<0?'var(--red)':'var(--green)';
}

function checkStops(){
  if(sessionStopped) return;
  const sg=parseFloat(document.getElementById('boletaSG')?.value||20);
  const sl=parseFloat(document.getElementById('boletaSL')?.value||30);
  if(sessionPnl>=sg){
    sessionStopped=true; disableAutoTrade();
    log(`üèÜ STOP GAIN! Lucro: $${sessionPnl.toFixed(2)}`,'success');
    document.getElementById('bStatus').textContent='STOP GAIN ‚úÖ';
    document.getElementById('bStatus').style.color='var(--green)';
    try{playStopGain();}catch(e){}
    showStopAlert('gain');
  } else if(sessionPnl<=-sl){
    sessionStopped=true; disableAutoTrade();
    log(`üö® STOP LOSS! Preju√≠zo: $${sessionPnl.toFixed(2)}`,'error');
    document.getElementById('bStatus').textContent='STOP LOSS ‚ùå';
    document.getElementById('bStatus').style.color='var(--red)';
    try{playStopLoss();}catch(e){}
    showStopAlert('loss');
  }
}

function showStopAlert(type){
  const old=document.getElementById('stopAlert'); if(old) old.remove();
  const isGain=type==='gain';
  const isMart=type==='martingale';
  const color=isGain?'#00ff9f':'#ff3b6b', rgba=isGain?'rgba(0,255,159,.3)':'rgba(255,59,107,.3)';
  const div=document.createElement('div');
  div.id='stopAlert'; div.className='overlay';
  div.innerHTML=`<div class="overlay-box" style="border:2px solid ${color};box-shadow:0 0 60px ${rgba};">
    <div style="font-size:52px;margin-bottom:12px;">${isGain?'üèÜ':isMart?'üíÄ':'üõë'}</div>
    <h2 style="color:${color};font-size:20px;letter-spacing:2px;margin-bottom:10px;">${isGain?'STOP GAIN ATINGIDO!':isMart?'STOP MARTINGALE!':'STOP LOSS ATINGIDO!'}</h2>
    <p style="color:#c8e6f5;font-size:13px;margin-bottom:6px;">${isGain?'Meta de lucro alcan√ßada!':isMart?'Perdeu no n√≠vel m√°ximo do Martingale.':'Limite de perda atingido.'}</p>
    <p style="color:${color};font-size:30px;font-weight:900;font-family:Share Tech Mono,monospace;margin-bottom:8px;">${sessionPnl>=0?'+':''}$${sessionPnl.toFixed(2)}</p>
    <p style="color:#8aafcc;font-size:13px;margin-bottom:24px;">Deseja continuar operando ou encerrar?</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button onclick="continueSession()" style="background:rgba(0,212,255,.15);color:#00d4ff;border:1px solid #00d4ff;border-radius:8px;padding:11px 24px;cursor:pointer;font-size:13px;font-weight:700;">‚ñ∂ CONTINUAR</button>
      <button onclick="stopSession()" style="background:${isGain?'rgba(0,255,159,.1)':'rgba(255,59,107,.1)'};color:${color};border:1px solid ${color};border-radius:8px;padding:11px 24px;cursor:pointer;font-size:13px;font-weight:700;">‚èπ ENCERRAR</button>
    </div>
  </div>`;
  document.body.appendChild(div);
}

function continueSession(){
  document.getElementById('stopAlert')?.remove();
  sessionStopped=false; sessionPnl=0; sessionOps=0;
  updatePnlUI();
  log('‚ñ∂ Sess√£o continuada! Contadores resetados.','info');
}

function stopSession(){
  document.getElementById('stopAlert')?.remove();
  sessionStopped=true; disableAutoTrade();
  log('‚èπ Sess√£o encerrada.','warning');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROCESS DIGIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function processDigitSilent(d){
  digits.push(d); freqMap[d]=(freqMap[d]||0)+1;
  const cfg=getStrategyConfig();
  const isWin=cfg.winDigits.includes(d);
  if(isWin){wins++;currentLossStreak=0;}
  else{losses++;currentLossStreak++;if(currentLossStreak>maxLossStreak)maxLossStreak=currentLossStreak;}
}

// ‚îÄ‚îÄ CYCLE STATES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IDLE       ‚Üí monitoring virtual losses, counting toward target
// TRIGGERED  ‚Üí target reached, trade sent, waiting for result
// After result ‚Üí back to IDLE (win: reset mart) or IDLE (loss: pending mart++)
// One trade per cycle. No re-entry until next virtual cycle completes.
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let cycleState = 'IDLE'; // 'IDLE' | 'TRIGGERED'

// ‚îÄ‚îÄ PING ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pingInterval = null;
let pingStartTime = 0;
let currentPing = 0;
let pingAlertShown = false;
const PING_GOOD = 200;   // ms ‚Äî green
const PING_WARN = 500;   // ms ‚Äî yellow
const PING_BAD  = 1000;  // ms ‚Äî red, alert + skip trade

function startPing(){
  stopPing();
  pingInterval = setInterval(sendPing, 3000); // every 3s
  sendPing(); // immediate first
}

function stopPing(){
  clearInterval(pingInterval);
  pingInterval = null;
  pingAlertShown = false;
  // Reset UI
  const dot=document.getElementById('pingDot');
  const box=document.getElementById('pingBox');
  const val=document.getElementById('pingVal');
  if(dot){ dot.className='ping-dot'; }
  if(box){ box.className='ping-box'; }
  if(val){ val.textContent='‚Äî'; }
  hidePingAlert();
}

function sendPing(){
  if(!ws || ws.readyState !== 1) return;
  pingStartTime = Date.now();
  try{ ws.send(JSON.stringify({ping:1})); } catch(e){}
}

function handlePong(){
  currentPing = Date.now() - pingStartTime;
  updatePingUI(currentPing);
}

function updatePingUI(ms){
  const dot=document.getElementById('pingDot');
  const box=document.getElementById('pingBox');
  const val=document.getElementById('pingVal');
  if(!val) return;
  val.textContent = ms + ' ms';
  let cls, boxCls, label;
  if(ms < PING_GOOD){
    cls='good'; boxCls='good';
    val.style.color='var(--green)';
    label='EXCELENTE';
  } else if(ms < PING_WARN){
    cls='warn'; boxCls='warn';
    val.style.color='var(--gold)';
    label='ACEIT√ÅVEL';
  } else {
    cls='bad'; boxCls='bad';
    val.style.color='var(--red)';
    label='ALTO';
  }
  if(dot){ dot.className='ping-dot '+cls; }
  if(box){ box.className='ping-box '+boxCls; box.title='Ping: '+ms+'ms ‚Äî '+label; }
  // Alert if bad
  if(ms >= PING_BAD){
    showPingAlert(ms);
  } else {
    hidePingAlert();
  }
}

function showPingAlert(ms){
  const el=document.getElementById('pingAlert');
  const msg=document.getElementById('pingAlertMsg');
  if(!el) return;
  if(msg) msg.textContent='Ping atual: '+ms+'ms ‚Äî Lat√™ncia muito alta para operar com seguran√ßa';
  el.classList.add('show');
  if(!pingAlertShown){
    pingAlertShown=true;
    log('üî¥ PING CR√çTICO: '+ms+'ms ‚Äî Opera√ß√µes podem ser puladas!','error');
  }
}

function hidePingAlert(){
  const el=document.getElementById('pingAlert');
  if(el) el.classList.remove('show');
  pingAlertShown=false;
}

function isPingOkToTrade(){
  // If no ping measured yet (not connected long), allow
  if(currentPing === 0) return true;
  return currentPing < PING_BAD;
}

function processDigit(d){
  digits.push(d); freqMap[d]=(freqMap[d]||0)+1;
  const cfg=getStrategyConfig();
  const isWin=cfg.winDigits.includes(d);
  if(isWin){wins++;currentLossStreak=0;}
  else{losses++;currentLossStreak++;if(currentLossStreak>maxLossStreak)maxLossStreak=currentLossStreak;}

  // Chip class determined inline as robot logic runs (captures state before resets)
  let pendingChipClass = 'neutral';
  // If this is the trade digit (first digit after trigger), mark it
  if(window._nextChipIsTrigger){
    pendingChipClass = 'pending-trigger';
    window._nextChipIsTrigger = false;
  }

  // ‚îÄ‚îÄ Virtual loss monitoring ‚Äî only when IDLE (no active trade) ‚îÄ‚îÄ
  if(cycleState === 'IDLE' && !sessionStopped && autoTradeEnabled){
    // A win resets the virtual streak ‚Äî fresh start
    if(isWin){
      pendingChipClass = 'neutral';
      if(virtualLossStreak > 0){
        log(`üîÅ Streak virtual zerado (d√≠gito ${d} = WIN)`, 'info');
      }
      virtualLossStreak = 0;
    } else {
      virtualLossStreak++;
      const target = getVirtualLossTarget();
      pendingChipClass = 'virt-loss'; // will be overwritten if this is the trigger digit
      log(`üëÅÔ∏è Loss virtual ${virtualLossStreak}/${target} (d√≠gito ${d})`, 'info');

      if(virtualLossStreak >= target){
        // ‚îÄ‚îÄ CYCLE TRIGGERED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        cycleState = 'TRIGGERED';
        robotActivationCount++;
        buildMartTable();

        if(pendingMartingaleLevel > 0){
          martingaleLevel = pendingMartingaleLevel;
          martingaleEntry = dynamicMartTable[martingaleLevel - 1]?.entry || (selectedRobot?.entry || 1);
          log(`ü§ñ REATIVADO ap√≥s ${target} losses virtuais ‚Üí N√≠vel ${martingaleLevel} ‚Äî $${parseFloat(martingaleEntry).toFixed(2)}`, 'warning');
          pendingMartingaleLevel = 0;
        } else {
          martingaleLevel = 1;
          martingaleEntry = dynamicMartTable[0]?.entry || (selectedRobot?.entry || 1);
          log(`ü§ñ ROB√î ATIVADO! ${target} losses virtuais ‚Üí N√≠vel 1 ‚Äî $${parseFloat(martingaleEntry).toFixed(2)}`, 'warning');
        }

        setSignal('entrar', 'üö® ENTRAR AGORA!', `N√≠vel ${martingaleLevel} ‚Äî $${parseFloat(martingaleEntry).toFixed(2)}`);
        // Trigger digit is the last virtual loss ‚Äî stays red (virt-loss).
        // The NEXT digit (evaluated by Deriv for the trade) will be marked pending-trigger.
        pendingChipClass = 'virt-loss';
        window._nextChipIsTrigger = true; // flag: next digit = trade digit
        virtualLossStreak = 0;

        if(autoTradeEnabled && !tradeInProgress && !sessionStopped){
          // AUTO-TRADE ON: send trade, stay TRIGGERED until result comes back
          setTimeout(() => placeTrade(martingaleEntry), 300);
        } else {
          // AUTO-TRADE OFF: just signal, immediately return to IDLE for next cycle
          // User sees the signal but robot doesn't place the trade automatically
          cycleState = 'IDLE';
        }
      }
    }
  }
  // If TRIGGERED: ignore all incoming digits for robot logic ‚Äî just display them

  updateLastDigit(d);
  updateVdots();
  updateBoletaDisplay();
  // Update freq + OU every digit via rAF (non-blocking); diagnostics every 5 digits
  if(!window._uiUpdatePending){
    window._uiUpdatePending = true;
    requestAnimationFrame(()=>{
      updateFreqGrid();
      updateOUTable();
      if(digits.length % 5 === 0) updateDiagnostics();
      window._uiUpdatePending = false;
    });
  }
  document.getElementById('progressText').textContent = digits.length + ' d√≠gitos';
  document.getElementById('totalDigits').textContent = 'Total: ' + digits.length + ' d√≠gitos';

  // Digit chip coloring based on cycle context
  // chipClass is set BEFORE any streak resets to capture correct state
  const stream = document.getElementById('digitStream');
  const chip = document.createElement('div');
  chip.className = 'digit-chip ' + pendingChipClass;
  chip.textContent = d;
  // If this is the trade digit, store reference to recolor when trade result arrives
  if(pendingChipClass === 'pending-trigger'){
    window._triggerChip = chip;
    chip.className = 'digit-chip virt-loss'; // neutral until result
  }
  stream.appendChild(chip);
  if(stream.children.length > 200) stream.removeChild(stream.firstChild);
  stream.scrollTop = stream.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UI UPDATES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSignal(cls, text, desc){
  document.getElementById('robotSignal').className='signal-val '+cls;
  document.getElementById('robotSignal').textContent=text;
  document.getElementById('signalDesc').textContent=desc;
}

function updateLastDigit(d){
  const cfg=getStrategyConfig();
  const isWin=cfg.winDigits.includes(d);
  const el=document.getElementById('lastDigitDisplay');
  el.textContent=d;
  el.style.color=isWin?'var(--green)':'var(--red)';
  el.style.background=isWin?'rgba(0,255,159,.1)':'rgba(255,59,107,.1)';
  document.getElementById('lastDigitResult').textContent=isWin?'‚úÖ WIN':'‚ùå LOSS';
  document.getElementById('lastDigitResult').style.color=isWin?'var(--green)':'var(--red)';
  document.getElementById('lastDigitStrat').textContent=cfg.name+' ('+cfg.winDigits.join(',')+')';
}

function updateFreqGrid(){
  const total=digits.length;
  const max=Math.max(...Object.values(freqMap),1);
  document.getElementById('freqGrid').innerHTML=Object.keys(freqMap).map(d=>{
    const cnt=freqMap[d]||0;
    const pct=total>0?(cnt/total*100).toFixed(1):0;
    const barW=total>0?(cnt/max*100):0;
    return `<div class="freq-card">
      <div class="freq-digit">${d}</div>
      <div class="freq-count">${cnt} (${pct}%)</div>
      <div class="freq-bar-wrap"><div class="freq-bar" style="width:${barW}%"></div></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ ESTRAT√âGIAS Over 0-8 com payouts base da Deriv (R_100 Volatility)
// Payout real √© buscado via API ‚Äî esses valores s√£o fallback inicial
const FALLBACK_PAYOUTS = {
  over0:0.055, over1:0.10, over2:0.22, over3:0.43,
  over4:0.85,  over5:1.50, over6:2.40, over7:4.50, over8:9.00,
  under1:9.00, under2:4.50, under3:2.40, under4:1.50,
  under5:0.85, under6:0.43, under7:0.22, under8:0.10, under9:0.055
};

const ALL_STRATEGIES = [
  {key:'over0', label:'Over 0', digits:'1‚Äì9', winCount:9},
  {key:'over1', label:'Over 1', digits:'2‚Äì9', winCount:8},
  {key:'over2', label:'Over 2', digits:'3‚Äì9', winCount:7},
  {key:'over3', label:'Over 3', digits:'4‚Äì9', winCount:6},
  {key:'over4', label:'Over 4', digits:'5‚Äì9', winCount:5},
  {key:'over5', label:'Over 5', digits:'6‚Äì9', winCount:4},
  {key:'over6', label:'Over 6', digits:'7‚Äì9', winCount:3},
  {key:'over7', label:'Over 7', digits:'8‚Äì9', winCount:2},
  {key:'over8', label:'Over 8', digits:'s√≥ 9', winCount:1},
];

function getEffectivePayout(key){
  // Prefer live fetched payout, fall back to static table
  return payoutCache[key] ?? FALLBACK_PAYOUTS[key] ?? 0.43;
}

function syncMartRefFromBoleta(){
  const entry=parseFloat(document.getElementById('boletaEntry')?.value||0.35)||0.35;
  const factor=getMartFactor();
  const levels=getMartLevels();
  const eEl=document.getElementById('martRefEntry');
  const fEl=document.getElementById('martRefFactor');
  const lEl=document.getElementById('martRefLevels');
  if(eEl) eEl.value=entry.toFixed(2);
  if(fEl) fEl.value=factor;
  if(lEl){ const capped=Math.min(Math.max(levels,3),8); lEl.value=String(capped); }
  updateMartRefTable();
}

// Update a single strategy row's payout cell in real-time
function updatePayoutCell(stratKey, multiplier){
  const entry=parseFloat(document.getElementById('martRefEntry')?.value||0.35)||0.35;
  const factor=parseFloat(document.getElementById('martRefFactor')?.value||2.8)||2.8;
  const LEVELS=parseInt(document.getElementById('martRefLevels')?.value||5)||5;

  // Build level amounts
  const levelAmounts=[], levelAccum=[];
  let e=entry, acc=0;
  for(let i=0;i<LEVELS;i++){
    acc+=e;
    levelAmounts.push(parseFloat(e.toFixed(2)));
    levelAccum.push(parseFloat(acc.toFixed(2)));
    e*=factor;
  }

  const payout=multiplier;
  const payoutPct=(payout*100).toFixed(1)+'%';
  const payColor=payout>1.5?'var(--red)':payout>0.5?'var(--gold)':'var(--green)';

  // Find the row for this strategy
  const tbody=document.getElementById('martRefBody');
  if(!tbody) return;
  const rows=tbody.querySelectorAll('tr');
  rows.forEach(row=>{
    if(row.dataset.stratKey !== stratKey) return;
    const cells=row.querySelectorAll('td');
    if(!cells.length) return;
    // Update payout cell (index 1)
    cells[1].innerHTML=`<span style="color:${payColor};font-weight:700;font-size:12px;">${payoutPct}</span><div style="font-size:9px;color:var(--green);letter-spacing:1px;">‚óèLIVE</div>`;
    // Update profit cells (index 3 onwards ‚Äî after strat, payout, win%)
    for(let i=0;i<LEVELS;i++){
      const cell=cells[i+3];
      if(!cell) continue;
      const stake=levelAmounts[i];
      const prevAccum=i>0?levelAccum[i-1]:0;
      const grossProfit=stake*payout;
      const net=grossProfit-prevAccum;
      const grossStr='+$'+grossProfit.toFixed(2);
      const netStr=(net>=0?'‚ñ≤+$':'‚ñº-$')+Math.abs(net).toFixed(2);
      const netColor=net>=0?'var(--green)':'var(--red)';
      cell.innerHTML=`<div style="color:var(--green);font-size:11px;font-weight:700;">${grossStr}</div><div style="color:${netColor};font-size:9px;">${netStr}</div>`;
    }
  });
}

function updateMartRefTable(){
  const tbody=document.getElementById('martRefBody');
  if(!tbody) return;

  // Own inputs ‚Äî independent of boleta
  const entry=parseFloat(document.getElementById('martRefEntry')?.value||0.35)||0.35;
  const factor=parseFloat(document.getElementById('martRefFactor')?.value||2.8)||2.8;
  const LEVELS=parseInt(document.getElementById('martRefLevels')?.value||5)||5;
  const activeStrat=selectedRobot?.strategy||document.getElementById('manualStrategy')?.value||'over3';

  // Info label
  const info=document.getElementById('martRefInfo');
  if(info) info.textContent=`Entrada: $${entry.toFixed(2)} ¬∑ Fator: x${factor} ¬∑ 5 n√≠veis`;

  // Always build 5 levels regardless of robot config
  const levelAmounts=[], levelAccum=[];
  let e=entry, acc=0;
  for(let i=0;i<LEVELS;i++){
    acc+=e;
    levelAmounts.push(parseFloat(e.toFixed(2)));
    levelAccum.push(parseFloat(acc.toFixed(2)));
    e*=factor;
  }

  // Header
  const headerRow=document.querySelector('#martRefTable thead tr');
  if(headerRow){
    let h='<th class="strat-col">ESTRAT√âGIA</th><th>PAYOUT</th><th>WIN%</th>';
    for(let i=1;i<=LEVELS;i++){
      const stakeStr='$'+levelAmounts[i-1].toFixed(2);
      h+=`<th>N${i}<div style="font-size:8px;color:var(--dim);font-weight:400;">${stakeStr}</div></th>`;
    }
    headerRow.innerHTML=h;
  }

  tbody.innerHTML=ALL_STRATEGIES.map(strat=>{
    const payout=getEffectivePayout(strat.key);
    const isLive=payoutCache[strat.key]!=null;
    const winPct=((strat.winCount/10)*100).toFixed(0)+'%';
    const payoutPct=(payout*100).toFixed(0)+'%';
    const isActive=strat.key===activeStrat;
    const payColor=payout>1.5?'var(--red)':payout>0.5?'var(--gold)':'var(--green)';

    let cells='';
    for(let i=0;i<LEVELS;i++){
      const stake=levelAmounts[i];
      const prevAccum=i>0?levelAccum[i-1]:0;
      const grossProfit=stake*payout;
      // Net profit = gross profit from this bet minus all previous losses
      const net=grossProfit-prevAccum;
      const grossStr='+$'+grossProfit.toFixed(2);
      const netStr=(net>=0?'‚ñ≤+$':'‚ñº-$')+Math.abs(net).toFixed(2);
      const netColor=net>=0?'var(--green)':'var(--red)';
      cells+=`<td style="padding:4px 6px;">
        <div style="color:var(--green);font-size:11px;font-weight:700;">${grossStr}</div>
        <div style="color:${netColor};font-size:9px;">${netStr}</div>
      </td>`;
    }

    return `<tr class="${isActive?'active-strat':''}" data-strat-key="${strat.key}">
      <td class="strat-cell" style="padding:5px 8px;">
        <span style="font-size:12px;">${strat.label}</span>
        <div style="font-size:9px;color:var(--dim);">${strat.digits}</div>
      </td>
      <td style="color:${payColor};font-weight:700;font-size:11px;">
        ${payoutPct}
        ${isLive
          ? '<div style="font-size:9px;color:var(--green);letter-spacing:1px;">‚óèLIVE</div>'
          : '<div style="font-size:9px;color:var(--dim);letter-spacing:1px;">~est.</div>'}
      </td>
      <td style="color:var(--dim);font-size:11px;">${winPct}</td>
      ${cells}
    </tr>`;
  }).join('');
}

function updateOUTable(){
  const total=digits.length;
  const ops=[
    {name:'Over 0',winD:[1,2,3,4,5,6,7,8,9]},{name:'Over 1',winD:[2,3,4,5,6,7,8,9]},
    {name:'Over 2',winD:[3,4,5,6,7,8,9]},{name:'Over 3',winD:[4,5,6,7,8,9]},
    {name:'Over 4',winD:[5,6,7,8,9]},{name:'Over 5',winD:[6,7,8,9]},
    {name:'Over 6',winD:[7,8,9]},{name:'Over 7',winD:[8,9]},{name:'Over 8',winD:[9]},
    {name:'Under 1',winD:[0]},{name:'Under 2',winD:[0,1]},{name:'Under 3',winD:[0,1,2]},
    {name:'Under 4',winD:[0,1,2,3]},{name:'Under 5',winD:[0,1,2,3,4]},
    {name:'Under 6',winD:[0,1,2,3,4,5]},{name:'Under 7',winD:[0,1,2,3,4,5,6]},
    {name:'Under 8',winD:[0,1,2,3,4,5,6,7]},{name:'Under 9',winD:[0,1,2,3,4,5,6,7,8]},
  ];
  const tbody=document.querySelector('#ouTable tbody');
  tbody.innerHTML=ops.map(o=>{
    const cnt=o.winD.reduce((s,d)=>s+(freqMap[d]||0),0);
    const pct=total>0?(cnt/total*100).toFixed(1):0;
    const exp=(o.winD.length/10*100).toFixed(0);
    const diff=total>0?(parseFloat(pct)-parseFloat(exp)):0;
    const badge=diff>=2?'badge-green':diff<=-2?'badge-red':'badge-gold';
    const label=diff>=2?'ACIMA':'ABAIXO DO ESPERADO';
    const isActive=selectedRobot&&selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2')===o.name;
    return `<tr ${isActive?'style="background:rgba(0,212,255,.05)"':''}>
      <td style="font-weight:700;${isActive?'color:var(--accent)':''}">${o.name}</td>
      <td>${o.winD[0]}‚Äì${o.winD[o.winD.length-1]}</td>
      <td style="color:${parseFloat(pct)>=parseFloat(exp)?'var(--green)':'var(--red)'};">${total>0?pct+'%':'‚Äî'}</td>
      <td>${total>50?`<span class="badge ${badge}">${pct>=exp?'ACIMA':label}</span>`:'<span style="color:var(--dim)">Coletando...</span>'}</td>
    </tr>`;
  }).join('');
}

function updateDiagnostics(){
  const total=digits.length;
  const grid=document.getElementById('diagGrid');
  const configs=[];
  for(let x=0;x<=8;x++){
    const w=[]; for(let d=x+1;d<=9;d++) w.push(d);
    configs.push({name:`OVER ${x}`,winD:w,expected:(9-x)/10*100,digits:`${x+1}‚Äì9`});
  }
  for(let x=1;x<=9;x++){
    const w=[]; for(let d=0;d<x;d++) w.push(d);
    configs.push({name:`UNDER ${x}`,winD:w,expected:x/10*100,digits:`0‚Äì${x-1}`});
  }
  const activeStrat=selectedRobot?selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/,'$1 $2'):'';
  grid.innerHTML=configs.map(c=>{
    const cnt=c.winD.reduce((s,d)=>s+(freqMap[d]||0),0);
    const pct=total>0?cnt/total*100:null;
    const pctD=pct!==null?pct.toFixed(1)+'%':'‚Äî';
    let color='var(--dim)', trend='Coletando...';
    if(pct!==null&&total>50){
      const diff=pct-c.expected;
      if(diff>=3){color='var(--green)';trend='üü¢ ACIMA';}
      else if(diff>=0){color='var(--accent)';trend='üîµ NORMAL';}
      else if(diff>=-3){color='var(--gold)';trend='üü° ABAIXO';}
      else{color='var(--red)';trend='üî¥ BEM ABAIXO';}
    }
    const isActive=c.name===activeStrat;
    return `<div class="diag-item" style="${isActive?'border-color:var(--accent);box-shadow:0 0 8px rgba(0,212,255,.2);':''}">
      <div class="diag-name" style="${isActive?'color:var(--accent);':''}">${c.name}</div>
      <div class="diag-exp">${c.digits} ¬∑ esp:${c.expected.toFixed(0)}%</div>
      <div class="diag-pct" style="color:${color}">${pctD}</div>
      <div class="diag-trend" style="color:${color}">${total>50?trend:'Coletando...'}</div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function log(msg,type='info'){
  const area=document.getElementById('logArea'); if(!area) return;
  const t=new Date().toLocaleTimeString('pt-BR');
  const line=document.createElement('div');
  line.className=`log-line ${type}`;
  line.textContent=`[${t}] ${msg}`;
  area.appendChild(line);
  // Keep max 200 lines ‚Äî remove oldest when exceeded
  while(area.children.length > 50) area.removeChild(area.firstChild);
  area.scrollTop=area.scrollHeight;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Init form watchers
['rfEntry','rfFactor','rfLevels'].forEach(id=>{
  const el=document.getElementById(id);
  if(el) el.addEventListener('input',updateMartPreview);
});

renderRobotList();
updateMartPreview();
applyBrand(); // apply saved brand on load
updateDiagnostics();
updateOUTable();
updateFreqGrid();
</script>
</body>
</html>
