<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DERIV · Sistema de Robôs</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Exo+2:wght@300;400;600;700;900&family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <script>if (sessionStorage.getItem('alpha_session')) document.documentElement.classList.add('restoring-session');</script>
  <style>
    .restoring-session #screenLogin {
      visibility: hidden !important;
    }

    :root {
      --bg: #0a0b14;
      --surface: rgba(22, 24, 38, .85);
      --surface2: rgba(30, 33, 52, .9);
      --border: rgba(56, 62, 92, .45);
      --accent: #00d4ff;
      --accent2: #00ff88;
      --red: #ff4757;
      --green: #00ff88;
      --gold: #ffb800;
      --text: #e2e8f4;
      --dim: #6b7394;
      --glass-bg: rgba(18, 20, 35, .75);
      --glass-border: rgba(80, 90, 140, .25);
      --glow-accent: rgba(0, 212, 255, .15);
      --glow-green: rgba(0, 255, 136, .12);
      --glow-red: rgba(255, 71, 87, .12);
      --glow-gold: rgba(255, 184, 0, .12);
      --gradient-accent: linear-gradient(135deg, #00d4ff, #0090ff);
      --gradient-success: linear-gradient(135deg, #00ff88, #00cc6a);
      --gradient-danger: linear-gradient(135deg, #ff4757, #ff2d3b);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background-image:
        radial-gradient(ellipse at 20% 50%, rgba(0, 212, 255, .04) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 20%, rgba(0, 255, 136, .03) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 80%, rgba(255, 184, 0, .02) 0%, transparent 50%);
      background-attachment: fixed;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(107, 115, 148, .3);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(107, 115, 148, .5);
    }

    /* Toggle Auto/Manual */
    .mode-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .mode-toggle-label {
      font-size: 9px;
      letter-spacing: 1.5px;
      font-family: 'Share Tech Mono', monospace;
      font-weight: 700;
      transition: color .3s;
    }

    .toggle-track {
      width: 48px;
      height: 26px;
      border-radius: 13px;
      background: rgba(0, 212, 255, .15);
      border: 1px solid rgba(0, 212, 255, .4);
      cursor: pointer;
      position: relative;
      transition: all .3s ease;
      backdrop-filter: blur(4px);
    }

    .toggle-track.manual {
      background: rgba(0, 255, 136, .15);
      border-color: rgba(0, 255, 136, .4);
    }

    .toggle-knob {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent);
      position: absolute;
      top: 2px;
      left: 2px;
      transition: left .3s ease, background .3s;
      box-shadow: 0 0 10px rgba(0, 212, 255, .6), 0 2px 8px rgba(0, 0, 0, .3);
    }

    .toggle-track.manual .toggle-knob {
      left: 24px;
      background: var(--green);
      box-shadow: 0 0 10px rgba(0, 255, 136, .6), 0 2px 8px rgba(0, 0, 0, .3);
    }

    /* Chart timeframe */
    #chartTimeframes {
      overflow-x: auto;
      scrollbar-width: none;
    }

    #chartTimeframes::-webkit-scrollbar {
      display: none;
    }

    .chart-tf-btn {
      padding: 5px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--dim);
      cursor: pointer;
      font-size: 10px;
      font-weight: 700;
      font-family: 'Share Tech Mono', monospace;
      white-space: nowrap;
      transition: all .25s ease;
    }

    .chart-tf-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--glow-accent);
    }

    .chart-tf-btn.active {
      background: rgba(0, 212, 255, .12);
      color: var(--accent);
      border-color: rgba(0, 212, 255, .5);
      box-shadow: 0 0 12px rgba(0, 212, 255, .15);
    }

    .chart-tf-sep {
      width: 1px;
      height: 18px;
      background: var(--border);
      margin: 0 6px;
      flex-shrink: 0;
    }

    .btn.active {
      background: rgba(0, 212, 255, .12);
      color: var(--accent);
      border: 1px solid rgba(0, 212, 255, .4);
    }

    /* Balance font sizes */
    #accBalanceD {
      font-size: 24px !important;
      font-weight: 900 !important;
      text-shadow: 0 0 20px rgba(0, 255, 136, .2);
    }

    #bPnl {
      font-size: 28px !important;
      text-shadow: 0 0 20px rgba(0, 255, 136, .15);
    }

    .screen {
      display: none;
      min-height: 100vh;
    }

    .screen.active {
      display: flex;
      flex-direction: column;
    }

    /* ── INPUTS & BUTTONS ── */
    input,
    select,
    textarea {
      background: rgba(20, 22, 40, .8);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px 16px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 14px;
      outline: none;
      width: 100%;
      transition: all .3s ease;
      backdrop-filter: blur(4px);
    }

    input:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(0, 212, 255, .15), inset 0 0 0 1px rgba(0, 212, 255, .1);
    }

    input::placeholder {
      color: rgba(107, 115, 148, .6);
    }

    label {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      text-transform: uppercase;
      display: block;
      margin-bottom: 6px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .btn {
      padding: 11px 22px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 1px;
      transition: all .3s ease;
      font-family: 'Inter', sans-serif;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(rgba(255, 255, 255, .08), transparent);
      pointer-events: none;
      opacity: 0;
      transition: opacity .3s;
    }

    .btn:hover::after {
      opacity: 1;
    }

    .btn-primary {
      background: var(--gradient-accent);
      color: #fff;
      box-shadow: 0 4px 16px rgba(0, 212, 255, .2);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(0, 212, 255, .35);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-danger {
      background: rgba(255, 71, 87, .1);
      color: var(--red);
      border: 1px solid rgba(255, 71, 87, .3);
      backdrop-filter: blur(4px);
    }

    .btn-danger:hover {
      background: rgba(255, 71, 87, .2);
      box-shadow: 0 0 20px rgba(255, 71, 87, .15);
    }

    .btn-success {
      background: rgba(0, 255, 136, .08);
      color: var(--green);
      border: 1px solid rgba(0, 255, 136, .3);
      backdrop-filter: blur(4px);
    }

    .btn-success:hover {
      background: rgba(0, 255, 136, .15);
      box-shadow: 0 0 20px rgba(0, 255, 136, .15);
    }

    .btn-gold {
      background: rgba(255, 184, 0, .1);
      color: var(--gold);
      border: 1px solid rgba(255, 184, 0, .3);
      backdrop-filter: blur(4px);
    }

    .btn-gold:hover {
      background: rgba(255, 184, 0, .18);
      box-shadow: 0 0 20px rgba(255, 184, 0, .15);
    }

    .btn-sm {
      padding: 7px 16px;
      font-size: 11px;
      border-radius: 8px;
    }

    .card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 22px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      transition: border-color .3s ease, box-shadow .3s ease, transform .3s ease;
    }

    .card:hover {
      border-color: rgba(0, 212, 255, .2);
      box-shadow: 0 4px 24px rgba(0, 0, 0, .2);
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: .6;
    }

    .mono {
      font-family: 'Share Tech Mono', monospace;
    }

    /* ── LOGIN SCREEN ── */
    #screenLogin {
      align-items: center;
      justify-content: center;
      background: radial-gradient(ellipse at 50% 40%, rgba(0, 212, 255, .06) 0%, transparent 60%),
        radial-gradient(ellipse at 30% 70%, rgba(0, 255, 136, .04) 0%, transparent 50%),
        var(--bg);
      position: relative;
      overflow: hidden;
    }

    #screenLogin::before {
      content: '';
      position: absolute;
      inset: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 30h60M30 0v60' stroke='%23ffffff' stroke-width='.3' opacity='.03'/%3E%3C/svg%3E");
      pointer-events: none;
    }

    .login-box {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 44px;
      width: 100%;
      max-width: 440px;
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .4), 0 0 80px rgba(0, 212, 255, .06);
    }

    .login-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--green), var(--accent));
      background-size: 200% 100%;
      animation: gradientSlide 3s ease infinite;
    }

    @keyframes gradientSlide {
      0% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }

      100% {
        background-position: 0% 50%;
      }
    }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo h1 {
      font-size: 24px;
      font-weight: 900;
      letter-spacing: 4px;
      color: var(--accent);
      text-shadow: 0 0 30px rgba(0, 212, 255, .3);
    }

    .login-logo p {
      font-size: 11px;
      color: var(--dim);
      letter-spacing: 3px;
      margin-top: 6px;
    }

    .brand-logo-img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: 16px;
      margin-bottom: 12px;
      box-shadow: 0 0 30px rgba(0, 212, 255, .15);
    }

    /* OAuth popup overlay */
    #oauthOverlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .75);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    #oauthOverlay.show {
      display: flex;
    }

    .oauth-modal {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 36px;
      text-align: center;
      max-width: 380px;
      width: 90%;
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
    }

    .oauth-spinner {
      width: 44px;
      height: 44px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 18px auto;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Profile dropdown */
    .profile-btn {
      position: relative;
      background: var(--glass-bg);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 38px;
      height: 38px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: var(--text);
      transition: all .3s ease;
      backdrop-filter: blur(4px);
    }

    .profile-btn:hover {
      border-color: var(--accent);
      box-shadow: 0 0 16px rgba(0, 212, 255, .15);
    }

    .profile-btn.deriv-connected {
      border-color: var(--green);
      box-shadow: 0 0 12px rgba(0, 255, 136, .25);
    }

    .profile-dropdown {
      display: none;
      position: absolute;
      top: calc(100% + 10px);
      right: 0;
      width: 320px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      box-shadow: 0 12px 48px rgba(0, 0, 0, .6);
      z-index: 999;
      overflow: hidden;
      backdrop-filter: blur(20px);
    }

    .profile-dropdown.open {
      display: block;
      animation: dropIn .2s ease;
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .profile-dropdown-header {
      padding: 18px;
      border-bottom: 1px solid var(--border);
      background: rgba(0, 0, 0, .2);
    }

    .profile-dropdown-section {
      padding: 14px 18px;
    }

    .pd-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--dim);
      margin-bottom: 10px;
      font-family: 'Share Tech Mono', monospace;
    }

    .deriv-status-badge {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 10px;
      background: rgba(0, 0, 0, .2);
      border: 1px solid var(--border);
      margin-bottom: 10px;
    }

    .deriv-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--dim);
      transition: all .3s;
    }

    .deriv-status-dot.connected {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    #profileDropdownWrap {
      position: relative;
    }

    .color-preview {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 2px solid var(--border);
      display: inline-block;
      vertical-align: middle;
      margin-left: 8px;
      cursor: pointer;
    }

    .login-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .login-tab {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--dim);
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all .3s ease;
    }

    .login-tab:hover {
      border-color: rgba(0, 212, 255, .3);
    }

    .login-tab.active {
      background: rgba(0, 212, 255, .1);
      color: var(--accent);
      border-color: rgba(0, 212, 255, .4);
      box-shadow: 0 0 16px rgba(0, 212, 255, .1);
    }

    /* Caixa de erro padronizada — usada via classList.add('err-visible') */
    .err-box {
      display: none;
      color: var(--red);
      font-size: 12px;
      text-align: center;
    }

    .err-box.err-visible {
      display: block;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 71, 87, .08);
      border: 1px solid rgba(255, 71, 87, .2);
    }

    /* ── TOP NAV ── */
    .topnav {
      background: rgba(14, 16, 28, .85);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      flex-wrap: wrap;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
    }

    /* ── PING ── */
    .ping-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(0, 0, 0, .3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 6px 14px;
      font-family: 'Share Tech Mono', monospace;
      transition: all .3s;
    }

    .ping-box.good {
      border-color: rgba(0, 255, 136, .4);
      box-shadow: 0 0 12px rgba(0, 255, 136, .08);
    }

    .ping-box.warn {
      border-color: rgba(255, 184, 0, .4);
      box-shadow: 0 0 12px rgba(255, 184, 0, .08);
    }

    .ping-box.bad {
      border-color: rgba(255, 71, 87, .5);
      animation: ping-danger .8s infinite;
    }

    @keyframes ping-danger {

      0%,
      100% {
        box-shadow: 0 0 0 rgba(255, 71, 87, 0);
      }

      50% {
        box-shadow: 0 0 16px rgba(255, 71, 87, .4);
      }
    }

    .ping-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: var(--dim);
      flex-shrink: 0;
      transition: all .3s;
    }

    .ping-dot.good {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: pingPulse 2s ease infinite;
    }

    .ping-dot.warn {
      background: var(--gold);
      box-shadow: 0 0 8px var(--gold);
    }

    .ping-dot.bad {
      background: var(--red);
      box-shadow: 0 0 8px var(--red);
    }

    @keyframes pingPulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: .6;
        transform: scale(1.2);
      }
    }

    .ping-val {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      min-width: 48px;
    }

    .ping-label {
      font-size: 9px;
      color: var(--dim);
      letter-spacing: 1px;
    }

    /* Ping alert overlay */
    #pingAlert {
      display: none;
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      background: rgba(255, 71, 87, .1);
      border: 2px solid var(--red);
      border-radius: 16px;
      padding: 16px 28px;
      text-align: center;
      backdrop-filter: blur(12px);
      box-shadow: 0 0 60px rgba(255, 71, 87, .2);
      min-width: 340px;
    }

    #pingAlert.show {
      display: block;
      animation: slideDown .3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }
    }

    .topnav-brand {
      font-size: 17px;
      font-weight: 900;
      letter-spacing: 3px;
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0, 212, 255, .2);
    }

    .topnav-user {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .nav-pill {
      padding: 6px 16px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--dim);
      cursor: pointer;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      transition: all .3s ease;
    }

    .nav-pill.active {
      background: rgba(0, 212, 255, .1);
      color: var(--accent);
      border-color: rgba(0, 212, 255, .4);
      box-shadow: 0 0 12px rgba(0, 212, 255, .1);
    }

    .nav-pill:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(0, 212, 255, .05);
    }

    /* ── ADMIN SCREEN ── */
    #screenAdmin .content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .admin-grid {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 24px;
      align-items: start;
    }

    @media(max-width:900px) {
      .admin-grid {
        grid-template-columns: 1fr;
      }
    }

    .robot-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .robot-card-item {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      flex-wrap: wrap;
      transition: all .3s ease;
      backdrop-filter: blur(8px);
    }

    .robot-card-item:hover {
      border-color: rgba(0, 212, 255, .3);
      transform: translateY(-1px);
      box-shadow: 0 4px 20px rgba(0, 0, 0, .2);
    }

    .robot-card-item.running {
      border-color: rgba(0, 255, 136, .35);
      box-shadow: 0 0 20px rgba(0, 255, 136, .08);
    }

    .robot-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--dim);
      flex-shrink: 0;
      transition: all .3s;
    }

    .robot-status-dot.running {
      background: var(--green);
      box-shadow: 0 0 10px var(--green);
      animation: pulse 2s ease infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: .5;
        transform: scale(1.15);
      }
    }

    .robot-name {
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
    }

    .robot-meta {
      font-size: 11px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      margin-top: 4px;
    }

    .robot-actions {
      display: flex;
      gap: 8px;
    }

    /* ── ROBOT FORM ── */
    .form-section {
      font-size: 10px;
      letter-spacing: 2.5px;
      color: var(--accent);
      font-family: 'Share Tech Mono', monospace;
      margin: 18px 0 12px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .form-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .form-grid-3 {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
    }

    /* ── DASHBOARD SCREEN ── */
    #screenDashboard {
      flex-direction: column;
    }

    #screenDashboard .dash-wrapper {
      display: grid;
      grid-template-columns: 350px 1fr 290px;
      gap: 0;
      flex: 1;
      overflow: hidden;
      height: calc(100vh - 50px);
    }

    /* LEFT panel */
    .dash-left {
      background: rgba(14, 16, 28, .9);
      border-right: 1px solid var(--border);
      overflow-y: auto;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
    }

    /* CENTER panel */
    .dash-center {
      overflow-y: auto;
      padding: 16px 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
    }

    /* RIGHT panel — log column */
    .dash-right {
      background: rgba(14, 16, 28, .9);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .dash-right-header {
      padding: 14px 16px 10px;
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--accent);
      font-family: 'Share Tech Mono', monospace;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(0, 0, 0, .15);
    }

    .dash-right-log {
      flex: 0 0 40%;
      overflow-y: auto;
      padding: 12px 14px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 10.5px;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
      background: rgba(6, 7, 14, .6);
    }

    .dash-right-ops {
      flex: 1;
      overflow-y: auto;
      padding: 0;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
      background: rgba(6, 7, 14, .6);
    }

    .live-ops-row {
      display: grid;
      grid-template-columns: 48px 1fr 72px 90px 44px 60px;
      gap: 4px;
      font-size: 10px;
      font-family: 'Share Tech Mono', monospace;
      padding: 6px 12px;
      border-bottom: 1px solid rgba(56, 62, 92, .25);
      transition: background .15s;
    }

    .live-ops-row:hover {
      background: rgba(0, 212, 255, .03);
    }

    .live-ops-row:last-child {
      border-bottom: none;
    }

    .live-ops-head {
      color: var(--dim);
      font-size: 8.5px;
      letter-spacing: 1.5px;
    }

    @media(max-width:1200px) {
      #screenDashboard .dash-wrapper {
        grid-template-columns: 310px 1fr 250px;
      }
    }

    @media(max-width:900px) {
      #screenDashboard .dash-wrapper {
        grid-template-columns: 1fr;
        height: auto;
      }

      .dash-right {
        height: 220px;
      }
    }

    /* Robot selector */
    .robot-selector {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .robot-sel-item {
      background: rgba(0, 0, 0, .25);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 13px 16px;
      cursor: pointer;
      transition: all .3s ease;
    }

    .robot-sel-item:hover,
    .robot-sel-item.active {
      border-color: var(--accent);
      background: rgba(0, 212, 255, .05);
    }

    .robot-sel-item .rs-name {
      font-weight: 700;
      font-size: 13px;
    }

    .robot-sel-item .rs-meta {
      font-size: 10px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      margin-top: 3px;
    }

    /* Robot dropdown */
    .robot-dropdown {
      position: relative;
      width: 100%;
    }

    .robot-dropdown-btn {
      width: 100%;
      background: rgba(0, 0, 0, .3);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 11px 16px;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      transition: all .3s ease;
    }

    .robot-dropdown-btn:hover,
    .robot-dropdown-btn.open {
      border-color: var(--accent);
      background: rgba(0, 212, 255, .04);
    }

    .robot-dropdown-btn .rdb-name {
      flex: 1;
      text-align: left;
    }

    .robot-dropdown-btn .rdb-arrow {
      font-size: 10px;
      color: var(--dim);
      transition: transform .25s ease;
    }

    .robot-dropdown-btn.open .rdb-arrow {
      transform: rotate(180deg);
    }

    .robot-dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: var(--glass-bg);
      border: 1px solid rgba(0, 212, 255, .4);
      border-radius: 12px;
      z-index: 100;
      overflow: hidden;
      box-shadow: 0 12px 48px rgba(0, 0, 0, .6);
      backdrop-filter: blur(16px);
    }

    .robot-dropdown-menu.open {
      display: block;
      animation: dropIn .2s ease;
    }

    .robot-dropdown-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border);
      transition: all .2s;
    }

    .robot-dropdown-item:last-child {
      border-bottom: none;
    }

    .robot-dropdown-item:hover {
      background: rgba(0, 212, 255, .06);
    }

    .robot-dropdown-item.active {
      background: rgba(0, 212, 255, .1);
      border-left: 3px solid var(--accent);
    }

    .robot-dropdown-item.manual-mode {
      border-top: 1px solid var(--border);
      background: rgba(255, 184, 0, .03);
    }

    .robot-dropdown-item.manual-mode:hover {
      background: rgba(255, 184, 0, .08);
    }

    .rdi-name {
      font-weight: 700;
      font-size: 12px;
    }

    .rdi-meta {
      font-size: 10px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      margin-top: 3px;
    }

    /* Manual mode fields */
    .manual-fields {
      display: none;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .manual-fields.active {
      display: flex;
    }

    /* Account bar */
    .acc-bar {
      background: rgba(14, 16, 28, .85);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 14px;
      margin-bottom: 16px;
      backdrop-filter: blur(8px);
    }

    .acc-info {
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      align-items: center;
    }

    .acc-field {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .acc-field-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
    }

    .acc-field-val {
      font-size: 15px;
      font-weight: 700;
    }

    /* Boleta */
    .boleta {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 18px 20px;
      margin-bottom: 16px;
      backdrop-filter: blur(8px);
    }

    .boleta-row {
      display: flex;
      gap: 12px;
      align-items: flex-end;
      flex-wrap: wrap;
    }

    .boleta-mini {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 14px;
    }

    .boleta-stat {
      background: rgba(0, 0, 0, .25);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(56, 62, 92, .2);
    }

    .boleta-stat-label {
      font-size: 9px;
      letter-spacing: 2px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
    }

    .boleta-stat-val {
      font-size: 17px;
      font-weight: 900;
      font-family: 'Share Tech Mono', monospace;
      margin-top: 4px;
    }

    .pnl-bar {
      height: 6px;
      background: rgba(0, 0, 0, .3);
      border-radius: 3px;
      margin-top: 6px;
      overflow: hidden;
    }

    .pnl-fill {
      height: 100%;
      border-radius: 3px;
      transition: width .5s ease;
    }

    /* Robot signal */
    .signal-box {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: 18px 22px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 14px;
      backdrop-filter: blur(8px);
      transition: all .4s ease;
    }

    .signal-main {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .signal-val {
      font-size: 28px;
      font-weight: 900;
      letter-spacing: 3px;
      font-family: 'Share Tech Mono', monospace;
    }

    .signal-val.aguardando {
      color: var(--dim);
    }

    .signal-val.virtual {
      color: var(--gold);
      text-shadow: 0 0 20px rgba(255, 184, 0, .3);
    }

    .signal-val.entrar {
      color: var(--green);
      animation: glowGreen 1s infinite alternate;
    }

    .signal-val.perigo {
      color: var(--red);
      text-shadow: 0 0 20px rgba(255, 71, 87, .3);
    }

    .signal-val.enviando {
      color: var(--accent);
      text-shadow: 0 0 20px rgba(0, 212, 255, .3);
    }

    @keyframes glowGreen {
      from {
        text-shadow: 0 0 12px rgba(0, 255, 136, .3);
      }

      to {
        text-shadow: 0 0 40px rgba(0, 255, 136, .6);
      }
    }

    /* Vdots */
    .vdots {
      display: flex;
      gap: 7px;
      flex-wrap: wrap;
    }

    .vdot {
      width: 15px;
      height: 15px;
      border-radius: 4px;
      border: 2px solid var(--border);
      transition: all .3s ease;
    }

    .vdot.active {
      background: var(--red);
      border-color: var(--red);
      box-shadow: 0 0 12px rgba(255, 71, 87, .5);
    }

    /* Digit stream */
    .digit-stream {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      padding: 12px;
      background: rgba(6, 7, 14, .6);
      border-radius: 10px;
      max-height: 120px;
      overflow-y: auto;
      border: 1px solid rgba(56, 62, 92, .15);
    }

    .digit-chip {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 700;
      font-family: 'Share Tech Mono', monospace;
      transition: all .2s;
    }

    .digit-chip.win {
      background: rgba(0, 255, 136, .12);
      color: var(--green);
      border: 1px solid rgba(0, 255, 136, .2);
    }

    .digit-chip.loss {
      background: rgba(255, 71, 87, .12);
      color: var(--red);
      border: 1px solid rgba(255, 71, 87, .2);
    }

    .digit-chip.neutral {
      background: rgba(0, 0, 0, .2);
      color: var(--dim);
      border: 1px solid rgba(56, 62, 92, .15);
    }

    .digit-chip.virt-loss {
      background: rgba(255, 71, 87, .2);
      color: var(--red);
      border: 1px solid rgba(255, 71, 87, .45);
    }

    .digit-chip.trigger-win {
      background: rgba(0, 212, 255, .2);
      color: var(--accent);
      border: 2px solid var(--accent);
      box-shadow: 0 0 10px rgba(0, 212, 255, .3);
    }

    .digit-chip.trigger-loss {
      background: rgba(255, 71, 87, .3);
      color: var(--red);
      border: 2px solid var(--red);
      box-shadow: 0 0 10px rgba(255, 71, 87, .3);
    }

    .digit-chip.gale-loss {
      background: var(--red);
      color: #fff;
      border: none;
      box-shadow: 0 0 10px rgba(255, 71, 87, .4);
    }

    /* Stats grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 8px;
      margin-bottom: 16px;
    }

    @media(max-width:900px) {
      .stats-grid {
        grid-template-columns: repeat(5, 1fr);
      }
    }

    .freq-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 16px 8px;
      text-align: center;
      backdrop-filter: blur(4px);
      transition: all .3s ease;
    }

    .freq-card:hover {
      border-color: rgba(0, 212, 255, .25);
      transform: translateY(-2px);
    }

    .freq-digit {
      font-size: 22px;
      font-weight: 900;
      font-family: 'Share Tech Mono', monospace;
    }

    .freq-count {
      font-size: 10px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      margin-top: 3px;
    }

    .freq-bar-wrap {
      height: 4px;
      background: rgba(0, 0, 0, .3);
      border-radius: 2px;
      margin-top: 5px;
      overflow: hidden;
    }

    .freq-bar {
      height: 100%;
      border-radius: 2px;
      background: var(--gradient-accent);
      transition: width .5s ease;
    }

    /* Diag grid */
    .diag-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }

    @media(max-width:900px) {
      .diag-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .diag-item {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 14px;
      text-align: center;
      backdrop-filter: blur(4px);
      transition: all .3s;
    }

    .diag-item:hover {
      border-color: rgba(0, 212, 255, .2);
    }

    .diag-name {
      font-size: 11px;
      font-weight: 700;
      font-family: 'Share Tech Mono', monospace;
    }

    .diag-pct {
      font-size: 20px;
      font-weight: 900;
      font-family: 'Share Tech Mono', monospace;
      margin-top: 5px;
    }

    .diag-trend {
      font-size: 9px;
      margin-top: 4px;
    }

    .diag-exp {
      font-size: 9px;
      color: var(--dim);
      font-family: 'Share Tech Mono', monospace;
      margin-top: 2px;
    }

    /* Log */
    .log-area {
      background: rgba(6, 7, 14, .6);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      height: 140px;
      overflow-y: auto;
      font-family: 'Share Tech Mono', monospace;
      font-size: 11px;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
    }

    .dash-right-log .log-line {
      margin-bottom: 5px;
      line-height: 1.5;
      word-break: break-word;
    }

    .log-line {
      margin-bottom: 3px;
      line-height: 1.5;
    }

    .log-line.info {
      color: var(--dim);
    }

    .log-line.success {
      color: var(--green);
      text-shadow: 0 0 6px rgba(0, 255, 136, .15);
    }

    .log-line.warning {
      color: var(--gold);
    }

    .log-line.error {
      color: var(--red);
    }

    /* Progress */
    .progress-bar {
      height: 6px;
      background: rgba(0, 0, 0, .3);
      border-radius: 3px;
      overflow: hidden;
      margin: 8px 0;
    }

    .progress-fill {
      height: 100%;
      background: var(--gradient-accent);
      border-radius: 3px;
      transition: width .4s ease;
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .2), transparent);
      animation: progressShine 2s ease infinite;
    }

    @keyframes progressShine {
      0% {
        transform: translateX(-100%);
      }

      100% {
        transform: translateX(100%);
      }
    }

    /* OU Table */
    .ou-table {
      width: 100%;
      border-collapse: collapse;
    }

    /* Martingale reference table */
    .mart-ref-table {
      width: 100%;
      border-collapse: collapse;
      font-family: 'Share Tech Mono', monospace;
    }

    .mart-ref-table th {
      font-size: 9px;
      letter-spacing: 1.5px;
      color: var(--dim);
      padding: 8px 10px;
      text-align: center;
      border-bottom: 1px solid var(--border);
      background: rgba(0, 0, 0, .25);
      position: sticky;
      top: 0;
    }

    .mart-ref-table th.strat-col {
      text-align: left;
      min-width: 70px;
    }

    .mart-ref-table td {
      font-size: 11px;
      padding: 6px 10px;
      border-bottom: 1px solid rgba(56, 62, 92, .25);
      text-align: center;
      transition: background .2s;
    }

    .mart-ref-table td.strat-cell {
      text-align: left;
      font-weight: 700;
    }

    .mart-ref-table tr:hover td {
      background: rgba(0, 212, 255, .04);
    }

    .mart-ref-table tr.active-strat td {
      background: rgba(0, 212, 255, .06);
    }

    .mart-ref-table tr.active-strat td.strat-cell {
      color: var(--accent);
    }

    .mart-ref-table .profit {
      color: var(--green);
    }

    .mart-ref-table .net {
      color: var(--gold);
      font-size: 10px;
    }

    .mart-ref-table .net.neg {
      color: var(--red);
    }

    .mart-ref-section {
      max-height: 340px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: rgba(107, 115, 148, .2) transparent;
    }

    .ou-table th {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--dim);
      padding: 8px 12px;
      text-align: left;
      border-bottom: 1px solid var(--border);
      font-family: 'Share Tech Mono', monospace;
    }

    .ou-table td {
      font-size: 12px;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(56, 62, 92, .25);
      font-family: 'Share Tech Mono', monospace;
      transition: background .15s;
    }

    .ou-table tr:hover td {
      background: rgba(0, 212, 255, .03);
    }

    .ou-table tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
    }

    .badge-green {
      background: rgba(0, 255, 136, .12);
      color: var(--green);
    }

    .badge-red {
      background: rgba(255, 71, 87, .12);
      color: var(--red);
    }

    .badge-gold {
      background: rgba(255, 184, 0, .12);
      color: var(--gold);
    }

    /* Stop alert overlay */
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(10, 11, 20, .97);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(8px);
    }

    .overlay-box {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 44px;
      max-width: 500px;
      width: 90%;
      text-align: center;
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
    }

    .digit-chip.freq-over {
      background: rgba(0, 212, 255, .12);
      color: var(--accent);
    }

    .digit-chip.freq-latest {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
    }

    /* ── ROBÔ FREQUÊNCIA DE DÍGITOS ── */
    #screenFreq {
      flex-direction: column;
    }

    .freq-chart-wrap {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 18px;
      margin-bottom: 16px;
      backdrop-filter: blur(8px);
    }

    .freq-bars {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 110px;
      padding: 0 2px;
    }

    .freq-bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      flex: 1;
      height: 100%;
    }

    .freq-bar-inner {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
      width: 100%;
    }

    .freq-bar {
      width: 100%;
      border-radius: 5px 5px 0 0;
      min-height: 3px;
      transition: height .4s ease, background .3s;
    }

    .freq-bar.b-under {
      background: rgba(0, 255, 136, .4);
      border: 1px solid rgba(0, 255, 136, .6);
    }

    .freq-bar.b-over {
      background: rgba(0, 212, 255, .35);
      border: 1px solid rgba(0, 212, 255, .6);
    }

    .freq-bar.b-neutral {
      background: rgba(0, 0, 0, .25);
      border: 1px solid var(--border);
    }

    .freq-bar.b-zero {
      background: rgba(255, 71, 87, .5);
      border: 1px solid var(--red);
      animation: freqPulse .8s ease infinite;
    }

    @keyframes freqPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .2;
      }
    }

    .freq-pct {
      font-size: 12px;
      font-family: 'Share Tech Mono', monospace;
      color: var(--dim);
      line-height: 1;
      min-height: 14px;
    }

    .freq-digit-lbl {
      font-size: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-weight: 700;
      line-height: 1;
    }

    .freq-digit-lbl.lbl-under {
      color: var(--green);
    }

    .freq-digit-lbl.lbl-over {
      color: var(--accent);
    }

    .freq-digit-lbl.lbl-neutral {
      color: var(--dim);
    }

    .freq-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }

    .freq-card {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 14px;
      padding: 16px;
      transition: all .3s ease;
    }

    .freq-card.fc-under.active {
      border-color: rgba(0, 255, 136, .5);
      box-shadow: 0 0 24px rgba(0, 255, 136, .1);
    }

    .freq-card.fc-over.active {
      border-color: rgba(0, 212, 255, .5);
      box-shadow: 0 0 24px rgba(0, 212, 255, .1);
    }

    .freq-status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 1px;
    }

    .freq-status-badge.aguard {
      background: rgba(255, 255, 255, .04);
      color: var(--dim);
    }

    .freq-status-badge.sinal {
      background: rgba(0, 255, 136, .12);
      color: var(--green);
    }

    .freq-status-badge.duplo {
      background: rgba(255, 184, 0, .1);
      color: var(--gold);
    }

    .freq-status-badge.operando {
      background: rgba(0, 212, 255, .12);
      color: var(--accent);
    }

    .freq-status-badge.mart {
      background: rgba(255, 184, 0, .12);
      color: var(--gold);
    }

    .freq-overlay {
      position: fixed;
      inset: 0;
      z-index: 9100;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, .8);
      backdrop-filter: blur(10px);
    }

    .freq-overlay.show {
      display: flex;
    }

    .freq-overlay-box {
      background: var(--glass-bg);
      border-radius: 24px;
      padding: 40px 52px;
      text-align: center;
      min-width: 300px;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(16px);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .5);
    }

    /* ══ FREQ DÍGITOS — REDESIGN (fq-* namespace) ══ */
    #screenFreq {
      --fq-bg: #0a0b14;
      --fq-surface: rgba(22, 24, 38, .85);
      --fq-surface2: rgba(30, 33, 52, .9);
      --fq-border: rgba(56, 62, 92, .45);
      --fq-text: #e2e8f4;
      --fq-dim: #6b7394;
      --fq-under: #00ff88;
      --fq-over: #00d4ff;
      --fq-red: #ff4757;
      --fq-gold: #ffb800;
      background: var(--fq-bg);
      font-family: 'Inter', sans-serif;
    }

    .fq-sidebar {
      width: 280px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .fq-panel {
      background: var(--fq-surface);
      border: 1px solid var(--fq-border);
      border-radius: 16px;
      padding: 18px;
      backdrop-filter: blur(8px);
    }

    .fq-label {
      font-size: 10px;
      letter-spacing: 2px;
      color: var(--fq-dim);
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    /* Market buttons */
    .fq-mkt-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 7px;
    }

    .fq-mkt-btn {
      padding: 9px 4px;
      background: rgba(0, 0, 0, .25);
      border: 1px solid var(--fq-border);
      border-radius: 10px;
      color: var(--fq-dim);
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all .3s ease;
      text-align: center;
      font-family: 'Inter', sans-serif;
    }

    .fq-mkt-btn.active {
      background: rgba(0, 212, 255, .1);
      border-color: rgba(0, 212, 255, .45);
      color: var(--fq-over);
      box-shadow: 0 0 12px rgba(0, 212, 255, .1);
    }

    .fq-mkt-btn:hover {
      border-color: var(--fq-over);
      color: var(--fq-text);
    }

    /* Size buttons */
    .fq-size-btns {
      display: flex;
      gap: 7px;
    }

    .fq-size-btn {
      flex: 1;
      padding: 9px;
      background: rgba(0, 0, 0, .25);
      border: 1px solid var(--fq-border);
      border-radius: 10px;
      color: var(--fq-dim);
      font-size: 11px;
      cursor: pointer;
      text-align: center;
      transition: all .3s ease;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: .5px;
    }

    .fq-size-btn.active {
      background: rgba(0, 212, 255, .08);
      border-color: rgba(0, 212, 255, .4);
      color: var(--fq-over);
    }

    /* Config inputs */
    .fq-input-group {
      margin-bottom: 12px;
    }

    .fq-input-label {
      font-size: 9.5px;
      color: var(--fq-dim);
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 5px;
      letter-spacing: .5px;
    }

    .fq-input {
      width: 100%;
      background: rgba(0, 0, 0, .3);
      border: 1px solid var(--fq-border);
      color: var(--fq-text);
      padding: 9px 12px;
      border-radius: 10px;
      font-family: 'Share Tech Mono', monospace;
      font-size: 13px;
      text-align: center;
      outline: none;
      transition: all .3s ease;
      box-sizing: border-box;
    }

    .fq-input:focus {
      border-color: var(--fq-over);
      box-shadow: 0 0 12px rgba(0, 212, 255, .1);
    }

    /* Start / Stop */
    .fq-start-btn {
      width: 100%;
      padding: 14px;
      border: 1px solid rgba(0, 255, 136, .3);
      border-radius: 12px;
      background: rgba(0, 255, 136, .06);
      color: var(--fq-under);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 1px;
      transition: all .3s ease;
      font-family: 'Inter', sans-serif;
      margin-top: 6px;
    }

    .fq-start-btn:hover {
      background: rgba(0, 255, 136, .12);
      box-shadow: 0 0 20px rgba(0, 255, 136, .12);
    }

    .fq-start-btn.stop {
      background: rgba(255, 71, 87, .06);
      border-color: rgba(255, 71, 87, .35);
      color: var(--fq-red);
    }

    .fq-start-btn.stop:hover {
      background: rgba(255, 71, 87, .12);
      box-shadow: 0 0 20px rgba(255, 71, 87, .12);
    }

    /* Session stats */
    .fq-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .fq-stat {
      background: rgba(0, 0, 0, .25);
      border-radius: 12px;
      padding: 12px;
      text-align: center;
      border: 1px solid rgba(56, 62, 92, .15);
    }

    .fq-stat-label {
      font-size: 9px;
      color: var(--fq-dim);
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 6px;
      letter-spacing: 1px;
    }

    .fq-stat-value {
      font-size: 22px;
      font-weight: 700;
      font-family: 'Inter', sans-serif;
      line-height: 1;
    }

    /* Digit chips */
    .fq-chips {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .fq-chip {
      flex: 1;
      background: rgba(0, 0, 0, .25);
      border: 1px solid var(--fq-border);
      border-radius: 14px;
      padding: 13px 4px 11px;
      text-align: center;
      transition: all .3s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      min-width: 0;
    }

    .fq-chip.chip-under {
      border-color: rgba(0, 255, 136, .25);
      background: rgba(0, 255, 136, .04);
    }

    .fq-chip.chip-over {
      border-color: rgba(0, 212, 255, .25);
      background: rgba(0, 212, 255, .04);
    }

    .fq-chip.chip-neutral {
      border-color: var(--fq-border);
    }

    .fq-chip.chip-hot {
      border-color: rgba(255, 184, 0, .55);
      background: rgba(255, 184, 0, .06);
    }

    .fq-chip.chip-zero {
      border-color: rgba(255, 71, 87, .65);
      background: rgba(255, 71, 87, .08);
      animation: fqZeroPulse .85s ease infinite;
    }

    @keyframes fqZeroPulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .25;
      }
    }

    .fq-chip-num {
      font-size: 22px;
      font-weight: 900;
      font-family: 'Share Tech Mono', monospace;
      line-height: 1;
    }

    .fq-chip-pct {
      font-size: 12px;
      font-family: 'Share Tech Mono', monospace;
      line-height: 1;
    }

    .fq-chip.chip-under .fq-chip-num {
      color: var(--fq-under);
    }

    .fq-chip.chip-under .fq-chip-pct {
      color: rgba(0, 255, 136, .65);
    }

    .fq-chip.chip-over .fq-chip-num {
      color: var(--fq-over);
    }

    .fq-chip.chip-over .fq-chip-pct {
      color: rgba(0, 212, 255, .65);
    }

    .fq-chip.chip-neutral .fq-chip-num {
      color: var(--fq-dim);
    }

    .fq-chip.chip-neutral .fq-chip-pct {
      color: var(--fq-dim);
    }

    .fq-chip.chip-hot .fq-chip-num {
      color: var(--fq-gold);
    }

    .fq-chip.chip-hot .fq-chip-pct {
      color: var(--fq-gold);
    }

    .fq-chip.chip-zero .fq-chip-num {
      color: var(--fq-red);
    }

    .fq-chip.chip-zero .fq-chip-pct {
      color: var(--fq-red);
    }

    /* Trade cards */
    .fq-trade-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-top: 14px;
    }

    .fq-trade-card {
      background: var(--fq-surface);
      border: 1px solid var(--fq-border);
      border-radius: 16px;
      padding: 18px;
      transition: all .3s ease;
      backdrop-filter: blur(8px);
    }

    .fq-trade-card.fq-under-card.active {
      border-color: rgba(0, 255, 136, .45);
      box-shadow: 0 0 28px rgba(0, 255, 136, .08);
    }

    .fq-trade-card.fq-over-card.active {
      border-color: rgba(0, 212, 255, .45);
      box-shadow: 0 0 28px rgba(0, 212, 255, .08);
    }

    #screenFreq .freq-status-badge.sinal {
      background: rgba(0, 255, 136, .12);
      color: var(--fq-under);
    }

    #screenFreq .freq-status-badge.operando {
      background: rgba(0, 212, 255, .12);
      color: var(--fq-over);
    }

    #screenFreq .freq-status-badge.duplo {
      background: rgba(255, 184, 0, .1);
      color: var(--fq-gold);
    }

    #screenFreq .freq-status-badge.mart {
      background: rgba(255, 184, 0, .12);
      color: var(--fq-gold);
    }

    #screenFreq .freq-status-badge.aguard {
      background: rgba(255, 255, 255, .03);
      color: var(--fq-dim);
    }

    /* ── Relógio Virtual ── */
    .fq-clock {
      background: var(--fq-surface);
      border: 1px solid var(--fq-border);
      border-radius: 16px;
      padding: 18px;
      margin-top: 14px;
      text-align: center;
      transition: all .4s ease;
      animation: fqClockIn .3s ease;
      backdrop-filter: blur(8px);
    }

    @keyframes fqClockIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .fq-clock.clk-win {
      border-color: rgba(0, 255, 136, .45);
      box-shadow: 0 0 30px rgba(0, 255, 136, .08);
    }

    .fq-clock.clk-loss {
      border-color: rgba(255, 71, 87, .45);
      box-shadow: 0 0 30px rgba(255, 71, 87, .08);
    }

    .fq-clock.clk-mart {
      border-color: rgba(255, 184, 0, .45);
      box-shadow: 0 0 30px rgba(255, 184, 0, .08);
    }

    .fq-clock.clk-hide {
      animation: fqClockOut .5s ease forwards;
    }

    @keyframes fqClockOut {
      from {
        opacity: 1;
      }

      to {
        opacity: 0;
        transform: translateY(6px);
      }
    }

    .fq-clock-lbl {
      font-size: 9px;
      letter-spacing: 2.5px;
      color: var(--fq-dim);
      font-family: 'Share Tech Mono', monospace;
      margin-bottom: 10px;
    }

    .fq-clock-time {
      font-size: 46px;
      font-weight: 900;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 6px;
      color: var(--fq-text);
      line-height: 1;
      transition: color .4s;
    }

    .fq-clock.clk-win .fq-clock-time {
      color: var(--fq-under);
      text-shadow: 0 0 20px rgba(0, 255, 136, .2);
    }

    .fq-clock.clk-loss .fq-clock-time {
      color: var(--fq-red);
      text-shadow: 0 0 20px rgba(255, 71, 87, .2);
    }

    .fq-clock.clk-mart .fq-clock-time {
      color: var(--fq-gold);
      text-shadow: 0 0 20px rgba(255, 184, 0, .2);
    }

    .fq-clock-sep {
      display: inline-block;
      animation: fqSepBlink .9s step-end infinite;
    }

    @keyframes fqSepBlink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: .1;
      }
    }

    .fq-clock.clk-win .fq-clock-sep,
    .fq-clock.clk-loss .fq-clock-sep,
    .fq-clock.clk-mart .fq-clock-sep {
      animation: none;
      opacity: 1;
    }

    .fq-clock-result {
      font-size: 11px;
      font-family: 'Share Tech Mono', monospace;
      letter-spacing: 1px;
      margin-top: 10px;
      padding: 5px 14px;
      border-radius: 20px;
      display: inline-block;
    }

    .fq-clock.clk-win .fq-clock-result {
      background: rgba(0, 255, 136, .1);
      color: var(--fq-under);
    }

    .fq-clock.clk-loss .fq-clock-result {
      background: rgba(255, 71, 87, .1);
      color: var(--fq-red);
    }

    .fq-clock.clk-mart .fq-clock-result {
      background: rgba(255, 184, 0, .1);
      color: var(--fq-gold);
    }
  </style>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ── Supabase config ──
    const SUPABASE_URL = 'https://okxaphtpaveuxbykqdfh.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9reGFwaHRwYXZldXhieWtxZGZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODgwODksImV4cCI6MjA4NzI2NDA4OX0.jzZaaXK200WQCqev9bZMG7nSlMot2eHD8TKjChDNNG0';

    function initSupabase() {
      if (typeof supabase === 'undefined') {
        setTimeout(initSupabase, 100);
        return;
      }
      // Limpar sessão potencialmente corrompida ANTES de criar o client
      // para evitar que setSession trave o mutex interno do SDK
      const _savedPre = sessionStorage.getItem('alpha_session');
      if (_savedPre) {
        try {
          const { access_token } = JSON.parse(_savedPre);
          let exp = 0;
          try { exp = JSON.parse(atob(access_token.split('.')[1])).exp * 1000; } catch (_) { }
          if (!exp || (exp - Date.now()) < 30000) {
            sessionStorage.removeItem('alpha_session');
            console.log('🧹 Sessão expirada removida antes da inicialização');
          }
        } catch (_) {
          sessionStorage.removeItem('alpha_session');
        }
      }

      const _supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON, {
        auth: {
          persistSession: false,
          detectSessionInUrl: false,
          flowType: 'implicit',
          lock: async (name, acquireTimeout, fn) => fn()
        }
      });
      window._sb = _supa;

      _supa.auth.onAuthStateChange(async (event, session) => {
        if (session?.user) {
          const user = session.user;
          try {
            const { data: profile } = await _supa
              .from('profiles')
              .select('name, plan, is_admin')
              .eq('id', user.id)
              .single();
            window._alphaUser = {
              uid: user.id, email: user.email,
              name: profile?.name || user.email.split('@')[0],
              plan: profile?.plan || 'free',
              is_admin: profile?.is_admin || false,
            };
          } catch (e) {
            window._alphaUser = {
              uid: user.id, email: user.email,
              name: user.email.split('@')[0], plan: 'free', is_admin: false
            };
          }
          document.documentElement.classList.remove('restoring-session');
          window._onAlphaLogin && window._onAlphaLogin(window._alphaUser);
        } else {
          window._alphaUser = null;
          document.documentElement.classList.remove('restoring-session');
          window._onAlphaLogout && window._onAlphaLogout();
        }
      });
      // Restore session from sessionStorage (avoids Web Locks)
      // setSession dispara onAuthStateChange(SIGNED_IN) que já faz todo o setup do login
      const _saved = sessionStorage.getItem('alpha_session');
      if (_saved) {
        try {
          const { access_token, refresh_token } = JSON.parse(_saved);
          // Verifica se o JWT ainda está válido ANTES de chamar setSession.
          // Se expirado, setSession tentaria um refresh via rede e poderia segurar o
          // mutex interno do SDK — bloqueando signInWithPassword indefinidamente.
          let exp = 0;
          try { exp = JSON.parse(atob(access_token.split('.')[1])).exp * 1000; } catch (_) { }
          const tokenValid = exp && (exp - Date.now()) > 30000; // > 30s restantes
          if (tokenValid) {
            _supa.auth.setSession({ access_token, refresh_token }).then(({ error }) => {
              if (error) {
                sessionStorage.removeItem('alpha_session');
                document.documentElement.classList.remove('restoring-session');
              }
            });
          } else {
            // Token expirado: limpa sessão e vai direto pra tela de login sem travar o mutex
            sessionStorage.removeItem('alpha_session');
            document.documentElement.classList.remove('restoring-session');
          }
        } catch (e) {
          sessionStorage.removeItem('alpha_session');
          document.documentElement.classList.remove('restoring-session');
        }
      }
      console.log('✅ Supabase inicializado');
    }

    // Start init after DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSupabase);
    } else {
      initSupabase();
    }
  </script>
</head>

<body>

  <!-- ════════════════════════════════════════════
     SCREEN 1: LOGIN
════════════════════════════════════════════ -->
  <div id="screenLogin" class="screen active">
    <div class="login-box" style="max-width:420px;">

      <!-- LOGO -->
      <div class="login-logo">
        <div id="loginLogoWrap" style="margin-bottom:8px;">
          <img id="loginLogoImg" style="display:none;" class="brand-logo-img">
          <div id="loginLogoEmoji" style="font-size:48px;">⚡</div>
        </div>
        <h1 id="loginBrandName">ALPHA SYSTEM</h1>
        <p id="loginBrandSlogan">PAINEL DE OPERAÇÕES AUTOMATIZADAS</p>
      </div>

      <!-- ── STEP 1: ALPHA LOGIN / REGISTER ── -->
      <div id="panelAlphaAuth">

        <!-- Tabs: Login / Cadastro -->
        <div class="login-tabs" style="margin-bottom:16px;">
          <button class="login-tab active" id="tabAlphaLogin" onclick="switchAlphaTab('login')">ENTRAR</button>
          <button class="login-tab" id="tabAlphaSignup" onclick="switchAlphaTab('signup')">CADASTRAR</button>
        </div>

        <!-- LOGIN -->
        <div id="panelAlphaLogin">
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="field"><label>E-mail</label>
              <input type="email" id="alphaLoginEmail" placeholder="seu@email.com" autocomplete="email"
                onkeydown="if(event.key==='Enter')alphaLogin()">
            </div>
            <div class="field"><label>Senha</label>
              <input type="password" id="alphaLoginPass" placeholder="••••••••"
                onkeydown="if(event.key==='Enter')alphaLogin()">
            </div>
            <button class="btn btn-primary" onclick="alphaLogin()" style="margin-top:4px;">▶ ENTRAR</button>
            <div id="alphaLoginErr" class="err-box"></div>
          </div>
        </div>

        <!-- CADASTRO -->
        <div id="panelAlphaSignup" style="display:none;">
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div class="field"><label>Nome</label>
              <input type="text" id="alphaSignupName" placeholder="Seu nome">
            </div>
            <div class="field"><label>E-mail</label>
              <input type="email" id="alphaSignupEmail" placeholder="seu@email.com" autocomplete="email">
            </div>
            <div class="field"><label>Senha</label>
              <input type="password" id="alphaSignupPass" placeholder="Mínimo 6 caracteres">
            </div>
            <div class="field"><label>Código de Acesso</label>
              <input type="text" id="alphaSignupCode" placeholder="ALPHA-XXXXX"
                oninput="this.value=this.value.toUpperCase()"
                style="letter-spacing:2px;font-family:'Share Tech Mono',monospace;">
            </div>
            <button class="btn btn-primary" onclick="alphaSignup()" style="margin-top:4px;">✅ CRIAR CONTA</button>
            <div id="alphaSignupErr" style="color:var(--red);font-size:12px;text-align:center;display:none;"></div>
          </div>
        </div>

      </div>


    </div>
  </div>


  <!-- ════════════════════════════════════════════
     SCREEN 2: ADMIN PANEL
════════════════════════════════════════════ -->
  <div id="screenAdmin" class="screen">
    <!-- TOP NAV -->
    <div class="topnav">
      <div class="topnav-brand" id="adminTopnavBrand">⚡ ALPHA SYSTEM · ADMIN</div>
      <div class="topnav-user" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <button class="nav-pill active" id="adminTabBtnRobots" onclick="showAdminTab('robots')">🤖 Robôs</button>
        <button class="nav-pill" id="adminTabBtnAdmins" onclick="showAdminTab('admins')">👥 Admins</button>
        <button class="nav-pill" id="adminTabBtnCodes" onclick="showAdminTab('codes')">🔑 Códigos</button>
        <button class="nav-pill" id="adminTabBtnBrand" onclick="showAdminTab('brand')">🎨 Marca</button>
        <button class="nav-pill" id="adminTabBtnOnline" onclick="showAdminTab('online')">🟢 Online</button>
        <span style="font-size:12px;color:var(--dim);" id="adminNavUser"></span>
        <button class="btn btn-gold btn-sm" onclick="goToDashboard()">📊 Trocar Conta</button>
        <button class="btn btn-danger btn-sm" onclick="logoutAll()">⏏ Sair</button>
      </div>
    </div>

    <div class="content">

      <!-- ROBOTS TAB -->
      <div id="adminTabRobots">
        <div class="admin-grid">

          <!-- LEFT: Robot List -->
          <div>
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
              <h2 style="font-size:16px;font-weight:900;letter-spacing:1px;">🤖 Robôs Criados</h2>
              <button class="btn btn-success btn-sm" onclick="openRobotForm()">+ Novo Robô</button>
            </div>
            <div class="robot-list" id="robotList">
              <div style="color:var(--dim);font-size:13px;text-align:center;padding:40px;">
                Nenhum robô criado ainda. Clique em "+ Novo Robô".
              </div>
            </div>
          </div>

          <!-- RIGHT: Robot Form -->
          <div class="card" id="robotFormCard">
            <div style="font-size:13px;font-weight:900;letter-spacing:1px;margin-bottom:16px;" id="robotFormTitle">➕
              NOVO ROBÔ</div>

            <div class="form-section">IDENTIFICAÇÃO</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div class="field">
                <label>Nome do Robô</label>
                <input type="text" id="rfName" placeholder="Ex: Over 3 Conservador">
              </div>
              <div class="field">
                <label>Descrição (opcional)</label>
                <input type="text" id="rfDesc" placeholder="Ex: Estratégia para baixo risco">
              </div>
            </div>

            <div class="form-section">ESTRATÉGIA</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div class="field">
                <label>Estratégia</label>
                <select id="rfStrategy">
                  <option value="over0">Over 0 (1–9) · 90%</option>
                  <option value="over1">Over 1 (2–9) · 80%</option>
                  <option value="over2">Over 2 (3–9) · 70%</option>
                  <option value="over3" selected>Over 3 (4–9) · 60%</option>
                  <option value="over4">Over 4 (5–9) · 50%</option>
                  <option value="over5">Over 5 (6–9) · 40%</option>
                  <option value="over6">Over 6 (7–9) · 30%</option>
                  <option value="over7">Over 7 (8–9) · 20%</option>
                  <option value="over8">Over 8 (só 9) · 10%</option>
                  <option value="under1">Under 1 (só 0) · 10%</option>
                  <option value="under2">Under 2 (0–1) · 20%</option>
                  <option value="under3">Under 3 (0–2) · 30%</option>
                  <option value="under4">Under 4 (0–3) · 40%</option>
                  <option value="under5">Under 5 (0–4) · 50%</option>
                  <option value="under6">Under 6 (0–5) · 60%</option>
                  <option value="under7">Under 7 (0–6) · 70%</option>
                  <option value="under8">Under 8 (0–7) · 80%</option>
                  <option value="under9">Under 9 (0–8) · 90%</option>
                </select>
              </div>
              <div class="field">
                <label>Losses Virtuais para Ativar</label>
                <select id="rfVirtual">
                  <option value="2">2 losses</option>
                  <option value="3">3 losses</option>
                  <option value="4">4 losses</option>
                  <option value="5" selected>5 losses</option>
                  <option value="6">6 losses</option>
                </select>
              </div>
            </div>

            <div class="form-section">MARTINGALE</div>
            <div class="form-grid-3" style="gap:12px;">
              <div class="field">
                <label>Entrada Base ($)</label>
                <input type="number" id="rfEntry" value="0.35" min="0.35" step="0.05">
              </div>
              <div class="field">
                <label>Fator Martingale</label>
                <input type="number" id="rfFactor" value="2.8" min="1.1" max="5" step="0.1">
              </div>
              <div class="field">
                <label>Níveis Máx.</label>
                <input type="number" id="rfLevels" value="5" min="1" max="8" step="1">
              </div>
            </div>

            <!-- Martingale preview -->
            <div style="background:var(--surface2);border-radius:8px;padding:12px;margin-top:14px;" id="martPreview">
            </div>

            <div style="display:flex;gap:10px;margin-top:16px;">
              <button class="btn btn-primary" style="flex:1;" onclick="saveRobot()">💾 SALVAR ROBÔ</button>
              <button class="btn btn-danger btn-sm" onclick="cancelRobotForm()">Cancelar</button>
            </div>
            <div id="robotFormErr" style="color:var(--red);font-size:12px;margin-top:8px;display:none;"></div>
          </div>

        </div>
      </div>

      <!-- ADMINS TAB -->
      <div id="adminTabAdmins" style="display:none;">
        <div style="max-width:600px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 style="font-size:16px;font-weight:900;">👥 Administradores</h2>
            <button class="btn btn-success btn-sm" onclick="openAdminForm()">+ Novo Admin</button>
          </div>
          <div id="adminList" style="display:flex;flex-direction:column;gap:10px;"></div>

          <div class="card" id="adminFormCard" style="display:none;margin-top:16px;">
            <div style="font-size:13px;font-weight:900;margin-bottom:14px;">➕ NOVO ADMINISTRADOR</div>
            <div style="display:flex;flex-direction:column;gap:12px;">
              <div class="field"><label>Usuário</label><input type="text" id="afUser" placeholder="nome_usuario"></div>
              <div class="field"><label>Senha</label><input type="password" id="afPass" placeholder="••••••••"></div>
              <div class="field"><label>Confirmar Senha</label><input type="password" id="afPass2"
                  placeholder="••••••••"></div>
              <div style="display:flex;gap:10px;">
                <button class="btn btn-primary btn-sm" onclick="saveAdmin()">Salvar</button>
                <button class="btn btn-danger btn-sm"
                  onclick="document.getElementById('adminFormCard').style.display='none'">Cancelar</button>
              </div>
              <div id="adminFormErr" style="color:var(--red);font-size:12px;display:none;"></div>
            </div>
          </div>
        </div>
      </div>


      <!-- CODES TAB -->
      <div id="adminTabCodes" style="display:none;">
        <div style="max-width:600px;">
          <h2 style="font-size:16px;font-weight:900;margin-bottom:20px;">🔑 Códigos de Convite</h2>
          <div class="card" style="margin-bottom:16px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:12px;">GERAR NOVO CÓDIGO
            </div>
            <div style="font-size:12px;color:var(--dim);margin-bottom:14px;">Cada código pode ser usado uma única vez
              para liberar acesso ao sistema.</div>
            <button class="btn btn-primary" onclick="generateInviteCode()">⚡ GERAR CÓDIGO</button>
          </div>
          <div class="card">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:12px;">CÓDIGOS DISPONÍVEIS
            </div>
            <div id="codeList">
              <div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">Carregando...</div>
            </div>
          </div>
        </div>
      </div>

      <!-- BRAND TAB -->
      <div id="adminTabBrand" style="display:none;">
        <div style="max-width:700px;">
          <h2 style="font-size:16px;font-weight:900;margin-bottom:20px;">🎨 Personalização da Marca</h2>

          <div class="card" style="margin-bottom:16px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">🏷️ IDENTIDADE</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
              <div class="field" style="grid-column:1/-1;">
                <label>Nome do Sistema</label>
                <input type="text" id="brandName" placeholder="Ex: ALPHA TRADER SYSTEM" maxlength="40">
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Slogan / Subtítulo</label>
                <input type="text" id="brandSlogan" placeholder="Ex: OPERAÇÕES AUTOMATIZADAS DE ALTA PERFORMANCE"
                  maxlength="60">
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Ícone / Emoji da Marca</label>
                <input type="text" id="brandIcon" placeholder="Ex: 🚀 ou ⚡ ou 💎" maxlength="4"
                  style="font-size:24px;width:80px;text-align:center;">
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:16px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">🖼️ LOGOTIPO</div>
            <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
              <div id="brandLogoPreview"
                style="width:80px;height:80px;border-radius:12px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:32px;background:var(--surface2);">
                <span id="brandLogoEmoji">⚡</span>
                <img id="brandLogoImg"
                  style="display:none;width:100%;height:100%;object-fit:contain;border-radius:10px;">
              </div>
              <div style="flex:1;">
                <div class="field" style="margin-bottom:8px;">
                  <label>URL da imagem (PNG/JPG/SVG)</label>
                  <input type="text" id="brandLogoUrl" placeholder="https://..." oninput="previewLogo()">
                </div>
                <div style="font-size:10px;color:var(--dim);">Cole a URL de uma imagem hospedada (Imgur, Google Drive
                  público, etc)</div>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:16px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">🎨 CORES</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
              <div class="field">
                <label>Cor de Destaque (Accent)</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandAccent" value="#00d4ff"
                    style="width:48px;height:36px;border:none;background:none;cursor:pointer;padding:0;">
                  <input type="text" id="brandAccentHex" value="#00d4ff" maxlength="7"
                    style="width:90px;font-family:'Share Tech Mono',monospace;"
                    oninput="syncColor('brandAccent','brandAccentHex')">
                  <div id="brandAccentPreview" class="color-preview" style="background:#00d4ff;"></div>
                </div>
              </div>
              <div class="field">
                <label>Cor Secundária (Gold)</label>
                <div style="display:flex;align-items:center;gap:8px;">
                  <input type="color" id="brandGold" value="#ffb800"
                    style="width:48px;height:36px;border:none;background:none;cursor:pointer;padding:0;">
                  <input type="text" id="brandGoldHex" value="#ffb800" maxlength="7"
                    style="width:90px;font-family:'Share Tech Mono',monospace;"
                    oninput="syncColor('brandGold','brandGoldHex')">
                  <div id="brandGoldPreview" class="color-preview" style="background:#ffb800;"></div>
                </div>
              </div>
            </div>
            <div style="margin-top:12px;">
              <div style="font-size:10px;color:var(--dim);margin-bottom:8px;">Presets rápidos:</div>
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn btn-sm" style="background:#00d4ff22;border:1px solid #00d4ff;color:#00d4ff;"
                  onclick="applyPreset('#00d4ff','#ffb800')">⚡ Padrão</button>
                <button class="btn btn-sm" style="background:#7c3aed22;border:1px solid #7c3aed;color:#a78bfa;"
                  onclick="applyPreset('#a78bfa','#f59e0b')">💜 Roxo</button>
                <button class="btn btn-sm" style="background:#059669;border:1px solid #10b981;color:#10b981;"
                  onclick="applyPreset('#10b981','#f59e0b')">💚 Verde</button>
                <button class="btn btn-sm" style="background:#dc262622;border:1px solid #ef4444;color:#ef4444;"
                  onclick="applyPreset('#ef4444','#f97316')">🔴 Vermelho</button>
                <button class="btn btn-sm" style="background:#0ea5e922;border:1px solid #0ea5e9;color:#0ea5e9;"
                  onclick="applyPreset('#0ea5e9','#06b6d4')">🔵 Azul</button>
                <button class="btn btn-sm" style="background:#f59e0b22;border:1px solid #f59e0b;color:#f59e0b;"
                  onclick="applyPreset('#f59e0b','#ef4444')">🟡 Ouro</button>
              </div>
            </div>
          </div>

          <div class="card" style="margin-bottom:16px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--accent);margin-bottom:16px;">📞 CONTATO & SUPORTE
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
              <div class="field">
                <label>WhatsApp de Suporte</label>
                <input type="text" id="brandWhatsapp" placeholder="Ex: +55 11 99999-9999">
              </div>
              <div class="field">
                <label>Telegram</label>
                <input type="text" id="brandTelegram" placeholder="Ex: @suaempresa">
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Site / Link de Vendas</label>
                <input type="text" id="brandWebsite" placeholder="https://seusite.com">
              </div>
              <div class="field" style="grid-column:1/-1;">
                <label>Mensagem de boas-vindas (exibida no login)</label>
                <textarea id="brandWelcome" rows="2"
                  placeholder="Ex: Bem-vindo ao sistema mais avançado de trading automatizado!"
                  style="resize:vertical;font-family:'Share Tech Mono',monospace;font-size:12px;"></textarea>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:12px;">
            <button class="btn btn-primary" onclick="saveBrand()" style="flex:1;">💾 SALVAR E APLICAR MARCA</button>
            <button class="btn btn-sm" onclick="resetBrand()" style="color:var(--dim);border:1px solid var(--border);">↺
              Restaurar Padrão</button>
          </div>
          <div id="brandSaveMsg"
            style="display:none;text-align:center;padding:10px;color:var(--green);font-size:12px;margin-top:8px;"></div>
        </div>
      </div>

      <!-- ONLINE TAB -->
      <div id="adminTabOnline" style="display:none;">
        <div style="max-width:600px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <h2 style="font-size:16px;font-weight:900;letter-spacing:1px;">🟢 Usuários Online Agora</h2>
            <button class="btn btn-sm" onclick="loadOnlineUsers()"
              style="font-size:11px;border:1px solid var(--border);">↺ Atualizar</button>
          </div>
          <div class="card">
            <div id="onlineUsersList">
              <div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">Carregando...</div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /screenAdmin -->

  <!-- ════════════════════════════════════════════
     SCREEN 3: DASHBOARD (TRADER)
════════════════════════════════════════════ -->
  <div id="screenDashboard" class="screen">
    <!-- Ping alert banner -->
    <div id="pingAlert">
      <div style="font-size:18px;margin-bottom:4px;">⚠️ PING ALTO — INSTABILIDADE</div>
      <div id="pingAlertMsg" style="font-size:12px;color:var(--text);"></div>
      <div style="font-size:10px;color:var(--dim);margin-top:6px;">Operação pode ser pulada para evitar entrada em
        momento ruim</div>
    </div>

    <div class="topnav">
      <div class="topnav-brand" id="dashTopnavBrand">⚡ ALPHA SYSTEM</div>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
        <!-- Ping indicator -->
        <div class="ping-box" id="pingBox">
          <div class="ping-dot" id="pingDot"></div>
          <div>
            <div class="ping-val" id="pingVal">—</div>
            <div class="ping-label">PING (ms)</div>
          </div>
        </div>
        <button class="nav-pill" id="btnChartNav" onclick="toggleChartPanel()">📈 Gráfico</button>
        <button class="nav-pill" id="btnReportsNav" onclick="showScreen('screenReports')">📊 Relatórios</button>
        <button class="nav-pill" id="btnFreqNav" onclick="showScreen('screenFreq')">🎯 Freq. Dígitos</button>
        <button class="nav-pill" onclick="showScreen('screenAdmin')" id="btnAdminNav" style="display:none;">🛠️
          Admin</button>

        <!-- Profile icon with dropdown -->
        <div id="profileDropdownWrap">
          <button class="profile-btn" id="profileBtn" onclick="toggleProfileDropdown()" title="Perfil e conta Deriv">
            👤
          </button>
          <div class="profile-dropdown" id="profileDropdown">

            <!-- User info -->
            <div class="profile-dropdown-header">
              <div style="font-size:13px;font-weight:700;" id="pdUserName">—</div>
              <div style="font-size:11px;color:var(--dim);margin-top:2px;" id="pdUserEmail">—</div>
              <div style="font-size:10px;color:var(--gold);margin-top:4px;" id="pdUserPlan">Plano Free</div>
            </div>

            <!-- Deriv connection -->
            <div class="profile-dropdown-section">
              <div class="pd-label">CONTA DERIV</div>
              <div class="deriv-status-badge" id="pdDerivBadge">
                <div class="deriv-status-dot" id="pdDerivDot"></div>
                <div style="flex:1;">
                  <div style="font-size:12px;font-weight:700;" id="pdDerivId">Não conectada</div>
                  <div style="font-size:10px;color:var(--dim);" id="pdDerivType"></div>
                </div>
              </div>

              <!-- Connect / Disconnect buttons -->
              <div id="pdDerivConnect">
                <button class="btn btn-primary" onclick="openDerivConnectModal()"
                  style="width:100%;padding:10px;font-size:12px;display:flex;align-items:center;justify-content:center;gap:8px;">
                  🔗 CONECTAR COM DERIV
                </button>
              </div>
              <div id="pdDerivDisconnect" style="display:none;">
                <button onclick="disconnectDeriv()"
                  style="width:100%;background:none;border:1px solid var(--border);border-radius:6px;color:var(--dim);font-size:11px;padding:8px;cursor:pointer;">
                  ✕ Desconectar conta Deriv
                </button>
              </div>
            </div>

            <!-- Logout -->
            <div style="padding:0 16px 16px;">
              <button onclick="alphaLogout()"
                style="width:100%;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);border-radius:8px;color:var(--red);font-size:12px;padding:9px;cursor:pointer;letter-spacing:1px;">
                ⏏ SAIR DO SISTEMA
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCOUNT BAR (top strip) -->
    <div class="acc-bar" id="accBar"
      style="display:none;border-radius:0;border-left:none;border-right:none;border-top:none;">
      <div class="acc-info">
        <div class="acc-field">
          <span class="acc-field-label">CONTA</span>
          <span class="acc-field-val mono" id="accLoginIdD" style="color:var(--accent);">—</span>
        </div>
        <div class="acc-field">
          <span class="acc-field-label">TIPO</span>
          <span class="acc-field-val" id="accTypeD">—</span>
        </div>
        <div class="acc-field">
          <span class="acc-field-label">SALDO</span>
          <span class="acc-field-val mono" id="accBalanceD" style="color:var(--green);">—</span>
        </div>
        <div class="acc-field">
          <span class="acc-field-label">MERCADO</span>
          <span class="acc-field-val mono" id="accMarketD" style="color:var(--text);">—</span>
        </div>
        <div class="acc-field">
          <span class="acc-field-label">ESTRATÉGIA</span>
          <span class="acc-field-val mono" id="accStratD" style="color:var(--gold);">—</span>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
        <div id="autoTradeIndicator" style="width:10px;height:10px;border-radius:50%;background:var(--dim);"></div>
        <span id="autoTradeLabel" style="font-size:11px;font-family:'Share Tech Mono',monospace;color:var(--dim);">ROBÔ
          PARADO</span>
      </div>
    </div>

    <!-- ══ CHART PANEL ══ -->
    <div id="chartPanel"
      style="display:none;background:var(--surface);border-bottom:1px solid var(--border);padding:12px 16px;">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
        <span
          style="font-size:11px;font-weight:900;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">PREÇO
          AO VIVO</span>
        <div style="display:flex;gap:6px;">
          <button class="btn btn-sm active" id="chartBtnLine" onclick="setChartType('line')">〰️ Linha</button>
          <button class="btn btn-sm" id="chartBtnCandle" onclick="setChartType('candle')">🕯️ Velas</button>
        </div>
        <div id="chartTimeframes" style="display:none;gap:4px;align-items:center;flex-wrap:nowrap;">
          <button class="chart-tf-btn" data-tf="1" onclick="setChartTf(1)">1s</button>
          <button class="chart-tf-btn" data-tf="5" onclick="setChartTf(5)">5s</button>
          <button class="chart-tf-btn" data-tf="10" onclick="setChartTf(10)">10s</button>
          <button class="chart-tf-btn" data-tf="15" onclick="setChartTf(15)">15s</button>
          <button class="chart-tf-btn active" data-tf="30" onclick="setChartTf(30)">30s</button>
          <div class="chart-tf-sep"></div>
          <button class="chart-tf-btn" data-tf="60" onclick="setChartTf(60)">1m</button>
          <button class="chart-tf-btn" data-tf="120" onclick="setChartTf(120)">2m</button>
          <button class="chart-tf-btn" data-tf="180" onclick="setChartTf(180)">3m</button>
          <button class="chart-tf-btn" data-tf="300" onclick="setChartTf(300)">5m</button>
          <button class="chart-tf-btn" data-tf="600" onclick="setChartTf(600)">10m</button>
          <button class="chart-tf-btn" data-tf="900" onclick="setChartTf(900)">15m</button>
          <button class="chart-tf-btn" data-tf="1800" onclick="setChartTf(1800)">30m</button>
          <div class="chart-tf-sep"></div>
          <button class="chart-tf-btn" data-tf="3600" onclick="setChartTf(3600)">1h</button>
          <button class="chart-tf-btn" data-tf="7200" onclick="setChartTf(7200)">2h</button>
          <button class="chart-tf-btn" data-tf="14400" onclick="setChartTf(14400)">4h</button>
        </div>
        <span id="chartLastPrice"
          style="margin-left:auto;font-family:'Share Tech Mono',monospace;font-size:14px;color:var(--accent);font-weight:700;"></span>
      </div>
      <div id="chartContainer" style="height:300px;border-radius:8px;overflow:hidden;"></div>
    </div>

    <div class="dash-wrapper">
      <!-- ═══ LEFT PANEL ═══ -->
      <div class="dash-left">

        <!-- ── BOLETA DE OPERAÇÃO ── -->
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <div style="font-size:11px;letter-spacing:2px;color:var(--gold);font-family:'Share Tech Mono',monospace;">💼
              BOLETA DE OPERAÇÃO</div>
            <div class="mode-toggle">
              <span class="mode-toggle-label" id="modeLabelAuto" style="color:var(--accent);">AUTO</span>
              <div class="toggle-track" id="modeToggle" onclick="toggleOperationMode()">
                <div class="toggle-knob" id="modeKnob"></div>
              </div>
              <span class="mode-toggle-label" id="modeLabelManual" style="color:var(--dim);">MANUAL</span>
            </div>
          </div>

          <!-- Robot dropdown selector -->
          <div class="field" style="margin-bottom:12px;">
            <label>Robô / Modo</label>
            <div class="robot-dropdown" id="robotDropdown">
              <button class="robot-dropdown-btn" id="robotDropdownBtn" onclick="toggleRobotDropdown()">
                <span class="rdb-name" id="robotDropdownLabel">⚡ Selecione um robô...</span>
                <span class="rdb-arrow">▼</span>
              </button>
              <div class="robot-dropdown-menu" id="robotDropdownMenu">
                <!-- populated by renderRobotSelectorList() -->
              </div>
            </div>
          </div>

          <!-- Manual mode fields (shown only when manual selected) -->
          <div class="manual-fields" id="manualFields">
            <div class="form-grid-2" style="gap:10px;">
              <div class="field">
                <label>Estratégia</label>
                <select id="manualStrategy" onchange="applyBoleta()">
                  <option value="over0">Over 0 · 90%</option>
                  <option value="over1">Over 1 · 80%</option>
                  <option value="over2">Over 2 · 70%</option>
                  <option value="over3" selected>Over 3 · 60%</option>
                  <option value="over4">Over 4 · 50%</option>
                  <option value="over5">Over 5 · 40%</option>
                  <option value="over6">Over 6 · 30%</option>
                  <option value="over7">Over 7 · 20%</option>
                  <option value="over8">Over 8 · 10%</option>
                  <option value="under1">Under 1 · 10%</option>
                  <option value="under2">Under 2 · 20%</option>
                  <option value="under3">Under 3 · 30%</option>
                  <option value="under4">Under 4 · 40%</option>
                  <option value="under5">Under 5 · 50%</option>
                  <option value="under6">Under 6 · 60%</option>
                  <option value="under7">Under 7 · 70%</option>
                  <option value="under8">Under 8 · 80%</option>
                  <option value="under9">Under 9 · 90%</option>
                </select>
              </div>
              <div class="field">
                <label>Losses Virtuais</label>
                <select id="manualVirtual" onchange="applyBoleta();updateVdots();">
                  <option value="2">2 losses</option>
                  <option value="3">3 losses</option>
                  <option value="4">4 losses</option>
                  <option value="5" selected>5 losses</option>
                  <option value="6">6 losses</option>
                </select>
              </div>
              <div class="field">
                <label>Fator Martingale</label>
                <input type="number" id="manualFactor" value="2.8" min="1.1" max="5" step="0.1" oninput="applyBoleta()">
              </div>
              <div class="field">
                <label>Níveis Máx.</label>
                <input type="number" id="manualLevels" value="5" min="1" max="8" step="1" oninput="applyBoleta()">
              </div>
            </div>
          </div>

          <!-- Common boleta fields -->
          <div
            style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;margin-top:4px;align-items:end;">
            <div class="field">
              <label>Mercado</label>
              <select id="boletaMarket"
                onchange="applyBoleta();updateOUTable();updateDiagnostics();reconnectPublicStream();"
                style="height:38px;">
                <optgroup label="── Volatility (padrão)">
                  <option value="R_10">Volatility 10</option>
                  <option value="R_25">Volatility 25</option>
                  <option value="R_50">Volatility 50</option>
                  <option value="R_75">Volatility 75</option>
                  <option value="R_100" selected>Volatility 100</option>
                </optgroup>
                <optgroup label="── Volatility (1s)">
                  <option value="1HZ10V">Volatility 10 (1s)</option>
                  <option value="1HZ25V">Volatility 25 (1s)</option>
                  <option value="1HZ50V">Volatility 50 (1s)</option>
                  <option value="1HZ75V">Volatility 75 (1s)</option>
                  <option value="1HZ100V">Volatility 100 (1s)</option>
                  <option value="1HZ150V">Volatility 150 (1s)</option>
                  <option value="1HZ200V">Volatility 200 (1s)</option>
                  <option value="1HZ250V">Volatility 250 (1s)</option>
                  <option value="1HZ300V">Volatility 300 (1s)</option>
                </optgroup>
                <optgroup label="── Boom &amp; Crash">
                  <option value="BOOM300N">Boom 300</option>
                  <option value="BOOM500">Boom 500</option>
                  <option value="BOOM1000">Boom 1000</option>
                  <option value="CRASH300N">Crash 300</option>
                  <option value="CRASH500">Crash 500</option>
                  <option value="CRASH1000">Crash 1000</option>
                </optgroup>
                <optgroup label="── Range Break">
                  <option value="RNGBULL100">Range Break 100 Bull</option>
                  <option value="RNGBEAR100">Range Break 100 Bear</option>
                  <option value="RNGBULL200">Range Break 200 Bull</option>
                  <option value="RNGBEAR200">Range Break 200 Bear</option>
                </optgroup>
                <optgroup label="── Step &amp; Jump">
                  <option value="STPIDX10">Step Index</option>
                  <option value="JD10">Jump 10</option>
                  <option value="JD25">Jump 25</option>
                  <option value="JD50">Jump 50</option>
                  <option value="JD75">Jump 75</option>
                  <option value="JD100">Jump 100</option>
                </optgroup>
              </select>
            </div>
            <div class="field">
              <label>Entrada Base ($)</label>
              <input type="number" id="boletaEntry" value="0.35" min="0.35" step="0.05" oninput="applyBoleta()"
                style="height:38px;">
            </div>
            <div class="field">
              <label>Stop Gain ($)</label>
              <input type="number" id="boletaSG" value="20" min="0.50" step="0.50" oninput="applyBoleta()">
            </div>
            <div class="field">
              <label>Stop Loss ($)</label>
              <input type="number" id="boletaSL" value="30" min="0.50" step="0.50" oninput="applyBoleta()">
            </div>
          </div>

          <!-- Martingale table -->
          <div id="boletaMartTable"
            style="background:var(--surface2);border-radius:8px;padding:10px;margin-bottom:12px;min-height:40px;">
            <div
              style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:Share Tech Mono,monospace;margin-bottom:6px;">
              TABELA MARTINGALE</div>
            <div id="martTableCells" style="display:flex;gap:5px;flex-wrap:wrap;"></div>
            <div id="martExposure"
              style="font-size:10px;color:var(--red);font-family:Share Tech Mono,monospace;margin-top:6px;"></div>
          </div>

          <!-- Controls inside boleta -->
          <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px;">
            <button class="btn btn-primary" id="connectBtn" onclick="connectDash()">▶ CONECTAR</button>
            <button class="btn" id="tradeToggleBtn" onclick="toggleAutoTrade()"
              style="background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.4);font-weight:700;">🤖
              INICIAR ROBÔ</button>
          </div>

          <!-- Progress -->
          <div style="margin-bottom:12px;">
            <div
              style="display:flex;justify-content:space-between;font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-bottom:4px;">
              <span>HISTÓRICO COLETADO</span>
              <span id="progressText">0 dígitos</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill" style="width:100%;"></div>
            </div>
          </div>

          <!-- PnL stats -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
            <div class="boleta-stat">
              <div class="boleta-stat-label">NÍVEL MART.</div>
              <div class="boleta-stat-val" id="bLevel" style="color:var(--gold);">—</div>
            </div>
            <div class="boleta-stat">
              <div class="boleta-stat-label">STATUS SESSÃO</div>
              <div class="boleta-stat-val" id="bStatus" style="font-size:13px;color:var(--dim);">AGUARDANDO</div>
            </div>
          </div>
          <div class="boleta-stat">
            <div class="boleta-stat-label">SESSÃO P&L</div>
            <div class="boleta-stat-val" id="bPnl" style="color:var(--green);">$0.00</div>
            <div class="pnl-bar">
              <div class="pnl-fill" id="pnlFill" style="width:0%;background:var(--green);"></div>
            </div>
          </div>
        </div>

      </div><!-- /dash-left -->

      <!-- ═══ CENTER PANEL ═══ -->
      <div class="dash-center">
        <!-- Signal box -->
        <div class="signal-box">
          <div class="signal-main">
            <span style="font-size:10px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">🤖
              SINAL DO ROBÔ</span>
            <span class="signal-val aguardando" id="robotSignal">AGUARDANDO CONEXÃO</span>
            <span style="font-size:11px;color:var(--dim);" id="signalDesc">Conecte para iniciar</span>
          </div>
          <div style="display:flex;flex-direction:column;align-items:center;gap:6px;">
            <span
              style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">LOSSES
              VIRTUAIS</span>
            <div class="vdots" id="vdots"></div>
            <span class="mono" style="font-size:10px;color:var(--dim);" id="vdotCount">0 / 5</span>
          </div>
          <div style="text-align:right;">
            <div style="font-size:9px;letter-spacing:2px;color:var(--dim);font-family:'Share Tech Mono',monospace;">
              MARTINGALE</div>
            <div style="font-size:26px;font-weight:900;font-family:'Share Tech Mono',monospace;color:var(--gold);"
              id="mLevel">—</div>
            <div style="font-size:13px;font-family:'Share Tech Mono',monospace;color:var(--accent);" id="mEntry">$—
            </div>
            <div style="font-size:10px;color:var(--dim);font-family:'Share Tech Mono',monospace;" id="mAccum">Acum: $—
            </div>
          </div>
        </div>

        <!-- Last digit + stream -->
        <div class="card" style="margin-bottom:14px;">
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:10px;">
            <div
              style="width:64px;height:64px;border-radius:12px;background:var(--surface2);display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900;font-family:'Share Tech Mono',monospace;"
              id="lastDigitDisplay">—</div>
            <div>
              <div style="font-size:14px;font-weight:700;" id="lastDigitResult">—</div>
              <div style="font-size:11px;color:var(--dim);" id="lastDigitStrat">—</div>
              <div style="font-size:11px;color:var(--dim);margin-top:4px;" id="totalDigits">0 dígitos</div>
            </div>
          </div>
          <div class="digit-stream" id="digitStream"></div>
        </div>

        <!-- Stats by digit -->
        <div class="stats-grid" id="freqGrid"></div>

        <!-- Over/Under Table -->
        <div class="card" style="margin-bottom:14px;">
          <div
            style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:12px;">
            📊 TABELA OVER/UNDER</div>
          <table class="ou-table" id="ouTable">
            <thead>
              <tr>
                <th>OPERAÇÃO</th>
                <th>DÍGITOS</th>
                <th>WIN RATE</th>
                <th>STATUS</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Martingale Reference Table -->
        <div class="card" style="margin-bottom:14px;">
          <div
            style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:10px;">
            📈 POTENCIAL MARTINGALE — 0 a 8 · 5 NÍVEIS</div>
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px;flex-wrap:wrap;">
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>Entrada ($)</label>
              <input type="number" id="martRefEntry" value="0.35" min="0.01" step="0.05" oninput="updateMartRefTable()"
                style="padding:6px 8px;font-size:13px;">
            </div>
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>Fator Mart.</label>
              <input type="number" id="martRefFactor" value="2.8" min="1.1" max="10" step="0.1"
                oninput="updateMartRefTable()" style="padding:6px 8px;font-size:13px;">
            </div>
            <div class="field" style="margin:0;flex:1;min-width:90px;">
              <label>Níveis</label>
              <select id="martRefLevels" onchange="updateMartRefTable()" style="padding:6px 8px;font-size:13px;">
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5" selected>5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
              </select>
            </div>
            <button onclick="syncMartRefFromBoleta()" title="Sincronizar com boleta"
              style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.3);border-radius:6px;color:var(--accent);font-size:11px;padding:6px 10px;cursor:pointer;font-family:'Share Tech Mono',monospace;letter-spacing:1px;white-space:nowrap;margin-top:14px;">
              ⟳ BOLETA
            </button>
          </div>
          <div class="mart-ref-section">
            <table class="mart-ref-table" id="martRefTable">
              <thead>
                <tr>
                  <th class="strat-col">ESTRATÉGIA</th>
                  <th>PAYOUT</th>
                  <th>N1</th>
                  <th>N2</th>
                  <th>N3</th>
                  <th>N4</th>
                  <th>N5</th>
                </tr>
              </thead>
              <tbody id="martRefBody"></tbody>
            </table>
          </div>
          <div
            style="font-size:9px;color:var(--dim);font-family:'Share Tech Mono',monospace;margin-top:8px;line-height:1.6;">
            🟢 Lucro bruto por nível &nbsp;·&nbsp; 🟡 Lucro líquido (descontando acumulado) &nbsp;·&nbsp; 🔴 Prejuízo
            líquido
          </div>
        </div>

        <!-- Diagnostics -->
        <div class="card" style="margin-bottom:14px;">
          <div
            style="font-size:11px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:12px;">
            🔬 DIAGNÓSTICO PREDITIVO</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div>
              <div
                style="font-size:9px;letter-spacing:2px;color:var(--green);font-family:'Share Tech Mono',monospace;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);">
                📈 OVER</div>
              <div class="diag-grid" id="diagGridOver"></div>
            </div>
            <div>
              <div
                style="font-size:9px;letter-spacing:2px;color:var(--accent);font-family:'Share Tech Mono',monospace;margin-bottom:6px;padding-bottom:4px;border-bottom:1px solid var(--border);">
                📉 UNDER</div>
              <div class="diag-grid" id="diagGridUnder"></div>
            </div>
          </div>
        </div>

      </div><!-- /dash-center -->

      <!-- ═══ RIGHT PANEL — LOG + LIVE OPS ═══ -->
      <div class="dash-right">
        <!-- LOG -->
        <div class="dash-right-header">
          <span>📋 LOG DO SISTEMA</span>
          <button onclick="document.getElementById('logArea').innerHTML=''"
            style="background:none;border:1px solid var(--border);border-radius:4px;color:var(--dim);font-size:9px;padding:2px 7px;cursor:pointer;letter-spacing:1px;">LIMPAR</button>
        </div>
        <div class="dash-right-log" id="logArea"></div>
        <!-- LIVE OPS -->
        <div class="dash-right-header" style="border-top:1px solid var(--border);">
          <span>⚡ OPERAÇÕES AO VIVO</span>
          <div style="display:flex;gap:8px;font-size:10px;">
            <span>✅ <span id="liveWins" style="color:var(--green);">0</span></span>
            <span>❌ <span id="liveLosses" style="color:var(--red);">0</span></span>
            <span style="color:var(--dim);">|</span>
            <span id="liveRate" style="color:var(--gold);">—%</span>
          </div>
        </div>
        <div class="live-ops-row live-ops-head" style="background:var(--surface2);padding:4px 10px;">
          <span>HORA</span><span>ESTRATÉGIA</span><span>ENTRADA</span><span>PREÇO
            IN→OUT</span><span>RES.</span><span>P&L</span>
        </div>
        <div class="dash-right-ops" id="liveOpsList">
          <div
            style="text-align:center;color:var(--dim);font-size:10px;padding:16px;font-family:'Share Tech Mono',monospace;">
            Aguardando operações...</div>
        </div>
      </div><!-- /dash-right -->

    </div><!-- /dash-wrapper -->
  </div><!-- /screenDashboard -->

  <!-- ════════════════════════════════════════════
     SCREEN: RELATÓRIOS DIÁRIOS
════════════════════════════════════════════ -->
  <div id="screenReports" class="screen">
    <!-- Topnav -->
    <div class="topnav">
      <div class="topnav-brand" id="reportsTopnavBrand">📊 RELATÓRIOS DIÁRIOS</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="nav-pill" onclick="showScreen('screenDashboard')">◀ Dashboard</button>
        <button class="nav-pill" id="btnClearReports" onclick="clearReports()"
          style="color:var(--red);border-color:rgba(248,113,113,.4);">🗑 Limpar</button>
      </div>
    </div>
    <div style="padding:20px;max-width:1200px;margin:0 auto;width:100%;overflow-y:auto;flex:1;">
      <!-- Resumo do dia atual -->
      <div id="reportsSummary" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
      </div>
      <!-- Tabela -->
      <div id="reportsContent">
        <div
          style="text-align:center;color:var(--dim);font-size:12px;padding:40px;font-family:'Share Tech Mono',monospace;">
          Nenhuma operação registrada nesta sessão.
        </div>
      </div>
    </div>
  </div>

  <!-- ════════════════════════════════════════════
     SCREEN: ROBÔ FREQUÊNCIA DE DÍGITOS
════════════════════════════════════════════ -->
  <div id="screenFreq" class="screen">
    <!-- Top nav -->
    <div class="topnav" style="background:#1c1e2d;border-bottom:1px solid #32364a;">
      <div class="topnav-brand" style="color:#60a5fa;">🎯 FREQ. DÍGITOS</div>
      <div style="display:flex;gap:10px;align-items:center;">
        <button class="nav-pill" onclick="showScreen('screenDashboard')">◀ Dashboard</button>
      </div>
    </div>

    <!-- Account bar -->
    <div id="freqAccBar"
      style="display:none;background:var(--surface);border-bottom:1px solid #32364a;padding:8px 18px;gap:20px;align-items:center;flex-wrap:wrap;">
      <div class="acc-field">
        <span class="acc-field-label">CONTA</span>
        <span class="acc-field-val mono" id="freqAccLoginId" style="color:var(--accent);font-size:13px;">—</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">TIPO</span>
        <span class="acc-field-val" id="freqAccType" style="font-size:13px;">—</span>
      </div>
      <div class="acc-field">
        <span class="acc-field-label">SALDO</span>
        <span class="acc-field-val mono" id="freqAccBalance" style="color:var(--green);font-size:13px;">—</span>
      </div>
    </div>

    <!-- Main layout -->
    <div
      style="display:flex;gap:14px;padding:18px;width:100%;overflow-y:auto;flex:1;box-sizing:border-box;align-items:flex-start;">

      <!-- ── SIDEBAR ── -->
      <div class="fq-sidebar">

        <!-- Market -->
        <div class="fq-panel">
          <div class="fq-label">Mercado</div>
          <div class="fq-mkt-grid" id="freqMarketBtns">
            <button class="fq-mkt-btn active" data-sym="R_10" onclick="freqSelectMarket('R_10',this)">V10</button>
            <button class="fq-mkt-btn" data-sym="R_25" onclick="freqSelectMarket('R_25',this)">V25</button>
            <button class="fq-mkt-btn" data-sym="R_50" onclick="freqSelectMarket('R_50',this)">V50</button>
            <button class="fq-mkt-btn" data-sym="R_75" onclick="freqSelectMarket('R_75',this)">V75</button>
            <button class="fq-mkt-btn" data-sym="R_100" onclick="freqSelectMarket('R_100',this)">V100</button>
          </div>
          <div id="freqConnStatus"
            style="font-size:10px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;margin-top:10px;text-align:center;">
            ⬤ Desconectado</div>
        </div>

        <!-- Robot selector -->
        <div class="fq-panel">
          <div class="fq-label">Robô</div>
          <div class="fq-size-btns">
            <button class="fq-size-btn active" id="freqBtnExtremus" onclick="freqSetStrategy('extremos')">⚡ EXTREMOS</button>
            <button class="fq-size-btn" id="freqBtnNeutros" onclick="freqSetStrategy('neutros')">🎯 MATCH</button>
          </div>
        </div>

        <!-- Analysis size -->
        <div class="fq-panel">
          <div class="fq-label">Análise do Robô</div>
          <div class="fq-size-btns">
            <button class="fq-size-btn active" id="freqBtnSize10" onclick="freqSetSize(10)">10 dígitos</button>
            <button class="fq-size-btn" id="freqBtnSize25" onclick="freqSetSize(25)">25 dígitos</button>
          </div>
        </div>

        <!-- Config -->
        <div class="fq-panel">
          <div class="fq-label">Configuração</div>
          <div id="freqConfigInputs">
            <div class="fq-input-group">
              <div class="fq-input-label">ENTRADA (USD)</div>
              <input type="number" id="freqEntry" value="0.35" step="0.01" min="0.35" class="fq-input">
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div class="fq-input-group">
                <div class="fq-input-label">STOP GAIN</div>
                <input type="number" id="freqSG" value="10" step="0.50" class="fq-input">
              </div>
              <div class="fq-input-group">
                <div class="fq-input-label">STOP LOSS</div>
                <input type="number" id="freqSL" value="5" step="0.50" class="fq-input">
              </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
              <div class="fq-input-group">
                <div class="fq-input-label">DIG. QUENTE %</div>
                <input type="number" id="freqHotThreshold" value="25" step="5" min="10" max="90" class="fq-input">
              </div>
              <div class="fq-input-group">
                <div class="fq-input-label">EQUIL. OPOSTO %</div>
                <input type="number" id="freqOppMinThreshold" value="15" step="5" min="0" max="60" class="fq-input">
              </div>
            </div>
          </div>
          <button id="freqToggleBtn" onclick="freqToggleRobot()" class="fq-start-btn">▶ INICIAR ROBÔ</button>
        </div>

        <!-- Session stats -->
        <div class="fq-panel">
          <div class="fq-label">Sessão</div>
          <div class="fq-stats">
            <div class="fq-stat">
              <div class="fq-stat-label">WINS</div>
              <div class="fq-stat-value" style="color:var(--fq-under);" id="freqWins">0</div>
            </div>
            <div class="fq-stat">
              <div class="fq-stat-label">LOSSES</div>
              <div class="fq-stat-value" style="color:var(--fq-red);" id="freqLosses">0</div>
            </div>
            <div class="fq-stat" style="grid-column:1/-1;">
              <div class="fq-stat-label">P&L</div>
              <div class="fq-stat-value" style="color:var(--fq-over);font-size:22px;" id="freqPnl">$0.00</div>
            </div>
            <div class="fq-stat" style="grid-column:1/-1;">
              <div class="fq-stat-label">STATUS</div>
              <div style="font-size:11px;font-weight:700;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;"
                id="freqStatusTxt">INATIVO</div>
            </div>
          </div>
        </div>

      </div><!-- /sidebar -->

      <!-- ── MAIN CONTENT ── -->
      <div style="flex:1;min-width:0;">

        <!-- Digit chips -->
        <div class="fq-panel" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
            <div
              style="font-size:10px;letter-spacing:1.5px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;">
              📊 FREQUÊNCIA &nbsp;<span style="color:var(--fq-under);">■ UNDER</span> &nbsp;<span
                style="color:var(--fq-over);">■ OVER</span> &nbsp;<span style="color:var(--fq-gold);">■ QUENTE</span>
              &nbsp;<span style="color:var(--fq-red);">■ ZERO</span>
            </div>
          </div>
          <div id="freqChart10Wrap">
            <div class="fq-chips" id="freqBars10"></div>
          </div>
          <div id="freqChart25Wrap" style="display:none;">
            <div class="fq-chips" id="freqBars25"></div>
          </div>
        </div>

        <!-- Live stream -->
        <div class="fq-panel" style="margin-bottom:12px;">
          <div style="display:flex;align-items:center;gap:14px;margin-bottom:10px;">
            <div id="freqLastDigitBox"
              style="width:52px;height:52px;border-radius:10px;background:var(--fq-surface2);display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:900;font-family:'Share Tech Mono',monospace;flex-shrink:0;transition:background .2s,color .2s;border:1px solid var(--fq-border);">
              —</div>
            <div>
              <div id="freqLastDigitResult"
                style="font-size:13px;font-weight:700;color:var(--fq-dim);margin-bottom:3px;">—</div>
              <div
                style="font-size:10px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;margin-bottom:2px;">
                <span style="color:var(--fq-under);">■ UNDER 3</span> (0,1,2) &nbsp;·&nbsp; <span
                  style="color:var(--fq-over);">■ OVER 6</span> (7,8,9)
              </div>
              <div style="font-size:10px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;">Total: <span
                  id="freqTotalDigits">0</span> dígitos</div>
            </div>
          </div>
          <div class="digit-stream" id="freqDigitStream" style="max-height:80px;"></div>
        </div>

        <!-- Trade cards UNDER + OVER -->
        <div class="fq-trade-cards">
          <!-- UNDER 3 -->
          <div class="fq-trade-card fq-under-card" id="freqCardUnder">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div id="freqCardUnderTitle" style="font-size:14px;font-weight:700;color:var(--fq-under);">📉 UNDER 3</div>
              <span class="freq-status-badge aguard" id="freqBadgeUnder">AGUARDANDO</span>
            </div>
            <div id="freqCardUnderInfo" style="font-size:10px;color:var(--fq-dim);margin-bottom:6px;font-family:'Share Tech Mono',monospace;">
              Monitora: <span style="color:var(--fq-under);">0, 1, 2</span> &nbsp;|&nbsp; Ganha se dígito ∈ {0,1,2}
            </div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fq-dim);margin:6px 0;">
              <span>Martingale</span><span style="color:var(--fq-text);">1.6× — 8 níveis</span>
            </div>
            <div
              style="font-size:11px;color:var(--fq-dim);display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>Nível atual</span>
              <span id="freqUnderLevel" style="color:var(--fq-gold);font-family:'Share Tech Mono',monospace;">1 /
                8</span>
            </div>
            <div
              style="font-size:11px;color:var(--fq-dim);display:flex;justify-content:space-between;margin-bottom:10px;">
              <span>Próxima entrada</span>
              <span id="freqUnderNextEntry"
                style="color:var(--fq-under);font-family:'Share Tech Mono',monospace;">—</span>
            </div>
            <div style="font-size:10px;color:var(--fq-dim);margin-bottom:4px;">Dígito(s) em 0%:</div>
            <div id="freqUnderZeroDigit"
              style="font-size:26px;font-weight:700;color:var(--fq-under);font-family:'Share Tech Mono',monospace;text-align:center;padding:4px 0;">
              —</div>
          </div>
          <!-- OVER 6 -->
          <div class="fq-trade-card fq-over-card" id="freqCardOver">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div id="freqCardOverTitle" style="font-size:14px;font-weight:700;color:var(--fq-over);">📈 OVER 6</div>
              <span class="freq-status-badge aguard" id="freqBadgeOver">AGUARDANDO</span>
            </div>
            <div id="freqCardOverInfo" style="font-size:10px;color:var(--fq-dim);margin-bottom:6px;font-family:'Share Tech Mono',monospace;">
              Monitora: <span style="color:var(--fq-over);">7, 8, 9</span> &nbsp;|&nbsp; Ganha se dígito ∈ {7,8,9}</div>
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--fq-dim);margin:6px 0;">
              <span>Martingale</span><span style="color:var(--fq-text);">1.9× — 8 níveis</span>
            </div>
            <div
              style="font-size:11px;color:var(--fq-dim);display:flex;justify-content:space-between;margin-bottom:4px;">
              <span>Nível atual</span>
              <span id="freqOverLevel" style="color:var(--fq-gold);font-family:'Share Tech Mono',monospace;">1 /
                8</span>
            </div>
            <div
              style="font-size:11px;color:var(--fq-dim);display:flex;justify-content:space-between;margin-bottom:10px;">
              <span>Próxima entrada</span>
              <span id="freqOverNextEntry"
                style="color:var(--fq-over);font-family:'Share Tech Mono',monospace;">—</span>
            </div>
            <div style="font-size:10px;color:var(--fq-dim);margin-bottom:4px;">Dígito(s) em 0%:</div>
            <div id="freqOverZeroDigit"
              style="font-size:26px;font-weight:700;color:var(--fq-over);font-family:'Share Tech Mono',monospace;text-align:center;padding:4px 0;">
              —</div>
          </div>
        </div>

        <!-- Active trade indicator -->
        <div id="freqOpIndicator"
          style="display:none;text-align:center;padding:16px;margin-top:12px;background:var(--fq-surface);border:1px solid var(--fq-border);border-radius:14px;">
          <div id="freqOpIcon" style="font-size:36px;margin-bottom:4px;line-height:1;">📉</div>
          <div id="freqOpLabel"
            style="font-size:15px;font-weight:700;letter-spacing:2px;color:var(--fq-under);margin-bottom:4px;">UNDER 3
          </div>
          <div id="freqOpLevel" style="font-size:11px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;">
            Nível 1 / 8 — $0.35</div>
        </div>

        <!-- Relógio 1: sessão do robô -->
        <div id="freqClockWrap" class="fq-clock" style="display:none;">
          <div class="fq-clock-lbl">⏱ DURAÇÃO DA SESSÃO</div>
          <div class="fq-clock-time">
            <span id="freqClockMin">00</span><span class="fq-clock-sep">:</span><span id="freqClockSec">00</span>
          </div>
          <div id="freqClockResult" class="fq-clock-result" style="display:none;"></div>
        </div>

        <!-- Relógio 2: duração da operação (entrada → resultado) -->
        <div id="freqOpClockWrap" class="fq-clock" style="display:none;">
          <div class="fq-clock-lbl">⚡ DURAÇÃO DA OPERAÇÃO</div>
          <div class="fq-clock-time">
            <span id="freqOpClockMin">00</span><span class="fq-clock-sep">:</span><span id="freqOpClockSec">00</span>
          </div>
          <div id="freqOpClockEntry"
            style="font-size:11px;color:var(--fq-dim);font-family:'Share Tech Mono',monospace;margin-top:6px;letter-spacing:1px;">
            Entrada: —</div>
          <div id="freqOpClockResult" class="fq-clock-result" style="display:none;"></div>
        </div>

      </div><!-- /main -->

      <!-- ── LOG PANEL ── -->
      <div style="width:240px;flex-shrink:0;position:sticky;top:0;">
        <div class="fq-panel">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
            <div
              style="font-size:10px;letter-spacing:2px;color:var(--fq-over);font-family:'Share Tech Mono',monospace;">📋
              LOG</div>
            <button onclick="freqClearLog()"
              style="background:none;border:1px solid var(--fq-border);color:var(--fq-dim);font-size:10px;cursor:pointer;font-family:'Share Tech Mono',monospace;padding:2px 7px;border-radius:4px;">limpar</button>
          </div>
          <div id="freqLogArea"
            style="font-family:'Share Tech Mono',monospace;font-size:10px;display:flex;flex-direction:column;gap:3px;max-height:600px;overflow-y:auto;">
            <div id="freqLogEmpty"
              style="color:var(--fq-dim);font-size:10px;text-align:center;padding:20px 0;line-height:1.6;">Inicie o
              robô<br>para ver os logs aqui.</div>
          </div>
        </div>
      </div>

    </div><!-- /main layout -->
  </div>

  <!-- Freq Result Overlay -->
  <div class="freq-overlay" id="freqResultOverlay">
    <div class="freq-overlay-box">
      <div style="font-size:44px;margin-bottom:8px;" id="freqResIcon">🏆</div>
      <div style="font-size:15px;font-weight:700;letter-spacing:2px;margin-bottom:6px;" id="freqResTitle">STOP GAIN
      </div>
      <div style="font-size:34px;font-weight:700;margin-bottom:12px;" id="freqResValue">+$0.00</div>
      <div style="font-size:11px;color:var(--dim);margin-bottom:24px;" id="freqResDetail">0 wins · 0 losses</div>
      <button onclick="freqCloseResult()"
        style="padding:10px 36px;background:linear-gradient(135deg,rgba(0,212,255,.2),rgba(0,255,159,.1));border:1px solid var(--accent);border-radius:10px;color:var(--accent);font-weight:700;cursor:pointer;font-size:13px;letter-spacing:1px;">FECHAR</button>
    </div>
  </div>

  <!-- oauthStatus (hidden, used during redirect) -->
  <div id="oauthStatus"
    style="display:none;position:fixed;inset:0;z-index:9998;align-items:center;justify-content:center;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);">
    <div
      style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;text-align:center;">
      <div style="font-size:11px;color:var(--accent);letter-spacing:2px;font-family:'Share Tech Mono',monospace;"
        id="oauthStatusMsg">Redirecionando para a Deriv...</div>
    </div>
  </div>

  <!-- OAuth waiting overlay -->
  <div id="oauthOverlay">
    <div class="oauth-modal">
      <div style="font-size:32px;margin-bottom:12px;">⚡</div>
      <div style="font-size:14px;font-weight:700;letter-spacing:2px;color:var(--accent);margin-bottom:8px;"
        id="oauthModalTitle">AUTORIZANDO...</div>
      <div class="oauth-spinner"></div>
      <div style="font-size:12px;color:var(--dim);margin-top:12px;" id="oauthModalMsg">Aguardando autorização na janela
        da Deriv</div>
      <button onclick="cancelOAuth()"
        style="margin-top:20px;background:none;border:1px solid var(--border);color:var(--dim);border-radius:8px;padding:8px 20px;cursor:pointer;font-size:12px;">Cancelar</button>
    </div>
  </div>

  <script>
    // ════════════════════════════════════════
    // STORAGE — persistent robots & admins
    // ════════════════════════════════════════
    function store(k, v) { try { localStorage.setItem(k, JSON.stringify(v)); } catch (e) { } }
    function load(k, def) { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch (e) { return def; } }

    // ── Password hashing (SHA-256 via Web Crypto) ──────────────────────────────
    async function hashPass(pass) {
      const enc = new TextEncoder();
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(pass));
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // Default admin — SHA-256 of 'admin123'
    let admins = load('drv_admins', [{ user: 'admin', pass: '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9' }]);
    const DEFAULT_ROBOTS = [
      {
        "id": "robot_gladiador",
        "name": "GLADIADOR",
        "desc": "Over 3 equilibrado. 60% win rate. Fator 2.8 calculado — lucro garantido em todos os 4 níveis. Entrada após 3 losses virtuais. Ideal para operação diária.",
        "strategy": "over3",
        "virtualLosses": 3,
        "entry": 0.35,
        "factor": 2.8,
        "levels": 4,
        "running": true,
        "createdAt": 1700000001000
      },
      {
        "id": "robot_sniper",
        "name": "SNIPER",
        "desc": "Over 5 seletivo. Payout ~123%. Fator 1.8 — cada nível garante ~$0.40 líquido. Aguarda 5 losses virtuais. Menor exposição, alta seletividade.",
        "strategy": "over5",
        "virtualLosses": 5,
        "entry": 0.35,
        "factor": 1.8,
        "levels": 5,
        "running": true,
        "createdAt": 1700000002000
      },
      {
        "id": "robot_titan",
        "name": "TITAN",
        "desc": "Over 4 ativo. 50% win rate. Fator 2.2 garante lucro crescente por nível. 2 losses virtuais = alta frequência de entradas.",
        "strategy": "over4",
        "virtualLosses": 2,
        "entry": 0.35,
        "factor": 2.2,
        "levels": 5,
        "running": true,
        "createdAt": 1700000003000
      },
      {
        "id": "robot_conservador",
        "name": "CONSERVADOR",
        "desc": "Over 2 — 70% win rate mas payout 22%. Fator 5.5 necessário para cobrir perdas em 3 níveis. Exposição sobe rapidamente — use com cautela.",
        "strategy": "over2",
        "virtualLosses": 4,
        "entry": 0.35,
        "factor": 5.5,
        "levels": 3,
        "running": true,
        "createdAt": 1700000004000
      },
      {
        "id": "robot_cacador",
        "name": "CAÇADOR",
        "desc": "Under 4 contrarian. Payout ~150%. Fator 1.6 — lucro líquido positivo em todos os 5 níveis. Complementa estratégias Over.",
        "strategy": "under4",
        "virtualLosses": 4,
        "entry": 0.35,
        "factor": 1.6,
        "levels": 5,
        "running": true,
        "createdAt": 1700000005000
      },
      {
        "id": "robot_equilibrio",
        "name": "EQUILÍBRIO",
        "desc": "Over 3 seguro. Apenas 3 níveis. Fator 2.7 garante lucro mínimo em cada nível. Para iniciantes ou preservação de capital.",
        "strategy": "over3",
        "virtualLosses": 4,
        "entry": 0.35,
        "factor": 2.7,
        "levels": 3,
        "running": true,
        "createdAt": 1700000006000
      },
      {
        "id": "robot_agressor",
        "name": "AGRESSOR",
        "desc": "Over 6 alto retorno. Payout 240%. Fator 1.3 — lucro líquido $0.84 no N1 até $0.23 no N5. Aguarda 6 losses virtuais.",
        "strategy": "over6",
        "virtualLosses": 6,
        "entry": 0.35,
        "factor": 1.3,
        "levels": 5,
        "running": true,
        "createdAt": 1700000007000
      },
      {
        "id": "robot_surfista",
        "name": "SURFISTA",
        "desc": "Under 5 simétrico. Fator 2.2 igual ao TITAN. Alternativa Under para diversificar direção de entrada.",
        "strategy": "under5",
        "virtualLosses": 3,
        "entry": 0.35,
        "factor": 2.2,
        "levels": 5,
        "running": true,
        "createdAt": 1700000008000
      }
    ];
    let robots = load('drv_robots', null);
    // Always sync default robots — update factor/levels on existing pre-built ones, preserve user-created
    {
      const stored = robots || [];
      const prebuiltIds = DEFAULT_ROBOTS.map(function (r) { return r.id; });
      const userRobots = stored.filter(function (r) { return !prebuiltIds.includes(r.id); });
      const merged = DEFAULT_ROBOTS.map(function (def) {
        const existing = stored.find(function (r) { return r.id === def.id; });
        if (existing) { const copy = Object.assign({}, def); copy.running = existing.running; return copy; }
        return Object.assign({}, def);
      });
      robots = merged.concat(userRobots);
      store('drv_robots', robots);
    }
    let currentUser = null; // { user, isAdmin }
    let editingRobotId = null;
    let selectedRobot = null;

    // ════════════════════════════════════════
    // SCREENS
    // ════════════════════════════════════════
    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      if (id === 'screenReports') loadReportsFromSupabase();
      if (id === 'screenFreq') freqInitChart();
    }

    // ════════════════════════════════════════
    // LOGIN
    // ════════════════════════════════════════
    // ════════════════════════════════════════
    // ALPHA AUTH (Supabase)
    // ════════════════════════════════════════

    // ════════════════════════════════════════
    // PROFILE DROPDOWN
    // ════════════════════════════════════════
    function toggleProfileDropdown() {
      const dd = document.getElementById('profileDropdown');
      if (dd) dd.classList.toggle('open');
    }
    function closeProfileDropdown() {
      const dd = document.getElementById('profileDropdown');
      if (dd) dd.classList.remove('open');
    }
    // Close on outside click
    document.addEventListener('click', function (e) {
      const wrap = document.getElementById('profileDropdownWrap');
      if (wrap && !wrap.contains(e.target)) closeProfileDropdown();
    });

    function updateProfileDropdown() {
      const user = window._alphaUser;
      if (!user) return;
      // Header
      const nameEl = document.getElementById('pdUserName');
      const emailEl = document.getElementById('pdUserEmail');
      const planEl = document.getElementById('pdUserPlan');
      if (nameEl) nameEl.textContent = user.name || user.email;
      if (emailEl) emailEl.textContent = user.email;
      if (planEl) planEl.textContent = 'Plano ' + (user.plan === 'free' ? 'Free' : user.plan === 'pro' ? '⭐ Pro' : user.plan);

      // Deriv status
      const dot = document.getElementById('pdDerivDot');
      const derivIdEl = document.getElementById('pdDerivId');
      const derivType = document.getElementById('pdDerivType');
      const btnConnect = document.getElementById('pdDerivConnect');
      const btnDisc = document.getElementById('pdDerivDisconnect');
      const profileBtn = document.getElementById('profileBtn');

      if (derivAccount) {
        if (dot) { dot.classList.add('connected'); }
        if (derivIdEl) derivIdEl.textContent = derivAccount.loginid;
        if (derivType) derivType.textContent = derivAccount.isVirtual ? '📊 Conta Demo' : '💰 Conta Real';
        if (btnConnect) btnConnect.style.display = 'none';
        if (btnDisc) btnDisc.style.display = 'block';
        if (profileBtn) profileBtn.classList.add('deriv-connected');
        profileBtn.title = 'Deriv: ' + derivAccount.loginid;
      } else {
        if (dot) { dot.classList.remove('connected'); }
        if (derivIdEl) derivIdEl.textContent = 'Não conectada';
        if (derivType) derivType.textContent = '';
        if (btnConnect) btnConnect.style.display = 'block';
        if (btnDisc) btnDisc.style.display = 'none';
        if (profileBtn) profileBtn.classList.remove('deriv-connected');
        profileBtn.title = 'Conectar Deriv';
      }
    }

    function openDerivConnectModal() {
      closeProfileDropdown();
      loginWithDeriv();
    }
    function showDerivConnectModal() { document.getElementById('derivConnectModal').style.display = 'flex'; }
    function closeDerivConnectModal() { document.getElementById('derivConnectModal').style.display = 'none'; }

    function disconnectDeriv() {
      if (!confirm('Desconectar conta Deriv? O robô será parado.')) return;
      if (ws) disconnectDash();
      // Remover token salvo do sessionStorage
      if (window._alphaUser?.uid) _removeDrvConn(window._alphaUser.uid);
      derivAccount = null;
      updateProfileDropdown();
      closeProfileDropdown();
      log('🔌 Conta Deriv desconectada.', 'warning');
    }

    function switchAlphaTab(tab) {
      ['login', 'signup', 'admin'].forEach(t => {
        const panel = document.getElementById('panelAlpha' + t.charAt(0).toUpperCase() + t.slice(1))
          || document.getElementById('panelAdminLogin');
        const btn = document.getElementById('tabAlpha' + t.charAt(0).toUpperCase() + t.slice(1));
        if (t === 'admin') {
          const p = document.getElementById('panelAdminLogin');
          if (p) p.style.display = tab === t ? 'block' : 'none';
        } else {
          if (panel) panel.style.display = tab === t ? 'block' : 'none';
        }
        if (btn) btn.classList.toggle('active', tab === t);
      });
    }

    async function alphaLogin() {
      const email = document.getElementById('alphaLoginEmail')?.value.trim();
      const pass = document.getElementById('alphaLoginPass')?.value;
      const err = document.getElementById('alphaLoginErr');
      if (!email || !pass) { err.textContent = 'Preencha e-mail e senha.'; err.classList.add('err-visible'); return; }
      err.classList.remove('err-visible');

      // Wait for Supabase to initialize (max 3s)
      let attempts = 0;
      while (!window._sb && attempts < 30) {
        await new Promise(r => setTimeout(r, 100));
        attempts++;
      }
      if (!window._sb) {
        err.textContent = 'Erro de conexão. Recarregue a página e tente novamente.';
        err.classList.add('err-visible');
        return;
      }

      // Show loading
      const btn = document.querySelector('#panelAlphaLogin .btn-primary');
      if (btn) { btn.textContent = '⏳ Aguarde...'; btn.disabled = true; }

      // Clear any stale session (persistSession:false — no local session to sign out from)
      sessionStorage.removeItem('alpha_session');

      let loginResult;
      try {
        const _timeout = new Promise((_, reject) =>
          setTimeout(() => reject(new Error('Tempo esgotado — verifique sua conexão e tente novamente.')), 15000));
        loginResult = await Promise.race([
          window._sb.auth.signInWithPassword({ email, password: pass }),
          _timeout
        ]);
      } catch (e) {
        if (btn) { btn.textContent = '▶ ENTRAR'; btn.disabled = false; }
        err.textContent = e.message;
        err.classList.add('err-visible');
        return;
      }

      if (btn) { btn.textContent = '▶ ENTRAR'; btn.disabled = false; }

      const { data, error } = loginResult;
      if (error) {
        const msgs = {
          'Invalid login credentials': 'E-mail ou senha incorretos.',
          'Email not confirmed': '📧 Confirme seu e-mail antes de entrar. Verifique sua caixa de entrada.',
          'Too many requests': 'Muitas tentativas. Aguarde alguns minutos.',
          'User not found': 'E-mail não cadastrado. Use a aba CADASTRAR.',
        };
        err.textContent = msgs[error.message] || ('Erro: ' + error.message);
        err.classList.add('err-visible');
        return;
      }

      if (data?.user && data?.session) {
        // Save session for F5 persistence
        sessionStorage.setItem('alpha_session', JSON.stringify({
          access_token: data.session.access_token,
          refresh_token: data.session.refresh_token,
        }));
        // Navega imediatamente — onAuthStateChange completa o setup do perfil em paralelo
        showScreen('screenDashboard');
      }
    }

    async function alphaSignup() {
      const name = (document.getElementById('alphaSignupName')?.value || '').trim();
      const email = (document.getElementById('alphaSignupEmail')?.value || '').trim();
      const pass = document.getElementById('alphaSignupPass')?.value || '';
      const code = (document.getElementById('alphaSignupCode')?.value || '').trim().toUpperCase();
      const btn = document.querySelector('#panelAlphaSignup .btn-primary');
      const err = document.getElementById('alphaSignupErr');

      const showErr = msg => {
        err.style.color = 'var(--red)';
        err.textContent = msg;
        err.style.display = 'block';
        if (btn) { btn.textContent = '✅ CRIAR CONTA'; btn.disabled = false; }
      };

      if (!name) return showErr('Informe seu nome.');
      if (!email) return showErr('Informe o e-mail.');
      if (!pass || pass.length < 6) return showErr('Senha deve ter mínimo 6 caracteres.');
      if (!code) return showErr('Informe o código de acesso.');
      if (!window._sb) return showErr('Supabase não inicializado.');

      err.style.display = 'none';
      if (btn) { btn.textContent = 'Aguarde...'; btn.disabled = true; }

      try {
        // 1. Validate invite code
        const { data: codeData, error: codeErr } = await window._sb
          .from('invite_codes').select('id, used').eq('code', code).maybeSingle();
        if (codeErr) return showErr('Erro ao validar código: ' + codeErr.message);
        if (!codeData) return showErr('Código de acesso inválido.');
        if (codeData.used) return showErr('Este código já foi utilizado.');

        // 2. Create auth user
        const { data, error: signUpErr } = await window._sb.auth.signUp({ email, password: pass });
        if (signUpErr) {
          const msgs = { 'User already registered': 'E-mail já cadastrado. Faça login.' };
          return showErr(msgs[signUpErr.message] || signUpErr.message);
        }

        // 3. Insert profile + mark code as used
        if (data?.user) {
          await window._sb.from('profiles').upsert({
            id: data.user.id, name, email, plan: 'free', created_at: new Date().toISOString()
          });
          await window._sb.from('invite_codes').update({
            used: true, used_by: email, used_at: new Date().toISOString()
          }).eq('id', codeData.id);
        }

        if (btn) { btn.textContent = '✅ CRIAR CONTA'; btn.disabled = false; }
        err.style.color = 'var(--green)';
        err.textContent = '✅ Conta criada! Verifique seu e-mail para confirmar o cadastro.';
        err.style.display = 'block';
      } catch (e) {
        showErr('Erro inesperado: ' + e.message);
      }
    }

    async function alphaLogout() {
      stopPresence();
      stopPing();
      if (ws) disconnectDash();
      if (freqWs) { freqWs.onclose = null; freqWs.onerror = null; freqWs.onmessage = null; freqWs.close(); freqWs = null; }
      derivAccount = null; currentUser = null; selectedRobot = null;
      try { resetSessionState(); } catch (e) { }
      safeSet('digitStream', 'innerHTML', '');
      safeSet('logArea', 'innerHTML', '');
      if (window._sb) await window._sb.auth.signOut();
      sessionStorage.removeItem('alpha_session');
      window._alphaUser = null;
      closeProfileDropdown();
      document.getElementById('panelAlphaAuth').style.display = 'block';
      showScreen('screenLogin');
    }

    // ── PRESENCE ────────────────────────────────────────────────────────────────
    let _presenceInterval = null;

    async function updatePresence() {
      if (!window._sb || !window._alphaUser?.uid) return;
      const { error } = await window._sb.from('presence').upsert({
        user_id: window._alphaUser.uid,
        email: window._alphaUser.email,
        name: window._alphaUser.name,
        last_seen: new Date().toISOString()
      }, { onConflict: 'user_id' });
      if (error) console.warn('[Presence] upsert failed:', error.message);
    }

    function startPresence() {
      updatePresence();
      clearInterval(_presenceInterval);
      _presenceInterval = setInterval(updatePresence, 30000);
    }

    function stopPresence() {
      clearInterval(_presenceInterval);
      _presenceInterval = null;
      if (window._sb && window._alphaUser?.uid) {
        try { window._sb.from('presence').delete().eq('user_id', window._alphaUser.uid); } catch (e) { }
      }
    }

    async function loadOnlineUsers() {
      const list = document.getElementById('onlineUsersList');
      if (!list) return;
      if (!window._sb) {
        list.innerHTML = '<div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">Supabase não inicializado.</div>';
        return;
      }
      list.innerHTML = '<div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">⏳ Carregando...</div>';
      try {
        const cutoff = new Date(Date.now() - 3 * 60 * 1000).toISOString();
        const { data, error } = await window._sb
          .from('presence').select('*').gte('last_seen', cutoff).order('last_seen', { ascending: false });
        if (error) throw error;
        if (!data?.length) {
          list.innerHTML = '<div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">Nenhum usuário online no momento.</div>';
          return;
        }
        list.innerHTML = data.map(u => {
          const ago = Math.floor((Date.now() - new Date(u.last_seen).getTime()) / 1000);
          const agoTxt = ago < 60 ? ago + 's atrás' : Math.floor(ago / 60) + 'min atrás';
          return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);">
        <div>
          <div style="font-size:13px;font-weight:700;">🟢 ${u.name || '—'}</div>
          <div style="font-size:11px;color:var(--dim);">${u.email}</div>
        </div>
        <div style="font-size:11px;color:var(--dim);">${agoTxt}</div>
      </div>`;
        }).join('') +
          `<div style="font-size:11px;color:var(--green);text-align:right;padding-top:10px;font-weight:700;">${data.length} online agora</div>`;
      } catch (e) {
        list.innerHTML = `<div style="color:var(--red);font-size:12px;text-align:center;padding:20px;">Erro: ${e.message}</div>`;
      }
    }
    // ────────────────────────────────────────────────────────────────────────────

    // Called by Supabase onAuthStateChange when user logs in
    window._onAlphaLogin = function (user) {
      currentUser = { user: user.name, isAdmin: user.is_admin || false };
      const btnAdmin = document.getElementById('btnAdminNav');
      if (btnAdmin) btnAdmin.style.display = user.is_admin ? 'inline-block' : 'none';

      // Tentar restaurar conexão Deriv salva do sessionStorage
      if (!derivAccount && user.uid) {
        const conn = _loadDrvConn(user.uid);
        if (conn) {
          derivAccount = {
            loginid: conn.loginid,
            token: conn.token,
            appId: conn.appId || DERIV_APP_ID,
            accType: conn.accType,
            isVirtual: conn.isVirtual,
            currency: conn.currency
          };
          log('🔗 Deriv restaurada automaticamente: ' + conn.loginid, 'success');
        }
      }

      updateProfileDropdown();
      startPresence();

      // Só navega ao dashboard se estiver na tela de login (evita interromper outras abas no F5)
      const _activeScreen = document.querySelector('.screen.active');
      if (!_activeScreen || _activeScreen.id === 'screenLogin') {
        showScreen('screenDashboard');
      }

      // Auto-connect se Deriv restaurada
      if (derivAccount) {
        setTimeout(() => { if (!ws || ws.readyState > 1) connectDash(); }, 700);
      } else {
        // Inicia stream público de dígitos ao vivo (sem conta Deriv)
        const _mkt = document.getElementById('boletaMarket')?.value || 'R_100';
        setTimeout(() => { if (!ws || ws.readyState > 1) connectPublicStream(_mkt); }, 500);
      }
    };

    window._onAlphaLogout = function () {
      document.getElementById('panelAlphaAuth').style.display = 'block';
      showScreen('screenLogin');
    };

    // ════════════════════════════════════════
    // LEGACY — keep for admin tab
    // ════════════════════════════════════════
    function switchLoginTab(tab) {
      // Kept for compatibility — Alpha system uses switchAlphaTab()
    }

    // ════════════════════════════════════════
    // DERIV OAUTH
    // ════════════════════════════════════════
    // How it works:
    // 1. Open Deriv OAuth URL in popup window
    // 2. Deriv redirects back to this page with ?token1=...&acct1=...
    // 3. We detect the redirect via popup URL polling OR via URL params on load
    // 4. Extract tokens and auto-login

    const DERIV_APP_ID = '127769'; // Replace with your registered App ID for production
    const DERIV_OAUTH_URL = `https://oauth.deriv.com/oauth2/authorize?app_id=${DERIV_APP_ID}&l=pt&brand=deriv`;

    let oauthPopup = null;   // kept for compatibility
    let oauthPollTimer = null; // kept for compatibility

    function loginWithDeriv() {
      // Save current Alpha session before redirect
      if (window._alphaUser) {
        sessionStorage.setItem('_preOAuthUser', JSON.stringify(window._alphaUser));
      }

      // Build redirect URL — Deriv sends tokens back as query params to this page
      const redirectUri = window.location.origin + window.location.pathname;
      const oauthUrl = 'https://oauth.deriv.com/oauth2/authorize'
        + '?app_id=' + DERIV_APP_ID
        + '&l=pt&brand=deriv'
        + '&redirect_uri=' + encodeURIComponent(redirectUri);

      // Show brief loading state then redirect
      const statusEl = document.getElementById('oauthStatus');
      const statusMsg = document.getElementById('oauthStatusMsg');
      if (statusEl) statusEl.style.display = 'block';
      if (statusMsg) statusMsg.textContent = 'Redirecionando para a Deriv...';

      setTimeout(() => { window.location.href = oauthUrl; }, 400);
    }

    function handleOAuthCallback(params) {
      document.getElementById('oauthOverlay').classList.remove('show');
      clearInterval(oauthPollTimer);

      // Deriv returns: acct1=VRTC..., token1=..., cur1=USD, acct2=CR..., token2=..., cur2=USD
      const accounts = [];
      let i = 1;
      while (params.get('acct' + i)) {
        accounts.push({
          loginid: params.get('acct' + i),
          token: params.get('token' + i),
          currency: params.get('cur' + i) || 'USD',
          isVirtual: params.get('acct' + i).startsWith('VR') || params.get('acct' + i).startsWith('VRTC')
        });
        i++;
      }

      if (!accounts.length) {
        showOAuthError('Nenhuma conta encontrada na resposta da Deriv.');
        return;
      }

      // Clean URL (remove tokens from address bar)
      window.history.replaceState({}, document.title, window.location.pathname);

      // If multiple accounts — let user pick
      if (accounts.length > 1) {
        showAccountPicker(accounts);
      } else {
        finishOAuthLogin(accounts[0]);
      }
    }

    function showAccountPicker(accounts) {
      const overlay = document.getElementById('oauthOverlay');
      overlay.classList.add('show');
      document.getElementById('oauthModalTitle').textContent = 'SELECIONE A CONTA';
      document.getElementById('oauthModalMsg').textContent = '';
      document.querySelector('.oauth-spinner').style.display = 'none';

      const modal = document.querySelector('.oauth-modal');
      // Remove existing picker if any
      const old = modal.querySelector('.account-picker');
      if (old) old.remove();

      const picker = document.createElement('div');
      picker.className = 'account-picker';
      picker.style.cssText = 'display:flex;flex-direction:column;gap:8px;margin-top:12px;';
      accounts.forEach(acc => {
        const badge = acc.isVirtual ? '📊 DEMO' : '💰 REAL';
        const color = acc.isVirtual ? 'var(--accent)' : 'var(--gold)';
        const btn = document.createElement('button');
        btn.style.cssText = `background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;color:var(--text);font-family:'Share Tech Mono',monospace;`;
        btn.innerHTML = `<span style="font-weight:700;">${acc.loginid}</span><span style="color:${color};font-size:11px;">${badge} · ${acc.currency}</span>`;
        btn.onmouseover = () => btn.style.borderColor = 'var(--accent)';
        btn.onmouseout = () => btn.style.borderColor = 'var(--border)';
        btn.onclick = () => { overlay.classList.remove('show'); document.querySelector('.oauth-spinner').style.display = 'block'; finishOAuthLogin(acc); };
        picker.appendChild(btn);
      });

      modal.appendChild(picker);
    }

    async function finishOAuthLogin(acc) {
      document.getElementById('oauthOverlay').classList.remove('show');

      const appId = DERIV_APP_ID;
      const alphaUser = window._alphaUser;

      currentUser = { user: alphaUser?.name || acc.loginid, isAdmin: false };
      derivAccount = {
        loginid: acc.loginid,
        token: acc.token,
        appId: appId,
        accType: acc.isVirtual ? 'demo' : 'real',
        isVirtual: acc.isVirtual,
        currency: acc.currency
      };

      // Persistir conexão Deriv no sessionStorage (por uid) para auto-reconexão na sessão
      if (alphaUser?.uid) {
        _saveDrvConn(alphaUser.uid, {
          loginid: acc.loginid,
          token: acc.token,
          appId: DERIV_APP_ID,
          accType: acc.isVirtual ? 'demo' : 'real',
          isVirtual: acc.isVirtual,
          currency: acc.currency,
          savedAt: Date.now()
        });
      }
      // Salvar metadados no Supabase (sem o token)
      if (window._sb && alphaUser?.uid) {
        try {
          await window._sb.from('profiles').update({
            deriv_login_id: acc.loginid,
            deriv_acc_type: acc.isVirtual ? 'demo' : 'real',
            deriv_currency: acc.currency,
            deriv_connected_at: new Date().toISOString()
          }).eq('id', alphaUser.uid);
        } catch (e) { console.warn('Supabase update failed', e); }
      }

      const displayName = alphaUser?.name || acc.loginid;
      closeDerivConnectModal();
      closeProfileDropdown();
      updateProfileDropdown();
      renderRobotSelectorList();
      showScreen('screenDashboard');
      log('✅ Deriv conectada: ' + acc.loginid + ' (' + (acc.isVirtual ? 'DEMO' : 'REAL') + ') | ' + acc.currency, 'success');
      // Auto-connect ao sistema sem precisar clicar em CONECTAR
      setTimeout(() => { if (!ws || ws.readyState > 1) connectDash(); }, 600);
    }

    function cancelOAuth() {
      clearInterval(oauthPollTimer);
      if (oauthPopup && !oauthPopup.closed) oauthPopup.close();
      oauthPopup = null;
      document.getElementById('oauthOverlay').classList.remove('show');
    }

    function showOAuthStatus(msg) {
      const el = document.getElementById('oauthStatus');
      const msgEl = document.getElementById('oauthStatusMsg');
      if (el) el.style.display = 'block';
      if (msgEl) msgEl.textContent = msg;
    }

    function showOAuthError(msg) {
      const overlay = document.getElementById('oauthOverlay');
      const title = document.getElementById('oauthModalTitle');
      const msgEl = document.getElementById('oauthModalMsg');
      const spinner = overlay?.querySelector('.oauth-spinner');
      if (spinner) spinner.style.display = 'none';
      if (title) title.textContent = 'ERRO';
      if (msgEl) { msgEl.textContent = msg; msgEl.style.color = 'var(--red)'; }
      if (overlay) overlay.classList.add('show');
    }

    // On page load — check if this is an OAuth redirect
    (function checkOAuthOnLoad() {
      const params = new URLSearchParams(window.location.search);
      if (!params.get('token1') || !params.get('acct1')) return;

      // Tokens arrived via redirect — restore Alpha session if saved
      const saved = sessionStorage.getItem('_preOAuthUser');
      if (saved) {
        try { window._alphaUser = JSON.parse(saved); } catch (e) { }
        sessionStorage.removeItem('_preOAuthUser');
      }

      // Clean URL immediately so tokens don't appear in address bar
      window.history.replaceState({}, document.title, window.location.pathname);

      // Wait for JS to initialize then process
      setTimeout(() => { handleOAuthCallback(params); }, 500);
    })();

    async function loginAdmin() {
      const uEl = document.getElementById('adminUser');
      const pEl = document.getElementById('adminPass');
      const err = document.getElementById('adminLoginErr');
      if (!uEl || !pEl || !err) return; // elementos não presentes na tela atual
      const u = uEl.value.trim();
      const p = pEl.value;
      const hash = await hashPass(p);
      let found = admins.find(a => a.user === u && a.pass === hash);
      // Migração automática: senhas antigas em btoa → SHA-256
      if (!found) {
        const legacy = admins.find(a => a.user === u && a.pass === btoa(p));
        if (legacy) { legacy.pass = hash; store('drv_admins', admins); found = legacy; }
      }
      if (!found) { err.textContent = 'Usuário ou senha incorretos.'; err.style.display = 'block'; return; }
      err.style.display = 'none';
      currentUser = { user: u, isAdmin: true };
      window._alphaUser = { uid: null, email: u, name: u, plan: 'admin' };
      safeSet('adminNavUser', 'textContent', '👤 ' + u);
      safeSet('btnAdminNav', 'style.display', 'inline-block');
      const btnAdmin = document.getElementById('btnAdminNav');
      if (btnAdmin) btnAdmin.style.display = 'inline-block';
      updateProfileDropdown();
      renderRobotList();
      renderAdminList();
      showScreen('screenAdmin');
    }

    function safeEl(id) { return $el(id); }
    function safeSet(id, prop, val) { const el = safeEl(id); if (el) el[prop] = val; }
    function safeCss(id, css) { const el = safeEl(id); if (el) el.style.cssText = css; }

    // ════════════════════════════════════════
    // CHART (TradingView Lightweight Charts)
    // ════════════════════════════════════════
    let _chart = null, _lineSeries = null, _candleSeries = null;
    let _chartType = 'line', _chartTf = 30, _currentCandle = null, _chartReady = false;

    function toggleChartPanel() {
      const panel = document.getElementById('chartPanel');
      const btn = document.getElementById('btnChartNav');
      if (!panel) return;
      const visible = panel.style.display !== 'none';
      panel.style.display = visible ? 'none' : 'block';
      btn?.classList.toggle('active', !visible);
      if (!visible) {
        setTimeout(() => {
          initChart();
          if (_chart) _chart.applyOptions({ width: document.getElementById('chartContainer').clientWidth });
          if (window._chartPendingHistory) {
            feedChartHistory(window._chartPendingHistory.prices, window._chartPendingHistory.times);
            window._chartPendingHistory = null;
          }
        }, 50);
      }
    }

    function initChart() {
      if (_chart) return;
      const container = document.getElementById('chartContainer');
      if (!container || typeof LightweightCharts === 'undefined') return;
      _chart = LightweightCharts.createChart(container, {
        width: container.clientWidth, height: 300,
        layout: { background: { color: '#12131b' }, textColor: '#dde2f0' },
        grid: { vertLines: { color: '#32364a' }, horzLines: { color: '#32364a' } },
        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        rightPriceScale: { borderColor: '#32364a' },
        timeScale: { borderColor: '#32364a', timeVisible: true, secondsVisible: true },
      });
      _lineSeries = _chart.addLineSeries({ color: '#60a5fa', lineWidth: 2 });
      _candleSeries = _chart.addCandlestickSeries({
        upColor: '#4ade80', downColor: '#f87171',
        borderUpColor: '#4ade80', borderDownColor: '#f87171',
        wickUpColor: '#4ade80', wickDownColor: '#f87171',
      });
      setChartType('line');
      window.addEventListener('resize', () => {
        if (_chart) _chart.applyOptions({ width: document.getElementById('chartContainer').clientWidth });
      });
    }

    function setChartType(type) {
      _chartType = type;
      _lineSeries?.applyOptions({ visible: type === 'line' });
      _candleSeries?.applyOptions({ visible: type === 'candle' });
      document.getElementById('chartBtnLine')?.classList.toggle('active', type === 'line');
      document.getElementById('chartBtnCandle')?.classList.toggle('active', type === 'candle');
      const tfBar = document.getElementById('chartTimeframes');
      if (tfBar) tfBar.style.display = type === 'candle' ? 'flex' : 'none';
    }

    function setChartTf(seconds) {
      _chartTf = seconds;
      _currentCandle = null;
      document.querySelectorAll('.chart-tf-btn').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.tf) === seconds);
      });
    }

    function feedChartHistory(prices, times) {
      if (!_chart) initChart();
      if (!_chart) return;
      const lineData = [], candleMap = {};
      for (let i = 0; i < prices.length; i++) {
        const t = times[i], v = parseFloat(prices[i]);
        lineData.push({ time: t, value: v });
        const bucket = Math.floor(t / _chartTf) * _chartTf;
        if (!candleMap[bucket]) candleMap[bucket] = { time: bucket, open: v, high: v, low: v, close: v };
        else {
          if (v > candleMap[bucket].high) candleMap[bucket].high = v;
          if (v < candleMap[bucket].low) candleMap[bucket].low = v;
          candleMap[bucket].close = v;
        }
      }
      const candleData = Object.values(candleMap).sort((a, b) => a.time - b.time);
      _lineSeries?.setData(lineData);
      _candleSeries?.setData(candleData);
      if (candleData.length) _currentCandle = { ...candleData[candleData.length - 1] };
      _chartReady = true;
    }

    function updateChart(price, time) {
      if (!_chart || !_chartReady) return;
      const v = parseFloat(price);
      const t = time || Math.floor(Date.now() / 1000);
      _lineSeries?.update({ time: t, value: v });
      const bucket = Math.floor(t / _chartTf) * _chartTf;
      if (!_currentCandle || _currentCandle.time !== bucket) {
        _currentCandle = { time: bucket, open: v, high: v, low: v, close: v };
      } else {
        if (v > _currentCandle.high) _currentCandle.high = v;
        if (v < _currentCandle.low) _currentCandle.low = v;
        _currentCandle.close = v;
      }
      _candleSeries?.update({ ..._currentCandle });
      const el = document.getElementById('chartLastPrice');
      if (el) el.textContent = price;
    }

    // ════════════════════════════════════════
    // BOLETA LOCK / UNLOCK
    // ════════════════════════════════════════
    const _BOLETA_INPUTS = [
      'robotDropdownBtn', 'manualStrategy', 'manualVirtual',
      'manualFactor', 'manualLevels', 'boletaMarket',
      'boletaEntry', 'boletaSG', 'boletaSL'
    ];
    function lockBoleta() {
      _BOLETA_INPUTS.forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = true; el.style.opacity = '0.4'; el.style.cursor = 'not-allowed'; }
      });
      // Bloquear o toggle AUTO/MANUAL
      const tog = document.getElementById('modeToggle');
      if (tog) { tog.style.pointerEvents = 'none'; tog.style.opacity = '0.4'; }
      // Impedir abertura do dropdown de robôs
      const menu = document.getElementById('robotDropdownMenu');
      if (menu) { menu.style.pointerEvents = 'none'; }
    }
    function unlockBoleta() {
      _BOLETA_INPUTS.forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = false; el.style.opacity = ''; el.style.cursor = ''; }
      });
      const tog = document.getElementById('modeToggle');
      if (tog) { tog.style.pointerEvents = ''; tog.style.opacity = ''; }
      const menu = document.getElementById('robotDropdownMenu');
      if (menu) { menu.style.pointerEvents = ''; }
    }

    // ════════════════════════════════════════
    // TOGGLE AUTO / MANUAL
    // ════════════════════════════════════════
    let _modeManual = false;
    function toggleOperationMode() {
      _modeManual = !_modeManual;
      document.getElementById('modeToggle')?.classList.toggle('manual', _modeManual);
      document.getElementById('modeLabelAuto').style.color = _modeManual ? 'var(--dim)' : 'var(--accent)';
      document.getElementById('modeLabelManual').style.color = _modeManual ? 'var(--green)' : 'var(--dim)';
      const manualFields = document.getElementById('manualFields');
      if (manualFields) manualFields.style.display = _modeManual ? 'block' : 'none';
      const robotDrop = document.getElementById('robotDropdown');
      if (robotDrop) robotDrop.closest?.('.field')?.style && (robotDrop.closest('.field').style.display = _modeManual ? 'none' : 'block');
      // Re-renderiza dropdown para mostrar/esconder item Manual
      renderRobotSelectorList();
      window._modeManual = _modeManual; // expor globalmente
      log(_modeManual ? '🖐 Modo MANUAL ativado' : '🤖 Modo AUTOMÁTICO ativado', 'warning');
    }

    // ════════════════════════════════════════
    // LIVE OPS
    // ════════════════════════════════════════
    let _liveWins = 0, _liveLosses = 0;
    function addLiveOp(strategy, entry, result, pnl, entryPrice, exitPrice, accType) {
      _liveWins += result === 'WIN' ? 1 : 0;
      _liveLosses += result === 'LOSS' ? 1 : 0;
      const total = _liveWins + _liveLosses;
      const rate = total > 0 ? Math.round(_liveWins / total * 100) : 0;
      const wEl = document.getElementById('liveWins');
      const lEl = document.getElementById('liveLosses');
      const rEl = document.getElementById('liveRate');
      if (wEl) wEl.textContent = _liveWins;
      if (lEl) lEl.textContent = _liveLosses;
      if (rEl) rEl.textContent = rate + '%';
      const list = document.getElementById('liveOpsList');
      if (!list) return;
      if (list.querySelector('div[style*="Aguardando"]')) list.innerHTML = '';
      const now = new Date();
      const hh = now.getHours().toString().padStart(2, '0');
      const mm = now.getMinutes().toString().padStart(2, '0');
      const ss = now.getSeconds().toString().padStart(2, '0');
      const color = result === 'WIN' ? 'var(--green)' : 'var(--red)';
      const sign = pnl >= 0 ? '+' : '';
      const isReal = accType === 'real';
      const accBadge = isReal
        ? `<span style="font-size:8px;background:rgba(255,184,0,.2);color:var(--gold);border-radius:3px;padding:1px 4px;">REAL</span>`
        : `<span style="font-size:8px;background:rgba(0,212,255,.15);color:var(--accent);border-radius:3px;padding:1px 4px;">DEMO</span>`;
      const priceIn = entryPrice ? parseFloat(entryPrice).toFixed(2) : '—';
      const priceOut = exitPrice ? parseFloat(exitPrice).toFixed(2) : '—';
      const row = document.createElement('div');
      row.className = 'live-ops-row';
      row.innerHTML = `
    <span class="mono" style="color:var(--dim);font-size:9px;">${hh}:${mm}:${ss}</span>
    <span style="font-size:9px;">${strategy || '—'} ${accBadge}</span>
    <span class="mono" style="font-size:9px;">$${parseFloat(entry).toFixed(2)}</span>
    <span class="mono" style="font-size:9px;color:var(--dim);">${priceIn}→${priceOut}</span>
    <span style="color:${color};font-weight:700;font-size:9px;">${result === 'WIN' ? 'WIN' : 'LOSS'}</span>
    <span class="mono" style="color:${color};font-size:9px;">${sign}$${Math.abs(pnl).toFixed(2)}</span>`;
      list.insertBefore(row, list.firstChild);
      while (list.children.length > 50) list.removeChild(list.lastChild);
    }

    // ════════════════════════════════════════
    // INVITE CODES (admin panel)
    // ════════════════════════════════════════
    function _genCodeStr() {
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
      let s = 'ALPHA-';
      for (let i = 0; i < 5; i++) s += chars[Math.floor(Math.random() * chars.length)];
      return s;
    }

    async function generateInviteCode() {
      if (!window._sb) return;
      const code = _genCodeStr();
      const { error } = await window._sb.from('invite_codes').insert({ code });
      if (error) { alert('Erro ao gerar código: ' + error.message); return; }
      renderCodeList();
    }

    async function renderCodeList() {
      const list = document.getElementById('codeList');
      if (!list || !window._sb) return;
      list.innerHTML = '<div style="color:var(--dim);font-size:12px;text-align:center;padding:20px;">Carregando...</div>';
      const { data, error } = await window._sb
        .from('invite_codes').select('*').order('created_at', { ascending: false });
      if (error || !data?.length) {
        list.innerHTML = '<div style="color:var(--dim);font-size:13px;text-align:center;padding:40px;">Nenhum código gerado ainda.</div>';
        return;
      }
      list.innerHTML = data.map(c => `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;">
      <div style="display:flex;align-items:center;gap:12px;">
        <span class="mono" style="font-size:15px;letter-spacing:2px;color:${c.used ? 'var(--dim)' : 'var(--accent)'};">${c.code}</span>
        <span style="font-size:11px;padding:2px 8px;border-radius:4px;font-weight:700;background:${c.used ? 'rgba(255,59,107,.15)' : 'rgba(0,255,159,.15)'};color:${c.used ? 'var(--red)' : 'var(--green)'};">
          ${c.used ? 'USADO' : 'DISPONÍVEL'}
        </span>
        ${c.used ? `<span style="font-size:11px;color:var(--dim);">${c.used_by || ''}</span>` : ''}
      </div>
      <div style="display:flex;gap:8px;">
        ${!c.used ? `<button class="btn btn-sm btn-success" onclick="copyCode('${c.code}')">📋 Copiar</button>` : ''}
        <button class="btn btn-sm btn-danger" onclick="deleteCode('${c.id}')">🗑️</button>
      </div>
    </div>`).join('');
    }

    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => { alert('Código copiado: ' + code); });
    }

    async function deleteCode(id) {
      if (!confirm('Deletar este código?')) return;
      await window._sb.from('invite_codes').delete().eq('id', id);
      renderCodeList();
    }

    async function logoutAll() {
      // Hard close WebSockets
      stopPing();
      if (ws) {
        ws.onclose = null; ws.onerror = null; ws.onmessage = null; ws.onopen = null;
        ws.close(); ws = null;
      }
      if (freqWs) { freqWs.onclose = null; freqWs.onerror = null; freqWs.onmessage = null; freqWs.close(); freqWs = null; }
      disconnectPublicStream();
      // Supabase signOut
      if (window._sb) try { await window._sb.auth.signOut(); } catch (e) { }
      sessionStorage.removeItem('alpha_session');
      window._alphaUser = null;
      currentUser = null; derivAccount = null; selectedRobot = null;
      digits = []; freqMap = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
      try { resetSessionState(); } catch (e) { }
      // Reset dashboard UI safely (may not exist if coming from admin screen)
      safeSet('accBar', 'style', 'display:none');
      safeSet('freqAccBar', 'style', 'display:none');
      safeSet('digitStream', 'innerHTML', '');
      safeSet('logArea', 'innerHTML', '');
      safeSet('robotDropdownLabel', 'textContent', '⚡ Selecione um robô...');
      const lblEl = safeEl('robotDropdownLabel'); if (lblEl) lblEl.style.color = '';
      try { setSignal('aguardando', 'AGUARDANDO CONEXÃO', 'Conecte para iniciar'); } catch (e) { }
      try { resetConnectBtn(); } catch (e) { }
      safeSet('tradeToggleBtn', 'textContent', '🤖 INICIAR ROBÔ');
      safeCss('tradeToggleBtn', 'background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;');
      safeCss('autoTradeIndicator', 'width:10px;height:10px;border-radius:50%;background:var(--dim);');
      safeSet('autoTradeLabel', 'textContent', 'ROBÔ PARADO');
      safeCss('autoTradeLabel', 'color:var(--dim)');
      safeSet('adminNavUser', 'textContent', '');
      safeCss('btnAdminNav', 'display:none');
      // Clear login inputs
      safeSet('adminUser', 'value', ''); safeSet('adminPass', 'value', '');
      safeSet('adminLoginErr', 'style', 'display:none');
      showScreen('screenLogin');
    }

    // ════════════════════════════════════════
    // ADMIN — ROBOTS CRUD
    // ════════════════════════════════════════
    function goToDashboard() {
      // Go to dashboard screen keeping the admin session active
      renderRobotSelectorList();
      showScreen('screenDashboard');
      document.getElementById('btnAdminNav').style.display = 'inline-block';
      log('🔄 Trocado para tela de operação.', 'info');
    }

    // ════════════════════════════════════════
    // BRAND SYSTEM
    // ════════════════════════════════════════
    const BRAND_DEFAULTS = {
      name: 'ALPHA SYSTEM',
      slogan: 'PAINEL DE OPERAÇÕES AUTOMATIZADAS',
      icon: '⚡',
      logoUrl: '',
      accent: '#00d4ff',
      gold: '#ffb800',
      whatsapp: '',
      telegram: '',
      website: '',
      welcome: ''
    };

    let brandConfig = Object.assign({}, BRAND_DEFAULTS, load('drv_brand', {}));

    function applyBrand() {
      const b = brandConfig;
      // CSS variables
      document.documentElement.style.setProperty('--accent', b.accent);
      document.documentElement.style.setProperty('--gold', b.gold);
      // Login screen
      const nameEl = document.getElementById('loginBrandName');
      const sloganEl = document.getElementById('loginBrandSlogan');
      const emojiEl = document.getElementById('loginLogoEmoji');
      const imgEl = document.getElementById('loginLogoImg');
      if (nameEl) nameEl.textContent = b.name;
      if (sloganEl) sloganEl.textContent = b.slogan;
      if (emojiEl) { emojiEl.textContent = b.icon; emojiEl.style.display = b.logoUrl ? 'none' : 'block'; }
      if (imgEl) { imgEl.src = b.logoUrl || ''; imgEl.style.display = b.logoUrl ? 'block' : 'none'; }
      // Topnav
      const adminBrand = document.getElementById('adminTopnavBrand');
      const dashBrand = document.getElementById('dashTopnavBrand');
      if (adminBrand) adminBrand.textContent = b.icon + ' ' + b.name + ' · ADMIN';
      if (dashBrand) dashBrand.textContent = b.icon + ' ' + b.name;
      // Page title
      document.title = b.name;
    }

    function loadBrandForm() {
      const b = brandConfig;
      const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
      set('brandName', b.name);
      set('brandSlogan', b.slogan);
      set('brandIcon', b.icon);
      set('brandLogoUrl', b.logoUrl);
      set('brandAccent', b.accent);
      set('brandAccentHex', b.accent);
      set('brandGold', b.gold);
      set('brandGoldHex', b.gold);
      set('brandWhatsapp', b.whatsapp);
      set('brandTelegram', b.telegram);
      set('brandWebsite', b.website);
      set('brandWelcome', b.welcome);
      // Previews
      const ap = document.getElementById('brandAccentPreview');
      const gp = document.getElementById('brandGoldPreview');
      if (ap) ap.style.background = b.accent;
      if (gp) gp.style.background = b.gold;
      const emojiEl = document.getElementById('brandLogoEmoji');
      if (emojiEl) emojiEl.textContent = b.icon || '⚡';
      previewLogo();
    }

    function saveBrand() {
      brandConfig = {
        name: (document.getElementById('brandName')?.value.trim() || BRAND_DEFAULTS.name).toUpperCase(),
        slogan: (document.getElementById('brandSlogan')?.value.trim() || BRAND_DEFAULTS.slogan).toUpperCase(),
        icon: document.getElementById('brandIcon')?.value.trim() || BRAND_DEFAULTS.icon,
        logoUrl: document.getElementById('brandLogoUrl')?.value.trim() || '',
        accent: document.getElementById('brandAccentHex')?.value.trim() || BRAND_DEFAULTS.accent,
        gold: document.getElementById('brandGoldHex')?.value.trim() || BRAND_DEFAULTS.gold,
        whatsapp: document.getElementById('brandWhatsapp')?.value.trim() || '',
        telegram: document.getElementById('brandTelegram')?.value.trim() || '',
        website: document.getElementById('brandWebsite')?.value.trim() || '',
        welcome: document.getElementById('brandWelcome')?.value.trim() || '',
      };
      store('drv_brand', brandConfig);
      applyBrand();
      const msg = document.getElementById('brandSaveMsg');
      if (msg) { msg.textContent = '✅ Marca aplicada com sucesso!'; msg.style.display = 'block'; setTimeout(() => msg.style.display = 'none', 3000); }
    }

    function resetBrand() {
      if (!confirm('Restaurar configurações padrão da marca?')) return;
      brandConfig = Object.assign({}, BRAND_DEFAULTS);
      store('drv_brand', brandConfig);
      loadBrandForm();
      applyBrand();
    }

    function previewLogo() {
      const url = document.getElementById('brandLogoUrl')?.value.trim();
      const imgEl = document.getElementById('brandLogoImg');
      const emojiEl = document.getElementById('brandLogoEmoji');
      if (!imgEl || !emojiEl) return;
      if (url) { imgEl.src = url; imgEl.style.display = 'block'; emojiEl.style.display = 'none'; }
      else { imgEl.style.display = 'none'; emojiEl.style.display = 'block'; }
    }

    function syncColor(pickerIdOrHex, hexId) {
      // called from hex input
      const hex = document.getElementById(hexId)?.value;
      if (!hex || hex.length < 4) return;
      const picker = document.getElementById(pickerIdOrHex);
      if (picker && /^#[0-9a-fA-F]{6}$/.test(hex)) picker.value = hex;
      // update preview
      const previewId = pickerIdOrHex + 'Preview';
      const preview = document.getElementById(previewId);
      if (preview) preview.style.background = hex;
      // live CSS update
      if (pickerIdOrHex === 'brandAccent') document.documentElement.style.setProperty('--accent', hex);
      if (pickerIdOrHex === 'brandGold') document.documentElement.style.setProperty('--gold', hex);
    }

    function applyPreset(accent, gold) {
      const aEl = document.getElementById('brandAccent');
      const aHex = document.getElementById('brandAccentHex');
      const gEl = document.getElementById('brandGold');
      const gHex = document.getElementById('brandGoldHex');
      if (aEl) aEl.value = accent;
      if (aHex) aHex.value = accent;
      if (gEl) gEl.value = gold;
      if (gHex) gHex.value = gold;
      const ap = document.getElementById('brandAccentPreview');
      const gp = document.getElementById('brandGoldPreview');
      if (ap) ap.style.background = accent;
      if (gp) gp.style.background = gold;
      document.documentElement.style.setProperty('--accent', accent);
      document.documentElement.style.setProperty('--gold', gold);
    }

    // Sync color picker → hex input
    document.addEventListener('input', function (e) {
      if (e.target.id === 'brandAccent') {
        const hex = e.target.value;
        const hEl = document.getElementById('brandAccentHex');
        if (hEl) hEl.value = hex;
        const p = document.getElementById('brandAccentPreview');
        if (p) p.style.background = hex;
        document.documentElement.style.setProperty('--accent', hex);
      }
      if (e.target.id === 'brandGold') {
        const hex = e.target.value;
        const hEl = document.getElementById('brandGoldHex');
        if (hEl) hEl.value = hex;
        const p = document.getElementById('brandGoldPreview');
        if (p) p.style.background = hex;
        document.documentElement.style.setProperty('--gold', hex);
      }
      if (e.target.id === 'brandIcon') {
        const emojiEl = document.getElementById('brandLogoEmoji');
        if (emojiEl) emojiEl.textContent = e.target.value || '⚡';
      }
    });

    function showAdminTab(tab) {
      ['robots', 'admins', 'codes', 'brand', 'online'].forEach(t => {
        const panel = document.getElementById('adminTab' + t.charAt(0).toUpperCase() + t.slice(1));
        const btn = document.getElementById('adminTabBtn' + t.charAt(0).toUpperCase() + t.slice(1));
        if (panel) panel.style.display = tab === t ? 'block' : 'none';
        if (btn) btn.classList.toggle('active', tab === t);
      });
      if (tab === 'codes') renderCodeList();
      if (tab === 'online') { loadOnlineUsers(); startOnlineRefresh(); }
      else stopOnlineRefresh();
    }

    let _onlineRefreshInterval = null;
    function startOnlineRefresh() {
      clearInterval(_onlineRefreshInterval);
      _onlineRefreshInterval = setInterval(loadOnlineUsers, 30000);
    }
    function stopOnlineRefresh() {
      clearInterval(_onlineRefreshInterval);
      _onlineRefreshInterval = null;
    }

    ['rfEntry', 'rfFactor', 'rfLevels'].forEach(id => {
      // will attach after DOM ready
    });

    function updateMartPreview() {
      const entry = parseFloat(document.getElementById('rfEntry').value) || 0.35;
      const factor = parseFloat(document.getElementById('rfFactor').value) || 2.8;
      const levels = parseInt(document.getElementById('rfLevels').value) || 5;
      let e = entry, acc = 0, html = '<div style="font-size:10px;letter-spacing:1px;color:var(--dim);font-family:Share Tech Mono,monospace;margin-bottom:6px;">TABELA MARTINGALE</div><div style="display:flex;gap:6px;flex-wrap:wrap;">';
      for (let i = 1; i <= levels; i++) {
        acc += e;
        html += `<div style="background:var(--bg);border-radius:6px;padding:5px 8px;text-align:center;">
      <div style="font-size:9px;color:var(--dim);">N${i}</div>
      <div style="font-size:12px;font-weight:700;color:var(--gold);font-family:Share Tech Mono,monospace;">$${e.toFixed(2)}</div>
    </div>`;
        e = e * factor;
      }
      html += `</div><div style="font-size:11px;color:var(--red);font-family:Share Tech Mono,monospace;margin-top:8px;">Exposição máxima: $${acc.toFixed(2)}</div>`;
      document.getElementById('martPreview').innerHTML = html;
    }

    function openRobotForm(id = null) {
      editingRobotId = id;
      const title = document.getElementById('robotFormTitle');
      if (id) {
        const r = robots.find(x => x.id === id);
        if (!r) return;
        title.textContent = '✏️ EDITAR ROBÔ';
        document.getElementById('rfName').value = r.name;
        document.getElementById('rfDesc').value = r.desc || '';
        document.getElementById('rfStrategy').value = r.strategy;
        document.getElementById('rfVirtual').value = r.virtualLosses;
        document.getElementById('rfEntry').value = r.entry;
        document.getElementById('rfFactor').value = r.factor;
        document.getElementById('rfLevels').value = r.levels;
      } else {
        title.textContent = '➕ NOVO ROBÔ';
        ['rfName', 'rfDesc'].forEach(i => document.getElementById(i).value = '');
        document.getElementById('rfStrategy').value = 'over3';
      }
      updateMartPreview();
      document.getElementById('robotFormErr').style.display = 'none';
    }

    function cancelRobotForm() { editingRobotId = null; openRobotForm(); }

    function saveRobot() {
      const err = document.getElementById('robotFormErr');
      const name = document.getElementById('rfName').value.trim();

      if (!name) { err.textContent = 'Nome é obrigatório.'; err.style.display = 'block'; return; }

      const robot = {
        id: editingRobotId || ('r_' + Date.now()),
        name,
        desc: document.getElementById('rfDesc').value.trim(),
        strategy: document.getElementById('rfStrategy').value,
        virtualLosses: parseInt(document.getElementById('rfVirtual').value),
        entry: parseFloat(document.getElementById('rfEntry').value),
        factor: parseFloat(document.getElementById('rfFactor').value),
        levels: parseInt(document.getElementById('rfLevels').value),
        running: false,
        createdAt: editingRobotId ? (robots.find(r => r.id === editingRobotId)?.createdAt || Date.now()) : Date.now()
      };

      if (editingRobotId) {
        robots = robots.map(r => r.id === editingRobotId ? robot : r);
      } else {
        robots.push(robot);
      }
      store('drv_robots', robots);
      err.style.display = 'none';
      editingRobotId = null;
      renderRobotList();
      openRobotForm(); // reset form
    }

    function deleteRobot(id) {
      if (!confirm('Deletar este robô?')) return;
      robots = robots.filter(r => r.id !== id);
      store('drv_robots', robots);
      renderRobotList();
    }

    function toggleRobotRunning(id) {
      robots = robots.map(r => r.id === id ? { ...r, running: !r.running } : r);
      store('drv_robots', robots);
      renderRobotList();
    }

    function renderRobotList() {
      const list = document.getElementById('robotList');
      if (!robots.length) { list.innerHTML = '<div style="color:var(--dim);font-size:13px;text-align:center;padding:40px;">Nenhum robô criado ainda.</div>'; return; }
      list.innerHTML = robots.map(r => {
        const stratLabel = r.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2');
        const accBadge = r.accType === 'demo' ? '<span class="badge badge-gold">DEMO</span>' : '<span class="badge badge-red">REAL</span>';
        return `<div class="robot-card-item ${r.running ? 'running' : ''}">
      <div class="robot-status-dot ${r.running ? 'running' : ''}"></div>
      <div style="flex:1;min-width:150px;">
        <div class="robot-name">${r.name}</div>
        <div class="robot-meta">${stratLabel} · ${r.market} · ${r.loginId} ${accBadge}</div>
        <div class="robot-meta">Entrada: $${r.entry} · x${r.factor} · ${r.levels} níveis · Virtual: ${r.virtualLosses} losses</div>
      </div>
      <div class="robot-actions">
        <button class="btn btn-sm ${r.running ? 'btn-danger' : 'btn-success'}" onclick="toggleRobotRunning('${r.id}')">${r.running ? '⏹ Parar' : '▶ Ativar'}</button>
        <button class="btn btn-sm btn-gold" onclick="openRobotForm('${r.id}')">✏️</button>
        <button class="btn btn-sm btn-danger" onclick="deleteRobot('${r.id}')">🗑️</button>
      </div>
    </div>`;
      }).join('');
    }

    // ════════════════════════════════════════
    // ADMIN — ADMINS CRUD
    // ════════════════════════════════════════
    function openAdminForm() { document.getElementById('adminFormCard').style.display = 'block'; }

    async function saveAdmin() {
      const u = document.getElementById('afUser').value.trim();
      const p = document.getElementById('afPass').value;
      const p2 = document.getElementById('afPass2').value;
      const err = document.getElementById('adminFormErr');
      if (!u) { err.textContent = 'Usuário obrigatório.'; err.style.display = 'block'; return; }
      if (p.length < 4) { err.textContent = 'Senha mínima: 4 caracteres.'; err.style.display = 'block'; return; }
      if (p !== p2) { err.textContent = 'Senhas não conferem.'; err.style.display = 'block'; return; }
      if (admins.find(a => a.user === u)) { err.textContent = 'Usuário já existe.'; err.style.display = 'block'; return; }
      admins.push({ user: u, pass: await hashPass(p) });
      store('drv_admins', admins);
      err.style.display = 'none';
      document.getElementById('adminFormCard').style.display = 'none';
      renderAdminList();
    }

    function deleteAdmin(u) {
      if (u === currentUser?.user) { alert('Você não pode deletar seu próprio usuário.'); return; }
      if (!confirm('Deletar admin "' + u + '"?')) return;
      admins = admins.filter(a => a.user !== u);
      store('drv_admins', admins);
      renderAdminList();
    }

    function renderAdminList() {
      const list = document.getElementById('adminList');
      list.innerHTML = admins.map(a => `
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;">
      <div>
        <span style="font-weight:700;">👤 ${a.user}</span>
        ${a.user === currentUser?.user ? '<span class="badge badge-gold" style="margin-left:8px;">VOCÊ</span>' : ''}
      </div>
      <button class="btn btn-sm btn-danger" onclick="deleteAdmin('${a.user}')" ${a.user === currentUser?.user ? 'disabled' : ''}>🗑️ Remover</button>
    </div>`).join('');
    }

    // ════════════════════════════════════════
    // DASHBOARD STATE
    // ════════════════════════════════════════
    let ws = null;
    let wsPub = null; // public WebSocket for live stream without Deriv auth
    let derivAccount = null; // from trader login or selected robot
    let digits = [];
    let freqMap = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
    let wins = 0, losses = 0, currentLossStreak = 0, maxLossStreak = 0;
    let virtualLossStreak = 0, robotActive = false, pendingMartingaleLevel = 0;
    let martingaleLevel = 0, martingaleEntry = 0;
    let robotActivationCount = 0;
    let autoTradeEnabled = false, tradeInProgress = false, currentContractId = null, pendingBuyReqId = null;
    let processedContracts = new Set(); // prevent double-processing
    let sessionPnl = 0, sessionOps = 0, sessionStopped = false;
    let accountBalance = 0, accountCurrency = 'USD';
    let dynamicMartTable = [];
    let connectTimeout = null;
    // ── DOM cache — elementos consultados a cada tick ────────────────────────
    const _dom = {};
    document.addEventListener('DOMContentLoaded', () => {
      const ids = ['boletaSG', 'boletaSL', 'boletaMarket', 'freqHotThreshold',
        'freqOppMinThreshold', 'freqEntry', 'freqSG', 'freqSL',
        'pingDot', 'pingBox', 'pingVal', 'bPnl', 'pnlFill', 'bStatus',
        'accBalanceD', 'freqAccBalance'];
      ids.forEach(id => { _dom[id] = document.getElementById(id); });
    });
    // $el — DOM query com cache; safeEl delega aqui para consistência
    function $el(id) { return _dom[id] || document.getElementById(id); }

    // ── Helpers para token Deriv em sessionStorage ────────────────────────────
    function _saveDrvConn(uid, data) { try { sessionStorage.setItem('drv_conn_' + uid, JSON.stringify(data)); } catch (e) { } }
    function _loadDrvConn(uid) { try { const v = sessionStorage.getItem('drv_conn_' + uid); return v ? JSON.parse(v) : null; } catch (e) { return null; } }
    function _removeDrvConn(uid) { try { sessionStorage.removeItem('drv_conn_' + uid); } catch (e) { } }

    // ── WebSocket auto-reconnect ──────────────────────────────────────────────
    let _wsReconnectTimer = null;
    let _wsReconnectAttempts = 0;
    const WS_RECONNECT_MAX_DELAY = 30000; // 30s
    function _scheduleReconnect() {
      clearTimeout(_wsReconnectTimer);
      const delay = Math.min(1000 * Math.pow(2, _wsReconnectAttempts), WS_RECONNECT_MAX_DELAY);
      _wsReconnectAttempts++;
      log(`🔄 Reconectando em ${Math.round(delay / 1000)}s (tentativa ${_wsReconnectAttempts})...`, 'warning');
      _wsReconnectTimer = setTimeout(() => { try { if (derivAccount && !ws) connectDash(); } catch (e) { log('❌ Erro ao reconectar: ' + e.message, 'error'); } }, delay);
    }
    function _resetReconnect() {
      clearTimeout(_wsReconnectTimer);
      _wsReconnectTimer = null;
      _wsReconnectAttempts = 0;
    }

    function resetSessionState() {
      digits = []; freqMap = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
      wins = 0; losses = 0; currentLossStreak = 0; maxLossStreak = 0;
      virtualLossStreak = 0; robotActive = false; pendingMartingaleLevel = 0;
      martingaleLevel = 0; martingaleEntry = 0; robotActivationCount = 0;
      autoTradeEnabled = false; tradeInProgress = false; currentContractId = null; cycleState = 'IDLE'; processedContracts = new Set();
      sessionPnl = 0; sessionOps = 0; sessionStopped = false;
      dynamicMartTable = [];
    }

    // ════════════════════════════════════════
    // ROBOT SELECTOR (dashboard)
    // ════════════════════════════════════════
    function renderRobotSelectorList() {
      const menu = document.getElementById('robotDropdownMenu');
      if (!menu) return;
      const toShow = robots; // all robots visible; admin marks active/inactive
      let html = '';
      toShow.forEach(r => {
        const stratLabel = r.strategy.toUpperCase().replace(/([A-Za-z]+)(\d+)/, '$1 $2');
        const statusBadge = r.running
          ? '<span style="color:var(--green);font-size:9px;margin-left:4px;">● ATIVO</span>'
          : '<span style="color:var(--dim);font-size:9px;margin-left:4px;">○ inativo</span>';
        html += `<div class="robot-dropdown-item" id="rsel_${r.id}" onclick="selectRobot('${r.id}')"
      style="${r.running ? '' : 'opacity:0.7'}">
      <div class="rdi-name">🤖 ${r.name} ${statusBadge}</div>
      <div class="rdi-meta">${stratLabel} · x${r.factor} · ${r.levels} níveis · ${r.virtualLosses} losses</div>
    </div>`;
      });
      // Só mostra MODO MANUAL quando o toggle estiver em MANUAL
      if (window._modeManual) {
        html += `<div class="robot-dropdown-item manual-mode" onclick="selectManualMode()">
      <div class="rdi-name" style="color:var(--gold);">✋ MODO MANUAL</div>
      <div class="rdi-meta" style="color:var(--gold);">Configure a estratégia manualmente</div>
    </div>`;
      }
      menu.innerHTML = html || '<div style="padding:12px;color:var(--dim);font-size:12px;text-align:center;">Nenhum robô disponível.</div>';
    }

    function toggleRobotDropdown() {
      const btn = document.getElementById('robotDropdownBtn');
      const menu = document.getElementById('robotDropdownMenu');
      if (!menu) return;
      renderRobotSelectorList();
      const isOpen = menu.classList.contains('open');
      if (!isOpen) {
        menu.classList.add('open'); btn.classList.add('open');
        setTimeout(() => document.addEventListener('click', closeDropdownOutside, { once: true }), 10);
      } else {
        menu.classList.remove('open'); btn.classList.remove('open');
      }
    }

    function closeDropdownOutside(e) {
      const dd = document.getElementById('robotDropdown');
      if (dd && !dd.contains(e.target)) {
        document.getElementById('robotDropdownMenu')?.classList.remove('open');
        document.getElementById('robotDropdownBtn')?.classList.remove('open');
      }
    }

    function selectManualMode() {
      selectedRobot = null;
      document.getElementById('robotDropdownMenu')?.classList.remove('open');
      document.getElementById('robotDropdownBtn')?.classList.remove('open');
      const lbl = document.getElementById('robotDropdownLabel');
      if (lbl) { lbl.textContent = '✋ MODO MANUAL'; lbl.style.color = 'var(--gold)'; }
      document.getElementById('manualFields')?.classList.add('active');
      document.querySelectorAll('.robot-dropdown-item').forEach(el => el.classList.remove('active'));
      applyBoleta();
      log('✋ Modo manual ativado.', 'info');
    }

    function selectRobot(id) {
      selectedRobot = robots.find(r => r.id === id);
      if (!selectedRobot) return;
      // Close dropdown
      document.getElementById('robotDropdownMenu')?.classList.remove('open');
      document.getElementById('robotDropdownBtn')?.classList.remove('open');
      // Update label
      const lbl = document.getElementById('robotDropdownLabel');
      if (lbl) { lbl.textContent = '🤖 ' + selectedRobot.name; lbl.style.color = 'var(--accent)'; }
      // Mark active in menu
      document.querySelectorAll('.robot-dropdown-item').forEach(el => el.classList.remove('active'));
      document.getElementById('rsel_' + id)?.classList.add('active');
      // Hide manual fields
      document.getElementById('manualFields')?.classList.remove('active');
      // Sync entry from robot config
      const entryEl = document.getElementById('boletaEntry');
      if (entryEl) { entryEl.value = selectedRobot.entry; delete entryEl.dataset.manuallyChanged; }
      buildMartTable();
      renderMartTable();
      updateBoletaDisplay();
      updateVdots();
      const stratLabel = selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2');
      log(`🤖 Robô selecionado: ${selectedRobot.name} | ${stratLabel} | ${selectedRobot.virtualLosses} losses virtuais`, 'info');
    }

    function buildMartTable() {
      dynamicMartTable = [];
      const baseEntry = parseFloat(document.getElementById('boletaEntry')?.value || selectedRobot?.entry || 0.35) || 0.35;
      const levels = getMartLevels();
      const factor = getMartFactor();
      let e = baseEntry, acc = 0;
      for (let i = 1; i <= levels; i++) {
        acc += e;
        dynamicMartTable.push({ level: i, entry: parseFloat(e.toFixed(2)), accum: parseFloat(acc.toFixed(2)) });
        e = e * factor;
      }
    }

    function applyBoleta() {
      buildMartTable();
      renderMartTable();
      updateVdots();
      updateMartRefTable();
      schedulePayout();
      const market = document.getElementById('boletaMarket')?.value || 'R_100';
      document.getElementById('accMarketD').textContent = market;
      if (selectedRobot) {
        document.getElementById('accStratD').textContent = selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2');
      } else {
        const ms = document.getElementById('manualStrategy')?.value || 'over3';
        document.getElementById('accStratD').textContent = ms.toUpperCase().replace(/([a-z]+)(\d+)/i, '$1 $2');
      }
    }

    function renderMartTable() {
      const cells = document.getElementById('martTableCells');
      const exp = document.getElementById('martExposure');
      if (!cells) return;
      // Use live payout if available, fallback to static table
      const stratKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
      const payout = getEffectivePayout(stratKey);
      const isLivePayout = payoutCache[stratKey] != null;
      cells.innerHTML = dynamicMartTable.map(row => {
        const grossProfit = row.entry * payout;
        const profitStr = '+$' + grossProfit.toFixed(2);
        return `
    <div style="background:var(--bg);border-radius:6px;padding:6px 10px;text-align:center;border:1px solid var(--border);min-width:64px;">
      <div style="font-size:9px;color:var(--dim);font-family:Share Tech Mono,monospace;">N${row.level}</div>
      <div style="font-size:12px;font-weight:700;color:var(--gold);font-family:Share Tech Mono,monospace;">$${row.entry.toFixed(2)}</div>
      <div style="font-size:11px;font-weight:700;color:#00ff9f;font-family:Share Tech Mono,monospace;">${profitStr}</div>
      <div style="font-size:9px;color:var(--dim);font-family:Share Tech Mono,monospace;">acum $${row.accum.toFixed(2)}</div>
    </div>`;
      }).join('');
      const maxExposure = dynamicMartTable[dynamicMartTable.length - 1]?.accum || 0;
      const entryLast = dynamicMartTable[dynamicMartTable.length - 1]?.entry || 0;
      const lastProfit = '+$' + (entryLast * payout).toFixed(2);
      const liveTag = isLivePayout ? ' ●live' : ' ~est.';
      exp.textContent = maxExposure > 0 ? `Exposição máxima: $${maxExposure.toFixed(2)} · Lucro N${dynamicMartTable.length}: ${lastProfit}${liveTag}` : '';
    }

    function updateBoletaDisplay() {
      if (!selectedRobot) return;
      document.getElementById('bLevel').textContent = martingaleLevel || '—';
      document.getElementById('accMarketD').textContent = document.getElementById('boletaMarket')?.value || 'R_100';
      document.getElementById('accStratD').textContent = selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2');
      // Sync boleta entry with robot entry if not manually changed
      const entryEl = document.getElementById('boletaEntry');
      if (entryEl && !entryEl.dataset.manuallyChanged) entryEl.value = selectedRobot.entry;
      renderMartTable();
    }

    function updateVdots() {
      const target = getVirtualLossTarget();
      const container = document.getElementById('vdots');
      container.innerHTML = '';
      for (let i = 0; i < target; i++) {
        const d = document.createElement('div');
        d.className = 'vdot' + (i < virtualLossStreak ? ' active' : '');
        container.appendChild(d);
      }
      document.getElementById('vdotCount').textContent = virtualLossStreak + ' / ' + target;
    }

    // ════════════════════════════════════════
    // SOUND EFFECTS
    // ════════════════════════════════════════
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playWin() {
      [0, 0.18].forEach((d, i) => {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sine'; o.frequency.setValueAtTime(i ? 1500 : 1200, audioCtx.currentTime + d);
        g.gain.setValueAtTime(0, audioCtx.currentTime + d);
        g.gain.linearRampToValueAtTime(0.4, audioCtx.currentTime + d + 0.01);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d + 0.15);
        o.start(audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d + 0.15);
      });
    }
    function playLoss() {
      const o = audioCtx.createOscillator(), g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = 'sawtooth'; o.frequency.setValueAtTime(400, audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 0.4);
      g.gain.setValueAtTime(0.3, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.4);
      o.start(audioCtx.currentTime); o.stop(audioCtx.currentTime + 0.4);
    }
    function playStopGain() {
      [0, 0.12, 0.24, 0.36].forEach((d, i) => {
        const f = [800, 1000, 1200, 1600][i];
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'sine'; o.frequency.setValueAtTime(f, audioCtx.currentTime + d);
        g.gain.setValueAtTime(0.35, audioCtx.currentTime + d);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d + 0.2);
        o.start(audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d + 0.2);
      });
    }
    function playStopLoss() {
      [0, 0.2, 0.4].forEach(d => {
        const o = audioCtx.createOscillator(), g = audioCtx.createGain();
        o.connect(g); g.connect(audioCtx.destination);
        o.type = 'square'; o.frequency.setValueAtTime(300, audioCtx.currentTime + d);
        g.gain.setValueAtTime(0.2, audioCtx.currentTime + d);
        g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d + 0.15);
        o.start(audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d + 0.15);
      });
    }

    // ════════════════════════════════════════
    // STRATEGY CONFIG
    // ════════════════════════════════════════
    // Live payout cache — fetched from Deriv proposal API
    // key: strategyKey, value: multiplier (profit/stake ratio)
    let payoutCache = {};
    let payoutFetchTimer = null;
    let payoutReqMap = {}; // reqId → stratKey mapping

    function getStrategyPayout(key) {
      if (!key) {
        if (selectedRobot) key = selectedRobot.strategy;
        else key = document.getElementById('manualStrategy')?.value || 'over3';
      }
      return payoutCache[key] || null; // null = not yet fetched, use getEffectivePayout for fallback
    }

    // Fetch real payout from Deriv proposal API
    function fetchPayoutFromDeriv(stratKey, stake, market) {
      if (!ws || ws.readyState !== 1) return;
      const contract = getContractTypeForStrategy(stratKey);
      const reqId = 'p_' + stratKey + '_' + Date.now(); // string req_id, encodes stratKey
      payoutReqMap[reqId] = stratKey; // track which strat this request is for
      const msg = {
        proposal: 1,
        amount: parseFloat(stake).toFixed(2),
        basis: 'stake',
        contract_type: contract.type,
        currency: accountCurrency || 'USD',
        duration: 1,
        duration_unit: 't',
        symbol: market || 'R_100',
        barrier: contract.barrier,
        req_id: reqId
      };
      ws.send(JSON.stringify(msg));
    }

    function getContractTypeForStrategy(key) {
      if (!key) key = (selectedRobot?.strategy) || document.getElementById('manualStrategy')?.value || 'over3';
      const n = parseInt(key.replace(/[^0-9]/g, ''));
      const isOver = key.startsWith('over');
      return { type: isOver ? 'DIGITOVER' : 'DIGITUNDER', barrier: String(n) };
    }

    // Schedule a payout fetch (debounced 600ms) — current strategy only
    function schedulePayout() {
      clearTimeout(payoutFetchTimer);
      payoutFetchTimer = setTimeout(() => {
        if (!ws || ws.readyState !== 1) return;
        const stratKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
        const stake = parseFloat(document.getElementById('boletaEntry')?.value || 0.35);
        const market = document.getElementById('boletaMarket')?.value || 'R_100';
        fetchPayoutFromDeriv(stratKey, stake, market);
      }, 600);
    }

    // Fetch payout for ALL 9 Over strategies sequentially (with small delay between each)
    function scheduleAllPayouts() {
      if (!ws || ws.readyState !== 1) return;
      const stake = parseFloat(document.getElementById('boletaEntry')?.value || 0.35);
      const market = document.getElementById('boletaMarket')?.value || 'R_100';
      const keys = ['over0', 'over1', 'over2', 'over3', 'over4', 'over5', 'over6', 'over7', 'over8'];
      keys.forEach((key, i) => {
        setTimeout(() => {
          if (ws && ws.readyState === 1) fetchPayoutFromDeriv(key, stake, market);
        }, i * 400); // 400ms between each to avoid rate limit
      });
    }

    function getStrategyConfig(key) {
      if (!key) {
        if (selectedRobot) key = selectedRobot.strategy;
        else key = document.getElementById('manualStrategy')?.value || 'over3';
      }
      const n = parseInt(key.replace(/[^0-9]/g, ''));
      const isOver = key.startsWith('over');
      const winDigits = [], lossDigits = [];
      for (let d = 0; d <= 9; d++) {
        if (isOver) { (d > n ? winDigits : lossDigits).push(d); }
        else { (d < n ? winDigits : lossDigits).push(d); }
      }
      const payout = getStrategyPayout(key);
      return { name: (isOver ? 'OVER ' : 'UNDER ') + n, winDigits, lossDigits, payout };
    }

    function getVirtualLossTarget() {
      if (selectedRobot) return selectedRobot.virtualLosses || 2;
      return parseInt(document.getElementById('manualVirtual')?.value || 5);
    }

    function getMartLevels() {
      if (selectedRobot) return selectedRobot.levels || 5;
      return parseInt(document.getElementById('manualLevels')?.value || 5);
    }

    function getMartFactor() {
      if (selectedRobot) return selectedRobot.factor || 2.8;
      return parseFloat(document.getElementById('manualFactor')?.value || 2.8);
    }

    function getContractType() {
      return getContractTypeForStrategy(); // uses selectedRobot or manualStrategy correctly
    }

    // ════════════════════════════════════════
    // PUBLIC STREAM (sem auth Deriv)
    // ════════════════════════════════════════
    function disconnectPublicStream() {
      if (wsPub) { wsPub.onclose = null; wsPub.onerror = null; wsPub.onmessage = null; wsPub.onopen = null; wsPub.close(); wsPub = null; }
    }

    function connectPublicStream(market) {
      if (ws && ws.readyState <= 1) return; // trading WS ativo, não interfere
      disconnectPublicStream();
      const mkt = market || document.getElementById('boletaMarket')?.value || 'R_100';
      let pubState = 'CONNECTING';
      try { wsPub = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${DERIV_APP_ID}`); }
      catch (e) { return; }

      wsPub.onopen = () => {
        pubState = 'LOADING';
        log(`📡 Buscando últimos 5000 dígitos históricos (${mkt})...`, 'info');
        wsPub.send(JSON.stringify({ ticks_history: mkt, count: 5000, end: 'latest', style: 'ticks', adjust_start_time: 1 }));
      };

      wsPub.onmessage = (e) => {
        if (ws && ws.readyState <= 1) { disconnectPublicStream(); return; }
        let data; try { data = JSON.parse(e.data); } catch { return; }

        if (data.msg_type === 'history' && data.history && pubState === 'LOADING') {
          pubState = 'LIVE';
          digits = []; freqMap = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
          document.getElementById('digitStream').innerHTML = '';
          const prices = data.history.prices || [];
          const times = data.history.times || [];
          prices.forEach(p => {
            const s = p.toString(), parts = s.split('.');
            const d = parts.length > 1 ? parseInt(parts[1].slice(-1)) : parseInt(s.slice(-1));
            processDigitSilent(d);
          });
          log(`✅ ${prices.length} dígitos históricos carregados! Iniciando stream ao vivo...`, 'success');
          updateDiagnostics(); updateOUTable(); updateMartRefTable(); updateFreqGrid();
          updateLastDigit(digits[digits.length - 1] ?? 0);
          if (document.getElementById('chartPanel')?.style.display !== 'none') feedChartHistory(prices, times);
          else { window._chartPendingHistory = { prices, times }; }
          wsPub.send(JSON.stringify({ ticks: mkt, subscribe: 1 }));
        }

        if (data.msg_type === 'tick' && data.tick && pubState === 'LIVE') {
          const s = data.tick.quote.toString(), parts = s.split('.');
          const d = parts.length > 1 ? parseInt(parts[1].slice(-1)) : parseInt(s.slice(-1));
          processDigit(d);
          updateChart(data.tick.quote, data.tick.epoch);
        }
      };

      wsPub.onerror = () => { wsPub = null; };
      wsPub.onclose = () => { wsPub = null; };
    }

    function reconnectPublicStream() {
      if (ws && ws.readyState <= 1) return;
      const mkt = document.getElementById('boletaMarket')?.value || 'R_100';
      connectPublicStream(mkt);
    }

    // ════════════════════════════════════════
    // WEBSOCKET & CONNECT
    // ════════════════════════════════════════
    function connectDash() {
      if (!derivAccount) { showDerivConnectModal(); return; }
      if (ws && (ws.readyState === 0 || ws.readyState === 1)) { log('⚠️ Já conectado.', 'warning'); return; }
      if (location.protocol === 'file:') { log('⚠️ Aberto via file:// — use o INICIAR_WINDOWS.bat para funcionar corretamente.', 'warning'); }

      disconnectPublicStream(); // para stream público antes de conectar com auth

      // Credentials ALWAYS come from derivAccount (robots are strategy-only configs)
      const creds = derivAccount;
      const appId = creds?.appId || '127769';
      const token = creds?.token || null;
      const market = document.getElementById('boletaMarket')?.value || 'R_100';

      // Reset digit state
      digits = []; freqMap = { 0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0, 9: 0 };
      wins = 0; losses = 0; currentLossStreak = 0;
      document.getElementById('digitStream').innerHTML = '';
      buildMartTable(); updateBoletaDisplay(); updateVdots();

      // Connection state — prevents double auth/subscription
      let connState = 'CONNECTING'; // CONNECTING → AUTHING → LOADING → LIVE

      document.getElementById('connectBtn').textContent = '⏹ ENCERRAR CONEXÃO';
      document.getElementById('connectBtn').style.cssText = 'background:rgba(248,113,113,.15);color:var(--red);border:1px solid rgba(248,113,113,.4);font-weight:700;';
      document.getElementById('connectBtn').setAttribute('onclick', 'disconnectDash()');
      const modeLabel = selectedRobot ? `Robô: ${selectedRobot.name}` : 'Modo Manual';
      log(`🔌 Conectando: ${creds?.loginid || creds?.loginId || '—'} | ${market} | ${modeLabel}`, 'info');

      connectTimeout = setTimeout(() => {
        log('⏱️ Timeout 15s — sem resposta da Deriv. Verifique App ID, internet e tente novamente.', 'error');
        resetConnectBtn(); if (ws) ws.close();
      }, 15000);

      try {
        ws = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${appId}`);
      } catch (e) {
        clearTimeout(connectTimeout);
        log('❌ Erro WebSocket: ' + e.message, 'error');
        resetConnectBtn(); return;
      }

      ws.onopen = () => {
        _resetReconnect(); // conexão bem-sucedida — reseta backoff exponential
        clearTimeout(connectTimeout);
        log('✅ WebSocket conectado!', 'success');
        document.getElementById('connectBtn').textContent = '⏹ ENCERRAR CONEXÃO';
        document.getElementById('connectBtn').style.cssText = 'background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.4);font-weight:700;';
        document.getElementById('connectBtn').setAttribute('onclick', 'disconnectDash()');
        // Step 1: authorize if we have a token, else go straight to history
        if (token) {
          connState = 'AUTHING';
          log('🔐 Autenticando...', 'info');
          ws.send(JSON.stringify({ authorize: token }));
        } else {
          connState = 'LOADING';
          loadHistory(market);
        }
        // Start ping AFTER connection (ping is independent, handled separately)
        startPing();
      };

      ws.onmessage = (e) => {
        let data; try { data = JSON.parse(e.data); } catch { return; }

        // ── Ping/pong (independent of auth flow) ──
        if (data.msg_type === 'ping') handlePong();

        // ── Auth ──
        if (data.msg_type === 'authorize' && data.authorize && connState === 'AUTHING') {
          connState = 'LOADING';
          const auth = data.authorize;
          accountCurrency = auth.currency || 'USD';
          const isVirt = auth.is_virtual === 1;
          document.getElementById('accLoginIdD').textContent = auth.loginid;
          document.getElementById('accTypeD').textContent = isVirt ? '📊 DEMO' : '💰 REAL';
          document.getElementById('accTypeD').style.color = isVirt ? 'var(--accent)' : 'var(--gold)';
          document.getElementById('accBar').style.display = 'flex';
          // Freq. Dígitos account bar
          const fqBar = document.getElementById('freqAccBar');
          if (fqBar) {
            document.getElementById('freqAccLoginId').textContent = auth.loginid;
            const fqType = document.getElementById('freqAccType');
            fqType.textContent = isVirt ? '📊 DEMO' : '💰 REAL';
            fqType.style.color = isVirt ? 'var(--accent)' : 'var(--gold)';
            fqBar.style.display = 'flex';
          }
          log(`✅ Autenticado: ${auth.loginid} (${isVirt ? 'DEMO' : 'REAL'}) | ${auth.currency}`, 'success');
          if (!isVirt) log('🚨 CONTA REAL ATIVA — opere com cuidado!', 'error');
          // Subscribe balance ONCE
          ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
          // Load history ONCE
          loadHistory(market);
        }

        // ── Balance updates ──
        if (data.msg_type === 'balance' && data.balance) {
          accountBalance = parseFloat(data.balance.balance);
          updateBalanceUI(accountBalance);
        }

        // ── History loaded → subscribe ticks ONCE ──
        if (data.msg_type === 'history' && data.history && connState === 'LOADING') {
          connState = 'LIVE';
          const prices = data.history.prices || [];
          const times = data.history.times || [];
          log(`📦 Carregando ${prices.length} dígitos históricos...`, 'info');
          prices.forEach(p => {
            const s = p.toString(), parts = s.split('.');
            const d = parts.length > 1 ? parseInt(parts[1].slice(-1)) : parseInt(s.slice(-1));
            processDigitSilent(d);
          });
          log(`✅ Histórico carregado! ${digits.length} dígitos. Iniciando stream ao vivo...`, 'success');
          updateDiagnostics(); updateOUTable();
          updateMartRefTable(); updateFreqGrid(); updateMartRefTable();
          updateLastDigit(digits[digits.length - 1] ?? 0);
          // Subscribe ticks ONCE
          if (document.getElementById('chartPanel')?.style.display !== 'none') feedChartHistory(prices, times);
          else { window._chartPendingHistory = { prices, times }; }
          ws.send(JSON.stringify({ ticks: market, subscribe: 1 }));
          schedulePayout();
        }

        // ── Live ticks ──
        if (data.msg_type === 'tick' && data.tick && connState === 'LIVE') {
          const s = data.tick.quote.toString(), parts = s.split('.');
          const d = parts.length > 1 ? parseInt(parts[1].slice(-1)) : parseInt(s.slice(-1));
          processDigit(d);
          updateChart(data.tick.quote, data.tick.epoch);
        }

        // ── Trade responses ──
        if (data.msg_type === 'buy') handleBuy(data);
        if (data.msg_type === 'proposal') handleProposalResponse(data);
        if (data.msg_type === 'proposal_open_contract') handleContract(data);

        // ── Errors ──
        if (data.error) {
          const code = data.error.code || '';
          const msg = data.error.message || '';

          // 1. Trade buy error — don't kill connection
          if (data.req_id === pendingBuyReqId) {
            tradeInProgress = false; cycleState = 'IDLE';
            log('❌ Erro trade: ' + msg, 'error'); return;
          }
          // 2. Payout proposal error — ignore silently
          if (data.msg_type === 'proposal') return;
          // 3. AlreadySubscribed — ignore silently
          if (code === 'AlreadySubscribed') return;
          // 4. MarketIsClosed — warn only
          if (code === 'MarketIsClosed') {
            log('⚠️ Mercado fechado no momento.', 'warning'); return;
          }
          // 5. All other errors — log with guidance and reset connection
          clearTimeout(connectTimeout);
          log(`❌ Erro API: ${msg} (${code})`, 'error');
          if (code === 'InvalidAppID')
            log('💡 App ID inválido. Crie um em: developers.deriv.com → Dashboard → Register App', 'warning');
          else if (code === 'InvalidToken' || code === 'WrongResponse' || code === 'AuthorizationRequired') {
            // Token expirado/inválido — limpa sessionStorage e solicita nova autenticação OAuth
            const _uid = window._alphaUser?.uid;
            if (_uid) _removeDrvConn(_uid);
            derivAccount = null;
            updateProfileDropdown();
            log('🔐 Sessão Deriv expirada. Clique em "Conectar Deriv" no menu de perfil para reconectar.', 'warning');
          }
          else if (code === 'RateLimit')
            log('💡 Muitas requisições. Aguarde alguns segundos e tente novamente.', 'warning');
          // Reset and close for fatal errors
          disconnectDash();
          resetConnectBtn();
        }
      };

      ws.onclose = (e) => {
        clearTimeout(connectTimeout);
        stopPing();
        if (ws) { ws.onmessage = null; ws.onerror = null; ws.onopen = null; ws.onclose = null; ws = null; }
        if (cycleState === 'TRIGGERED') { cycleState = 'IDLE'; tradeInProgress = false; }
        log(`🔌 Conexão encerrada (${e.code}). Reconecte para operar.`, 'warning');
        resetConnectBtn();
        // Reconexão automática somente se não foi desconexão intencional e robô estava ativo
        if (autoTradeEnabled && derivAccount && e.code !== 1000) {
          _scheduleReconnect();
        } else {
          if (autoTradeEnabled) disableAutoTrade();
        }
      };

      ws.onerror = () => {
        clearTimeout(connectTimeout);
        stopPing();
        if (location.protocol === 'file:') log('🚨 WebSocket bloqueado via file://. Use o INICIAR_WINDOWS.bat (servidor local).', 'error');
        else { cycleState = 'IDLE'; log('❌ Erro de conexão WebSocket.', 'error'); }
        resetConnectBtn();
      };
    } // end connectDash

    function resetConnectBtn() {
        const btn = document.getElementById('connectBtn');
        btn.textContent = '▶ CONECTAR';
        btn.style.cssText = '';
        btn.className = 'btn btn-primary';
        btn.setAttribute('onclick', 'connectDash()');
      }

      function disconnectDash() {
        _resetReconnect(); // cancela qualquer reconnect pendente
        if (ws) { ws.onclose = null; ws.onerror = null; ws.onmessage = null; ws.onopen = null; ws.close(); ws = null; }
        cycleState = 'IDLE';
        if (autoTradeEnabled) disableAutoTrade();
        resetConnectBtn();
        log('⏹ Conexão encerrada pelo usuário.', 'warning');
      }

      function loadHistory(market) {
        log(`📡 Buscando últimos 5000 dígitos históricos (${market})...`, 'info');
        ws.send(JSON.stringify({ ticks_history: market, count: 5000, end: 'latest', style: 'ticks', adjust_start_time: 1 }));
      }

      // ════════════════════════════════════════
      // AUTO-TRADE
      // ════════════════════════════════════════
      function toggleAutoTrade() {
        if (!autoTradeEnabled) {
          if (!derivAccount || !ws || ws.readyState !== 1) { showDerivConnectModal(); return; }
          if (!selectedRobot) { log('⚠️ Selecione um robô antes de iniciar.', 'warning'); return; }
        }
        autoTradeEnabled = !autoTradeEnabled;
        const btn = document.getElementById('tradeToggleBtn');
        const ind = document.getElementById('autoTradeIndicator');
        const lbl = document.getElementById('autoTradeLabel');
        if (autoTradeEnabled) {
          btn.textContent = '⏹ PARAR ROBÔ';
          btn.style.cssText = 'background:rgba(255,59,107,.15);color:var(--red);border:1px solid rgba(255,59,107,.5);font-weight:700;';
          ind.style.cssText = 'width:10px;height:10px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 1.5s infinite;';
          lbl.style.color = 'var(--green)'; lbl.textContent = 'ROBÔ ATIVO';
          // Reset cycle and show active monitoring signal
          cycleState = 'IDLE'; virtualLossStreak = 0; pendingMartingaleLevel = 0;
          window._nextChipIsTrigger = false; window._triggerChip = null;
          updateVdots();
          setSignal('virtual', '👁️ MONITORANDO', 'Aguardando ' + getVirtualLossTarget() + ' losses virtuais para entrar');
          document.getElementById('bStatus').textContent = 'OPERANDO';
          document.getElementById('bStatus').style.color = 'var(--green)';
          lockBoleta();
          log('🤖 ROBÔ INICIADO — Operando automaticamente!', 'success');
        } else {
          btn.textContent = '🤖 INICIAR ROBÔ';
          btn.style.cssText = 'background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;';
          ind.style.cssText = 'width:10px;height:10px;border-radius:50%;background:var(--dim);';
          lbl.style.color = 'var(--dim)'; lbl.textContent = 'ROBÔ PARADO';
          // Reset robot cycle completely when manually disabled
          cycleState = 'IDLE';
          virtualLossStreak = 0;
          pendingMartingaleLevel = 0;
          robotActive = false;
          unlockBoleta();
          setSignal('aguardando', '⏸ ROBÔ PARADO', 'Clique em INICIAR ROBÔ para operar');
          log('⏸ Robô parado. Ciclo e streak resetados.', 'warning');
        }
      }

      function disableAutoTrade() {
        if (!autoTradeEnabled) return;
        autoTradeEnabled = false;
        robotActive = false;
        cycleState = 'IDLE';
        virtualLossStreak = 0;
        const btn = document.getElementById('tradeToggleBtn');
        btn.textContent = '🤖 INICIAR ROBÔ';
        btn.style.cssText = 'background:rgba(0,255,159,.1);color:var(--green);border:1px solid rgba(0,255,159,.4);font-weight:700;';
        document.getElementById('autoTradeIndicator').style.cssText = 'width:10px;height:10px;border-radius:50%;background:var(--dim);';
        document.getElementById('autoTradeLabel').style.color = 'var(--dim)';
        document.getElementById('autoTradeLabel').textContent = 'ROBÔ PARADO';
        unlockBoleta();
      }

      // ════════════════════════════════════════
      // TRADING
      // ════════════════════════════════════════
      function placeTrade(amount) {
        if (!ws || ws.readyState !== 1) {
          log('❌ Sem conexão — ciclo liberado.', 'error');
          cycleState = 'IDLE'; return;
        }
        if (tradeInProgress) { log('⏳ Trade já em andamento — bloqueado.', 'warning'); return; }
        if (!isPingOkToTrade()) {
          log(`🔴 OPERAÇÃO PULADA — Ping crítico: ${currentPing}ms. Aguarde conexão estável.`, 'error');
          cycleState = 'IDLE'; virtualLossStreak = 0;
          setSignal('perigo', '⚠️ PING CRÍTICO', 'Operação pulada — aguardando conexão estável');
          return;
        }
        if (cycleState !== 'TRIGGERED') { log('⚠️ Ciclo não ativo — trade cancelado.', 'warning'); return; }
        if (sessionStopped) {
          cycleState = 'IDLE';
          log('🛑 Sessão parada — ciclo liberado.', 'warning'); return;
        }
        const contract = getContractType();
        const market = selectedRobot?.market || derivAccount?.market || 'R_100';
        window._lastStrategy = contract.type + ' ' + contract.barrier;
        window._lastEntry = parseFloat(amount);
        pendingBuyReqId = Date.now();
        tradeInProgress = true;
        ws.send(JSON.stringify({
          buy: 1, price: parseFloat(amount).toFixed(2), parameters: {
            contract_type: contract.type, symbol: market, duration: 1, duration_unit: 't',
            basis: 'stake', amount: parseFloat(amount).toFixed(2), currency: accountCurrency || 'USD', barrier: contract.barrier
          }, req_id: pendingBuyReqId
        }));
        log(`📤 Ordem: ${contract.type} barrier ${contract.barrier} — $${parseFloat(amount).toFixed(2)}`, 'info');
        setSignal('enviando', '📤 ENVIANDO ORDEM...', 'Aguardando confirmação da Deriv');
      }

      function handleBuy(data) {
        if (data.error) { tradeInProgress = false; cycleState = 'IDLE'; log('❌ Erro ao comprar: ' + data.error.message + ' — ciclo liberado.', 'error'); return; }
        currentContractId = data.buy.contract_id;
        log(`✅ Contrato aberto! ID: ${currentContractId} | Pago: $${data.buy.buy_price}`, 'success');
        ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: currentContractId, subscribe: 1 }));
        setSignal('enviando', '⏳ CONTRATO ABERTO', 'Aguardando resultado...');
      }

      function handleProposalResponse(data) {
        if (data.error) return; // ignore proposal errors silently
        const p = data.proposal;
        if (!p) return;
        // Identify which strategy this proposal was for via req_id map
        const reqId = String(data.req_id || '');
        // Try map first, then parse from req_id string (format: p_over5_timestamp)
        let stratKey = payoutReqMap[reqId];
        if (!stratKey && reqId.startsWith('p_')) {
          const parts = reqId.split('_');
          if (parts.length >= 3) stratKey = parts[1] + parts[2]; // e.g. 'over' + '5'
          // actually format is p_{stratKey}_{timestamp} where stratKey has no underscore
          stratKey = reqId.replace(/^p_/, '').replace(/_\d+$/, '');
        }
        if (!stratKey) stratKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
        delete payoutReqMap[reqId]; // cleanup
        // Calculate real payout multiplier from API response
        const stake = parseFloat(p.ask_price || 0);
        const payout = parseFloat(p.payout || 0);
        if (stake <= 0 || payout <= 0) return;
        const multiplier = (payout - stake) / stake;
        if (multiplier <= 0) return; // sanity check
        payoutCache[stratKey] = multiplier;
        // Update payout cell in martRefTable for this specific strategy (no full rebuild)
        updatePayoutCell(stratKey, multiplier);
        // Only full-rebuild martingale boleta table if this is the active strategy
        const activeKey = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';
        if (stratKey === activeKey) renderMartTable();
        const label = stratKey.replace(/([a-zA-Z]+)(\d+)/, '$1 $2').toUpperCase();
        log(`💰 Payout REAL ${label}: ${(multiplier * 100).toFixed(1)}% (entrada $${stake.toFixed(2)} → lucro $${(stake * multiplier).toFixed(2)})`, 'success');
      }

      function handleContract(data) {
        const c = data.proposal_open_contract; if (!c) return;
        // Ignore updates from old/stale contracts — only process current one
        if (currentContractId && c.contract_id !== currentContractId) {
          log(`⚠️ Ignorando contrato antigo: ${c.contract_id}`, 'info');
          return;
        }
        if (c.balance_after) updateBalanceUI(parseFloat(c.balance_after));
        if (c.is_expired || c.is_sold) {
          // Prevent double-processing same contract result
          if (processedContracts.has(c.contract_id)) {
            log(`⚠️ Resultado duplicado ignorado: ${c.contract_id}`, 'info');
            return;
          }
          processedContracts.add(c.contract_id);
          // Mantém set pequeno: remove o mais antigo (insertion order) em vez de limpar tudo
          if (processedContracts.size > 20) processedContracts.delete(processedContracts.values().next().value);
          tradeInProgress = false;
          const profit = parseFloat(c.profit || 0);
          const isWin = profit > 0;
          const bal = parseFloat(c.balance_after || 0);
          const _ePrice = c.entry_tick?.value ?? c.entry_spot ?? null;
          const _xPrice = c.exit_tick?.value ?? c.exit_spot ?? null;
          const _aType = derivAccount?.accType || 'demo';
          // Registrar no relatório diário
          try { addTradeReport(c, isWin, profit); } catch (e) { }
          if (isWin) {
            try { playWin(); } catch (e) { }
            addPnl(profit);
            addLiveOp(window._lastStrategy || '—', window._lastEntry || 0, 'WIN', profit, _ePrice, _xPrice, _aType);
            const pnlSign = sessionPnl >= 0 ? '+' : '';
            log(`🏆 GANHOU! +$${profit.toFixed(2)} | Sessão: ${pnlSign}$${sessionPnl.toFixed(2)} | Saldo: $${bal.toFixed(2)}`, 'success');
            // Recolor trigger chip to BLUE (win)
            if (window._triggerChip) { window._triggerChip.className = 'digit-chip trigger-win'; window._triggerChip = null; }
            // WIN → reset everything, back to IDLE for fresh new cycle
            cycleState = 'IDLE';
            robotActive = false; virtualLossStreak = 0;
            // WIN em qualquer nível → volta SEMPRE ao nível 1
            const wasLevel = martingaleLevel;
            martingaleLevel = 0; pendingMartingaleLevel = 0;
            currentContractId = null;
            if (wasLevel > 1) {
              log(`↩️ Martingale resetado ao nível 1 (ganhou no nível ${wasLevel})`, 'success');
            }
            setSignal('aguardando', '✅ GANHOU! Monitorando...', 'Aguardando próximo ciclo de ' + (getVirtualLossTarget()) + ' losses virtuais');
          } else {
            try { playLoss(); } catch (e) { }
            const lost = Math.abs(profit);
            addPnl(-lost);
            addLiveOp(window._lastStrategy || '—', window._lastEntry || 0, 'LOSS', -lost, _ePrice, _xPrice, _aType);
            martingaleLevel++;
            const pnlSign = sessionPnl >= 0 ? '+' : '';
            const balMsg = bal < 0 ? ` | ⚠️ SALDO NEGATIVO: $${bal.toFixed(2)}` : `| Saldo: $${bal.toFixed(2)}`;
            log(`💸 PERDEU! -$${lost.toFixed(2)} | Sessão: ${pnlSign}$${sessionPnl.toFixed(2)} ${balMsg}`, 'error');
            // Recolor trigger chip to BRIGHT RED (loss)
            if (window._triggerChip) { window._triggerChip.className = 'digit-chip trigger-loss'; window._triggerChip = null; }
            if (bal < 0) log(`🚨 SALDO NEGATIVO: $${bal.toFixed(2)}`, 'error');
            const maxLvl = getMartLevels();
            if (martingaleLevel > maxLvl) {
              log(`🚨 STOP MARTINGALE! Perdeu no nível máximo (${maxLvl}). Robô encerrado automaticamente.`, 'error');
              cycleState = 'IDLE';
              robotActive = false; martingaleLevel = 0; virtualLossStreak = 0; pendingMartingaleLevel = 0;
              // Encerra robô automaticamente — independente do stop loss
              sessionStopped = true;
              disableAutoTrade();
              document.getElementById('bStatus').textContent = 'STOP MARTINGALE ❌';
              document.getElementById('bStatus').style.color = 'var(--red)';
              setSignal('perigo', '🚨 STOP MARTINGALE', 'Nível máximo atingido — Robô encerrado');
              try { playStopLoss(); } catch (e) { }
              showStopAlert('martingale');
            } else {
              // LOSS → store martingale level, go back to IDLE to wait for next virtual cycle
              pendingMartingaleLevel = martingaleLevel;
              cycleState = 'IDLE';
              robotActive = false; virtualLossStreak = 0;
              const next = dynamicMartTable[martingaleLevel - 1]?.entry || (selectedRobot?.entry || 1);
              log(`🔄 Voltando ao virtual... Próximo ciclo entrará no nível ${martingaleLevel} ($${parseFloat(next).toFixed(2)})`, 'warning');
              setSignal('virtual', '🔄 AGUARDANDO CICLO VIRTUAL', 'Esperando ' + (selectedRobot?.virtualLosses || 2) + ' losses virtuais → Nível ' + martingaleLevel);
            }
          }
          currentContractId = null;
          updateBoletaDisplay();
          updateVdots();
        }
      }

      // ════════════════════════════════════════
      // PNL & STOPS
      // ════════════════════════════════════════
      function addPnl(amount) {
        sessionPnl += amount; sessionOps++;
        updatePnlUI();
        checkStops();
      }

      function updatePnlUI() {
        const el = $el('bPnl');
        const bar = $el('pnlFill');
        const sign = sessionPnl >= 0 ? '+' : '';
        if (el) { el.textContent = sign + '$' + sessionPnl.toFixed(2); el.style.color = sessionPnl >= 0 ? 'var(--green)' : 'var(--red)'; }
        const sg = parseFloat($el('boletaSG')?.value || 20);
        const sl = parseFloat($el('boletaSL')?.value || 30);
        const maxV = Math.max(sg, sl, Math.abs(sessionPnl));
        if (bar) { bar.style.width = Math.min(Math.abs(sessionPnl) / maxV * 100, 100) + '%'; bar.style.background = sessionPnl >= 0 ? 'var(--green)' : 'var(--red)'; }
        const statusEl = $el('bStatus');
        if (statusEl && !sessionStopped) {
          statusEl.textContent = sessionOps > 0 ? 'OPERANDO' : 'AGUARDANDO';
          statusEl.style.color = sessionOps > 0 ? 'var(--accent)' : 'var(--dim)';
        }
      }

      function updateBalanceUI(bal) {
        accountBalance = bal;
        const txt = (bal < 0 ? '-$' + Math.abs(bal).toFixed(2) : '$' + bal.toFixed(2));
        const clr = bal < 0 ? 'var(--red)' : 'var(--green)';
        const el = document.getElementById('accBalanceD');
        el.textContent = txt; el.style.color = clr;
        const fqBal = document.getElementById('freqAccBalance');
        if (fqBal) { fqBal.textContent = txt; fqBal.style.color = clr; }
      }

      function checkStops() {
        if (sessionStopped) return;
        const sg = parseFloat($el('boletaSG')?.value || 20);
        const sl = parseFloat($el('boletaSL')?.value || 30);
        const statusEl = $el('bStatus');
        if (sessionPnl >= sg) {
          sessionStopped = true; disableAutoTrade();
          log(`🏆 STOP GAIN! Lucro: $${sessionPnl.toFixed(2)}`, 'success');
          if (statusEl) { statusEl.textContent = 'STOP GAIN ✅'; statusEl.style.color = 'var(--green)'; }
          try { playStopGain(); } catch (e) { }
          showStopAlert('gain');
        } else if (sessionPnl <= -sl) {
          sessionStopped = true; disableAutoTrade();
          log(`🚨 STOP LOSS! Prejuízo: $${sessionPnl.toFixed(2)}`, 'error');
          if (statusEl) { statusEl.textContent = 'STOP LOSS ❌'; statusEl.style.color = 'var(--red)'; }
          try { playStopLoss(); } catch (e) { }
          showStopAlert('loss');
        }
      }

      function showStopAlert(type) {
        const old = document.getElementById('stopAlert'); if (old) old.remove();
        const isGain = type === 'gain';
        const isMart = type === 'martingale';
        const color = isGain ? '#00ff9f' : '#ff3b6b', rgba = isGain ? 'rgba(0,255,159,.3)' : 'rgba(255,59,107,.3)';
        const div = document.createElement('div');
        div.id = 'stopAlert'; div.className = 'overlay';
        div.innerHTML = `<div class="overlay-box" style="border:2px solid ${color};box-shadow:0 0 60px ${rgba};">
    <div style="font-size:52px;margin-bottom:12px;">${isGain ? '🏆' : isMart ? '💀' : '🛑'}</div>
    <h2 style="color:${color};font-size:20px;letter-spacing:2px;margin-bottom:10px;">${isGain ? 'STOP GAIN ATINGIDO!' : isMart ? 'STOP MARTINGALE!' : 'STOP LOSS ATINGIDO!'}</h2>
    <p style="color:#c8e6f5;font-size:13px;margin-bottom:6px;">${isGain ? 'Meta de lucro alcançada!' : isMart ? 'Perdeu no nível máximo do Martingale.' : 'Limite de perda atingido.'}</p>
    <p style="color:${color};font-size:30px;font-weight:900;font-family:Share Tech Mono,monospace;margin-bottom:8px;">${sessionPnl >= 0 ? '+' : ''}$${sessionPnl.toFixed(2)}</p>
    <p style="color:#8aafcc;font-size:13px;margin-bottom:24px;">Deseja continuar operando ou encerrar?</p>
    <div style="display:flex;gap:12px;justify-content:center;">
      <button onclick="continueSession()" style="background:rgba(0,212,255,.15);color:#00d4ff;border:1px solid #00d4ff;border-radius:8px;padding:11px 24px;cursor:pointer;font-size:13px;font-weight:700;">▶ CONTINUAR</button>
      <button onclick="stopSession()" style="background:${isGain ? 'rgba(0,255,159,.1)' : 'rgba(255,59,107,.1)'};color:${color};border:1px solid ${color};border-radius:8px;padding:11px 24px;cursor:pointer;font-size:13px;font-weight:700;">⏹ ENCERRAR</button>
    </div>
  </div>`;
        document.body.appendChild(div);
      }

      function continueSession() {
        document.getElementById('stopAlert')?.remove();
        sessionStopped = false; sessionPnl = 0; sessionOps = 0;
        updatePnlUI();
        log('▶ Sessão continuada! Contadores resetados.', 'info');
        if (!autoTradeEnabled) toggleAutoTrade();
      }

      function stopSession() {
        document.getElementById('stopAlert')?.remove();
        sessionStopped = true; disableAutoTrade();
        log('⏹ Sessão encerrada.', 'warning');
      }

      // ════════════════════════════════════════
      // PROCESS DIGIT
      // ════════════════════════════════════════
      function processDigitSilent(d) {
        digits.push(d); freqMap[d] = (freqMap[d] || 0) + 1;
        const cfg = getStrategyConfig();
        const isWin = cfg.winDigits.includes(d);
        if (isWin) { wins++; currentLossStreak = 0; }
        else { losses++; currentLossStreak++; if (currentLossStreak > maxLossStreak) maxLossStreak = currentLossStreak; }
      }

      // ── CYCLE STATES ──────────────────────────────────────────────────────────
      // IDLE       → monitoring virtual losses, counting toward target
      // TRIGGERED  → target reached, trade sent, waiting for result
      // After result → back to IDLE (win: reset mart) or IDLE (loss: pending mart++)
      // One trade per cycle. No re-entry until next virtual cycle completes.
      // ──────────────────────────────────────────────────────────────────────────
      let cycleState = 'IDLE'; // 'IDLE' | 'TRIGGERED'

      // ── PING ENGINE ─────────────────────────────────
      let pingInterval = null;
      let pingStartTime = 0;
      let currentPing = 0;
      let pingAlertShown = false;
      const PING_GOOD = 200;   // ms — green
      const PING_WARN = 500;   // ms — yellow
      const PING_BAD = 1000;  // ms — red, alert + skip trade

      function startPing() {
        stopPing();
        pingInterval = setInterval(sendPing, 3000); // every 3s
        sendPing(); // immediate first
      }

      function stopPing() {
        clearInterval(pingInterval);
        pingInterval = null;
        pingAlertShown = false;
        // Reset UI
        const dot = $el('pingDot'), box = $el('pingBox'), val = $el('pingVal');
        if (dot) { dot.className = 'ping-dot'; }
        if (box) { box.className = 'ping-box'; }
        if (val) { val.textContent = '—'; }
        hidePingAlert();
      }

      function sendPing() {
        if (!ws || ws.readyState !== 1) return;
        pingStartTime = Date.now();
        try { ws.send(JSON.stringify({ ping: 1 })); } catch (e) { }
      }

      function handlePong() {
        currentPing = Date.now() - pingStartTime;
        updatePingUI(currentPing);
      }

      function updatePingUI(ms) {
        const dot = $el('pingDot');
        const box = $el('pingBox');
        const val = $el('pingVal');
        if (!val) return;
        val.textContent = ms + ' ms';
        let cls, boxCls, label;
        if (ms < PING_GOOD) {
          cls = 'good'; boxCls = 'good';
          val.style.color = 'var(--green)';
          label = 'EXCELENTE';
        } else if (ms < PING_WARN) {
          cls = 'warn'; boxCls = 'warn';
          val.style.color = 'var(--gold)';
          label = 'ACEITÁVEL';
        } else {
          cls = 'bad'; boxCls = 'bad';
          val.style.color = 'var(--red)';
          label = 'ALTO';
        }
        if (dot) { dot.className = 'ping-dot ' + cls; }
        if (box) { box.className = 'ping-box ' + boxCls; box.title = 'Ping: ' + ms + 'ms — ' + label; }
        // Alert if bad
        if (ms >= PING_BAD) {
          showPingAlert(ms);
        } else {
          hidePingAlert();
        }
      }

      function showPingAlert(ms) {
        const el = document.getElementById('pingAlert');
        const msg = document.getElementById('pingAlertMsg');
        if (!el) return;
        if (msg) msg.textContent = 'Ping atual: ' + ms + 'ms — Latência muito alta para operar com segurança';
        el.classList.add('show');
        if (!pingAlertShown) {
          pingAlertShown = true;
          log('🔴 PING CRÍTICO: ' + ms + 'ms — Operações podem ser puladas!', 'error');
        }
      }

      function hidePingAlert() {
        const el = document.getElementById('pingAlert');
        if (el) el.classList.remove('show');
        pingAlertShown = false;
      }

      function isPingOkToTrade() {
        // If no ping measured yet (not connected long), allow
        if (currentPing === 0) return true;
        return currentPing < PING_BAD;
      }

      function processDigit(d) {
        digits.push(d); freqMap[d] = (freqMap[d] || 0) + 1;
        const cfg = getStrategyConfig();
        const isWin = cfg.winDigits.includes(d);
        if (isWin) { wins++; currentLossStreak = 0; }
        else { losses++; currentLossStreak++; if (currentLossStreak > maxLossStreak) maxLossStreak = currentLossStreak; }

        // Chip class determined inline as robot logic runs (captures state before resets)
        let pendingChipClass = 'neutral';
        // If this is the trade digit (first digit after trigger), mark it
        if (window._nextChipIsTrigger) {
          pendingChipClass = 'pending-trigger';
          window._nextChipIsTrigger = false;
        }

        // ── Virtual loss monitoring — only when IDLE (no active trade) ──
        if (cycleState === 'IDLE' && !sessionStopped && autoTradeEnabled) {
          // A win resets the virtual streak — fresh start
          if (isWin) {
            pendingChipClass = 'neutral';
            if (virtualLossStreak > 0) {
              log(`🔁 Streak virtual zerado (dígito ${d} = WIN)`, 'info');
            }
            virtualLossStreak = 0;
          } else {
            virtualLossStreak++;
            const target = getVirtualLossTarget();
            pendingChipClass = 'virt-loss'; // will be overwritten if this is the trigger digit
            log(`👁️ Loss virtual ${virtualLossStreak}/${target} (dígito ${d})`, 'info');

            if (virtualLossStreak >= target) {
              // ── CYCLE TRIGGERED ─────────────────────────────────────────────
              cycleState = 'TRIGGERED';
              robotActivationCount++;
              buildMartTable();

              if (pendingMartingaleLevel > 0) {
                martingaleLevel = pendingMartingaleLevel;
                martingaleEntry = dynamicMartTable[martingaleLevel - 1]?.entry || (selectedRobot?.entry || 1);
                log(`🤖 REATIVADO após ${target} losses virtuais → Nível ${martingaleLevel} — $${parseFloat(martingaleEntry).toFixed(2)}`, 'warning');
                pendingMartingaleLevel = 0;
              } else {
                martingaleLevel = 1;
                martingaleEntry = dynamicMartTable[0]?.entry || (selectedRobot?.entry || 1);
                log(`🤖 ROBÔ ATIVADO! ${target} losses virtuais → Nível 1 — $${parseFloat(martingaleEntry).toFixed(2)}`, 'warning');
              }

              setSignal('entrar', '🚨 ENTRAR AGORA!', `Nível ${martingaleLevel} — $${parseFloat(martingaleEntry).toFixed(2)}`);
              // Trigger digit is the last virtual loss — stays red (virt-loss).
              // The NEXT digit (evaluated by Deriv for the trade) will be marked pending-trigger.
              pendingChipClass = 'virt-loss';
              window._nextChipIsTrigger = true; // flag: next digit = trade digit
              virtualLossStreak = 0;

              if (autoTradeEnabled && !tradeInProgress && !sessionStopped) {
                // AUTO-TRADE ON: send trade, stay TRIGGERED until result comes back
                setTimeout(() => placeTrade(martingaleEntry), 300);
              } else {
                // AUTO-TRADE OFF: just signal, immediately return to IDLE for next cycle
                // User sees the signal but robot doesn't place the trade automatically
                cycleState = 'IDLE';
              }
            }
          }
        }
        // If TRIGGERED: ignore all incoming digits for robot logic — just display them

        updateLastDigit(d);
        updateVdots();
        updateBoletaDisplay();
        // Update freq + OU every digit via rAF (non-blocking); diagnostics every 5 digits
        if (!window._uiUpdatePending) {
          window._uiUpdatePending = true;
          requestAnimationFrame(() => {
            updateFreqGrid();
            updateOUTable();
            if (digits.length % 5 === 0) updateDiagnostics();
            window._uiUpdatePending = false;
          });
        }
        document.getElementById('progressText').textContent = digits.length + ' dígitos';
        document.getElementById('totalDigits').textContent = 'Total: ' + digits.length + ' dígitos';

        // Digit chip coloring based on cycle context
        // chipClass is set BEFORE any streak resets to capture correct state
        const stream = document.getElementById('digitStream');
        const chip = document.createElement('div');
        chip.className = 'digit-chip ' + pendingChipClass;
        chip.textContent = d;
        // If this is the trade digit, store reference to recolor when trade result arrives
        if (pendingChipClass === 'pending-trigger') {
          window._triggerChip = chip;
          chip.className = 'digit-chip virt-loss'; // neutral until result
        }
        stream.appendChild(chip);
        if (stream.children.length > 200) stream.removeChild(stream.firstChild);
        stream.scrollTop = stream.scrollHeight;
      }

      // ════════════════════════════════════════
      // UI UPDATES
      // ════════════════════════════════════════
      function setSignal(cls, text, desc) {
        document.getElementById('robotSignal').className = 'signal-val ' + cls;
        document.getElementById('robotSignal').textContent = text;
        document.getElementById('signalDesc').textContent = desc;
      }

      function updateLastDigit(d) {
        const cfg = getStrategyConfig();
        const isWin = cfg.winDigits.includes(d);
        const el = document.getElementById('lastDigitDisplay');
        el.textContent = d;
        el.style.color = isWin ? 'var(--green)' : 'var(--red)';
        el.style.background = isWin ? 'rgba(0,255,159,.1)' : 'rgba(255,59,107,.1)';
        document.getElementById('lastDigitResult').textContent = isWin ? '✅ WIN' : '❌ LOSS';
        document.getElementById('lastDigitResult').style.color = isWin ? 'var(--green)' : 'var(--red)';
        document.getElementById('lastDigitStrat').textContent = cfg.name + ' (' + cfg.winDigits.join(',') + ')';
      }

      function updateFreqGrid() {
        const total = digits.length;
        const max = Math.max(...Object.values(freqMap), 1);
        document.getElementById('freqGrid').innerHTML = Object.keys(freqMap).map(d => {
          const cnt = freqMap[d] || 0;
          const pct = total > 0 ? (cnt / total * 100).toFixed(1) : 0;
          const barW = total > 0 ? (cnt / max * 100) : 0;
          return `<div class="freq-card">
      <div class="freq-digit">${d}</div>
      <div class="freq-count">${cnt} (${pct}%)</div>
      <div class="freq-bar-wrap"><div class="freq-bar" style="width:${barW}%"></div></div>
    </div>`;
        }).join('');
      }

      // ── ESTRATÉGIAS Over 0-8 com payouts base da Deriv (R_100 Volatility)
      // Payout real é buscado via API — esses valores são fallback inicial
      const FALLBACK_PAYOUTS = {
        over0: 0.055, over1: 0.10, over2: 0.22, over3: 0.43,
        over4: 0.85, over5: 1.50, over6: 2.40, over7: 4.50, over8: 9.00,
        under1: 9.00, under2: 4.50, under3: 2.40, under4: 1.50,
        under5: 0.85, under6: 0.43, under7: 0.22, under8: 0.10, under9: 0.055
      };

      const ALL_STRATEGIES = [
        { key: 'over0', label: 'Over 0', digits: '1–9', winCount: 9 },
        { key: 'over1', label: 'Over 1', digits: '2–9', winCount: 8 },
        { key: 'over2', label: 'Over 2', digits: '3–9', winCount: 7 },
        { key: 'over3', label: 'Over 3', digits: '4–9', winCount: 6 },
        { key: 'over4', label: 'Over 4', digits: '5–9', winCount: 5 },
        { key: 'over5', label: 'Over 5', digits: '6–9', winCount: 4 },
        { key: 'over6', label: 'Over 6', digits: '7–9', winCount: 3 },
        { key: 'over7', label: 'Over 7', digits: '8–9', winCount: 2 },
        { key: 'over8', label: 'Over 8', digits: 'só 9', winCount: 1 },
      ];

      function getEffectivePayout(key) {
        // Prefer live fetched payout, fall back to static table
        return payoutCache[key] ?? FALLBACK_PAYOUTS[key] ?? 0.43;
      }

      function syncMartRefFromBoleta() {
        const entry = parseFloat(document.getElementById('boletaEntry')?.value || 0.35) || 0.35;
        const factor = getMartFactor();
        const levels = getMartLevels();
        const eEl = document.getElementById('martRefEntry');
        const fEl = document.getElementById('martRefFactor');
        const lEl = document.getElementById('martRefLevels');
        if (eEl) eEl.value = entry.toFixed(2);
        if (fEl) fEl.value = factor;
        if (lEl) { const capped = Math.min(Math.max(levels, 3), 8); lEl.value = String(capped); }
        updateMartRefTable();
      }

      // Update a single strategy row's payout cell in real-time
      function updatePayoutCell(stratKey, multiplier) {
        const entry = parseFloat(document.getElementById('martRefEntry')?.value || 0.35) || 0.35;
        const factor = parseFloat(document.getElementById('martRefFactor')?.value || 2.8) || 2.8;
        const LEVELS = parseInt(document.getElementById('martRefLevels')?.value || 5) || 5;

        // Build level amounts
        const levelAmounts = [], levelAccum = [];
        let e = entry, acc = 0;
        for (let i = 0; i < LEVELS; i++) {
          acc += e;
          levelAmounts.push(parseFloat(e.toFixed(2)));
          levelAccum.push(parseFloat(acc.toFixed(2)));
          e *= factor;
        }

        const payout = multiplier;
        const payoutPct = (payout * 100).toFixed(1) + '%';
        const payColor = payout > 1.5 ? 'var(--red)' : payout > 0.5 ? 'var(--gold)' : 'var(--green)';

        // Find the row for this strategy
        const tbody = document.getElementById('martRefBody');
        if (!tbody) return;
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(row => {
          if (row.dataset.stratKey !== stratKey) return;
          const cells = row.querySelectorAll('td');
          if (!cells.length) return;
          // Update payout cell (index 1)
          cells[1].innerHTML = `<span style="color:${payColor};font-weight:700;font-size:12px;">${payoutPct}</span><div style="font-size:9px;color:var(--green);letter-spacing:1px;">●LIVE</div>`;
          // Update profit cells (index 3 onwards — after strat, payout, win%)
          for (let i = 0; i < LEVELS; i++) {
            const cell = cells[i + 3];
            if (!cell) continue;
            const stake = levelAmounts[i];
            const prevAccum = i > 0 ? levelAccum[i - 1] : 0;
            const grossProfit = stake * payout;
            const net = grossProfit - prevAccum;
            const grossStr = '+$' + grossProfit.toFixed(2);
            const netStr = (net >= 0 ? '▲+$' : '▼-$') + Math.abs(net).toFixed(2);
            const netColor = net >= 0 ? 'var(--green)' : 'var(--red)';
            cell.innerHTML = `<div style="color:var(--green);font-size:11px;font-weight:700;">${grossStr}</div><div style="color:${netColor};font-size:9px;">${netStr}</div>`;
          }
        });
      }

      function updateMartRefTable() {
        const tbody = document.getElementById('martRefBody');
        if (!tbody) return;

        // Own inputs — independent of boleta
        const entry = parseFloat(document.getElementById('martRefEntry')?.value || 0.35) || 0.35;
        const factor = parseFloat(document.getElementById('martRefFactor')?.value || 2.8) || 2.8;
        const LEVELS = parseInt(document.getElementById('martRefLevels')?.value || 5) || 5;
        const activeStrat = selectedRobot?.strategy || document.getElementById('manualStrategy')?.value || 'over3';

        // Info label
        const info = document.getElementById('martRefInfo');
        if (info) info.textContent = `Entrada: $${entry.toFixed(2)} · Fator: x${factor} · 5 níveis`;

        // Always build 5 levels regardless of robot config
        const levelAmounts = [], levelAccum = [];
        let e = entry, acc = 0;
        for (let i = 0; i < LEVELS; i++) {
          acc += e;
          levelAmounts.push(parseFloat(e.toFixed(2)));
          levelAccum.push(parseFloat(acc.toFixed(2)));
          e *= factor;
        }

        // Header
        const headerRow = document.querySelector('#martRefTable thead tr');
        if (headerRow) {
          let h = '<th class="strat-col">ESTRATÉGIA</th><th>PAYOUT</th><th>WIN%</th>';
          for (let i = 1; i <= LEVELS; i++) {
            const stakeStr = '$' + levelAmounts[i - 1].toFixed(2);
            h += `<th>N${i}<div style="font-size:8px;color:var(--dim);font-weight:400;">${stakeStr}</div></th>`;
          }
          headerRow.innerHTML = h;
        }

        tbody.innerHTML = ALL_STRATEGIES.map(strat => {
          const payout = getEffectivePayout(strat.key);
          const isLive = payoutCache[strat.key] != null;
          const winPct = ((strat.winCount / 10) * 100).toFixed(0) + '%';
          const payoutPct = (payout * 100).toFixed(0) + '%';
          const isActive = strat.key === activeStrat;
          const payColor = payout > 1.5 ? 'var(--red)' : payout > 0.5 ? 'var(--gold)' : 'var(--green)';

          let cells = '';
          for (let i = 0; i < LEVELS; i++) {
            const stake = levelAmounts[i];
            const prevAccum = i > 0 ? levelAccum[i - 1] : 0;
            const grossProfit = stake * payout;
            // Net profit = gross profit from this bet minus all previous losses
            const net = grossProfit - prevAccum;
            const grossStr = '+$' + grossProfit.toFixed(2);
            const netStr = (net >= 0 ? '▲+$' : '▼-$') + Math.abs(net).toFixed(2);
            const netColor = net >= 0 ? 'var(--green)' : 'var(--red)';
            cells += `<td style="padding:4px 6px;">
        <div style="color:var(--green);font-size:11px;font-weight:700;">${grossStr}</div>
        <div style="color:${netColor};font-size:9px;">${netStr}</div>
      </td>`;
          }

          return `<tr class="${isActive ? 'active-strat' : ''}" data-strat-key="${strat.key}">
      <td class="strat-cell" style="padding:5px 8px;">
        <span style="font-size:12px;">${strat.label}</span>
        <div style="font-size:9px;color:var(--dim);">${strat.digits}</div>
      </td>
      <td style="color:${payColor};font-weight:700;font-size:11px;">
        ${payoutPct}
        ${isLive
              ? '<div style="font-size:9px;color:var(--green);letter-spacing:1px;">●LIVE</div>'
              : '<div style="font-size:9px;color:var(--dim);letter-spacing:1px;">~est.</div>'}
      </td>
      <td style="color:var(--dim);font-size:11px;">${winPct}</td>
      ${cells}
    </tr>`;
        }).join('');
      }

      function updateOUTable() {
        const total = digits.length;
        const ops = [
          { name: 'Over 0', winD: [1, 2, 3, 4, 5, 6, 7, 8, 9] }, { name: 'Over 1', winD: [2, 3, 4, 5, 6, 7, 8, 9] },
          { name: 'Over 2', winD: [3, 4, 5, 6, 7, 8, 9] }, { name: 'Over 3', winD: [4, 5, 6, 7, 8, 9] },
          { name: 'Over 4', winD: [5, 6, 7, 8, 9] }, { name: 'Over 5', winD: [6, 7, 8, 9] },
          { name: 'Over 6', winD: [7, 8, 9] }, { name: 'Over 7', winD: [8, 9] }, { name: 'Over 8', winD: [9] },
          { name: 'Under 1', winD: [0] }, { name: 'Under 2', winD: [0, 1] }, { name: 'Under 3', winD: [0, 1, 2] },
          { name: 'Under 4', winD: [0, 1, 2, 3] }, { name: 'Under 5', winD: [0, 1, 2, 3, 4] },
          { name: 'Under 6', winD: [0, 1, 2, 3, 4, 5] }, { name: 'Under 7', winD: [0, 1, 2, 3, 4, 5, 6] },
          { name: 'Under 8', winD: [0, 1, 2, 3, 4, 5, 6, 7] }, { name: 'Under 9', winD: [0, 1, 2, 3, 4, 5, 6, 7, 8] },
        ];
        const tbody = document.querySelector('#ouTable tbody');
        tbody.innerHTML = ops.map(o => {
          const cnt = o.winD.reduce((s, d) => s + (freqMap[d] || 0), 0);
          const pct = total > 0 ? (cnt / total * 100).toFixed(1) : 0;
          const exp = (o.winD.length / 10 * 100).toFixed(0);
          const diff = total > 0 ? (parseFloat(pct) - parseFloat(exp)) : 0;
          const badge = diff >= 2 ? 'badge-green' : diff <= -2 ? 'badge-red' : 'badge-gold';
          const label = diff >= 2 ? 'ACIMA' : 'ABAIXO DO ESPERADO';
          const isActive = selectedRobot && selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2') === o.name;
          return `<tr ${isActive ? 'style="background:rgba(0,212,255,.05)"' : ''}>
      <td style="font-weight:700;${isActive ? 'color:var(--accent)' : ''}">${o.name}</td>
      <td>${o.winD[0]}–${o.winD[o.winD.length - 1]}</td>
      <td style="color:${parseFloat(pct) >= parseFloat(exp) ? 'var(--green)' : 'var(--red)'};">${total > 0 ? pct + '%' : '—'}</td>
      <td>${total > 50 ? `<span class="badge ${badge}">${pct >= exp ? 'ACIMA' : label}</span>` : '<span style="color:var(--dim)">Coletando...</span>'}</td>
    </tr>`;
        }).join('');
      }

      function updateDiagnostics() {
        const total = digits.length;
        const gridOver = document.getElementById('diagGridOver');
        const gridUnder = document.getElementById('diagGridUnder');
        if (!gridOver || !gridUnder) return;
        const activeStrat = selectedRobot ? selectedRobot.strategy.toUpperCase().replace(/(\D+)(\d+)/, '$1 $2') : '';
        function renderDiagItem(c) {
          const cnt = c.winD.reduce((s, d) => s + (freqMap[d] || 0), 0);
          const pct = total > 0 ? cnt / total * 100 : null;
          const pctD = pct !== null ? pct.toFixed(1) + '%' : '—';
          let color = 'var(--dim)', trend = 'Coletando...';
          if (pct !== null && total > 50) {
            const diff = pct - c.expected;
            if (diff >= 3) { color = 'var(--green)'; trend = '🟢 ACIMA'; }
            else if (diff >= 0) { color = 'var(--accent)'; trend = '🔵 NORMAL'; }
            else if (diff >= -3) { color = 'var(--gold)'; trend = '🟡 ABAIXO'; }
            else { color = 'var(--red)'; trend = '🔴 BEM ABAIXO'; }
          }
          const isActive = c.name === activeStrat;
          return `<div class="diag-item" style="${isActive ? 'border-color:var(--accent);box-shadow:0 0 8px rgba(0,212,255,.2);' : ''}">
      <div class="diag-name" style="${isActive ? 'color:var(--accent);' : ''}">${c.name}</div>
      <div class="diag-exp">${c.digits} · esp:${c.expected.toFixed(0)}%</div>
      <div class="diag-pct" style="color:${color}">${pctD}</div>
      <div class="diag-trend" style="color:${color}">${total > 50 ? trend : 'Coletando...'}</div>
    </div>`;
        }
        const overConfigs = [];
        for (let x = 0; x <= 8; x++) {
          const w = []; for (let d = x + 1; d <= 9; d++) w.push(d);
          overConfigs.push({ name: `OVER ${x}`, winD: w, expected: (9 - x) / 10 * 100, digits: `${x + 1}–9` });
        }
        const underConfigs = [];
        for (let x = 1; x <= 9; x++) {
          const w = []; for (let d = 0; d < x; d++) w.push(d);
          underConfigs.push({ name: `UNDER ${x}`, winD: w, expected: x / 10 * 100, digits: `0–${x - 1}` });
        }
        gridOver.innerHTML = overConfigs.map(renderDiagItem).join('');
        gridUnder.innerHTML = underConfigs.map(renderDiagItem).join('');
      }

      // ════════════════════════════════════════
      // RELATÓRIOS DIÁRIOS
      // ════════════════════════════════════════
      window._reportTrades = [];

      async function addTradeReport(c, isWin, profit) {
        const now = new Date();
        const mktSel = document.getElementById('boletaMarket');
        const mktLabel = mktSel?.options[mktSel?.selectedIndex]?.text || mktSel?.value || '—';
        const entryPrice = c.entry_tick?.value ?? c.entry_spot ?? null;
        const exitPrice = c.exit_tick?.value ?? c.exit_spot ?? null;
        const dur = (c.date_expiry && c.date_start) ? (c.date_expiry - c.date_start) + 's' : '—';
        const trade = {
          date: now.toLocaleDateString('pt-BR'),
          time: now.toLocaleTimeString('pt-BR'),
          market: mktLabel,
          strategy: window._lastStrategy || '—',
          entry: window._lastEntry || 0,
          entryPrice: entryPrice,
          exitPrice: exitPrice,
          duration: dur,
          result: isWin ? 'WIN' : 'LOSS',
          pnl: profit,
          accType: derivAccount?.accType || 'demo',
          martLevel: martingaleLevel
        };
        window._reportTrades.unshift(trade);
        renderReports();
        // ── Persistir no Supabase ──
        if (window._sb && window._alphaUser?.uid) {
          const { error: insErr } = await window._sb.from('trades').insert({
            user_id: window._alphaUser.uid,
            trade_date: trade.date,
            trade_time: trade.time,
            market: trade.market,
            strategy: trade.strategy,
            entry_amount: parseFloat(trade.entry) || 0,
            entry_price: trade.entryPrice != null ? parseFloat(trade.entryPrice) : null,
            exit_price: trade.exitPrice != null ? parseFloat(trade.exitPrice) : null,
            duration: trade.duration,
            result: trade.result,
            pnl: parseFloat(trade.pnl) || 0,
            acc_type: trade.accType,
            mart_level: trade.martLevel || 0
          });
          if (insErr) console.warn('[Trades] insert failed:', insErr.message);
        }
      }

      // ── Relatório do robô Freq. Dígitos ──────
      async function freqAddTradeReport(isWin, profit, martLevel) {
        const now = new Date();
        const strategy = freqTradeMode === 'over' ? 'OVER 6'
                       : freqTradeMode === 'match' ? `MATCH ${freqTradeMatchDigit}`
                       : 'UNDER 3';
        const trade = {
          date: now.toLocaleDateString('pt-BR'),
          time: now.toLocaleTimeString('pt-BR'),
          market: freqMarket,
          strategy: strategy,
          entry: freqGetEntry(martLevel),
          entryPrice: null,
          exitPrice: null,
          duration: '1t',
          result: isWin ? 'WIN' : 'LOSS',
          pnl: profit,
          accType: derivAccount?.accType || 'demo',
          martLevel: martLevel
        };
        window._reportTrades.unshift(trade);
        renderReports();
        if (window._sb && window._alphaUser?.uid) {
          const { error: insErr } = await window._sb.from('trades').insert({
            user_id: window._alphaUser.uid,
            trade_date: trade.date,
            trade_time: trade.time,
            market: trade.market,
            strategy: trade.strategy,
            entry_amount: parseFloat(trade.entry) || 0,
            entry_price: null,
            exit_price: null,
            duration: trade.duration,
            result: trade.result,
            pnl: parseFloat(trade.pnl) || 0,
            acc_type: trade.accType,
            mart_level: trade.martLevel || 0
          });
          if (insErr) console.warn('[FreqTrades] insert failed:', insErr.message);
          else console.log('[FreqTrades] insert OK:', trade.result, trade.pnl);
        } else {
          console.warn('[FreqTrades] Supabase não disponível — _sb:', !!window._sb, '_alphaUser:', !!window._alphaUser);
        }
      }

      function renderReports() {
        const content = document.getElementById('reportsContent');
        const summary = document.getElementById('reportsSummary');
        if (!content) return;
        const trades = window._reportTrades;
        if (!trades.length) {
          content.innerHTML = '<div style="text-align:center;color:var(--dim);font-size:12px;padding:40px;font-family:\'Share Tech Mono\',monospace;">Nenhuma operação registrada nesta sessão.</div>';
          if (summary) summary.innerHTML = '';
          return;
        }
        // Group by date
        const byDate = {};
        trades.forEach(t => { if (!byDate[t.date]) byDate[t.date] = []; byDate[t.date].push(t); });
        const dates = Object.keys(byDate); // newest date first (unshift order)
        // Summary cards for today (first date = most recent)
        const todayTrades = byDate[dates[0]] || [];
        const todayWins = todayTrades.filter(t => t.result === 'WIN').length;
        const todayTotal = todayTrades.length;
        const todayPnl = todayTrades.reduce((s, t) => s + t.pnl, 0);
        const todayRate = todayTotal > 0 ? Math.round(todayWins / todayTotal * 100) : 0;
        const pnlColor = todayPnl >= 0 ? 'var(--green)' : 'var(--red)';
        const pnlSign = todayPnl >= 0 ? '+' : '-';
        if (summary) summary.innerHTML = `
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--dim);letter-spacing:2px;font-family:'Share Tech Mono',monospace;">OPERAÇÕES</div>
      <div style="font-size:26px;font-weight:900;color:var(--accent);">${todayTotal}</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--dim);letter-spacing:2px;font-family:'Share Tech Mono',monospace;">WIN RATE</div>
      <div style="font-size:26px;font-weight:900;color:${pnlColor};">${todayRate}%</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--dim);letter-spacing:2px;font-family:'Share Tech Mono',monospace;">P&L DO DIA</div>
      <div style="font-size:26px;font-weight:900;color:${pnlColor};">${pnlSign}$${Math.abs(todayPnl).toFixed(2)}</div>
    </div>
    <div class="card" style="text-align:center;padding:14px;">
      <div style="font-size:10px;color:var(--dim);letter-spacing:2px;font-family:'Share Tech Mono',monospace;">RESULTADO</div>
      <div style="font-size:22px;font-weight:900;color:${pnlColor};">${todayPnl >= 0 ? '✅ GAIN' : '❌ LOSS'}</div>
    </div>`;
        // Tables per date
        content.innerHTML = dates.map(date => {
          const ts = byDate[date];
          const wins = ts.filter(t => t.result === 'WIN').length;
          const total = ts.length;
          const pnl = ts.reduce((s, t) => s + t.pnl, 0);
          const rate = total > 0 ? Math.round(wins / total * 100) : 0;
          const dp = pnl >= 0;
          return `<div style="margin-bottom:24px;">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid var(--border);">
        <span style="font-size:13px;font-weight:700;font-family:'Share Tech Mono',monospace;color:var(--text);">📅 ${date}</span>
        <span style="font-size:11px;color:var(--dim);">${total} ops</span>
        <span style="font-size:11px;color:${dp ? 'var(--green)' : 'var(--red)'};">⚡ ${rate}% win</span>
        <span style="font-size:12px;font-weight:700;color:${dp ? 'var(--green)' : 'var(--red)'};">${dp ? '+' : '-'}$${Math.abs(pnl).toFixed(2)}</span>
        <span style="font-size:11px;padding:2px 8px;border-radius:4px;font-weight:700;background:${dp ? 'rgba(0,255,159,.15)' : 'rgba(255,59,107,.15)'};color:${dp ? 'var(--green)' : 'var(--red)'};">${dp ? 'GAIN' : 'LOSS'}</span>
      </div>
      <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:11px;font-family:'Share Tech Mono',monospace;">
        <thead>
          <tr style="color:var(--dim);font-size:9px;letter-spacing:1px;">
            <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border);">HORA</th>
            <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border);">MERCADO</th>
            <th style="text-align:left;padding:5px 8px;border-bottom:1px solid var(--border);">ESTRATÉGIA</th>
            <th style="text-align:right;padding:5px 8px;border-bottom:1px solid var(--border);">ENTRADA</th>
            <th style="text-align:right;padding:5px 8px;border-bottom:1px solid var(--border);">PREÇO IN→OUT</th>
            <th style="text-align:right;padding:5px 8px;border-bottom:1px solid var(--border);">DURAÇÃO</th>
            <th style="text-align:center;padding:5px 8px;border-bottom:1px solid var(--border);">CONTA</th>
            <th style="text-align:center;padding:5px 8px;border-bottom:1px solid var(--border);">RESULTADO</th>
            <th style="text-align:right;padding:5px 8px;border-bottom:1px solid var(--border);">P&L</th>
          </tr>
        </thead>
        <tbody>
          ${ts.map(t => {
            const win = t.result === 'WIN';
            const c = win ? 'var(--green)' : 'var(--red)';
            const eP = t.entryPrice ? parseFloat(t.entryPrice).toFixed(2) : '—';
            const xP = t.exitPrice ? parseFloat(t.exitPrice).toFixed(2) : '—';
            const s = t.pnl >= 0 ? '+' : '';
            const isReal = t.accType === 'real';
            const accBadge = isReal ? `<span style="font-size:8px;background:rgba(255,184,0,.2);color:var(--gold);border-radius:3px;padding:1px 5px;">REAL</span>` : `<span style="font-size:8px;background:rgba(0,212,255,.15);color:var(--accent);border-radius:3px;padding:1px 5px;">DEMO</span>`;
            return `<tr style="border-bottom:1px solid rgba(13,58,92,.4);">
              <td style="padding:5px 8px;color:var(--dim);">${t.time}</td>
              <td style="padding:5px 8px;">${t.market}</td>
              <td style="padding:5px 8px;">${t.strategy}</td>
              <td style="padding:5px 8px;text-align:right;">$${parseFloat(t.entry).toFixed(2)}</td>
              <td style="padding:5px 8px;text-align:right;color:var(--dim);">${eP}→${xP}</td>
              <td style="padding:5px 8px;text-align:right;color:var(--dim);">${t.duration}</td>
              <td style="padding:5px 8px;text-align:center;">${accBadge}</td>
              <td style="padding:5px 8px;text-align:center;font-weight:700;color:${c};">${t.result}</td>
              <td style="padding:5px 8px;text-align:right;font-weight:700;color:${c};">${s}$${Math.abs(t.pnl).toFixed(2)}</td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>`;
        }).join('');
      }

      async function loadReportsFromSupabase() {
        const content = document.getElementById('reportsContent');
        if (!window._sb || !window._alphaUser?.uid) {
          renderReports(); return;
        }
        if (content) content.innerHTML = '<div style="text-align:center;color:var(--dim);font-size:12px;padding:40px;font-family:\'Share Tech Mono\',monospace;">⏳ Carregando relatórios...</div>';
        try {
          const { data, error } = await window._sb
            .from('trades')
            .select('*')
            .eq('user_id', window._alphaUser.uid)
            .order('created_at', { ascending: false })
            .limit(1000);
          if (error) throw error;
          window._reportTrades = (data || []).map(r => ({
            date: r.trade_date,
            time: r.trade_time,
            market: r.market,
            strategy: r.strategy,
            entry: r.entry_amount,
            entryPrice: r.entry_price,
            exitPrice: r.exit_price,
            duration: r.duration,
            result: r.result,
            pnl: r.pnl,
            accType: r.acc_type,
            martLevel: r.mart_level
          }));
          renderReports();
        } catch (e) {
          console.warn('[Trades] Supabase load failed:', e.message);
          renderReports();
        }
      }

      async function clearReports() {
        if (!confirm('Limpar TODOS os relatórios? Esta ação é irreversível.')) return;
        if (window._sb && window._alphaUser?.uid) {
          try {
            await window._sb.from('trades').delete().eq('user_id', window._alphaUser.uid);
          } catch (e) { console.warn('[Trades] Supabase delete failed:', e.message); }
        }
        window._reportTrades = [];
        renderReports();
      }

      // ════════════════════════════════════════
      // LOG
      // ════════════════════════════════════════
      function log(msg, type = 'info') {
        const area = document.getElementById('logArea'); if (!area) return;
        const t = new Date().toLocaleTimeString('pt-BR');
        const line = document.createElement('div');
        line.className = `log-line ${type}`;
        line.textContent = `[${t}] ${msg}`;
        area.appendChild(line);
        // Keep max 200 lines — remove oldest when exceeded
        while (area.children.length > 50) area.removeChild(area.firstChild);
        area.scrollTop = area.scrollHeight;
      }

      // ════════════════════════════════════════
      // INIT
      // ════════════════════════════════════════
      // Init form watchers
      ['rfEntry', 'rfFactor', 'rfLevels'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.addEventListener('input', updateMartPreview);
      });

      // ════════════════════════════════════════
      // ROBÔ FREQUÊNCIA DE DÍGITOS
      // ════════════════════════════════════════
      const FREQ_UNDER_DIGITS = [0, 1, 2];          // monitora 0,1,2 → contrato UNDER 3
      const FREQ_OVER_DIGITS = [7, 8, 9];          // monitora 7,8,9 → contrato OVER 6
      const FREQ_UNDER_FACTOR = 1.85;
      const FREQ_OVER_FACTOR = 1.9;
      const FREQ_MAX_LEVELS = 8;
      const FREQ_NEUTROS_DIGITS     = [3, 4, 5, 6]; // grupo monitorado pelo MATCH
      const FREQ_NEUTROS_FACTOR     = 1.3;           // fator conservador com payout ~9x
      const FREQ_NEUTROS_MAX_LEVELS = 17;            // 17 níveis → risco máx ~R$99,77 (base 0,35)
      // Casas decimais por mercado — determina o último dígito da cotação
      const FREQ_DECIMALS = { 'R_10': 3, 'R_25': 3, 'R_50': 4, 'R_75': 4, 'R_100': 2 };
      function freqGetLastDigit(price, market) {
        const d = FREQ_DECIMALS[market] || 2;
        return Math.round(parseFloat(price) * Math.pow(10, d)) % 10;
      }

      let freqWs = null;
      let freqMarket = 'R_10';
      let freqBuffer = [];       // últimos 25 dígitos
      let freqAnalysisSize = 10;       // tamanho usado pelo robô: 10 ou 25
      let freqTotalDigits = 0;        // contador total de dígitos recebidos
      let freqTicksSubscribed = false;    // flag: tick subscription ativa no freqWs
      let freqRobotActive = false;
      let freqTradeActive = false;
      let freqCurrentContractId = null;
      let freqMode = null;          // 'under' | 'over' | 'match' | null
      let freqStrategy = 'extremos'; // 'extremos' | 'neutros'
      let freqMatchDigit = null;     // dígito alvo do DIGITMATCH (3|4|5|6 | null)
      let freqTradeMode = null;      // mode capturado na entrada (para relatório)
      let freqTradeMatchDigit = null; // freqMatchDigit capturado na entrada
      let freqMartLevel = 0;        // 0 = base, 1..5 = martingale
      let freqSessionWins = 0;
      let freqSessionLosses = 0;
      let freqSessionPnl = 0;
      let freqProcessedContracts = new Set();
      let freqTickHandledId = null; // ID do contrato já resolvido pelo tick (POC só faz P&L)
      let freqTickHandledMartLevel = 0;    // nível da trade encerrada pelo tick (imune a sobrescrita)
      let freqEntryTick = 0;    // freqTotalDigits no momento da entrada
      let freqTradeMartLevel = 0;    // nível martingale no momento da entrada (para relatório)

      // ── Mercado ──────────────────────────────
      function freqSelectMarket(sym, btn) {
        freqMarket = sym;
        document.querySelectorAll('#freqMarketBtns button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        freqBuffer = [];
        freqResetStream();
        freqRenderChart();
        if (freqWs && freqWs.readyState === 1) {
          // Cancela ticks do mercado anterior e recarrega histórico do novo
          freqTicksSubscribed = false;
          freqWs.send(JSON.stringify({ forget_all: 'ticks' }));
          freqWs.send(JSON.stringify({ ticks_history: freqMarket, count: 30, end: 'latest', style: 'ticks' }));
        }
      }

      // ── Inicializa WS de gráfico (visualização, sem trading) ──
      function freqInitChart() {
        freqRenderChart();
        if (freqWs && freqWs.readyState <= 1) return; // já conectado
        freqTicksSubscribed = false;
        freqWs = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${DERIV_APP_ID}`);
        freqWs.onopen = () => {
          document.getElementById('freqConnStatus').textContent = '⬤ Conectado';
          document.getElementById('freqConnStatus').style.color = 'var(--green)';
          // Carrega histórico primeiro; ticks live só após buffer populado
          freqWs.send(JSON.stringify({ ticks_history: freqMarket, count: 30, end: 'latest', style: 'ticks' }));
        };
        freqWs.onclose = () => {
          document.getElementById('freqConnStatus').textContent = '⬤ Desconectado';
          document.getElementById('freqConnStatus').style.color = 'var(--dim)';
          freqTicksSubscribed = false;
        };
        freqWs.onmessage = freqHandleMsg;
      }

      // ── Handler de mensagens WS ──────────────
      function freqHandleMsg(evt) {
        const data = JSON.parse(evt.data);
        if (data.error) return; // ignora erros silenciosamente
        if (data.msg_type === 'authorize') {
          // Após auth: pede histórico se ticks ainda não estiverem fluindo
          if (!freqTicksSubscribed) {
            freqWs.send(JSON.stringify({ ticks_history: freqMarket, count: 30, end: 'latest', style: 'ticks' }));
          }
        }
        if (data.msg_type === 'history') {
          // Pré-popula buffer com histórico → garante que robô começa com dados prontos
          const prices = data.history?.prices || [];
          const recent = prices.slice(-25);
          freqBuffer = recent.map(p => freqGetLastDigit(parseFloat(p), freqMarket));
          freqRenderChart(true); // force=true: ignora throttle no carregamento inicial
          // Só agora assina ticks live
          if (!freqTicksSubscribed) {
            freqWs.send(JSON.stringify({ ticks: freqMarket, subscribe: 1 }));
          }
        }
        if (data.msg_type === 'tick') {
          freqTicksSubscribed = true; // confirma que ticks estão ativos
          freqOnTick(data.tick);
        }
        if (data.msg_type === 'buy') freqHandleBuy(data);
        if (data.msg_type === 'proposal_open_contract') freqHandleContract(data);
      }

      // ── Processa cada tick ───────────────────
      function freqOnTick(tick) {
        if (!tick || tick.quote == null) return;
        const lastDigit = freqGetLastDigit(tick.quote, freqMarket);
        freqBuffer.push(lastDigit);
        if (freqBuffer.length > 25) freqBuffer.shift();
        freqTotalDigits++;
        freqRenderChart();
        freqUpdateStream(lastDigit);
        if (freqRobotActive && freqBuffer.length >= freqAnalysisSize) {
          if (freqMode && freqTradeActive && freqTotalDigits > freqEntryTick) {
            // Tick de resolução do contrato 1-tick: calcula resultado agora sem esperar POC
            freqResolveOnTick(lastDigit);
          } else if (!freqTradeActive) {
            freqCheckEntry();
          }
        }
      }

      // ── Atualiza stream de dígitos ────────────
      let _freqLastStream = 0;
      function freqUpdateStream(d) {
        const isUnder = FREQ_UNDER_DIGITS.includes(d);
        const isOver = FREQ_OVER_DIGITS.includes(d);

        // Box grande: atualiza sempre (operação barata — essencial para parecer vivo)
        const box = document.getElementById('freqLastDigitBox');
        const result = document.getElementById('freqLastDigitResult');
        const total = document.getElementById('freqTotalDigits');
        if (box) {
          box.textContent = d;
          if (isUnder) { box.style.background = 'rgba(74,222,128,.15)'; box.style.color = 'var(--fq-under)'; }
          else if (isOver) { box.style.background = 'rgba(96,165,250,.15)'; box.style.color = 'var(--fq-over)'; }
          else { box.style.background = 'var(--fq-surface2)'; box.style.color = 'var(--fq-dim)'; }
        }
        if (result) {
          if (isUnder) { result.textContent = '✅ UNDER 3'; result.style.color = 'var(--fq-under)'; }
          else if (isOver) { result.textContent = '✅ OVER 6'; result.style.color = 'var(--fq-over)'; }
          else { result.textContent = '— NEUTRO (' + d + ')'; result.style.color = 'var(--fq-dim)'; }
        }
        if (total) total.textContent = freqTotalDigits.toLocaleString('pt-BR');

        // Chips no stream: throttle 200ms — evita flood de DOM em V100 (100 ticks/s)
        const now = Date.now();
        if (now - _freqLastStream < 200) return;
        _freqLastStream = now;

        const stream = document.getElementById('freqDigitStream');
        if (!stream) return;
        const prev = stream.querySelector('.freq-latest');
        if (prev) prev.classList.remove('freq-latest');
        const chip = document.createElement('div');
        chip.textContent = d;
        chip.className = 'digit-chip ' + (isUnder ? 'win' : isOver ? 'freq-over' : 'neutral') + ' freq-latest';
        stream.appendChild(chip);
        if (stream.children.length > 60) stream.removeChild(stream.firstChild);
        stream.scrollTop = stream.scrollHeight;
      }

      // ── Reseta stream ─────────────────────────
      function freqResetStream() {
        freqTotalDigits = 0;
        const stream = document.getElementById('freqDigitStream');
        if (stream) stream.innerHTML = '';
        const box = document.getElementById('freqLastDigitBox');
        if (box) { box.textContent = '—'; box.style.background = 'var(--fq-surface2)'; box.style.color = 'var(--fq-dim)'; }
        const result = document.getElementById('freqLastDigitResult');
        if (result) { result.textContent = '—'; result.style.color = 'var(--fq-dim)'; }
        const total = document.getElementById('freqTotalDigits');
        if (total) total.textContent = '0';
      }

      // ── Calcula frequência dos últimos N dígitos ─
      function freqCalcFreq(n) {
        const slice = n ? freqBuffer.slice(-n) : freqBuffer;
        const c = {};
        for (let i = 0; i <= 9; i++) c[i] = 0;
        slice.forEach(d => c[d]++);
        return { counts: c, total: slice.length };
      }

      // ── Renderiza chips de dígitos ──
      function freqRenderBars(elId, n) {
        const barsEl = document.getElementById(elId);
        if (!barsEl) return;
        const { counts, total } = freqCalcFreq(n);
        const ready = freqBuffer.length >= n;
        const threshold = parseFloat(document.getElementById('freqHotThreshold')?.value || 40) / 100;
        let html = '';
        for (let d = 0; d <= 9; d++) {
          const pct = total > 0 ? Math.round((counts[d] / total) * 100) : 0;
          const isUnder = FREQ_UNDER_DIGITS.includes(d);
          const isOver = FREQ_OVER_DIGITS.includes(d);
          const isZero = ready && counts[d] === 0;
          const isHot = ready && !isZero && total > 0 && (counts[d] / total) >= threshold;
          let cls = 'fq-chip ';
          if (isZero) cls += 'chip-zero';
          else if (isHot) cls += 'chip-hot';
          else if (isUnder) cls += 'chip-under';
          else if (isOver) cls += 'chip-over';
          else cls += 'chip-neutral';
          html += `<div class="${cls}">
      <div class="fq-chip-num">${d}</div>
      <div class="fq-chip-pct">${ready ? pct + '%' : '—'}</div>
    </div>`;
        }
        barsEl.innerHTML = html;
      }

      // ── Renderiza só o gráfico ativo (throttled a 250ms p/ V100) ──
      let _freqLastRender = 0;
      function freqRenderChart(force) {
        const now = Date.now();
        if (!force && now - _freqLastRender < 250) return;
        _freqLastRender = now;
        freqRenderBars('freqBars' + freqAnalysisSize, freqAnalysisSize);
        const { counts, total } = freqCalcFreq(freqAnalysisSize);
        freqUpdateCards(counts, total, freqBuffer.length >= freqAnalysisSize);
      }

      // ── Alterna tamanho de análise do robô ───
      function freqSetSize(n) {
        if (freqRobotActive) return; // não muda durante operação
        freqAnalysisSize = n;
        freqBuffer = [];
        freqResetStream();
        document.getElementById('freqBtnSize10').classList.toggle('active', n === 10);
        document.getElementById('freqBtnSize25').classList.toggle('active', n === 25);
        // Mostra só o gráfico correspondente
        document.getElementById('freqChart10Wrap').style.display = n === 10 ? 'block' : 'none';
        document.getElementById('freqChart25Wrap').style.display = n === 25 ? 'block' : 'none';
        freqRenderChart();
      }

      // ── Alterna estratégia: EXTREMOS ↔ NEUTROS MATCH ──
      function freqSetStrategy(strat) {
        if (freqRobotActive) { freqLog('⚠️ Pare o robô antes de trocar a estratégia.', 'warning'); return; }
        freqStrategy = strat;
        freqMatchDigit = null;
        document.getElementById('freqBtnExtremus').classList.toggle('active', strat === 'extremos');
        document.getElementById('freqBtnNeutros').classList.toggle('active', strat === 'neutros');
        if (strat === 'extremos') {
          document.getElementById('freqCardUnderTitle').textContent = '📉 UNDER 3';
          document.getElementById('freqCardUnderInfo').innerHTML = 'Monitora: <span style="color:var(--fq-under);">0, 1, 2</span> &nbsp;|&nbsp; Ganha se dígito ∈ {0,1,2}';
          document.getElementById('freqCardOverTitle').textContent = '📈 OVER 6';
          document.getElementById('freqCardOverInfo').innerHTML = 'Monitora: <span style="color:var(--fq-over);">7, 8, 9</span> &nbsp;|&nbsp; Ganha se dígito ∈ {7,8,9}';
        } else {
          document.getElementById('freqCardUnderTitle').textContent = '🎯 MATCH [3-6]';
          document.getElementById('freqCardUnderInfo').innerHTML = 'Monitora: <span style="color:var(--fq-under);">3, 4, 5, 6</span> &nbsp;|&nbsp; DIGITMATCH no dígito em 0%';
          document.getElementById('freqCardOverTitle').textContent = '🎯 ALVO';
          document.getElementById('freqCardOverInfo').innerHTML = 'Dígito alvo: <span id="freqMatchTarget" style="color:var(--fq-over);font-family:\'Share Tech Mono\',monospace;">—</span>';
        }
        const cfgInputs = document.getElementById('freqConfigInputs');
        if (cfgInputs) cfgInputs.style.display = strat === 'neutros' ? 'none' : '';
        freqLog(`🔄 Estratégia: ${strat === 'extremos' ? '⚡ EXTREMOS' : '🎯 NEUTROS MATCH'}`, 'info');
        freqMode = null;
        const { counts, total } = freqCalcFreq(freqAnalysisSize);
        freqUpdateCards(counts, total, total >= freqAnalysisSize);
        freqUpdateLevelDisplay();
      }

      // ── Atualiza info cards UNDER / OVER ─────
      function freqUpdateCards(counts, total, ready) {
        // ── NEUTROS MATCH: exibe análise do grupo [3-6] com as 3 condições ──
        if (freqStrategy === 'neutros') {
          const uZeroEl = document.getElementById('freqUnderZeroDigit');
          const uBadge  = document.getElementById('freqBadgeUnder');
          const uCard   = document.getElementById('freqCardUnder');
          const oZeroEl = document.getElementById('freqOverZeroDigit');
          const oBadge  = document.getElementById('freqBadgeOver');
          const oCard   = document.getElementById('freqCardOver');
          const matchTargetEl = document.getElementById('freqMatchTarget');

          if (freqMode === 'match') {
            // Trade ativa: exibe dígito alvo e pausa o OVER card
            if (uZeroEl) uZeroEl.textContent = freqMatchDigit ?? '—';
            if (uBadge)  { uBadge.textContent = '⚡ MATCH'; uBadge.className = 'freq-status-badge sinal'; }
            if (uCard)   { uCard.classList.add('active'); uCard.style.opacity = '1'; }
            if (oZeroEl) oZeroEl.textContent = freqMatchDigit ?? '—';
            if (oBadge)  { oBadge.textContent = '⏸ PAUSADO'; oBadge.className = 'freq-status-badge aguard'; }
            if (oCard)   { oCard.classList.remove('active'); oCard.style.opacity = '0.45'; }
            if (matchTargetEl) matchTargetEl.textContent = freqMatchDigit ?? '—';
          } else if (!ready || total === 0) {
            [uZeroEl, oZeroEl].forEach(el => { if (el) el.textContent = '—'; });
            [uBadge, oBadge].forEach(el => { if (el) { el.textContent = 'AGUARDANDO'; el.className = 'freq-status-badge aguard'; } });
            [uCard, oCard].forEach(el => { if (el) { el.classList.remove('active'); el.style.opacity = '1'; } });
            if (matchTargetEl) matchTargetEl.textContent = '—';
          } else {
            // Verifica as 3 condições (espelha freqCheckEntry)
            const neutZeros = FREQ_NEUTROS_DIGITS.filter(d => counts[d] === 0);
            const underHasZero = FREQ_UNDER_DIGITS.some(d => counts[d] === 0);
            const overHasZero  = FREQ_OVER_DIGITS.some(d => counts[d] === 0);
            const uGrp = FREQ_UNDER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;
            const oGrp = FREQ_OVER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;
            const qualifies = neutZeros.length === 1 && !underHasZero && !overHasZero && uGrp >= 0.20 && oGrp >= 0.20;

            if (qualifies) {
              if (uZeroEl) uZeroEl.textContent = neutZeros[0];
              if (uBadge)  { uBadge.textContent = '⚡ SINAL'; uBadge.className = 'freq-status-badge sinal'; }
              if (uCard)   { uCard.classList.add('active'); uCard.style.opacity = '1'; }
              if (oZeroEl) oZeroEl.textContent = neutZeros[0];
              if (oBadge)  { oBadge.textContent = '🎯 ALVO'; oBadge.className = 'freq-status-badge sinal'; }
              if (oCard)   { oCard.classList.add('active'); oCard.style.opacity = '1'; }
              if (matchTargetEl) matchTargetEl.textContent = neutZeros[0];
            } else {
              // Mostra o dígito em 0% (se houver) mas sem SINAL pois condições não completas
              const display = neutZeros.length > 0 ? neutZeros.join(', ') : '—';
              if (uZeroEl) uZeroEl.textContent = display;
              if (uBadge)  { uBadge.textContent = 'AGUARDANDO'; uBadge.className = 'freq-status-badge aguard'; }
              if (uCard)   { uCard.classList.remove('active'); uCard.style.opacity = '1'; }
              if (oZeroEl) oZeroEl.textContent = '—';
              if (oBadge)  { oBadge.textContent = 'AGUARDANDO'; oBadge.className = 'freq-status-badge aguard'; }
              if (oCard)   { oCard.classList.remove('active'); oCard.style.opacity = '1'; }
              if (matchTargetEl) matchTargetEl.textContent = '—';
            }
          }
          return;
        }

        // Usa as mesmas condições do freqCheckEntry() para evitar falsos positivos visuais
        const threshold = parseFloat($el('freqHotThreshold')?.value || 40) / 100;
        const oppMin = parseFloat($el('freqOppMinThreshold')?.value || 20) / 100;

        const underZeros = ready ? FREQ_UNDER_DIGITS.filter(d => counts[d] === 0) : [];
        const overZeros = ready ? FREQ_OVER_DIGITS.filter(d => counts[d] === 0) : [];
        const underHot = ready && total > 0 ? FREQ_UNDER_DIGITS.filter(d => counts[d] / total >= threshold) : [];
        const overHot = ready && total > 0 ? FREQ_OVER_DIGITS.filter(d => counts[d] / total >= threshold) : [];
        const underGroupPct = total > 0 ? FREQ_UNDER_DIGITS.reduce((s, d) => s + counts[d], 0) / total : 0;
        const overGroupPct = total > 0 ? FREQ_OVER_DIGITS.reduce((s, d) => s + counts[d], 0) / total : 0;

        const underQualifies = underZeros.length === 1 && underHot.length >= 1 && overGroupPct >= oppMin;
        const overQualifies = overZeros.length === 1 && overHot.length >= 1 && underGroupPct >= oppMin;
        const ambiguous = underQualifies && overQualifies;

        // UNDER card
        const uZeroEl = document.getElementById('freqUnderZeroDigit');
        const uBadge = document.getElementById('freqBadgeUnder');
        const uCard = document.getElementById('freqCardUnder');

        if (freqMode === 'over') {
          uZeroEl.textContent = '—';
          uBadge.textContent = '⏸ PAUSADO'; uBadge.className = 'freq-status-badge aguard';
          uCard.classList.remove('active');
          uCard.style.opacity = '0.45';
        } else {
          uCard.style.opacity = '1';
          if (!ready) {
            uZeroEl.textContent = '—'; uBadge.textContent = 'AGUARDANDO'; uBadge.className = 'freq-status-badge aguard'; uCard.classList.remove('active');
          } else if (ambiguous) {
            uZeroEl.textContent = underZeros[0];
            uBadge.textContent = '⚠️ DUPLO'; uBadge.className = 'freq-status-badge duplo';
            uCard.classList.remove('active');
          } else if (underQualifies) {
            uZeroEl.textContent = underZeros[0];
            uBadge.textContent = '⚡ SINAL'; uBadge.className = 'freq-status-badge sinal';
            uCard.classList.add('active');
          } else if (underZeros.length > 1) {
            uZeroEl.textContent = underZeros.join(', ');
            uBadge.textContent = '⚠️ DUPLO'; uBadge.className = 'freq-status-badge duplo';
            uCard.classList.remove('active');
          } else {
            uZeroEl.textContent = underZeros.length === 1 ? underZeros[0] : '—';
            uBadge.textContent = 'AGUARDANDO'; uBadge.className = 'freq-status-badge aguard';
            uCard.classList.remove('active');
          }
        }

        // OVER card
        const oZeroEl = document.getElementById('freqOverZeroDigit');
        const oBadge = document.getElementById('freqBadgeOver');
        const oCard = document.getElementById('freqCardOver');

        if (freqMode === 'under') {
          oZeroEl.textContent = '—';
          oBadge.textContent = '⏸ PAUSADO'; oBadge.className = 'freq-status-badge aguard';
          oCard.classList.remove('active');
          oCard.style.opacity = '0.45';
        } else {
          oCard.style.opacity = '1';
          if (!ready) {
            oZeroEl.textContent = '—'; oBadge.textContent = 'AGUARDANDO'; oBadge.className = 'freq-status-badge aguard'; oCard.classList.remove('active');
          } else if (ambiguous) {
            oZeroEl.textContent = overZeros[0];
            oBadge.textContent = '⚠️ DUPLO'; oBadge.className = 'freq-status-badge duplo';
            oCard.classList.remove('active');
          } else if (overQualifies) {
            oZeroEl.textContent = overZeros[0];
            oBadge.textContent = '⚡ SINAL'; oBadge.className = 'freq-status-badge sinal';
            oCard.classList.add('active');
          } else if (overZeros.length > 1) {
            oZeroEl.textContent = overZeros.join(', ');
            oBadge.textContent = '⚠️ DUPLO'; oBadge.className = 'freq-status-badge duplo';
            oCard.classList.remove('active');
          } else {
            oZeroEl.textContent = overZeros.length === 1 ? overZeros[0] : '—';
            oBadge.textContent = 'AGUARDANDO'; oBadge.className = 'freq-status-badge aguard';
            oCard.classList.remove('active');
          }
        }

        freqUpdateLevelDisplay();
      }

      // ── Label de nível: nível 0 = "Entrada", 1+ = "Gale X" ──
      const FREQ_MAX_GALES = FREQ_MAX_LEVELS - 1; // 7 gales máx (nível 0 é a entrada base)
      function freqLevelLabel(level) {
        return level === 0 ? 'Entrada' : `Gale ${level}`;
      }

      // ── Calcula entrada com martingale ───────
      function freqGetEntry(level) {
        const base = parseFloat(document.getElementById('freqEntry')?.value || 0.35);
        const factor = freqMode === 'match' ? FREQ_NEUTROS_FACTOR
                     : (freqMode === 'over') ? FREQ_OVER_FACTOR : FREQ_UNDER_FACTOR;
        let amt = base;
        for (let i = 0; i < level; i++) amt *= factor;
        return parseFloat(amt.toFixed(2));
      }

      // ── Atualiza display de nível/entrada ────
      function freqUpdateLevelDisplay() {
        const uLevel = document.getElementById('freqUnderLevel');
        const oLevel = document.getElementById('freqOverLevel');
        const uNext = document.getElementById('freqUnderNextEntry');
        const oNext = document.getElementById('freqOverNextEntry');
        const base = parseFloat(document.getElementById('freqEntry')?.value || 0.35);

        if (freqMode === 'under') {
          if (uLevel) uLevel.textContent = freqLevelLabel(freqMartLevel) + ' / ' + FREQ_MAX_GALES + ' gales';
          if (uNext) uNext.textContent = '$' + freqGetEntry(freqMartLevel).toFixed(2);
          if (oLevel) oLevel.textContent = 'Entrada / ' + FREQ_MAX_GALES + ' gales';
          if (oNext) oNext.textContent = '$' + base.toFixed(2);
        } else if (freqMode === 'over') {
          if (oLevel) oLevel.textContent = freqLevelLabel(freqMartLevel) + ' / ' + FREQ_MAX_GALES + ' gales';
          if (oNext) oNext.textContent = '$' + freqGetEntry(freqMartLevel).toFixed(2);
          if (uLevel) uLevel.textContent = 'Entrada / ' + FREQ_MAX_GALES + ' gales';
          if (uNext) uNext.textContent = '$' + base.toFixed(2);
        } else if (freqMode === 'match') {
          const maxG = FREQ_NEUTROS_MAX_LEVELS - 1;
          if (uLevel) uLevel.textContent = freqLevelLabel(freqMartLevel) + ' / ' + maxG + ' gales';
          if (uNext) uNext.textContent = '$' + freqGetEntry(freqMartLevel).toFixed(2);
          if (oLevel) oLevel.textContent = freqMatchDigit !== null ? 'Alvo: ' + freqMatchDigit : '—';
          if (oNext) oNext.textContent = '—';
        } else {
          if (uLevel) uLevel.textContent = 'Entrada / ' + FREQ_MAX_GALES + ' gales';
          if (oLevel) oLevel.textContent = 'Entrada / ' + FREQ_MAX_GALES + ' gales';
          if (uNext) uNext.textContent = '$' + base.toFixed(2);
          if (oNext) oNext.textContent = '$' + base.toFixed(2);
        }
      }

      // ── Resolve contrato 1-tick diretamente pelo dígito (sem esperar POC) ────────
      function freqResolveOnTick(digit) {
        const isWin = freqMode === 'under' ? FREQ_UNDER_DIGITS.includes(digit)
          : freqMode === 'over' ? FREQ_OVER_DIGITS.includes(digit)
          : freqMode === 'match' ? digit === freqMatchDigit
          : false;
        // Marca como resolvido pelo tick → POC só fará atualização de P&L exato
        freqTickHandledId = freqCurrentContractId;
        freqTickHandledMartLevel = freqTradeMartLevel; // salva antes de freqEnterTrade sobrescrever
        if (freqCurrentContractId) freqProcessedContracts.add(freqCurrentContractId);
        freqTradeActive = false;
        freqCurrentContractId = null;

        if (isWin) {
          try { playWin(); } catch (e) { }
          freqSessionWins++;
          freqUpdateStats();
          freqMode = null;
          freqMatchDigit = null;
          freqMartLevel = 0;
          freqUpdateOpIndicator();
          freqLog(`🏆 WIN | aguardando P&L exato do servidor...`, 'success');
          // freqShowResult chamado no freqHandleContract após P&L ser somado
        } else {
          try { playLoss(); } catch (e) { }
          freqSessionLosses++;
          freqUpdateStats();
          freqMartLevel++;
          // Pinta o chip do dígito de resolução em vermelho
          const latestChip = document.querySelector('#freqDigitStream .freq-latest');
          if (latestChip) latestChip.classList.add('gale-loss');
          const statusEl = document.getElementById('freqStatusTxt');
          if (statusEl) statusEl.textContent = `❌ PERDEU — ${freqLevelLabel(freqMartLevel)} próximo`;
          freqLog(`💸 LOSS | ${freqLevelLabel(freqMartLevel)} ($${freqGetEntry(freqMartLevel).toFixed(2)}) | P&L atualizado em breve...`, 'error');
          // Verifica Stop Loss estimado com base na stake perdida
          const lostStake = freqGetEntry(freqMartLevel - 1);
          const estimatedPnl = freqSessionPnl - lostStake;
          const sl = parseFloat(document.getElementById('freqSL')?.value || 5);
          if (estimatedPnl <= -sl) {
            freqLog(`🛑 STOP LOSS estimado atingido (~$${Math.abs(estimatedPnl).toFixed(2)})`, 'error');
            freqClockStop('loss'); freqOpClockStop('loss', `-$${freqOpTotalStaked.toFixed(2)}`);
            freqShowResult('loss');
            freqRobotActive = false;
            freqSetToggleBtn(false);
            return;
          }
          const _maxLvl = freqMode === 'match' ? FREQ_NEUTROS_MAX_LEVELS : FREQ_MAX_LEVELS;
          if (freqMartLevel >= _maxLvl) {
            freqLog(`🚨 STOP MARTINGALE — nível máximo atingido`, 'error');
            freqMode = null; freqMatchDigit = null;
            freqClockStop('martingale'); freqOpClockStop('martingale', `-$${freqOpTotalStaked.toFixed(2)}`);
            freqShowResult('martingale');
            freqRobotActive = false;
            freqSetToggleBtn(false);
            return;
          }
          freqUpdateLevelDisplay();
          freqUpdateOpIndicator();
          freqEnterTrade(freqMode); // re-entra IMEDIATAMENTE no mesmo tick
        }
      }

      // ── Verifica condição de entrada ─────────
      function freqCheckEntry() {
        if (!freqRobotActive || freqTradeActive) return;

        // ── Em cadeia ativa (pós-loss): entra imediatamente no próximo tick ──
        if (freqMode === 'under') { freqEnterTrade('under'); return; }
        if (freqMode === 'over') { freqEnterTrade('over'); return; }
        if (freqMode === 'match') {
          if (freqMartLevel >= FREQ_NEUTROS_MAX_LEVELS) {
            freqLog(`🛑 NEUTROS MATCH — limite de ${FREQ_NEUTROS_MAX_LEVELS} níveis atingido`, 'error');
            freqMode = null; freqMatchDigit = null; freqTradeActive = false;
            return;
          }
          freqEnterTrade('match');
          return;
        }

        // ── Estado neutro: avalia gatilho com filtro de dígito quente ──
        const { counts, total } = freqCalcFreq(freqAnalysisSize);
        if (total === 0) return;

        const threshold = parseFloat($el('freqHotThreshold')?.value || 40) / 100;
        const oppMin = parseFloat($el('freqOppMinThreshold')?.value || 20) / 100;

        // ── NEUTROS MATCH: avalia dígitos [3,4,5,6] — 3 condições obrigatórias ──
        if (freqStrategy === 'neutros') {
          // Cond. 1: exatamente 1 dígito de [3,4,5,6] em 0%
          const neutZeros = FREQ_NEUTROS_DIGITS.filter(d => counts[d] === 0);
          if (neutZeros.length !== 1) return;
          // Cond. 2: nenhum dígito dos extremos em 0%
          const underHasZero = FREQ_UNDER_DIGITS.some(d => counts[d] === 0);
          const overHasZero  = FREQ_OVER_DIGITS.some(d => counts[d] === 0);
          if (underHasZero || overHasZero) return;
          // Cond. 3: soma de frequência de cada grupo extremo > 20%
          const uGrpPct = FREQ_UNDER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;
          const oGrpPct = FREQ_OVER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;
          if (uGrpPct < 0.20 || oGrpPct < 0.20) return;
          // Todas as condições satisfeitas → entra
          freqMatchDigit = neutZeros[0];
          freqMode = 'match';
          freqMartLevel = 0;
          freqLog(`🎯 NEUTROS MATCH — dígito ${neutZeros[0]} em 0% | UNDER:${Math.round(uGrpPct*100)}% OVER:${Math.round(oGrpPct*100)}%`, 'warning');
          freqEnterTrade('match');
          return;
        }

        // Frequência total de cada grupo (soma dos 3 dígitos / total de ticks)
        const underGroupPct = FREQ_UNDER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;
        const overGroupPct = FREQ_OVER_DIGITS.reduce((s, d) => s + counts[d], 0) / total;

        // Under: exatamente 1 dígito do grupo (0,1,2) em 0%
        //        E pelo menos 1 outro dígito do mesmo grupo acima do threshold
        //        E grupo OVER não está excessivamente frio (evita correção para over)
        const underZeros = FREQ_UNDER_DIGITS.filter(d => counts[d] === 0);
        const underHot = FREQ_UNDER_DIGITS.filter(d => counts[d] / total >= threshold);
        const underQualifies = underZeros.length === 1 && underHot.length >= 1 && overGroupPct >= oppMin;

        // Over: exatamente 1 dígito do grupo (7,8,9) em 0%
        //       E pelo menos 1 outro dígito do mesmo grupo acima do threshold
        //       E grupo UNDER não está excessivamente frio (evita correção para under)
        const overZeros = FREQ_OVER_DIGITS.filter(d => counts[d] === 0);
        const overHot = FREQ_OVER_DIGITS.filter(d => counts[d] / total >= threshold);
        const overQualifies = overZeros.length === 1 && overHot.length >= 1 && underGroupPct >= oppMin;

        // Ambos qualificam → mercado ambíguo, aguarda
        if (underQualifies && overQualifies) return;

        if (underQualifies) {
          freqMode = 'under'; freqMartLevel = 0;
          const hotPct = Math.round(counts[underHot[0]] / total * 100);
          const overOppPct = Math.round(overGroupPct * 100);
          freqLog(`🎯 Gatilho UNDER 3 — dígito ${underZeros[0]} em 0% | dígito ${underHot[0]} em ${hotPct}% | over oposto: ${overOppPct}%`, 'warning');
          freqEnterTrade('under');
        } else if (overQualifies) {
          freqMode = 'over'; freqMartLevel = 0;
          const hotPct = Math.round(counts[overHot[0]] / total * 100);
          const underOppPct = Math.round(underGroupPct * 100);
          freqLog(`🎯 Gatilho OVER 6 — dígito ${overZeros[0]} em 0% | dígito ${overHot[0]} em ${hotPct}% | under oposto: ${underOppPct}%`, 'warning');
          freqEnterTrade('over');
        }
        // Nenhum qualifica → aguarda próximo tick
      }

      // ── Som de entrada ────────────────────────
      function playFreqEntry() {
        try {
          [0, 0.13].forEach((d, i) => {
            const o = audioCtx.createOscillator(), g = audioCtx.createGain();
            o.connect(g); g.connect(audioCtx.destination);
            o.type = 'sine'; o.frequency.setValueAtTime(i ? 1100 : 800, audioCtx.currentTime + d);
            g.gain.setValueAtTime(0.25, audioCtx.currentTime + d);
            g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + d + 0.18);
            o.start(audioCtx.currentTime + d); o.stop(audioCtx.currentTime + d + 0.18);
          });
        } catch (e) { }
      }

      // ── Atualiza logo da operação ─────────────
      function freqUpdateOpIndicator() {
        const el = document.getElementById('freqOpIndicator');
        if (!freqTradeActive || !freqMode) { if (el) el.style.display = 'none'; return; }
        if (el) el.style.display = 'block';
        const isUnder = freqMode === 'under';
        const isMatch = freqMode === 'match';
        const icon = document.getElementById('freqOpIcon');
        const label = document.getElementById('freqOpLabel');
        const level = document.getElementById('freqOpLevel');
        if (icon) icon.textContent = isUnder ? '📉' : isMatch ? '🎯' : '📈';
        if (label) {
          label.textContent = isUnder ? 'UNDER 3' : isMatch ? `MATCH ${freqMatchDigit}` : 'OVER 6';
          label.style.color = isUnder ? 'var(--fq-under)' : isMatch ? 'var(--fq-gold)' : 'var(--fq-over)';
        }
        const maxGales = isMatch ? FREQ_NEUTROS_MAX_LEVELS - 1 : FREQ_MAX_GALES;
        if (level) { const amt = freqGetEntry(freqMartLevel); level.textContent = `${freqLevelLabel(freqMartLevel)} / ${maxGales} gales — $${amt.toFixed(2)}`; }
      }

      // ══════════════════════════════════════════
      // ── Relógio virtual da operação ──────────
      // ══════════════════════════════════════════
      let freqClockStart_ts = null;
      let freqClockInterval = null;
      let freqOpClockStart_ts = null;
      let freqOpClockInterval = null;
      let freqOpTotalStaked = 0;    // soma das entradas da cadeia atual

      function freqClockTick() {
        if (!freqClockStart_ts) return;
        const elapsed = Math.floor((Date.now() - freqClockStart_ts) / 1000);
        const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const s = String(elapsed % 60).padStart(2, '0');
        const mEl = document.getElementById('freqClockMin');
        const sEl = document.getElementById('freqClockSec');
        if (mEl) mEl.textContent = m;
        if (sEl) sEl.textContent = s;
      }

      function freqClockShow() {
        freqClockStart_ts = Date.now();
        clearInterval(freqClockInterval);
        freqClockInterval = setInterval(freqClockTick, 1000);
        const wrap = document.getElementById('freqClockWrap');
        if (!wrap) return;
        wrap.style.display = 'block';
        wrap.className = 'fq-clock'; // reset classes
        const res = document.getElementById('freqClockResult');
        if (res) { res.style.display = 'none'; res.textContent = ''; }
        const mEl = document.getElementById('freqClockMin');
        const sEl = document.getElementById('freqClockSec');
        if (mEl) mEl.textContent = '00';
        if (sEl) sEl.textContent = '00';
      }

      function freqClockStop(type, extra) {
        clearInterval(freqClockInterval);
        freqClockInterval = null;
        freqClockTick(); // atualiza display com tempo final
        const wrap = document.getElementById('freqClockWrap');
        const res = document.getElementById('freqClockResult');
        if (!wrap) return;
        const labels = {
          win: '✅ STOP GAIN ' + (extra || ''),
          loss: '🛑 STOP LOSS',
          martingale: '🚨 LIMITE DE GALE',
          stopped: '⏹ PARADO'
        };
        const cls = type === 'win' ? 'clk-win' : (type === 'loss' ? 'clk-loss' : 'clk-mart');
        wrap.className = 'fq-clock ' + cls;
        if (res) { res.textContent = labels[type] || ''; res.style.display = 'inline-block'; }
        // Relógio permanece visível na tela (não some)
      }

      // ── Relógio 2: duração da operação ───────
      function freqOpClockTick() {
        if (!freqOpClockStart_ts) return;
        const elapsed = Math.floor((Date.now() - freqOpClockStart_ts) / 1000);
        const m = String(Math.floor(elapsed / 60)).padStart(2, '0');
        const s = String(elapsed % 60).padStart(2, '0');
        const mEl = document.getElementById('freqOpClockMin');
        const sEl = document.getElementById('freqOpClockSec');
        if (mEl) mEl.textContent = m;
        if (sEl) sEl.textContent = s;
      }

      function freqOpClockShow() {
        freqOpTotalStaked = 0;
        freqOpClockStart_ts = Date.now();
        clearInterval(freqOpClockInterval);
        freqOpClockInterval = setInterval(freqOpClockTick, 1000);
        const wrap = document.getElementById('freqOpClockWrap');
        if (!wrap) return;
        wrap.style.display = 'block';
        wrap.className = 'fq-clock';
        const res = document.getElementById('freqOpClockResult');
        if (res) { res.style.display = 'none'; res.textContent = ''; }
        const ent = document.getElementById('freqOpClockEntry');
        if (ent) { ent.textContent = 'Entrada: —'; ent.style.display = 'block'; }
        const mEl = document.getElementById('freqOpClockMin');
        const sEl = document.getElementById('freqOpClockSec');
        if (mEl) mEl.textContent = '00';
        if (sEl) sEl.textContent = '00';
      }

      function freqOpClockStop(type, extra) {
        clearInterval(freqOpClockInterval);
        freqOpClockInterval = null;
        freqOpClockTick();
        const wrap = document.getElementById('freqOpClockWrap');
        const res = document.getElementById('freqOpClockResult');
        const ent = document.getElementById('freqOpClockEntry');
        if (!wrap) return;
        const statusLabels = {
          win: '✅ WIN',
          loss: '🛑 STOP LOSS',
          martingale: '🚨 LIMITE DE GALE',
          stopped: '⏹ PARADO'
        };
        const cls = type === 'win' ? 'clk-win' : (type === 'loss' ? 'clk-loss' : 'clk-mart');
        wrap.className = 'fq-clock ' + cls;
        // Linha de entrada acumulada
        if (ent) ent.textContent = `Entrada: $${freqOpTotalStaked.toFixed(2)}`;
        // Resultado líquido (extra = "+$2.00" ou "-$5.00")
        if (res) {
          const liqLine = extra ? `Líquido: ${extra}` : '';
          res.innerHTML = `${statusLabels[type] || ''}<br><span style="font-size:13px;opacity:.85;">${liqLine}</span>`;
          res.style.display = 'inline-block';
        }
      }

      function freqOpClockReset() {
        clearInterval(freqOpClockInterval);
        freqOpClockInterval = null;
        freqOpClockStart_ts = null;
        const wrap = document.getElementById('freqOpClockWrap');
        if (wrap) wrap.style.display = 'none';
      }

      // ── Envia ordem de compra ─────────────────
      function freqEnterTrade(mode) {
        if (!freqWs || freqWs.readyState !== 1) return;
        if (!derivAccount?.token) { alert('Conecte sua conta Deriv primeiro!'); return; }
        const amount = freqGetEntry(freqMartLevel);
        const contractType = mode === 'match' ? 'DIGITMATCH'
                           : mode === 'under' ? 'DIGITUNDER' : 'DIGITOVER';
        const barrier = mode === 'under' ? '3' : mode === 'over' ? '6' : String(freqMatchDigit);
        const modeLabel = mode === 'under' ? 'UNDER 3' : mode === 'over' ? 'OVER 6' : `MATCH ${freqMatchDigit}`;
        const modeIcon  = mode === 'under' ? '📉' : mode === 'over' ? '📈' : '🎯';
        freqTradeActive = true;
        freqEntryTick = freqTotalDigits;
        freqTradeMartLevel = freqMartLevel;
        freqTradeMode = mode;
        freqTradeMatchDigit = freqMatchDigit;
        if (freqMartLevel === 0) freqOpClockShow(); // inicia relógio na 1ª entrada
        freqOpTotalStaked += amount;               // acumula stake do gale
        const entEl = document.getElementById('freqOpClockEntry');
        if (entEl) entEl.textContent = `Entrada: $${freqOpTotalStaked.toFixed(2)}`;
        playFreqEntry();
        freqUpdateOpIndicator();
        const statusEl = document.getElementById('freqStatusTxt');
        if (statusEl) statusEl.textContent = `${modeIcon} ${modeLabel} — $${amount}`;
        freqLog(`📤 Ordem: ${modeLabel} — $${amount.toFixed(2)} (${freqLevelLabel(freqMartLevel)})`, 'info');
        freqWs.send(JSON.stringify({
          buy: 1,
          price: amount.toFixed(2),
          parameters: {
            contract_type: contractType,
            symbol: freqMarket,
            duration: 1, duration_unit: 't',
            basis: 'stake',
            amount: amount.toFixed(2),
            currency: derivAccount.currency || 'USD',
            barrier: barrier
          }
        }));
      }

      // ── Resultado da compra ──────────────────
      function freqHandleBuy(data) {
        if (data.error) {
          freqTradeActive = false;
          if (data.error.code === 'AuthorizationRequired') {
            // re-authoriza e tenta novamente no próximo tick
            freqWs.send(JSON.stringify({ authorize: derivAccount.token }));
          }
          return;
        }
        freqCurrentContractId = data.buy.contract_id;
        freqWs.send(JSON.stringify({ proposal_open_contract: 1, contract_id: freqCurrentContractId, subscribe: 1 }));
      }

      // ── Resultado do contrato ────────────────
      function freqHandleContract(data) {
        const c = data.proposal_open_contract;
        if (!c) return;
        if (!c.is_expired && !c.is_sold) return;

        // Contrato já resolvido pelo tick → só atualiza P&L exato
        if (c.contract_id === freqTickHandledId) {
          freqTickHandledId = null;
          const profit = parseFloat(c.profit || 0);
          freqSessionPnl += profit;
          freqUpdateStats();
          freqAddTradeReport(profit > 0, profit, freqTickHandledMartLevel);
          if (profit > 0) {
            freqLog(`🏆 WIN +$${profit.toFixed(2)} | P&L: ${freqSessionPnl >= 0 ? '+' : ''}$${freqSessionPnl.toFixed(2)}`, 'success');
            freqOpClockStop('win', `+$${profit.toFixed(2)}`); // operação encerrou
            freqShowResult('gain');
            // Verifica Stop Gain
            const sg = parseFloat(document.getElementById('freqSG')?.value || 10);
            if (freqSessionPnl >= sg && freqRobotActive) {
              freqRobotActive = false;
              freqSetToggleBtn(false);
              freqLog(`🎯 STOP GAIN atingido: +$${freqSessionPnl.toFixed(2)}`, 'success');
              freqClockStop('win', `+$${freqSessionPnl.toFixed(2)}`);
            }
          } else {
            freqLog(`💸 LOSS $${Math.abs(profit).toFixed(2)} | P&L: ${freqSessionPnl >= 0 ? '+' : ''}$${freqSessionPnl.toFixed(2)}`, 'error');
            // Verifica Stop Loss com valor exato
            const sl = parseFloat(document.getElementById('freqSL')?.value || 5);
            if (freqSessionPnl <= -sl && freqRobotActive) {
              freqRobotActive = false;
              freqSetToggleBtn(false);
              freqLog(`🛑 STOP LOSS atingido: $${freqSessionPnl.toFixed(2)}`, 'error');
              freqClockStop('loss'); freqOpClockStop('loss', `-$${freqOpTotalStaked.toFixed(2)}`);
            }
          }
          return;
        }

        // Fallback: contrato não foi resolvido pelo tick (latência extrema ou edge case)
        if (freqCurrentContractId && c.contract_id !== freqCurrentContractId) return;
        if (freqProcessedContracts.has(c.contract_id)) return;
        freqProcessedContracts.add(c.contract_id);
        if (freqProcessedContracts.size > 20) {
          freqProcessedContracts.delete(freqProcessedContracts.values().next().value);
        }

        freqTradeActive = false;
        freqCurrentContractId = null;

        const profit = parseFloat(c.profit || 0);
        const isWin = profit > 0;

        if (isWin) {
          try { playWin(); } catch (e) { }
          freqSessionWins++;
          freqSessionPnl += profit;
          freqUpdateStats();
          freqAddTradeReport(true, profit, freqTradeMartLevel);
          freqMode = null;
          freqMartLevel = 0;
          freqUpdateOpIndicator();
          freqLog(`🏆 WIN +$${profit.toFixed(2)} | P&L: ${freqSessionPnl >= 0 ? '+' : ''}$${freqSessionPnl.toFixed(2)}`, 'success');
          freqOpClockStop('win', `+$${profit.toFixed(2)}`);
          freqShowResult('gain');
          // Verifica Stop Gain
          const sgFb = parseFloat(document.getElementById('freqSG')?.value || 10);
          if (freqSessionPnl >= sgFb && freqRobotActive) {
            freqRobotActive = false;
            freqSetToggleBtn(false);
            freqLog(`🎯 STOP GAIN atingido: +$${freqSessionPnl.toFixed(2)}`, 'success');
            freqClockStop('win', `+$${freqSessionPnl.toFixed(2)}`);
          }
          return;
        } else {
          try { playLoss(); } catch (e) { }
          freqSessionLosses++;
          freqSessionPnl += profit;
          freqUpdateStats();
          freqAddTradeReport(false, profit, freqTradeMartLevel);
          freqMartLevel++;
          const statusEl = document.getElementById('freqStatusTxt');
          if (statusEl) statusEl.textContent = `❌ PERDEU — ${freqLevelLabel(freqMartLevel)} próximo`;
          freqLog(`💸 LOSS $${Math.abs(profit).toFixed(2)} | ${freqLevelLabel(freqMartLevel)} ($${freqGetEntry(freqMartLevel).toFixed(2)}) | P&L: ${freqSessionPnl >= 0 ? '+' : ''}$${freqSessionPnl.toFixed(2)}`, 'error');
          const sl = parseFloat(document.getElementById('freqSL')?.value || 5);
          if (freqSessionPnl <= -sl) {
            freqLog(`🛑 STOP LOSS atingido: $${freqSessionPnl.toFixed(2)}`, 'error');
            freqClockStop('loss'); freqOpClockStop('loss', `-$${freqOpTotalStaked.toFixed(2)}`);
            freqShowResult('loss'); return;
          }
          if (freqMartLevel >= FREQ_MAX_LEVELS) {
            freqLog(`🚨 STOP MARTINGALE — nível máximo atingido`, 'error');
            freqClockStop('martingale'); freqOpClockStop('martingale', `-$${freqOpTotalStaked.toFixed(2)}`);
            freqShowResult('martingale'); return;
          }
          freqUpdateLevelDisplay();
          freqUpdateOpIndicator();
          freqEnterTrade(freqMode);
        }
      }

      // ── Atualiza stats da sessão ─────────────
      function freqUpdateStats() {
        const wEl = document.getElementById('freqWins');
        const lEl = document.getElementById('freqLosses');
        const pEl = document.getElementById('freqPnl');
        if (wEl) wEl.textContent = freqSessionWins;
        if (lEl) lEl.textContent = freqSessionLosses;
        if (pEl) {
          pEl.textContent = (freqSessionPnl >= 0 ? '+' : '') + '$' + freqSessionPnl.toFixed(2);
          pEl.style.color = freqSessionPnl >= 0 ? 'var(--green)' : 'var(--red)';
        }
      }

      // ── Log do robô de frequência ─────────────
      function freqLog(msg, type = 'info') {
        const area = document.getElementById('freqLogArea');
        if (!area) return;
        // Remove placeholder na primeira mensagem
        const empty = document.getElementById('freqLogEmpty');
        if (empty) empty.remove();
        const t = new Date().toLocaleTimeString('pt-BR');
        const colors = { info: 'var(--dim)', success: 'var(--green)', error: 'var(--red)', warning: 'var(--gold)' };
        const line = document.createElement('div');
        line.style.cssText = `color:${colors[type] || colors.info};line-height:1.4;border-bottom:1px solid rgba(255,255,255,.04);padding-bottom:2px;`;
        line.textContent = `[${t}] ${msg}`;
        area.appendChild(line);
        // Limite de 50 linhas
        while (area.children.length > 50) area.removeChild(area.firstChild);
        area.scrollTop = area.scrollHeight;
      }
      function freqClearLog() {
        const area = document.getElementById('freqLogArea');
        if (area) area.innerHTML = '<div id="freqLogEmpty" style="color:var(--dim);font-size:10px;text-align:center;padding:20px 0;line-height:1.6;">Inicie o robô<br>para ver os logs aqui.</div>';
      }

      // ── Toggle único INICIAR / PARAR ──────────
      function freqToggleRobot() {
        if (freqRobotActive) freqStopRobot(); else freqStartRobot();
      }

      function freqSetToggleBtn(active) {
        const btn = document.getElementById('freqToggleBtn');
        if (!btn) return;
        if (active) {
          btn.textContent = '⏹ PARAR ROBÔ';
          btn.classList.add('stop');
          btn.style.cssText = '';
        } else {
          btn.textContent = '▶ INICIAR ROBÔ';
          btn.classList.remove('stop');
          btn.style.cssText = '';
        }
      }

      // ── Inicia robô ──────────────────────────
      function freqStartRobot() {
        if (!derivAccount) { alert('Conecte sua conta Deriv primeiro!'); return; }
        freqClockShow();     // inicia/zera relógio de sessão
        freqOpClockReset();  // zera/oculta relógio de operação
        freqRobotActive = true;
        freqMartLevel = 0;
        freqMode = null;
        freqTradeActive = false;
        freqProcessedContracts.clear();
        freqUpdateStats();
        freqSetToggleBtn(true);
        document.getElementById('freqStatusTxt').textContent = 'MONITORANDO...';
        const sg = parseFloat(document.getElementById('freqSG')?.value || 10);
        const sl = parseFloat(document.getElementById('freqSL')?.value || 5);
        const hot = parseFloat(document.getElementById('freqHotThreshold')?.value || 40);
        const opp = parseFloat(document.getElementById('freqOppMinThreshold')?.value || 20);
        freqLog(`🤖 Robô iniciado | Entrada: $${parseFloat(document.getElementById('freqEntry')?.value || 0.35).toFixed(2)} | SG: $${sg} | SL: $${sl} | Quente: ${hot}% | Equil.: ${opp}%`, 'success');

        // Bloqueia inputs e seletor de mercado
        ['freqEntry', 'freqSG', 'freqSL', 'freqHotThreshold', 'freqOppMinThreshold'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.disabled = true; el.style.opacity = '0.5'; }
        });
        document.querySelectorAll('#freqMarketBtns button, #freqBtnSize10, #freqBtnSize25').forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });

        // Se WS já está conectado e com ticks fluindo → só autoriza para trading
        if (freqWs && freqWs.readyState === 1) {
          freqWs.send(JSON.stringify({ authorize: derivAccount.token }));
          return;
        }

        // WS não está pronto → abre novo com auth (vai assinar ticks após authorize)
        freqTicksSubscribed = false;
        if (freqWs) { freqWs.onclose = null; freqWs.close(); }
        freqWs = new WebSocket(`wss://ws.binaryws.com/websockets/v3?app_id=${DERIV_APP_ID}`);
        freqWs.onopen = () => {
          document.getElementById('freqConnStatus').textContent = '⬤ Conectado';
          document.getElementById('freqConnStatus').style.color = 'var(--green)';
          freqWs.send(JSON.stringify({ authorize: derivAccount.token }));
        };
        freqWs.onclose = () => {
          document.getElementById('freqConnStatus').textContent = '⬤ Desconectado';
          document.getElementById('freqConnStatus').style.color = 'var(--dim)';
          freqTicksSubscribed = false;
        };
        freqWs.onmessage = freqHandleMsg;
      }

      // ── Para robô ────────────────────────────
      function freqStopRobot() {
        if (freqRobotActive) freqLog('⏹ Robô parado.', 'warning');
        freqRobotActive = false;
        freqMode = null;
        freqMartLevel = 0;
        freqTradeActive = false;
        freqClockStop('stopped');   // para sessão, mantém visível
        freqOpClockStop('stopped'); // para operação, mantém visível
        freqSetToggleBtn(false);
        freqUpdateOpIndicator();
        document.getElementById('freqStatusTxt').textContent = 'PARADO';

        // Desbloqueia inputs
        ['freqEntry', 'freqSG', 'freqSL', 'freqHotThreshold', 'freqOppMinThreshold'].forEach(id => {
          const el = document.getElementById(id);
          if (el) { el.disabled = false; el.style.opacity = '1'; }
        });
        document.querySelectorAll('#freqMarketBtns button, #freqBtnSize10, #freqBtnSize25').forEach(b => { b.disabled = false; b.style.opacity = '1'; });

        const uBadge = document.getElementById('freqBadgeUnder');
        const oBadge = document.getElementById('freqBadgeOver');
        if (uBadge) { uBadge.textContent = 'AGUARDANDO'; uBadge.className = 'freq-status-badge aguard'; }
        if (oBadge) { oBadge.textContent = 'AGUARDANDO'; oBadge.className = 'freq-status-badge aguard'; }
      }

      // ── Overlay de resultado ──────────────────
      function freqShowResult(type) {
        freqStopRobot();
        const overlay = document.getElementById('freqResultOverlay');
        const icon = document.getElementById('freqResIcon');
        const title = document.getElementById('freqResTitle');
        const value = document.getElementById('freqResValue');
        const detail = document.getElementById('freqResDetail');
        if (type === 'gain') {
          icon.textContent = '🏆'; title.textContent = 'STOP GAIN'; title.style.color = 'var(--green)'; value.style.color = 'var(--green)';
          freqLog(`🏆 STOP GAIN! ${freqSessionWins} wins · ${freqSessionLosses} losses | P&L: +$${freqSessionPnl.toFixed(2)}`, 'success');
          try { playStopGain(); } catch (e) { }
        } else if (type === 'loss') {
          icon.textContent = '❌'; title.textContent = 'STOP LOSS'; title.style.color = 'var(--red)'; value.style.color = 'var(--red)';
          try { playStopLoss(); } catch (e) { }
        } else {
          icon.textContent = '🚨'; title.textContent = 'STOP MARTINGALE'; title.style.color = 'var(--red)'; value.style.color = 'var(--red)';
          try { playStopLoss(); } catch (e) { }
        }
        value.textContent = (freqSessionPnl >= 0 ? '+' : '') + '$' + freqSessionPnl.toFixed(2);
        detail.textContent = `${freqSessionWins} wins · ${freqSessionLosses} losses`;
        overlay.classList.add('show');
      }

      function freqCloseResult() {
        document.getElementById('freqResultOverlay').classList.remove('show');
      }

      // ── Init ──────────────────────────────────
      renderRobotList();
      updateMartPreview();
      applyBrand(); // apply saved brand on load
      updateDiagnostics();
      updateOUTable();
      updateFreqGrid();
  </script>

  <!-- ══ MODAL: CONECTAR DERIV ══ -->
  <div id="derivConnectModal"
    style="display:none;position:fixed;inset:0;z-index:9999;align-items:center;justify-content:center;background:rgba(0,0,0,.78);backdrop-filter:blur(6px);">
    <div
      style="background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:36px 32px;width:100%;max-width:380px;text-align:center;position:relative;">
      <div style="font-size:38px;margin-bottom:12px;">🔗</div>
      <div
        style="font-size:14px;font-weight:900;letter-spacing:2px;color:var(--accent);margin-bottom:10px;font-family:'Share Tech Mono',monospace;">
        CONECTE SUA CONTA DERIV</div>
      <p style="font-size:13px;color:var(--dim);line-height:1.7;margin-bottom:24px;">Para operar você precisa vincular
        sua conta Deriv.<br>Você já pode ver o mercado ao vivo gratuitamente.</p>
      <button class="btn btn-primary" style="width:100%;margin-bottom:10px;"
        onclick="closeDerivConnectModal();loginWithDeriv();">🔗 CONECTAR COM DERIV</button>
      <button class="btn" style="width:100%;background:transparent;border:1px solid var(--border);color:var(--dim);"
        onclick="closeDerivConnectModal()">Fechar</button>
    </div>
  </div>

</body>

</html>